((self||this).webpackJsonp=(self||this).webpackJsonp||[]).push([[0],[function(e,t,i){"use strict";var n;function r(...e){const t={attrScopes:{}};for(const i of e)void 0!==i.attrTransparencyColor&&(t.attrTransparencyColor=i.attrTransparencyColor),void 0!==i.attrScopes&&(t.attrScopes={...t.attrScopes,...i.attrScopes});return t}i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r})),function(e){e[e.FeatureGeometry=0]="FeatureGeometry",e[e.TechniqueGeometry=1]="TechniqueGeometry",e[e.TechniqueRendering=2]="TechniqueRendering"}(n||(n={}))},,function(e,t,i){"use strict";var n,r,s,o=i(10),a=i(4),l=i(15),h=i(20),c=(i(14),i(7));i(11);!function(e){let t,i;e.WORKER_SERVICE_MANAGER_SERVICE_ID="worker-service-manager",function(e){e.Initialized="initialized",e.Request="request",e.Response="response"}(t=e.ServiceMessageName||(e.ServiceMessageName={})),e.isInitializedMessage=function(e){return e&&"string"==typeof e.service&&"string"==typeof e.type&&e.type===t.Initialized},function(e){e.CreateService="create-service",e.DestroyService="destroy-service"}(i=e.Requests||(e.Requests={})),e.isUnknownServiceError=function(e){return/unknown targetServiceType requested: /.test(e.message)},e.isRequestMessage=function(e){return e&&"string"==typeof e.service&&"string"==typeof e.type&&e.type===t.Request},e.isResponseMessage=function(e){return e&&"string"==typeof e.service&&"string"==typeof e.type&&e.type===t.Response}}(n||(n={})),function(e){let t;!function(e){e.RegisterIndex="register-index",e.UpdateIndex="update-index",e.TileRequest="tile-request"}(t=e.Requests||(e.Requests={})),e.isRegisterIndexRequest=function(e){return e&&"string"==typeof e.type&&e.type===t.RegisterIndex},e.isUpdateIndexRequest=function(e){return e&&"string"==typeof e.type&&e.type===t.UpdateIndex},e.isTileRequest=function(e){return e&&"string"==typeof e.type&&e.type===t.TileRequest}}(r||(r={}));class d{constructor(e=0,t=new AbortController){this.priority=e,this.abortController=t}get signal(){return this.abortController.signal}abort(){this.abortController.abort()}}!function(e){let t,i;!function(e){e.Configuration="configuration"}(t=e.DecoderMessageName||(e.DecoderMessageName={})),e.isConfigurationMessage=function(e){return e&&"string"==typeof e.service&&"string"==typeof e.type&&e.type===t.Configuration},function(e){e.DecodeTileRequest="decode-tile-request",e.TileInfoRequest="tile-info-request"}(i=e.Requests||(e.Requests={})),e.isDecodeTileRequest=function(e){return e&&"string"==typeof e.type&&e.type===i.DecodeTileRequest},e.isTileInfoRequest=function(e){return e&&"string"==typeof e.type&&e.type===i.TileInfoRequest}}(s||(s={}));var m,u=i(21),p=i(3),f=i(22),g=i(9);!function(e){e[e.Point=0]="Point",e[e.Line=1]="Line",e[e.Polygon=2]="Polygon"}(m||(m={}));const v=100;class _{constructor(e,t=5e3){this.featureIds=new Array,this.numFeatures=0,this.numPositions=0,this.featureIds=new Array(t),this.featureIds.length=t,this.techniqueIndex=new Array(t),this.techniqueIndex.length=t,this.textIndex=new Array(t),this.textIndex.length=t,this.positionIndex=new Array(t),this.positionIndex.length=t,this.positions=new Array(10*t),this.positions.length=10*t,e&&(this.layerIndex=new Array(t),this.layerIndex.length=t,this.classIndex=new Array(t),this.classIndex.length=t,this.typeIndex=new Array(t),this.typeIndex.length=t)}getNumBytes(){return 8*(this.featureIds.length+this.techniqueIndex.length+this.textIndex.length+this.positionIndex.length+this.positions.length+(void 0!==this.layerIndex?this.layerIndex.length:0)+(void 0!==this.classIndex?this.classIndex.length:0)+(void 0!==this.typeIndex?this.typeIndex.length:0))}}class y extends _{constructor(){super(...arguments),this.userData=[]}getNumBytes(){return super.getNumBytes()+8*((void 0!==this.segmentIds?this.segmentIds.length:0)+(void 0!==this.segmentStartOffsets?this.segmentStartOffsets.length:0)+(void 0!==this.segmentEndOffsets?this.segmentEndOffsets.length:0))}}class x extends _{constructor(e,t=5e3){super(e,t),this.groupNumRings=0,this.outerRingStartIndex=new Array(t),this.outerRingStartIndex.length=t,this.innerRingIsOuterContour=new Array(t),this.innerRingIsOuterContour.length=t,this.innerRingStartIndex=new Array(t),this.innerRingStartIndex.length=t}getNumBytes(){return super.getNumBytes()+8*((void 0!==this.outerRingStartIndex?this.outerRingStartIndex.length:0)+(void 0!==this.innerRingIsOuterContour?this.innerRingIsOuterContour.length:0)+(void 0!==this.innerRingStartIndex?this.innerRingStartIndex.length:0))}}class b{constructor(e,t){this.tileKey=e,this.textCatalog=new Array,this.techniqueCatalog=new Array,this.setupTime=0,this.numBytes=0,this.pointGroup=new _(t),this.lineGroup=new y(t),this.polygonGroup=new x(t),t&&(this.layerCatalog=new Array,this.classCatalog=new Array,this.typeCatalog=new Array)}getNumBytes(){let e=v;for(const t of this.textCatalog)e+=2*t.length;if(e+=this.techniqueCatalog.length*v,e+=this.pointGroup.getNumBytes(),e+=this.lineGroup.getNumBytes(),e+=this.polygonGroup.getNumBytes(),void 0!==this.layerCatalog){for(const t of this.layerCatalog)e+=2*t.length;for(const t of this.classCatalog)e+=2*t.length;for(const t of this.typeCatalog)e+=2*t.length}return e}}!function(e){function t(e){e.featureIds.length=e.numFeatures,e.techniqueIndex.length=e.numFeatures,e.textIndex.length=e.numFeatures,e.positionIndex.length=e.numFeatures,e.positions.length=e.numPositions,void 0!==e.layerIndex&&(e.layerIndex.length=e.numFeatures),void 0!==e.classIndex&&(e.classIndex.length=e.numFeatures),void 0!==e.typeIndex&&(e.typeIndex.length=e.numFeatures)}function i(e){return e.numPositions===e.positions.length}function n(e,t,i,n){let r;if(t){const t=e.lookup("name:short");if("string"==typeof t&&t.length>0)return t}if(i){const t=e.lookup("iso_code");if("string"==typeof t&&t.length>0)return t}if(void 0!==n)for(const t of n)if(r=e.lookup(`name:${t}`)||e.lookup(`name_${t}`),"string"==typeof r&&r.length>0)return r;if(r=e.lookup("name"),"string"==typeof r)return r}e.finish=function(e){var i,n;t(e.pointGroup),t(i=e.lineGroup),void 0!==i.segmentIds&&(i.segmentIds.length=i.numFeatures,i.segmentStartOffsets.length=i.numFeatures,i.segmentEndOffsets.length=i.numFeatures),t(n=e.polygonGroup),n.outerRingStartIndex.length=n.numFeatures,n.innerRingIsOuterContour.length=n.groupNumRings,n.innerRingStartIndex.length=n.groupNumRings,e.numBytes=e.getNumBytes()},e.featureGroupSize=function(e){return e.numFeatures},e.featureGroupFinished=i,e.tileInfoFinished=function(e){return i(e.pointGroup)&&i(e.lineGroup)&&i(e.polygonGroup)},e.getFeatureName=n,e.getFeatureText=function(e,t,i){let r,s;const o=e instanceof a.d?e:e.env;if(Object(l.s)(t)||Object(l.l)(t)||Object(l.j)(t)){if(void 0!==t.text)return Object(g.a)(e,t.text);if(void 0!==t.label){const e=o.lookup(t.label);return"string"==typeof e?e:void 0}r=t.useAbbreviation,s=t.useIsoCode}return n(o,r,s,i)}}(b||(b={}));class w{constructor(e,t){this.tileInfo=e,this.storeExtendedTags=t,this.techniqueIndexMap=new Map,this.stringMap=new Map,this.layerMap=new Map,this.classMap=new Map,this.typeMap=new Map}addTechnique(e){let t=this.techniqueIndexMap.get(e._index);if(void 0!==t)return t;const i=Object(f.b)(e);return t=this.tileInfo.techniqueCatalog.length,this.techniqueIndexMap.set(i._index,t),this.tileInfo.techniqueCatalog.push(i),t}addFeature(e,t,i,n,r,s){let o=-1;switch(void 0!==n&&n.length>0&&(o=this.addText(n)),e.featureIds[e.numFeatures]=i,e.techniqueIndex[e.numFeatures]=r,e.textIndex[e.numFeatures]=o,e.positionIndex[e.numFeatures]=e.numPositions,s){case m.Polygon:const i=e;Object(p.l)(void 0!==i.outerRingStartIndex),Object(p.l)(void 0!==i.innerRingStartIndex),Object(p.l)(void 0!==i.innerRingIsOuterContour),i.outerRingStartIndex[e.numFeatures]=i.groupNumRings;break;case m.Line:e.userData[e.numFeatures]=t.entries}this.storeExtendedTags&&(e.layerIndex[e.numFeatures]=this.addLayer(t.lookup("$layer")),e.classIndex[e.numFeatures]=this.addClass(t.lookup("class")),e.typeIndex[e.numFeatures]=this.addType(t.lookup("type"))),e.numFeatures++}addFeaturePoint(e,t,i){e.positions[e.numPositions++]=t,e.positions[e.numPositions++]=i}addFeaturePoints(e,t){const i=e.numPositions,n=t.length,r=e.positions;for(let e=0;e<n;e++)r[i+e]=t[e];e.numPositions+=t.length}addRoadSegments(e,t,i,n){void 0===e.segmentIds&&(e.segmentIds=new Array,e.segmentStartOffsets=new Array,e.segmentEndOffsets=new Array),e.segmentIds[e.numFeatures-1]=t,e.segmentStartOffsets[e.numFeatures-1]=i,e.segmentEndOffsets[e.numFeatures-1]=n}addRingPoints(e,t,i){e.innerRingStartIndex[e.groupNumRings]=e.numPositions,e.innerRingIsOuterContour[e.groupNumRings]=i?1:0,e.groupNumRings++;const n=e.numPositions,r=t.length,s=e.positions;for(let e=0;e<r;e++)s[n+e]=t[e];e.numPositions+=t.length}finish(){b.finish(this.tileInfo)}addText(e){return this.addStringValue(e,this.tileInfo.textCatalog,this.stringMap)}addLayer(e){return this.addStringValue(e,this.tileInfo.layerCatalog,this.layerMap)}addClass(e){return this.addStringValue(e,this.tileInfo.classCatalog,this.classMap)}addType(e){return this.addStringValue(e,this.tileInfo.typeCatalog,this.typeMap)}addStringValue(e,t,i){if(null==e)return-1;const n=e.toString();let r=i.get(n);return void 0!==r?r:(r=t.length,t.push(n),i.set(n,r),r)}}class T{constructor(e){this.tileInfo=e}visitAll(e){this.visitAllPointFeatures(e),this.visitAllLineFeatures(e),this.visitAllPolygonFeatures(e)}visitFeature(e,t){let i=0;const n=this.tileInfo.pointGroup.numFeatures,r=this.tileInfo.pointGroup.featureIds;for(let s=0;s<n;s++)r[s]===e&&(i++,this.visitPointFeature(s,t));const s=this.tileInfo.lineGroup.numFeatures,o=this.tileInfo.lineGroup.featureIds;for(let n=0;n<s;n++)o[n]===e&&(i++,this.visitLineFeature(n,t));const a=this.tileInfo.polygonGroup.numFeatures,l=this.tileInfo.polygonGroup.featureIds;for(let n=0;n<a;n++)l[n]===e&&(i++,this.visitPolygonFeature(n,t));return i}visitAllPointFeatures(e){const t=this.tileInfo.pointGroup.numFeatures;for(let i=0;i<t;i++)this.visitPointFeature(i,e)}visitAllLineFeatures(e){const t=this.tileInfo.lineGroup.numFeatures;for(let i=0;i<t;i++)this.visitLineFeature(i,e)}visitAllPolygonFeatures(e){const t=this.tileInfo.polygonGroup.numFeatures;for(let i=0;i<t;i++)this.visitPolygonFeature(i,e)}getTag(e,t){return void 0!==t&&t[e]>=0?t[e]:-1}visitPointFeature(e,t){const i=this.tileInfo.pointGroup,n=i.positionIndex[e],r=i.positions[n],s=i.positions[n+1];t.acceptPoint&&t.acceptPoint(i.featureIds[e],i.techniqueIndex[e],r,s,i.textIndex[e],this.getTag(e,i.layerIndex),this.getTag(e,i.classIndex),this.getTag(e,i.typeIndex))}visitLineFeature(e,t){const i=this.tileInfo,n=i.lineGroup,r=n.numFeatures,s=n.positionIndex[e],o=e===r-1?n.positions.length-s:n.positionIndex[e+1]-s;let a,l,h;void 0!==n.segmentIds&&(a=n.segmentIds[e],l=n.segmentStartOffsets[e],h=n.segmentEndOffsets[e]),t.acceptLine&&t.acceptLine(n.featureIds[e],n.techniqueIndex[e],n.textIndex[e],this.getTag(e,n.layerIndex),this.getTag(e,n.classIndex),this.getTag(e,n.typeIndex),i.lineGroup.positions,s,o,a,l,h)}visitPolygonFeature(e,t){if(void 0===t.acceptPolygon)return;const i=this.tileInfo.polygonGroup,n=i.numFeatures,r=i.outerRingStartIndex[e],s=e===n-1?i.innerRingStartIndex.length-r:i.outerRingStartIndex[e+1]-r;T.polygonAccessor.setup(i,e,r,s),t.acceptPolygon(i.featureIds[e],i.techniqueIndex[e],i.textIndex[e],this.getTag(e,i.layerIndex),this.getTag(e,i.classIndex),this.getTag(e,i.typeIndex),T.polygonAccessor),T.polygonAccessor.reset()}}T.polygonAccessor=new class{constructor(){this.featureIndex=0,this.ringStart=0,this.numRings=0}setup(e,t,i,n){this.polygons=e,this.featureIndex=t,this.ringStart=i,this.numRings=n}reset(){this.polygons=void 0,this.featureIndex=0,this.ringStart=0,this.numRings=0}isOuterRing(e){if(Object(p.l)(e>=0),Object(p.l)(e<this.numRings),Object(p.l)(void 0!==this.polygons),e<0||e>=this.numRings||void 0===this.polygons)throw new Error("ExtendedTileInfoPolygonAccessor: Invalid ring index");return 0!==this.polygons.innerRingIsOuterContour[this.ringStart+e]}getPoints(e){if(Object(p.l)(e>=0),Object(p.l)(e<this.numRings),Object(p.l)(void 0!==this.polygons),e<0||e>=this.numRings||void 0===this.polygons)throw new Error("ExtendedTileInfoPolygonAccessor: Invalid ring index");const t=this.polygons.innerRingStartIndex[this.ringStart+e];let i;return i=e<this.numRings-1?this.polygons.innerRingStartIndex[this.ringStart+e+1]-t:this.ringStart+e<this.polygons.innerRingStartIndex.length-1?this.polygons.innerRingStartIndex[this.ringStart+e+1]-t:this.polygons.positions.length-t,{points:this.polygons.positions,pointsStart:t,numPointValues:i}}};var S=i(8);i.d(t,"a",(function(){return o.a})),i.d(t,"C",(function(){return a.o})),i.d(t,"b",(function(){return a.e})),i.d(t,"k",(function(){return l.a})),i.d(t,"l",(function(){return l.b})),i.d(t,"R",(function(){return l.u})),i.d(t,"x",(function(){return l.e})),i.d(t,"K",(function(){return l.p})),i.d(t,"G",(function(){return l.l})),i.d(t,"E",(function(){return l.j})),i.d(t,"F",(function(){return l.k})),i.d(t,"J",(function(){return l.o})),i.d(t,"H",(function(){return l.m})),i.d(t,"y",(function(){return l.f})),i.d(t,"A",(function(){return l.h})),i.d(t,"z",(function(){return l.g})),i.d(t,"L",(function(){return l.q})),i.d(t,"M",(function(){return l.r})),i.d(t,"N",(function(){return l.s})),i.d(t,"I",(function(){return l.n})),i.d(t,"D",(function(){return l.i})),i.d(t,"P",(function(){return l.t})),i.d(t,"S",(function(){return l.v})),i.d(t,"q",(function(){return l.c})),i.d(t,"r",(function(){return l.d})),i.d(t,"f",(function(){return h.a})),i.d(t,"g",(function(){return h.b})),i.d(t,"m",(function(){return h.d})),i.d(t,"i",(function(){return h.c})),i.d(t,"O",(function(){return h.e})),i.d(t,"B",(function(){return c.c})),i.d(t,"w",(function(){return c.b})),i.d(t,"o",(function(){return n})),i.d(t,"p",(function(){return r})),i.d(t,"j",(function(){return d})),i.d(t,"n",(function(){return s})),i.d(t,"s",(function(){return u.b})),i.d(t,"h",(function(){return u.a})),i.d(t,"u",(function(){return u.d})),i.d(t,"v",(function(){return u.e})),i.d(t,"t",(function(){return u.c})),i.d(t,"e",(function(){return m})),i.d(t,"c",(function(){return b})),i.d(t,"d",(function(){return w})),i.d(t,"Q",(function(){return S.f}))},,function(e,t,i){"use strict";const n={at:{call:(e,t)=>{const i=t.args,n=e.evaluate(i[0]);if("number"!=typeof n)throw new Error("expected the index of the element to retrieve");const r=e.evaluate(i[1]);if(!Array.isArray(r))throw new Error("expected an array");return n>=0&&n<r.length?r[n]:null}}},r={"to-boolean":{call:(e,t)=>Boolean(e.evaluate(t.args[0]))},"to-string":{call:(e,t)=>String(e.evaluate(t.args[0]))},"to-number":{call:(e,t)=>{for(const i of t.args){const t=Number(e.evaluate(i));if(!isNaN(t))return t}throw new Error("cannot convert the value to a number")}}};var s=i(1),o=i(10);const a={rgba:{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]),r=e.evaluate(t.args[2]),a=e.evaluate(t.args[3]);if("number"==typeof i&&"number"==typeof n&&"number"==typeof r&&"number"==typeof a&&i>=0&&n>=0&&r>=0&&a>=0&&a<=1)return function(e,t,i,n){return o.a.getHexFromRgba(s.bb.clamp(e,0,255)/255,s.bb.clamp(t,0,255)/255,s.bb.clamp(i,0,255)/255,s.bb.clamp(n,0,1))}(i,n,r,a);throw new Error(`unknown color 'rgba(${i},${n},${r},${a})'`)}},rgb:{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]),r=e.evaluate(t.args[2]);if("number"==typeof i&&"number"==typeof n&&"number"==typeof r&&i>=0&&n>=0&&r>=0)return function(e,t,i){return o.a.getHexFromRgb(s.bb.clamp(e,0,255)/255,s.bb.clamp(t,0,255)/255,s.bb.clamp(i,0,255)/255)}(i,n,r);throw new Error(`unknown color 'rgb(${i},${n},${r})'`)}},hsl:{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]),r=e.evaluate(t.args[2]);if("number"==typeof i&&"number"==typeof n&&"number"==typeof r&&i>=0&&n>=0&&r>=0)return function(e,t,i){return o.a.getHexFromHsl(s.bb.euclideanModulo(e,360)/360,s.bb.clamp(t,0,100)/100,s.bb.clamp(i,0,100)/100)}(i,n,r);throw new Error(`unknown color 'hsl(${i},${n}%,${r}%)'`)}}};function l(e,t,i=!1){const n=e.evaluate(t.args[0]),r=e.evaluate(t.args[1]);if(!("number"==typeof n&&"number"==typeof r||"string"==typeof n&&"string"==typeof r)&&i)throw new Error(`invalid operands '${n}' and '${r}' for operator '${t.op}'`);switch(t.op){case"<":return n<r;case">":return n>r;case"<=":return n<=r;case">=":return n>=r;default:throw new Error(`invalid comparison operator '${t.op}'`)}}const h={"!":{call:(e,t)=>!e.evaluate(t.args[0])},"==":{call:(e,t)=>{return e.evaluate(t.args[0])===e.evaluate(t.args[1])}},"!=":{call:(e,t)=>{return e.evaluate(t.args[0])!==e.evaluate(t.args[1])}},"<":{call:(e,t)=>l(e,t)},">":{call:(e,t)=>l(e,t)},"<=":{call:(e,t)=>l(e,t)},">=":{call:(e,t)=>l(e,t)}},c={"geometry-type":{call:(e,t)=>{switch(e.env.lookup("$geometryType")){case"point":return"Point";case"line":return"LineString";case"polygon":return"Polygon";default:return null}}}};function d(e,t,i){switch(t){case"boolean":case"number":case"string":for(const n of i){const i=e.evaluate(n);if(typeof i===t)return i}throw new Error(`expected a '${t}'`);default:throw new Error(`invalid type '${t}'`)}}const m={all:{call:(e,t)=>{for(const i of t.args)if(!e.evaluate(i))return!1;return!0}},any:{call:(e,t)=>{for(const i of t.args)if(e.evaluate(i))return!0;return!1}},none:{call:(e,t)=>{for(const i of t.args)if(e.evaluate(i))return!1;return!0}},boolean:{call:(e,t)=>d(e,"boolean",t.args)},number:{call:(e,t)=>d(e,"number",t.args)},string:{call:(e,t)=>d(e,"string",t.args)}};var u=i(7);const p={interpolate:{isDynamicOperator:e=>e.args[1]&&e.args[1].isDynamic(),call:(e,t)=>{if(function(e){if(e._interpolatedProperty||void 0!==e._mode)return;const t=e.args[0];if(!(t instanceof ne))throw new Error("expected an interpolation type");let i,n;if("linear"===t.op)i="Linear";else if("discrete"===t.op)i="Discrete";else if("cubic"===t.op)i="Cubic";else{if("exponential"!==t.op)throw new Error("unrecognized interpolation type");{i="Exponential";const e=t.args[0];if(!(e instanceof J))throw new Error("expected the base of the exponential interpolation");n=e.value}}const r=e.args[1];if(!(r instanceof ne))throw new Error("expected the input of the interpolation");if("zoom"!==r.op)throw new Error("only 'zoom' is supported");if(2===e.args.length||e.args.length%2)throw new Error("invalid number of samples");const s=[],o=[];let a=!0;for(let t=2;t<e.args.length;t+=2){const i=e.args[t];if(!(i instanceof J))throw new Error("expected a numeric literal");if(s.push(i.value),a){const i=e.args[t+1];i instanceof K?o.push(i.value):a=!1}}if(a){const t=Object(u.a)({interpolation:i,exponent:n,zoomLevels:s,values:o});if(!t)throw new Error("failed to create interpolation");e._interpolatedProperty=t}else e._mode=i,e._exponent=n,e._stops=s}(t),e.scope!==Z.Dynamic)return t;let i=t._interpolatedProperty;if(!i){const n=[];for(let i=2;i<t.args.length;i+=2){const r=e.evaluate(t.args[i+1]);n.push(r)}if(i=Object(u.a)({interpolation:t._mode,exponent:t._exponent,zoomLevels:t._stops,values:n}),void 0===i)throw new Error("failed to create interpolator")}return Object(u.b)(i,e.env)}},step:{isDynamicOperator:e=>e.args[0]&&e.args[0].isDynamic(),call:(e,t)=>{if(function(e){if(void 0!==e._inputIsZoom)return;if(void 0===e.args[0])throw new Error("expected the input of the 'step' operator");if(e.args.length<3||e.args.length%2)throw new Error("not enough arguments");const t=e.args[0];t instanceof ne&&"zoom"===t.op?e._inputIsZoom=!0:e._inputIsZoom=!1;for(let t=2;t<e.args.length;t+=2){if(!(e.args[t]instanceof J))throw new Error("expected a numeric literal")}}(t),e.scope===Z.Value)return t;if(e.scope===Z.Condition||!1===t._inputIsZoom)return function(e,t){const{args:i}=t,n=e.evaluate(i[0]);if(null===n)return e.evaluate(i[1]);if("number"!=typeof n)throw new Error("the input of a 'step' operator must have type 'number'");let r=1,s=i.length/2-1;for(;r<s;){const e=r+s>>>1,t=i[2*e].value;n<t?s=e-1:n>t?r=e+1:s=e}const o=i[2*r];if(!(o instanceof J))throw new Error("expected a numeric literal");const a=o.value<=n?r:r-1;return e.evaluate(i[2*a+1])}(e,t);!function(e){if(e._stops||e._interpolatedProperty)return;const t=[Number.MIN_SAFE_INTEGER];for(let i=2;i<e.args.length;i+=2){const n=e.args[i];t.push(n.value)}const i=[];let n=!0;for(let t=1;n&&t<e.args.length;t+=2){const r=e.args[t];r instanceof K?i.push(r.value):n=!1}if(n){const n=Object(u.a)({interpolation:"Discrete",zoomLevels:t,values:i});if(void 0===n)throw new Error("failed to create interpolator");e._interpolatedProperty=n}else e._stops=t}(t);let i=t._interpolatedProperty;if(!i){const n=[];for(let i=1;i<t.args.length;i+=2){const r=e.evaluate(t.args[i]);n.push(r)}if(i=Object(u.a)({interpolation:"Discrete",zoomLevels:t._stops,values:n}),void 0===i)throw new Error("failed to create interpolator")}return Object(u.b)(i,e.env)}}},f={ppi:{call:e=>{const t=e.env.lookup("$ppi");return"number"==typeof t?t:72}},zoom:{isDynamicOperator:()=>!0,call:e=>{if(e.scope===Z.Condition){const t=e.env.lookup("$zoom");if(void 0!==t)return t;throw new Error("failed to get the zoom level.")}throw new Error("invalid usage of the 'zoom' operator.")}}},g={"^":{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]);if("number"!=typeof i||"number"!=typeof n)throw new Error(`invalid operands '${typeof i}' and '${typeof n}' for operator '^'`);return Math.pow(i,n)}},"-":{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]);if("number"!=typeof i||"number"!=typeof n)throw new Error(`invalid operands '${typeof i}' and '${typeof n}' for operator '-'`);return i-n}},"/":{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]);if("number"!=typeof i||"number"!=typeof n)throw new Error(`invalid operands '${typeof i}' and '${typeof n}' for operator '/'`);return i/n}},"%":{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]);if("number"!=typeof i||"number"!=typeof n)throw new Error(`invalid operands '${typeof i}' and '${typeof n}' for operator '%'`);return i%n}},"+":{call:(e,t)=>t.args.reduce((t,i)=>Number(t)+Number(e.evaluate(i)),0)},"*":{call:(e,t)=>t.args.reduce((t,i)=>Number(t)*Number(e.evaluate(i)),1)},abs:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'abs'`);return Math.abs(i)}},acos:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'acos'`);return Math.acos(i)}},asin:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'asin'`);return Math.asin(i)}},atan:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'atan'`);return Math.atan(i)}},ceil:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'ceil'`);return Math.ceil(i)}},cos:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'cos'`);return Math.cos(i)}},e:{call:()=>Math.E},floor:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'floor'`);return Math.floor(i)}},ln:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'ln'`);return Math.log(i)}},ln2:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'ln2'`);return Math.log2(i)}},log10:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'log10'`);return Math.log10(i)}},max:{call:(e,t)=>Math.max(...t.args.map(t=>Number(e.evaluate(t))))},min:{call:(e,t)=>Math.min(...t.args.map(t=>Number(e.evaluate(t))))},clamp:{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]),r=e.evaluate(t.args[2]);if("number"!=typeof i||"number"!=typeof n||"number"!=typeof r)throw new Error(`invalid operands '${i}', ${n}, ${r} for operator 'clamp'`);return s.bb.clamp(i,n,r)}},pi:{call:()=>Math.PI},round:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'round'`);return Math.round(i)}},sin:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'sin'`);return Math.sin(i)}},sqrt:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'sqrt'`);return Math.sqrt(i)}},tan:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if("number"!=typeof i)throw new Error(`invalid operand '${i}' for operator 'tan'`);return Math.tan(i)}}},v={length:{call:(e,t)=>{const i=e.evaluate(t.args[0]);if(Array.isArray(i)||"string"==typeof i)return i.length;throw new Error(`invalid operand '${i}' for operator 'length'`)}},coalesce:{call:(e,t)=>{for(const i of t.args){const t=e.evaluate(i);if(null!==t)return t}return null}}},_=Object.prototype.hasOwnProperty;var y;function x(e,t,i){const n=e.evaluate(t[0]);if("string"!=typeof n)throw new Error("expected the name of an attribute");const r=e.evaluate(t[1]);return r&&"object"==typeof r&&_.call(r,n)?i!==y.get||r[n]:i===y.get&&null}!function(e){e[e.get=0]="get",e[e.has=1]="has"}(y||(y={}));const b={get:{call:(e,t)=>x(e,t.args,y.get)},has:{call:(e,t)=>x(e,t.args,y.has)}},w={concat:{call:(e,t)=>"".concat(...t.args.map(t=>String(e.evaluate(t))))},downcase:{call:(e,t)=>String(e.evaluate(t.args[0])).toLocaleLowerCase()},upcase:{call:(e,t)=>String(e.evaluate(t.args[0])).toLocaleUpperCase()},"~=":{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]);return"string"==typeof i&&"string"==typeof n&&-1!==i.indexOf(n)}},"^=":{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]);return"string"==typeof i&&"string"==typeof n&&i.startsWith(n)}},"$=":{call:(e,t)=>{const i=e.evaluate(t.args[0]),n=e.evaluate(t.args[1]);return"string"==typeof i&&"string"==typeof n&&i.endsWith(n)}}},T={typeof:{call:(e,t)=>typeof e.evaluate(t.args[0])}},S=new Map;class C{constructor(e,t,i,n){this.evaluator=e,this.env=t,this.scope=i,this.cache=n,this.m_partialEvaluation=!1}get partialEvaluation(){return this.m_partialEvaluation}evaluate(e){if(void 0!==e)return e.accept(this.evaluator,this);throw new Error("Failed to evaluate expression")}partiallyEvaluate(e){if(void 0===e)throw new Error("Failed to evaluate expression");const t=this.m_partialEvaluation;this.m_partialEvaluation=!0;try{const i=e.accept(this.evaluator,this);return this.m_partialEvaluation=t,i instanceof $?i:K.fromValue(i)}catch(e){throw e}finally{this.m_partialEvaluation=t}}}class E{static defineOperator(e,t){S.set(e,t)}static defineOperators(e){Object.getOwnPropertyNames(e).forEach(t=>{this.defineOperator(t,e[t])})}static getOperator(e){return S.get(e)}visitVarExpr(e,t){const i=t.env.lookup(e.name);return void 0!==i?i:null}visitNullLiteralExpr(e,t){return null}visitBooleanLiteralExpr(e,t){return e.value}visitNumberLiteralExpr(e,t){return e.value}visitStringLiteralExpr(e,t){return e.value}visitObjectLiteralExpr(e,t){return e.value}visitHasAttributeExpr(e,t){return void 0!==t.env.lookup(e.name)}visitContainsExpr(e,t){const i=e.value.accept(this,t),n=e.elements.includes(i);return void 0!==t.cache&&t.cache.set(e,n),n}visitMatchExpr(e,t){const i=t.evaluate(e.value);for(const[n,r]of e.branches){if(Array.isArray(n)&&n.includes(i))return t.evaluate(r);if(n===i)return t.evaluate(r)}return t.evaluate(e.fallback)}visitCaseExpr(e,t){for(const[i,n]of e.branches)if(t.evaluate(i))return t.evaluate(n);return t.evaluate(e.fallback)}visitCallExpr(e,t){if(void 0!==t.cache){const i=t.cache.get(e);if(void 0!==i)return i}const i=e.descriptor||S.get(e.op);if(i){e.descriptor=i;const n=i.call(t,e);return t.cache&&t.cache.set(e,n),n}throw new Error(`undefined operator '${e.op}`)}}E.defineOperators(r),E.defineOperators(h),E.defineOperators(g),E.defineOperators(w),E.defineOperators(a),E.defineOperators(T),E.defineOperators(v),E.defineOperators(m),E.defineOperators(n),E.defineOperators(p),E.defineOperators(b),E.defineOperators(c),E.defineOperators(f);var M,A;function P(e){switch(e){case M.Tab:case M.Lf:case M.Cr:case M.Space:return!0;default:return!1}}function L(e){return e>=M._0&&e<=M._9}function R(e){return e>=M.a&&e<=M.z||e>=M.A&&e<=M.Z}function O(e){return function(e){return R(e)||L(e)}(e)||e===M._||e===M.Dollar||e===M.Dot||e===M.LBracket||e===M.RBracket}function F(e){switch(e){case A.Eof:return"eof";case A.Error:return"error";case A.Identifier:return"identifier";case A.Number:return"number";case A.String:return"string";case A.Comma:return",";case A.LParen:return"(";case A.RParen:return")";case A.LBracket:return"[";case A.RBracket:return"]";case A.Exclaim:return"!";case A.TildeEqual:return"~=";case A.CaretEqual:return"^=";case A.DollarEqual:return"$=";case A.EqualEqual:return"==";case A.ExclaimEqual:return"!=";case A.Less:return"<";case A.Greater:return">";case A.LessEqual:return"<=";case A.GreaterEqual:return">=";case A.BarBar:return"||";case A.AmpAmp:return"&&";default:throw new Error(`invalid token ${e}`)}}!function(e){e[e.Tab=9]="Tab",e[e.Lf=10]="Lf",e[e.Cr=13]="Cr",e[e.Space=32]="Space",e[e.LParen=40]="LParen",e[e.RParen=41]="RParen",e[e.Comma=44]="Comma",e[e.Dot=46]="Dot",e[e.LBracket=91]="LBracket",e[e.Backslash=92]="Backslash",e[e.RBracket=93]="RBracket",e[e._0=48]="_0",e[e._9=57]="_9",e[e._=95]="_",e[e.A=64]="A",e[e.Z=90]="Z",e[e.a=97]="a",e[e.z=122]="z",e[e.DoubleQuote=34]="DoubleQuote",e[e.SingleQuote=39]="SingleQuote",e[e.Exclaim=33]="Exclaim",e[e.Equal=61]="Equal",e[e.Caret=94]="Caret",e[e.Tilde=126]="Tilde",e[e.Dollar=36]="Dollar",e[e.Less=60]="Less",e[e.Greater=62]="Greater",e[e.Bar=124]="Bar",e[e.Amp=38]="Amp"}(M||(M={})),function(e){e[e.Eof=0]="Eof",e[e.Error=1]="Error",e[e.Identifier=2]="Identifier",e[e.Number=3]="Number",e[e.String=4]="String",e[e.Comma=5]="Comma",e[e.LParen=6]="LParen",e[e.RParen=7]="RParen",e[e.LBracket=8]="LBracket",e[e.RBracket=9]="RBracket",e[e.Exclaim=10]="Exclaim",e[e.TildeEqual=11]="TildeEqual",e[e.CaretEqual=12]="CaretEqual",e[e.DollarEqual=13]="DollarEqual",e[e.EqualEqual=14]="EqualEqual",e[e.ExclaimEqual=15]="ExclaimEqual",e[e.Less=16]="Less",e[e.Greater=17]="Greater",e[e.LessEqual=18]="LessEqual",e[e.GreaterEqual=19]="GreaterEqual",e[e.BarBar=20]="BarBar",e[e.AmpAmp=21]="AmpAmp"}(A||(A={}));class D{constructor(e){this.code=e,this.m_token=A.Error,this.m_index=0,this.m_char=M.Lf}token(){return this.m_token}text(){return this.m_text||""}next(){if(this.m_token=this.yylex(),this.m_token===A.Error)throw new Error(`unexpected character ${this.m_char}`);return this.m_token}yyinp(){this.m_char=this.code.codePointAt(this.m_index++)||0}yylex(){for(this.m_text=void 0;P(this.m_char);)this.yyinp();if(0===this.m_char)return A.Eof;const e=this.m_char;switch(this.yyinp(),e){case M.LParen:return A.LParen;case M.RParen:return A.RParen;case M.LBracket:return A.LBracket;case M.RBracket:return A.RBracket;case M.Comma:return A.Comma;case M.SingleQuote:case M.DoubleQuote:{const t=this.m_index-1;for(;this.m_char&&this.m_char!==e;)this.yyinp();if(this.m_char!==e)throw new Error("Unfinished string literal");return this.yyinp(),this.m_text=this.code.substring(t,this.m_index-2),A.String}case M.Exclaim:return this.m_char===M.Equal?(this.yyinp(),A.ExclaimEqual):A.Exclaim;case M.Caret:return this.m_char===M.Equal?(this.yyinp(),A.CaretEqual):A.Error;case M.Tilde:return this.m_char===M.Equal?(this.yyinp(),A.TildeEqual):A.Error;case M.Equal:return this.m_char===M.Equal?(this.yyinp(),A.EqualEqual):A.Error;case M.Less:return this.m_char===M.Equal?(this.yyinp(),A.LessEqual):A.Less;case M.Greater:return this.m_char===M.Equal?(this.yyinp(),A.GreaterEqual):A.Greater;case M.Bar:return this.m_char===M.Bar?(this.yyinp(),A.BarBar):A.Error;case M.Amp:return this.m_char===M.Amp?(this.yyinp(),A.AmpAmp):A.Error;default:{const t=this.m_index-2;if(R(e)||e===M._||e===M.Dollar&&O(this.m_char)){for(;O(this.m_char);)this.yyinp();return this.m_text=this.code.substring(t,this.m_index-1),A.Identifier}if(L(e)){for(;L(this.m_char);)this.yyinp();if(this.m_char===M.Dot)for(this.yyinp();L(this.m_char);)this.yyinp();return this.m_text=this.code.substring(t,this.m_index-1),A.Number}if(e===M.Dollar)return this.m_char===M.Equal?(this.yyinp(),A.DollarEqual):A.Error}}return A.Error}}function I(e){switch(e){case A.TildeEqual:return"~=";case A.CaretEqual:return"^=";case A.DollarEqual:return"$=";case A.EqualEqual:return"==";case A.ExclaimEqual:return"!=";default:return}}function z(e){switch(e){case A.Less:return"<";case A.Greater:return">";case A.LessEqual:return"<=";case A.GreaterEqual:return">=";default:return}}class k{constructor(e){this.lex=new D(e),this.lex.next()}parse(){return this.parseLogicalOr()}yyexpect(e){if(this.lex.token()!==e)throw new Error(`Syntax error: Expected token '${F(e)}' but `+`found '${F(this.lex.token())}'`);this.lex.next()}parsePrimary(){switch(this.lex.token()){case A.Identifier:{const e=this.lex.text();switch(e){case"has":this.lex.next(),this.yyexpect(A.LParen);const t=this.lex.text();return this.yyexpect(A.Identifier),this.yyexpect(A.RParen),new te(t);case"length":this.lex.next(),this.yyexpect(A.LParen);const i=this.parseLogicalOr();return this.yyexpect(A.RParen),new ne("length",[i]);default:const n=new H(e);return this.lex.next(),n}}case A.LParen:{this.lex.next();const e=this.parseLogicalOr();return this.yyexpect(A.RParen),e}default:return this.parseLiteral()}}parseLiteral(){switch(this.lex.token()){case A.Number:{const e=new J(parseFloat(this.lex.text()));return this.lex.next(),e}case A.String:{const e=new Q(this.lex.text());return this.lex.next(),e}default:throw new Error("Syntax error")}}parseUnary(){return this.lex.token()===A.Exclaim?(this.lex.next(),new ne("!",[this.parseUnary()])):this.parsePrimary()}parseRelational(){let e=this.parseUnary();for(;;)if(this.lex.token()===A.Identifier&&"in"===this.lex.text()){this.lex.next(),this.yyexpect(A.LBracket);const t=[this.parseLiteral()];for(;this.lex.token()===A.Comma;)this.lex.next(),t.push(this.parseLiteral());this.yyexpect(A.RBracket),e=new ie(e,t.map(e=>e.value))}else{const t=z(this.lex.token());if(void 0===t)break;this.lex.next();const i=this.parseUnary();e=new ne(t,[e,i])}return e}parseEquality(){let e=this.parseRelational();for(;;){const t=I(this.lex.token());if(void 0===t)break;this.lex.next();const i=this.parseRelational();e=new ne(t,[e,i])}return e}parseLogicalAnd(){const e=this.parseEquality();if(this.lex.token()!==A.AmpAmp)return e;const t=[e];do{this.lex.next(),t.push(this.parseEquality())}while(this.lex.token()===A.AmpAmp);return new ne("all",t)}parseLogicalOr(){const e=this.parseLogicalAnd();if(this.lex.token()!==A.BarBar)return e;const t=[e];do{this.lex.next(),t.push(this.parseLogicalAnd())}while(this.lex.token()===A.BarBar);return new ne("any",t)}}var j=i(11),N=i(14),G=i(19);i.d(t,"o",(function(){return W})),i.d(t,"f",(function(){return Z})),i.d(t,"e",(function(){return $})),i.d(t,"n",(function(){return H})),i.d(t,"h",(function(){return K})),i.d(t,"k",(function(){return X})),i.d(t,"l",(function(){return J})),i.d(t,"m",(function(){return Q})),i.d(t,"g",(function(){return te})),i.d(t,"c",(function(){return ie})),i.d(t,"a",(function(){return ne})),i.d(t,"j",(function(){return re})),i.d(t,"b",(function(){return se})),i.d(t,"d",(function(){return G.a})),i.d(t,"i",(function(){return G.b}));const U=new E,B=new class{visitNullLiteralExpr(e,t){return e}visitBooleanLiteralExpr(e,t){return e}visitNumberLiteralExpr(e,t){return e}visitStringLiteralExpr(e,t){return e}visitObjectLiteralExpr(e,t){return e}visitVarExpr(e,t){if(t.preserve&&t.preserve.has(e.name))return e;const i=t.env.lookup(e.name);return K.fromValue(void 0!==i?i:null)}visitHasAttributeExpr(e,t){if(t.preserve&&t.preserve.has(e.name))return e;const i=void 0!==t.env.lookup(e.name);return K.fromValue(i)}visitContainsExpr(e,t){const i=e.value.accept(this,t);if(i instanceof K){const t=e.elements.includes(i.value);return K.fromValue(t)}return i===e.value?e:new ie(i,e.elements)}visitCallExpr(e,t){const i=e.args.map(e=>e.accept(this,t));return i.some((t,i)=>t!==e.args[i])?new ne(e.op,i):e}visitMatchExpr(e,t){const i=e.value.accept(this,t);if(i instanceof K){const n=i.value;for(const[i,r]of e.branches){if(Array.isArray(i)&&i.includes(n))return r.accept(this,t);if(i===n)return r.accept(this,t)}return e.fallback.accept(this,t)}let n=e.value!==i;const r=e.branches.map(([e,i])=>{const r=i.accept(this,t);return r!==i&&(n=!0),[e,r]}),s=e.fallback.accept(this,t);return s!==e.fallback&&(n=!0),n?new re(i,r,s):e}visitCaseExpr(e,t){const i=[];let n=!1;for(const[r,s]of e.branches){const e=r.accept(this,t);if(e instanceof K){if(e.value)return s.accept(this,t)}else e!==r&&(n=!0),i.push([e,s])}if(0===i.length)return e.fallback.accept(this,t);i.length!==e.branches.length&&(n=!0),i.forEach(e=>{const i=e[1].accept(this,t);i!==e[1]&&(n=!0),e[1]=i});const r=e.fallback.accept(this,t);return r!==e.fallback&&(n=!0),n?new se(i,r):e}};class q{constructor(){this.properties=new Set}}class V{static of(e){const t=new q;return e.accept(this.instance,t),t}visitNullLiteralExpr(e,t){}visitBooleanLiteralExpr(e,t){}visitNumberLiteralExpr(e,t){}visitStringLiteralExpr(e,t){}visitObjectLiteralExpr(e,t){}visitVarExpr(e,t){t.properties.add(e.name)}visitHasAttributeExpr(e,t){t.properties.add(e.name)}visitContainsExpr(e,t){e.value.accept(this,t)}visitCallExpr(e,t){"zoom"===e.op&&0===e.args.length?t.zoom=!0:e.args.forEach(e=>e.accept(this,t))}visitMatchExpr(e,t){e.value.accept(this,t),e.branches.forEach(([e,i])=>i.accept(this,t)),e.fallback.accept(this,t)}visitCaseExpr(e,t){e.branches.forEach(([e,i])=>{e.accept(this,t),i.accept(this,t)}),e.fallback.accept(this,t)}}function W(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]}var Z;V.instance=new V,function(e){e[e.Value=0]="Value",e[e.Condition=1]="Condition",e[e.Dynamic=2]="Dynamic"}(Z||(Z={}));class ${static isExpr(e){return e instanceof $}static parse(e){return new k(e).parse()}static fromJSON(e,t,i){return ae(e,void 0!==t?{definitions:t,lockedNames:new Set,cache:i||new Map}:void 0)}evaluate(e,t=Z.Value,i){return this.accept(U,new C(U,e,t,i))}instantiate(e){return this.accept(B,e)}dependencies(){return V.of(this)}intern(e){return e.add(this)}toJSON(){return(new oe).serialize(this)}isDynamic(){return void 0===this.m_isDynamic&&(this.m_isDynamic=this.exprIsDynamic()),this.m_isDynamic}}class H extends ${constructor(e){super(),this.name=e}accept(e,t){return e.visitVarExpr(this,t)}exprIsDynamic(){return!1}}class K extends ${static fromValue(e){switch(typeof e){case"boolean":return new Y(e);case"number":return new J(e);case"string":return new Q(e);case"object":return null===e?X.instance:new ee(e);default:throw new Error(`failed to create a literal from '${e}'`)}}exprIsDynamic(){return!1}}class X extends K{constructor(){super(),this.value=null}accept(e,t){return e.visitNullLiteralExpr(this,t)}exprIsDynamic(){return!1}}X.instance=new X;class Y extends K{constructor(e){super(),this.value=e}accept(e,t){return e.visitBooleanLiteralExpr(this,t)}}class J extends K{constructor(e){super(),this.value=e}accept(e,t){return e.visitNumberLiteralExpr(this,t)}}class Q extends K{constructor(e){super(),this.value=e}accept(e,t){return e.visitStringLiteralExpr(this,t)}}class ee extends K{constructor(e){super(),this.value=e}get isArrayLiteral(){return Array.isArray(this.value)}accept(e,t){return e.visitObjectLiteralExpr(this,t)}}class te extends ${constructor(e){super(),this.name=e}accept(e,t){return e.visitHasAttributeExpr(this,t)}exprIsDynamic(){return!1}}class ie extends ${constructor(e,t){super(),this.value=e,this.elements=t}static isValidElementsArray(e){if(!Array.isArray(e)||0===e.length)return!1;const t=typeof e[0];return("number"===t||"string"===t)&&e.every(e=>typeof e===t)}accept(e,t){return e.visitContainsExpr(this,t)}exprIsDynamic(){return this.value.isDynamic()}}class ne extends ${constructor(e,t){super(),this.op=e,this.args=t}get children(){return this.args}accept(e,t){return e.visitCallExpr(this,t)}exprIsDynamic(){const e=this.descriptor||E.getOperator(this.op);return!!(e&&e.isDynamicOperator&&e.isDynamicOperator(this))||this.args.some(e=>e.isDynamic())}}class re extends ${constructor(e,t,i){super(),this.value=e,this.branches=t,this.fallback=i}static isValidMatchLabel(e){switch(typeof e){case"number":case"string":return!0;case"object":if(!Array.isArray(e)||0===e.length)return!1;const t=typeof e[0];return("number"===t||"string"===t)&&e.every(e=>typeof e===t);default:return!1}}accept(e,t){return e.visitMatchExpr(this,t)}exprIsDynamic(){return this.value.isDynamic()||this.branches.some(([e,t])=>t.isDynamic())||this.fallback.isDynamic()}}class se extends ${constructor(e,t){super(),this.branches=e,this.fallback=t}accept(e,t){return e.visitCaseExpr(this,t)}exprIsDynamic(){return this.branches.some(([e,t])=>e.isDynamic()||t.isDynamic())||this.fallback.isDynamic()}}class oe{serialize(e){return e.accept(this,void 0)}visitNullLiteralExpr(e,t){return null}visitBooleanLiteralExpr(e,t){return e.value}visitNumberLiteralExpr(e,t){return e.value}visitStringLiteralExpr(e,t){return e.value}visitObjectLiteralExpr(e,t){return["literal",e.value]}visitVarExpr(e,t){return["get",e.name]}visitHasAttributeExpr(e,t){return["has",e.name]}visitContainsExpr(e,t){return["in",this.serialize(e.value),e.elements]}visitCallExpr(e,t){return[e.op,...e.args.map(e=>this.serialize(e))]}visitMatchExpr(e,t){const i=[];for(const[t,n]of e.branches)i.push(t,this.serialize(n));return["match",this.serialize(e.value),...i,this.serialize(e.fallback)]}visitCaseExpr(e,t){const i=[];for(const[t,n]of e.branches)i.push(this.serialize(t),this.serialize(n));return["case",...i,this.serialize(e.fallback)]}}function ae(e,t){if(Array.isArray(e))return function e(t,i){const n=t[0];if("string"!=typeof n)throw new Error("expected a builtin function name");switch(n){case"!has":case"!in":return new ne("!",[e([n.slice(1),...t.slice(1)])]);case"ref":return function(e,t){if("string"!=typeof e[1])throw new Error("expected the name of an attribute");if(void 0===t)throw new Error("ref used with no definitions");const i=e[1];if(t.lockedNames.has(i))throw new Error(`circular referene to '${i}'`);if(!(i in t.definitions))throw new Error(`definition '${i}' not found`);const n=t.cache.get(i);if(void 0!==n)return n;let r,s=t.definitions[i];Object(N.c)(s)&&(s=s.value);if(Object(N.d)(s)){if(Object(u.d)(s.value))return $.fromJSON(Object(j.b)(s.value));if(!W(s.value))return $.fromJSON(s.value);s=s.value}if(!W(s))throw new Error(`unsupported definition ${i}`);t.lockedNames.add(i);try{r=ae(s,t)}finally{t.lockedNames.delete(i)}return t.cache.set(i,r),r}(t,i);case"get":return function(e,t){if(void 0!==e[2])return le("get",e,t);const i=e[1];if("string"!=typeof i)throw new Error("expected the name of an attribute");return new H(i)}(t,i);case"has":return function(e,t){if(void 0!==e[2])return le("has",e,t);const i=e[1];if("string"!=typeof i)throw new Error("expected the name of an attribute");return new te(i)}(t,i);case"in":return function(e,t){const i=e[2];if(!ie.isValidElementsArray(i))throw new Error("'in' expects an array of number or string literals");return new ie(ae(e[1],t),i)}(t,i);case"literal":return function(e){const t=e[1];if(null===t||"object"!=typeof t)throw new Error("expected an object or array literal");return new ee(t)}(t);case"match":return function(e,t){if(e.length<4)throw new Error("not enough arguments");if(!(e.length%2))throw new Error("fallback is missing in 'match' expression");const i=ae(e[1],t),n=[];for(let i=2;i<e.length-1;i+=2){const r=e[i];if(!re.isValidMatchLabel(r))throw new Error(`'${JSON.stringify(r)}' is not a valid label for 'match'`);const s=ae(e[i+1],t);n.push([r,s])}const r=ae(e[e.length-1],t);return new re(i,n,r)}(t,i);case"case":return function(e,t){if(e.length<3)throw new Error("not enough arguments");if(e.length%2)throw new Error("fallback is missing in 'case' expression");const i=[];for(let n=1;n<e.length-1;n+=2){const r=ae(e[n],t),s=ae(e[n+1],t);i.push([r,s])}const n=ae(e[e.length-1],t);return new se(i,n)}(t,i);default:return le(n,t,i)}}(e,t);if(null===e)return X.instance;if("boolean"==typeof e)return new Y(e);if("number"==typeof e)return new J(e);if("string"==typeof e)return new Q(e);throw new Error(`failed to create expression from: ${JSON.stringify(e)}`)}function le(e,t,i){return new ne(e,t.slice(1).map(e=>ae(e,i)))}},function(e,t,i){"use strict";var n=i(1);class r{constructor(e,t,i){this.latitude=e,this.longitude=t,this.altitude=i}static fromDegrees(e,t,i){return new r(e,t,i)}static fromRadians(e,t,i){return new r(n.bb.radToDeg(e),n.bb.radToDeg(t),i)}static fromLatLng(e){return new r(e.lat,e.lng)}static fromGeoPoint(e){return new r(e[1],e[0],e[2])}static fromObject(e){if(function(e){if(Array.isArray(e)){const[t,i,n]=e;return"number"==typeof t&&"number"==typeof i&&(void 0===n||"number"==typeof n)}return!1}(e))return r.fromGeoPoint(e);if((t=e)&&"number"==typeof t.latitude&&"number"==typeof t.longitude&&("number"==typeof t.altitude||void 0===t.altitude))return r.fromDegrees(e.latitude,e.longitude,e.altitude);if(function(e){return e&&"number"==typeof e.lat&&"number"==typeof e.lng}(e))return r.fromDegrees(e.lat,e.lng);var t;throw new Error("Invalid input coordinate format.")}get latitudeInRadians(){return n.bb.degToRad(this.latitude)}get longitudeInRadians(){return n.bb.degToRad(this.longitude)}get latitudeInDegrees(){return this.latitude}get longitudeInDegrees(){return this.longitude}get lat(){return this.latitude}get lng(){return this.longitude}isValid(){return!isNaN(this.latitude)&&!isNaN(this.longitude)}normalized(){let{latitude:e,longitude:t}=this;if(isNaN(e)||isNaN(t))return this;if(e>90){let i=(e+90)%360;i>=180&&(t+=180,i=360-i),e=i-90}if(e<-90){let i=(e-90)%360;i<=-180&&(t+=180,i=-360-i),e=i+90}if(t<-180||t>180){const e=Math.sign(t);t=(t%360+180*e)%360-180*e}return e===this.latitude&&t===this.longitude?this:new r(e,t,this.altitude)}equals(e){return this.latitude===e.latitude&&this.longitude===e.longitude&&this.altitude===e.altitude}copy(e){return this.latitude=e.latitude,this.longitude=e.longitude,this.altitude=e.altitude,this}clone(){return new r(this.latitude,this.longitude,this.altitude)}toLatLng(){return{lat:this.latitude,lng:this.longitude}}toGeoPoint(){return void 0!==this.altitude?[this.longitude,this.latitude,this.altitude]:[this.longitude,this.latitude]}}class s{constructor(e,t){this.southWest=e,this.northEast=t}static fromCoordinates(e,t){return new s(e,t)}get minAltitude(){if(void 0!==this.southWest.altitude&&void 0!==this.northEast.altitude)return Math.min(this.southWest.altitude,this.northEast.altitude)}get maxAltitude(){if(void 0!==this.southWest.altitude&&void 0!==this.northEast.altitude)return Math.max(this.southWest.altitude,this.northEast.altitude)}get south(){return this.southWest.latitude}get north(){return this.northEast.latitude}get west(){return this.southWest.longitude}get east(){return this.northEast.longitude}get center(){const e=.5*(this.south+this.north),{west:t,east:i}=this,{minAltitude:n,altitudeSpan:s}=this;let o;if(void 0!==n&&void 0!==s&&(o=n+.5*s),t<i)return new r(e,.5*(t+i),o);let a=.5*(360+i+t);return a>360&&(a-=360),new r(e,a,o)}get latitudeSpanInRadians(){return n.bb.degToRad(this.latitudeSpan)}get longitudeSpanInRadians(){return n.bb.degToRad(this.longitudeSpan)}get latitudeSpan(){return this.north-this.south}get altitudeSpan(){if(void 0!==this.maxAltitude&&void 0!==this.minAltitude)return this.maxAltitude-this.minAltitude}get longitudeSpan(){let e=this.northEast.longitude-this.southWest.longitude;return e<0&&(e+=360),e}get latitudeSpanInDegrees(){return this.latitudeSpan}get longitudeSpanInDegrees(){return this.longitudeSpan}contains(e){if(void 0===e.altitude||void 0===this.minAltitude||void 0===this.maxAltitude)return this.containsHelper(e);const t=this.minAltitude===this.maxAltitude,i=this.minAltitude===e.altitude,n=this.minAltitude<=e.altitude&&this.maxAltitude>e.altitude;return!(t?!i:!n)&&this.containsHelper(e)}clone(){return new s(this.southWest,this.northEast)}growToContain(e){this.southWest.latitude=Math.min(this.southWest.latitude,e.latitude),this.southWest.longitude=Math.min(this.southWest.longitude,e.longitude),this.southWest.altitude=void 0!==this.southWest.altitude&&void 0!==e.altitude?Math.min(this.southWest.altitude,e.altitude):void 0!==this.southWest.altitude?this.southWest.altitude:void 0!==e.altitude?e.altitude:void 0,this.northEast.latitude=Math.max(this.northEast.latitude,e.latitude),this.northEast.longitude=Math.max(this.northEast.longitude,e.longitude),this.northEast.altitude=void 0!==this.northEast.altitude&&void 0!==e.altitude?Math.max(this.northEast.altitude,e.altitude):void 0!==this.northEast.altitude?this.northEast.altitude:void 0!==e.altitude?e.altitude:void 0}containsHelper(e){if(e.latitude<this.southWest.latitude||e.latitude>=this.northEast.latitude)return!1;const{west:t,east:i}=this;return i>t?e.longitude>=t&&e.longitude<i:e.longitude>i||e.longitude<=t}}var o,a,l=i(12);function h(e){const t=e;return void 0!==t.min&&void 0!==t.max}function c(e){const t=e;return void 0!==t.position&&void 0!==t.xAxis&&void 0!==t.yAxis&&void 0!==t.zAxis&&void 0!==t.extents}!function(e){function t(e){return(e%=360)<0&&(e+=360),e}function i(e,i){const n=(e=t(e))-(i=t(i));return n>180?n-360:n<=-180?n+360:n}e.newEmptyBox3=function(){return{min:{x:1/0,y:1/0,z:1/0},max:{x:-1/0,y:-1/0,z:-1/0}}},e.newVector3=function(e,t,i,n){return void 0===n?{x:e,y:t,z:i}:(n.x=e,n.y=t,n.z=i,n)},e.degToRad=n.bb.degToRad,e.radToDeg=n.bb.radToDeg,e.clamp=n.bb.clamp,e.normalizeAngleDeg=t,e.angleDistanceDeg=i,e.interpolateAnglesDeg=function(e,t,n){return(e+i(t,e)*n)%360}}(o||(o={})),function(e){e[e.Planar=0]="Planar",e[e.Spherical=1]="Spherical"}(a||(a={}));class d{constructor(e){this.unitScale=e}localTangentSpace(e,t){return this.projectPoint(e,t.position),o.newVector3(1,0,0,t.xAxis),o.newVector3(0,1,0,t.yAxis),o.newVector3(0,0,1,t.zAxis),t}reprojectPoint(e,t,i){return e===this?void 0===i?{x:t.x,y:t.y,z:t.z}:(i.x=t.x,i.y=t.y,i.z=t.z,i):this.projectPoint(e.unprojectPoint(t),i)}}class m extends d{constructor(){super(...arguments),this.type=a.Planar}getScaleFactor(e){return 1}worldExtent(e,t,i){return i||(i=o.newEmptyBox3()),i.min.x=0,i.min.y=0,i.min.z=e,i.max.x=this.unitScale,i.max.y=this.unitScale/2,i.max.z=t,i}projectPoint(e,t){return void 0===t&&(t={x:0,y:0,z:0}),t.x=(n.bb.degToRad(e.longitude)+Math.PI)*m.geoToWorldScale*this.unitScale,t.y=(n.bb.degToRad(e.latitude)+.5*Math.PI)*m.geoToWorldScale*this.unitScale,t.z=e.altitude||0,t}unprojectPoint(e){return r.fromRadians(e.y*m.worldToGeoScale/this.unitScale-.5*Math.PI,e.x*m.worldToGeoScale/this.unitScale-Math.PI,e.z)}unprojectAltitude(e){return e.z}projectBox(e,t){const i=this.projectPoint(new r(e.center.latitude,e.center.longitude,0)),{latitudeSpanInRadians:n,longitudeSpanInRadians:s,altitudeSpan:a}=e,l=s*m.geoToWorldScale,d=n*m.geoToWorldScale;return t||(t=o.newEmptyBox3()),h(t)?(t.min.x=i.x-.5*l*this.unitScale,t.min.y=i.y-.5*d*this.unitScale,t.max.x=i.x+.5*l*this.unitScale,t.max.y=i.y+.5*d*this.unitScale,void 0!==a?(t.min.z=i.z-.5*a,t.max.z=i.z+.5*a):(t.min.z=0,t.max.z=0)):c(t)&&(o.newVector3(1,0,0,t.xAxis),o.newVector3(0,1,0,t.yAxis),o.newVector3(0,0,1,t.zAxis),t.position.x=i.x,t.position.y=i.y,t.position.z=i.z,t.extents.x=.5*l*this.unitScale,t.extents.y=.5*d*this.unitScale,t.extents.z=Math.max(Number.EPSILON,.5*(a||0))),t}unprojectBox(e){const t=this.unprojectPoint(e.min),i=this.unprojectPoint(e.max);return s.fromCoordinates(t,i)}groundDistance(e){return e.z}scalePointToSurface(e){return e.z=0,e}surfaceNormal(e,t){return void 0===t?t={x:0,y:0,z:1}:(t.x=0,t.y=0,t.z=1),t}}m.geoToWorldScale=1/(2*Math.PI),m.worldToGeoScale=2*Math.PI/1;const u=new m(1),p=new m(l.a.EQUATORIAL_CIRCUMFERENCE);new class extends d{constructor(){super(...arguments),this.type=a.Planar}getScaleFactor(e){return 1}worldExtent(e,t,i){return i||(i=o.newEmptyBox3()),i.min.x=-Math.PI,i.min.y=.5*-Math.PI,i.min.z=e,i.max.x=Math.PI,i.max.y=.5*Math.PI,i.max.z=t,i}projectPoint(e,t){return t||(t={x:0,y:0,z:0}),t.x=n.bb.degToRad(e.longitude),t.y=n.bb.degToRad(e.latitude),t.z=e.altitude||0,t}unprojectPoint(e){return r.fromRadians(e.y,e.x,e.z)}unprojectAltitude(e){return e.z}projectBox(e,t){t||(t=o.newEmptyBox3());const i=this.projectPoint(new r(e.south,e.west,e.minAltitude)),n=this.projectPoint(new r(e.north,e.east,e.maxAltitude));return h(t)?(t.min.x=i.x,t.min.y=i.y,t.min.z=i.z,t.max.x=n.x,t.max.y=n.y,t.max.z=n.z):c(t)&&(o.newVector3(1,0,0,t.xAxis),o.newVector3(0,1,0,t.yAxis),o.newVector3(0,0,1,t.zAxis),t.position.x=.5*(i.x+n.x),t.position.y=.5*(i.y+n.y),t.position.z=.5*(i.z+n.z),t.extents.x=.5*(n.x-i.x),t.extents.y=.5*(n.y-i.y),t.extents.z=Math.max(Number.EPSILON,.5*(n.z-i.z))),t}unprojectBox(e){const t=this.unprojectPoint(e.min),i=this.unprojectPoint(e.max);return s.fromCoordinates(t,i)}groundDistance(e){return e.z}scalePointToSurface(e){return e.z=0,e}surfaceNormal(e,t){return void 0===t?t={x:0,y:0,z:1}:(t.x=0,t.y=0,t.z=1),t}}(1);class f extends d{constructor(){super(...arguments),this.type=a.Planar}static clamp(e,t,i){return Math.min(Math.max(t,e),i)}static latitudeClamp(e){return f.clamp(e,-g.MAXIMUM_LATITUDE,g.MAXIMUM_LATITUDE)}static latitudeProject(e){return Math.log(Math.tan(.25*Math.PI+.5*e))/Math.PI}static latitudeClampProject(e){return f.latitudeProject(f.latitudeClamp(e))}static unprojectLatitude(e){return 2*Math.atan(Math.exp(Math.PI*e))-.5*Math.PI}getScaleFactor(e){return Math.cosh(2*Math.PI*(e.y/this.unitScale-.5))}worldExtent(e,t,i){return i||(i=o.newEmptyBox3()),i.min.x=0,i.min.y=0,i.min.z=e,i.max.x=this.unitScale,i.max.y=this.unitScale,i.max.z=t,i}projectPoint(e,t){let i;return i=e instanceof r?e:new r(e.latitude,e.longitude,e.altitude),t||(t={x:0,y:0,z:0}),t.x=(i.longitude+180)/360*this.unitScale,t.y=(.5*f.latitudeClampProject(i.latitudeInRadians)+.5)*this.unitScale,t.z=i.altitude||0,t}unprojectPoint(e){return r.fromRadians(f.unprojectLatitude(2*(e.y/this.unitScale-.5)),e.x/this.unitScale*2*Math.PI-Math.PI,e.z)}unprojectAltitude(e){return e.z}projectBox(e,t){const i=this.projectPoint(e.center),n=(.5*f.latitudeClampProject(e.northEast.latitudeInRadians)+.5)*this.unitScale,r=(.5*f.latitudeClampProject(e.southWest.latitudeInRadians)+.5)*this.unitScale,s=.5*(n+r);i.y=s;const a=n-r,l=e.longitudeSpan/360*this.unitScale;if(t||(t=o.newEmptyBox3()),h(t)){t.min.x=i.x-.5*l,t.min.y=i.y-.5*a,t.max.x=i.x+.5*l,t.max.y=i.y+.5*a;const n=e.altitudeSpan;void 0!==n?(t.min.z=i.z-.5*n,t.max.z=i.z+.5*n):(t.min.z=0,t.max.z=0)}else{if(!c(t))throw new Error("invalid bounding box");o.newVector3(1,0,0,t.xAxis),o.newVector3(0,1,0,t.yAxis),o.newVector3(0,0,1,t.zAxis),t.position.x=i.x,t.position.y=i.y,t.position.z=i.z,t.extents.x=.5*l,t.extents.y=.5*a,t.extents.z=Math.max(Number.EPSILON,.5*(e.altitudeSpan||0))}return t}unprojectBox(e){const t=this.unprojectPoint(e.min),i=this.unprojectPoint(e.max);return s.fromCoordinates(t,i)}groundDistance(e){return e.z}scalePointToSurface(e){return e.z=0,e}surfaceNormal(e,t){return void 0===t?t={x:0,y:0,z:1}:(t.x=0,t.y=0,t.z=1),t}reprojectPoint(e,t,i){return e===this||e!==_&&e!==v?super.reprojectPoint(e,t,i):(void 0===i&&(i={}),i.x=t.x,i.y=this.unitScale-t.y,i.z=t.z,i)}}class g{}g.MAXIMUM_LATITUDE=1.4844222297453322;const v=new f(l.a.EQUATORIAL_CIRCUMFERENCE),_=new class extends f{projectPoint(e,t){let i;i=e instanceof r?e:new r(e.latitude,e.longitude,e.altitude),t||(t={x:0,y:0,z:0}),t.x=(i.longitude+180)/360*this.unitScale;const n=Math.sin(f.latitudeClamp(i.latitudeInRadians));return t.y=(.5-Math.log((1+n)/(1-n))/(4*Math.PI))*this.unitScale,t.z=i.altitude||0,t}unprojectPoint(e){const t=e.x/this.unitScale-.5,i=.5-e.y/this.unitScale,n=360*t,s=90-360*Math.atan(Math.exp(2*-i*Math.PI))/Math.PI;return new r(s,n,e.z)}projectBox(e,t){const i=super.projectBox(e,t);if(h(i)){const e=i.max.y;i.max.y=this.unitScale-i.min.y,i.min.y=this.unitScale-e}else c(i)&&(o.newVector3(1,0,0,i.xAxis),o.newVector3(0,-1,0,i.yAxis),o.newVector3(0,0,-1,i.zAxis),i.position.y=this.unitScale-i.position.y);return i}unprojectBox(e){const t=this.unprojectPoint(e.min),i=this.unprojectPoint(e.max);return new s(new r(i.latitude,t.longitude,t.altitude),new r(t.latitude,i.longitude,i.altitude))}surfaceNormal(e,t){return void 0===t?t={x:0,y:0,z:-1}:(t.x=0,t.y=0,t.z=-1),t}localTangentSpace(e,t){return this.projectPoint(e,t.position),o.newVector3(1,0,0,t.xAxis),o.newVector3(0,-1,0,t.yAxis),o.newVector3(0,0,-1,t.zAxis),t}}(l.a.EQUATORIAL_CIRCUMFERENCE);class y extends d{constructor(e){super(e),this.unitScale=e,this.type=a.Planar,this.m_phi0=0,this.m_lambda0=0}static clampGeoPoint(e,t){const i=e.latitude,n=e.longitude,s=x.POLE_RADIUS,o=x.POLE_RADIUS_SQ,a=Math.round(n/90),l=90*a-n;if(a%2==0||Math.abs(l)>s)return e;const h=i-0,c=l*l+h*h;if(c<o){const e=Math.sqrt(c),t=(s-e)/e,o=1;return new r(i+h*t,n+(0===l&&0===h?s*o:l)*t)}return e}getScaleFactor(e){return Math.cosh(2*(e.x/this.unitScale-.5)*Math.PI)}worldExtent(e,t,i){return i||(i=o.newEmptyBox3()),i.min.x=0,i.min.y=0,i.min.z=e,i.max.x=this.unitScale,i.max.y=this.unitScale,i.max.z=t,i}projectPoint(e,t){t||(t={x:0,y:0,z:0});const i=y.clampGeoPoint(e,this.unitScale),n=i.longitude/360+.5,r=1===n?0:Math.floor(n),s=o.degToRad(i.latitude),a=o.degToRad(i.longitude-360*r)-this.m_lambda0,l=Math.cos(s)*Math.sin(a);t.x=Math.atanh(l),t.y=Math.atan2(Math.tan(s),Math.cos(a))-this.m_phi0;const h=.5/Math.PI;return t.x=this.unitScale*(o.clamp(t.x*h+.5,0,1)+r),t.y=this.unitScale*o.clamp(t.y*h+.5,0,1),t.z=e.altitude||0,t}unprojectPoint(e){const t=2*Math.PI,i=e.x/this.unitScale,n=e.y/this.unitScale,s=1===i?0:Math.floor(i),o=t*(i-.5-s),a=t*(n-.5),l=e.z||0,h=a+this.m_phi0,c=Math.asin(Math.sin(h)/Math.cosh(o)),d=this.m_lambda0+Math.atan2(Math.sinh(o),Math.cos(h))+s*t;return r.fromRadians(c,d,l)}projectBox(e,t){const{north:i,south:n,east:s,west:a}=e,l=[e.center,e.northEast,e.southWest,new r(n,s),new r(i,a)],d=x.POLE_EDGE_DEG,m=a<90&&s>90,u=a<0&&s>0,p=a<d&&s>-d&&i>0&&n<0;a<-90&&s>-90&&(l.push(new r(i,-90)),l.push(new r(n,-90))),m&&(l.push(new r(i,90)),l.push(new r(n,90))),u&&(l.push(new r(i,0)),l.push(new r(n,0))),p&&(l.push(new r(0,a)),l.push(new r(0,s))),x.alignLatitude(l,l[0]);const f=l.map(e=>this.projectPoint(e)),g=f.map(e=>e.x),v=f.map(e=>e.y),_=f.map(e=>e.z),y=Math.min(...g),b=Math.min(...v),w=Math.min(..._),T=Math.max(...g),S=Math.max(...v),C=Math.max(..._);if(t||(t=o.newEmptyBox3()),h(t))t.min.x=y,t.min.y=b,t.min.z=w,t.max.x=T,t.max.y=S,t.max.z=C;else{if(!c(t))throw new Error("invalid bounding box");o.newVector3(1,0,0,t.xAxis),o.newVector3(0,1,0,t.yAxis),o.newVector3(0,0,1,t.zAxis),t.position.x=(y+T)/2,t.position.y=(b+S)/2,t.position.z=(w+C)/2,t.extents.x=(T-y)/2,t.extents.y=(S-b)/2,t.extents.z=(C-w)/2}return t}unprojectBox(e){const t=this.unitScale,i=e.min,n=e.max,o=[{x:(i.x+n.x)/2,y:(i.y+n.y)/2,z:0},i,n,{x:i.x,y:n.y,z:0},{x:n.x,y:i.y,z:0}],a=.5*t,l=.25*t,h=.75*t,c=i.x<a&&n.x>a,d=i.y<a&&n.y>a,m=i.y<l&&n.y>l,u=i.y<h&&n.y>h;d&&(o.push({x:i.x,y:a,z:0}),o.push({x:n.x,y:a,z:0}),c&&o.push({x:a,y:a,z:0})),m&&(o.push({x:i.x,y:l,z:0}),o.push({x:n.x,y:l,z:0}),c&&o.push({x:a,y:l,z:0})),u&&(o.push({x:i.x,y:h,z:0}),o.push({x:n.x,y:h,z:0}),c&&o.push({x:a,y:h,z:0}));const p=o.map(e=>this.unprojectPoint(e));x.alignLongitude(p,p[0]);const f=p.map(e=>e.latitude),g=p.filter(e=>Math.abs(e.latitude)<90).map(e=>e.longitude),v=p.map(e=>e.altitude||0),_=new r(Math.min(...f),Math.min(...g),Math.min(...v)),y=new r(Math.max(...f),Math.max(...g),Math.max(...v));return s.fromCoordinates(_,y)}unprojectAltitude(e){return e.z}groundDistance(e){return e.z}scalePointToSurface(e){return e.z=0,e}surfaceNormal(e,t){return void 0===t?t={x:0,y:0,z:-1}:(t.x=0,t.y=0,t.z=-1),t}}class x{static alignLatitude(e,t){for(const i of e)0===i.latitude&&(i.latitude=1e-9*t.latitude)}static alignLongitude(e,t){const i=t.longitude<0?180:-180,n=t.longitude<0?-180:180;for(const t of e)t.longitude===i&&(t.longitude=n)}}x.POLE_EDGE=1.4844222297453322,x.POLE_EDGE_DEG=o.radToDeg(x.POLE_EDGE),x.POLE_RADIUS=90-x.POLE_EDGE_DEG,x.POLE_RADIUS_SQ=Math.pow(x.POLE_RADIUS,2);const b=new y(l.a.EQUATORIAL_CIRCUMFERENCE);function w(e){const t=1/Math.PI,i=Math.floor(2*(e*t+1));return n.bb.clamp(i,0,4)}function T(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z)}function S(e,t,i){const r=.5*(i+(e.maxAltitude||0)),s=n.bb.degToRad(e.west),o=n.bb.degToRad(e.east),a=w(s),l=w(o);let h=Math.cos(s),c=h,d=Math.sin(s),m=d;for(let e=a+1;e<=l;e++){const t=(e+1&1)*((2&e)-1);h=Math.min(t,h),c=Math.max(t,c);const i=(1&e)*((2&e)-1);d=Math.min(i,d),m=Math.max(i,m)}const u=Math.cos(o);h=Math.min(u,h),c=Math.max(u,c);const p=Math.sin(o);d=Math.min(p,d),m=Math.max(p,m);const f=(c+h)*r,g=(c-h)*r,v=(m+d)*r,_=(m-d)*r,y=n.bb.degToRad(e.south),x=n.bb.degToRad(e.north),b=Math.sin(x),T=Math.sin(y),S=(b+T)*r,C=(b-T)*r;return t.min.x=f-g,t.min.y=v-_,t.min.z=S-C,t.max.x=f+g,t.max.y=v+_,t.max.z=S+C,t}const C=new class extends d{constructor(){super(...arguments),this.type=a.Spherical}worldExtent(e,t,i=o.newEmptyBox3()){const n=this.unitScale+t;return i.min.x=-n,i.min.y=-n,i.min.z=-n,i.max.x=n,i.max.y=n,i.max.z=n,i}projectPoint(e,t=o.newVector3(0,0,0)){return function(e,t,i){const r=i+(e.altitude||0),s=n.bb.degToRad(e.latitude),o=n.bb.degToRad(e.longitude),a=Math.cos(s);return t.x=r*a*Math.cos(o),t.y=r*a*Math.sin(o),t.z=r*Math.sin(s),t}(e,t,this.unitScale)}unprojectPoint(e){const t=e.x*e.x+e.y*e.y,i=Math.sqrt(t),n=e.z/i;if(isNaN(n))return r.fromRadians(0,0,-this.unitScale);const s=Math.sqrt(t+e.z*e.z);return r.fromRadians(Math.atan(n),Math.atan2(e.y,e.x),s-this.unitScale)}unprojectAltitude(e){const t=e.x*e.x+e.y*e.y+e.z*e.z;return Math.sqrt(t)-l.a.EQUATORIAL_RADIUS}projectBox(e,t=o.newEmptyBox3()){if(h(t))return S(e,t,this.unitScale);if(c(t)){if(e.longitudeSpan>=90){const i=S(e,o.newEmptyBox3(),this.unitScale);return o.newVector3(1,0,0,t.xAxis),o.newVector3(0,1,0,t.yAxis),o.newVector3(0,0,1,t.zAxis),t.position.x=.5*(i.max.x+i.min.x),t.position.y=.5*(i.max.y+i.min.y),t.position.z=.5*(i.max.z+i.min.z),t.extents.x=.5*(i.max.x-i.min.x),t.extents.y=.5*(i.max.y-i.min.y),t.extents.z=.5*(i.max.z-i.min.z),t}const{south:i,west:r,north:s,east:a,center:l}=e,h=l.longitude,c=l.latitude,d=Math.cos(n.bb.degToRad(i)),m=Math.sin(n.bb.degToRad(i)),u=Math.cos(n.bb.degToRad(r)),p=Math.sin(n.bb.degToRad(r)),f=Math.cos(n.bb.degToRad(s)),g=Math.sin(n.bb.degToRad(s)),v=Math.cos(n.bb.degToRad(a)),_=Math.sin(n.bb.degToRad(a)),y=Math.cos(n.bb.degToRad(h)),x=Math.sin(n.bb.degToRad(h)),b=Math.cos(n.bb.degToRad(c)),w=Math.sin(n.bb.degToRad(c));let T,C,E;o.newVector3(y*b,x*b,w,t.zAxis),o.newVector3(-x,y,0,t.xAxis),o.newVector3(-y*w,-x*w,b,t.yAxis),i>=0?(T=Math.abs(d*(y*(p-_)+x*(v-u))),C=b*m-w*d,E=b*g-w*f*(y*v+x*_)):(s<=0?(T=Math.abs(f*(y*(p-_)+x*(v-u))),E=b*g-w*f):(T=Math.abs(y*(p-_)+x*(v-u)),E=b*g-w*f*(x*_+y*v)),C=b*m-w*d*(y*v+x*_));const M=.5*(this.unitScale+(e.maxAltitude||0)),A=.5*(this.unitScale+(e.minAltitude||0)),P=b*(y*v+x*_),L=Math.min(f*P+g*w,d*P+m*w);return o.newVector3(T*M,(E-C)*M,M-L*A,t.extents),o.newVector3(0,(C+E)*M,M+M,t.position),function(e,t,i,n){const r=e.x*n.x+t.x*n.y+i.x*n.z,s=e.y*n.x+t.y*n.y+i.y*n.z,o=e.z*n.x+t.z*n.y+i.z*n.z;n.x=r,n.y=s,n.z=o}(t.xAxis,t.yAxis,t.zAxis,t.position),t.position.x=t.position.x-t.zAxis.x*t.extents.z,t.position.y=t.position.y-t.zAxis.y*t.extents.z,t.position.z=t.position.z-t.zAxis.z*t.extents.z,t}throw new Error("Invalid bounding box")}unprojectBox(e){throw new Error("Method not implemented.")}getScaleFactor(e){return 1}groundDistance(e){return T(e)-this.unitScale}scalePointToSurface(e){const t=this.unitScale/(T(e)||1);return e.x*=t,e.y*=t,e.z*=t,e}surfaceNormal(e,t){void 0===t&&(t={x:0,y:0,z:0});const i=1/(T(e)||1);return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t}reprojectPoint(e,t,i){if(e===v||e===_){const{x:n,y:r,z:s}=t,o=this.unitScale,a=n/o-Math.PI,l=r/o-Math.PI,h=Math.exp(l),c=h*h,d=2*h/(c+1),m=(c-1)/(c+1),u=o+s;return void 0===i&&(i={}),i.x=Math.cos(a)*d*u,i.y=Math.sin(a)*d*u,i.z=m*u,e===_&&(i.z=-i.z),i}return super.reprojectPoint(e,t,i)}localTangentSpace(e,t){const i=n.bb.degToRad(e.latitude),r=n.bb.degToRad(e.longitude),s=Math.cos(r),a=Math.sin(r),l=Math.cos(i),h=Math.sin(i);return o.newVector3(s*l,a*l,h,t.zAxis),o.newVector3(-a,s,0,t.xAxis),o.newVector3(-s*h,-a*h,l,t.yAxis),this.projectPoint(e,t.position),t}}(l.a.EQUATORIAL_RADIUS);class E{constructor(e,t=0,i=0){this.tilingScheme=e,this.minElevation=t,this.maxElevation=i,this.m_tilingScheme=e,this.m_worldBox=e.projection.worldExtent(t,i);const{min:n,max:r}=this.m_worldBox;this.m_worldDimensions={x:r.x-n.x,y:r.y-n.y,z:r.z-n.z}}get projection(){return this.m_tilingScheme.projection}get subdivisionScheme(){return this.m_tilingScheme.subdivisionScheme}getWorldBox(e,t){const i=e.level,n=this.subdivisionScheme.getLevelDimensionX(i),r=this.subdivisionScheme.getLevelDimensionY(i),s=this.m_worldDimensions.x/n,a=this.m_worldDimensions.y/r,l=this.m_worldBox.min.x+s*e.column,h=this.m_worldBox.min.y+a*e.row;return t||(t=o.newEmptyBox3()),t.min.x=l,t.min.y=h,t.min.z=this.m_worldBox.min.z,t.max.x=l+s,t.max.y=h+a,t.max.z=this.m_worldBox.max.z,t}getGeoBox(e){const t=this.getWorldBox(e);return this.projection.unprojectBox(t)}}const M=new class{getSubdivisionX(){return 2}getSubdivisionY(e){return 0===e?1:2}getLevelDimensionX(e){return 1<<e}getLevelDimensionY(e){return 0!==e?1<<e-1:1}};const A=new class{getSubdivisionX(){return 2}getSubdivisionY(){return 2}getLevelDimensionX(e){return 1<<e}getLevelDimensionY(e){return 1<<e}},P=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648,4294967296,8589934592,17179869184,34359738368,68719476736,137438953472,274877906944,549755813888,1099511627776,2199023255552,4398046511104,8796093022208,17592186044416,35184372088832,70368744177664,0x800000000000,281474976710656,562949953421312,0x4000000000000,0x8000000000000,4503599627370496];class L{constructor(e,t,i){this.row=e,this.column=t,this.level=i}static fromRowColumnLevel(e,t,i){return new L(e,t,i)}static fromQuadKey(e){const t=e.length;let i=0,n=0;for(let r=0;r<e.length;++r){const s=1<<r,o=parseInt(e.charAt(t-r-1),10);1&o&&(n|=s),2&o&&(i|=s)}return L.fromRowColumnLevel(i,n,t)}static fromMortonCode(e){let t=0,i=0,n=0,r=e;for(;r>1;){const e=1<<t;1&r&&(n|=e),2&r&&(i|=e),t++,r=(r-(3&r))/4}const s=L.fromRowColumnLevel(i,n,t);return s.m_mortonCode=e,s}static fromHereTile(e){const t=L.fromMortonCode(parseInt(e,10));return t.m_hereTile=e,t}static columnsAtLevel(e){return Math.pow(2,e)}static rowsAtLevel(e){return Math.pow(2,e)}static atCoords(e,t,i,n,r){return L.fromRowColumnLevel(Math.floor(i/(r/L.rowsAtLevel(e))),Math.floor(t/(n/L.columnsAtLevel(e))),e)}static parentMortonCode(e){return Math.floor(e/4)}parent(){if(0===this.level)throw new Error("Cannot get the parent of the root tile key");return L.fromRowColumnLevel(this.row>>>1,this.column>>>1,this.level-1)}changedLevelBy(e){const t=Math.max(0,this.level+e);let i=this.row,n=this.column;return e>=0?(i<<=e,n<<=e):(i>>>=-e,n>>>=-e),L.fromRowColumnLevel(i,n,t)}changedLevelTo(e){return this.changedLevelBy(e-this.level)}mortonCode(){if(void 0===this.m_mortonCode){let e=this.column,t=this.row,i=P[this.level<<1];for(let n=0;n<this.level;++n)1&e&&(i+=P[2*n]),1&t&&(i+=P[2*n+1]),e>>>=1,t>>>=1;this.m_mortonCode=i}return this.m_mortonCode}toHereTile(){return void 0===this.m_hereTile&&(this.m_hereTile=this.mortonCode().toString()),this.m_hereTile}toQuadKey(){let e="";for(let t=this.level;t>0;--t){const i=1<<t-1,n=0!=(this.column&i),r=0!=(this.row&i);e+=n&&r?"3":r?"2":n?"1":"0"}return e}equals(e){return this.row===e.row&&this.column===e.column&&this.level===e.level}addedSubKey(e){const t=L.fromQuadKey(0===e.length?"-":e),i=this.changedLevelBy(t.level);return L.fromRowColumnLevel(i.row+t.row,i.column+t.column,i.level)}addedSubHereTile(e){const t=L.fromHereTile(e),i=this.changedLevelBy(t.level);return L.fromRowColumnLevel(i.row+t.row,i.column+t.column,i.level)}getSubHereTile(e){const t=1<<2*e;return(this.mortonCode()&t-1|t).toString()}rowCount(){return L.rowsAtLevel(this.level)}columnCount(){return L.columnsAtLevel(this.level)}}class R{constructor(e,t,i){this.tileKey=e,this.sizeX=t,this.sizeY=i}[Symbol.iterator](){return 2===this.sizeX&&2===this.sizeY?R.ZCurveIterator(this.tileKey):R.RowColumnIterator(this.tileKey,this.sizeX,this.sizeY)}}var O;(O=R||(R={})).RowColumnIterator=function*(e,t,i){for(let n=0;n<i;n++)for(let r=0;r<t;r++)yield L.fromRowColumnLevel(e.row*i+n,e.column*t+r,e.level+1)},O.ZCurveIterator=function*(e){for(let t=0;t<4;t++)yield L.fromRowColumnLevel(e.row<<1|t>>1,e.column<<1|1&t,e.level+1)};class F{static geoCoordinatesToTileKey(e,t,i){const n=e.projection.projectPoint(t);return this.worldCoordinatesToTileKey(e,n,i)}static worldCoordinatesToTileKey(e,t,i){const n=e.projection,r=e.subdivisionScheme,s=r.getLevelDimensionX(i),o=r.getLevelDimensionY(i),{min:a,max:l}=n.worldExtent(0,0),h=l.x-a.x,c=l.y-a.y;if(t.x<a.x||t.x>l.x)return null;if(t.y<a.y||t.y>l.y)return null;const d=Math.min(s-1,Math.floor(s*(t.x-a.x)/h)),m=Math.min(o-1,Math.floor(o*(t.y-a.y)/c));return L.fromRowColumnLevel(m,d,i)}static geoRectangleToTileKeys(e,t,i){const n=(e,t,i)=>e<t?i-(t-e)%(i-t):t+(e-t)%(i-t),s=(e,t,i)=>Math.min(Math.max(e,t),i),o=n(t.southWest.longitudeInRadians,-Math.PI,Math.PI),a=s(t.southWest.latitudeInRadians,-.5*Math.PI,.5*Math.PI),l=n(t.northEast.longitudeInRadians,-Math.PI,Math.PI),h=s(t.northEast.latitudeInRadians,-.5*Math.PI,.5*Math.PI),c=F.geoCoordinatesToTileKey(e,r.fromRadians(a,o),i),d=F.geoCoordinatesToTileKey(e,r.fromRadians(h,l),i),m=e.subdivisionScheme.getLevelDimensionX(i);if(!c||!d)throw new Error("Invalid coordinates");const u=c.column;let p=d.column;o>l&&(p+=p!==u?m:m-1);const f=Math.min(c.row,d.row),g=Math.max(c.row,d.row),v=new Array;for(let e=f;e<=g;++e)for(let t=u;t<=p;++t)v.push(L.fromRowColumnLevel(e,t%m,i));return v}}class D{constructor(e){this.m_subdivisionScheme=e}subTiles(e){const t=this.m_subdivisionScheme.getSubdivisionX(e.level),i=this.m_subdivisionScheme.getSubdivisionY(e.level);return new R(e,t,i)}}class I{constructor(e,t){this.subdivisionScheme=e,this.projection=t,this.boundingBoxGenerator=new E(this),this.tileTreeTraverse=new D(e)}getSubTileKeys(e){return this.tileTreeTraverse.subTiles(e)}getTileKey(e,t){return F.geoCoordinatesToTileKey(this,e,t)}getTileKeys(e,t){return F.geoRectangleToTileKeys(this,e,t)}getGeoBox(e){return this.boundingBoxGenerator.getGeoBox(e)}getWorldBox(e,t){return this.boundingBoxGenerator.getWorldBox(e,t)}}new I(M,u);const z=new I(A,_),k=(new I(A,v),new I(A,b));class j{constructor(e,t,i){this.position=new n.Zb,this.xAxis=new n.Zb(1,0,0),this.yAxis=new n.Zb(0,1,0),this.zAxis=new n.Zb(0,0,1),this.extents=new n.Zb,void 0!==e&&this.position.copy(e),void 0!==t&&t.extractBasis(this.xAxis,this.yAxis,this.zAxis),void 0!==i&&this.extents.copy(i)}clone(){const e=new j;return e.copy(this),e}copy(e){this.position.copy(e.position),this.xAxis.copy(e.xAxis),this.yAxis.copy(e.yAxis),this.zAxis.copy(e.zAxis),this.extents.copy(e.extents)}getCenter(e=new n.Zb){return e.copy(this.position)}getSize(e=new n.Zb){return e.copy(this.extents).multiplyScalar(2)}getRotationMatrix(e=new n.db){return e.makeBasis(this.xAxis,this.yAxis,this.zAxis)}intersects(e){const t=Array.isArray(e)?e:e.planes;for(const e of t){const t=Math.abs(e.normal.dot(this.xAxis)*this.extents.x)+Math.abs(e.normal.dot(this.yAxis)*this.extents.y)+Math.abs(e.normal.dot(this.zAxis)*this.extents.z);if(e.distanceToPoint(this.position)+t<0)return!1}return!0}contains(e){const t=e.x-this.position.x,i=e.y-this.position.y,n=e.z-this.position.z,r=Math.abs(t*this.xAxis.x+i*this.xAxis.y+n*this.xAxis.z),s=Math.abs(t*this.yAxis.x+i*this.yAxis.y+n*this.yAxis.z),o=Math.abs(t*this.zAxis.x+i*this.zAxis.y+n*this.zAxis.z);return!(r>this.extents.x||s>this.extents.y||o>this.extents.z)}distanceToPoint(e){return Math.sqrt(this.distanceToPointSquared(e))}distanceToPointSquared(e){const t=new n.Zb;t.subVectors(e,this.position);const i=[t.dot(this.xAxis),t.dot(this.yAxis),t.dot(this.zAxis)];let r=0;for(let e=0;e<3;++e){const t=i[e],n=this.extents.getComponent(e);if(t<-n){const e=n+t;r+=e*e}else if(t>n){const e=t-n;r+=e*e}}return r}}i.d(t,"b",(function(){return r})),i.d(t,"a",(function(){return l.a})),i.d(t,"l",(function(){return u})),i.d(t,"j",(function(){return p})),i.d(t,"f",(function(){return a})),i.d(t,"d",(function(){return g})),i.d(t,"k",(function(){return v})),i.d(t,"o",(function(){return _})),i.d(t,"i",(function(){return x})),i.d(t,"n",(function(){return C})),i.d(t,"g",(function(){return L})),i.d(t,"h",(function(){return F})),i.d(t,"p",(function(){return z})),i.d(t,"m",(function(){return k})),i.d(t,"c",(function(){return o})),i.d(t,"e",(function(){return j}))},function(e,t,i){"use strict";var n,r,s;i.d(t,"a",(function(){return n})),i.d(t,"d",(function(){return r})),i.d(t,"e",(function(){return s})),i.d(t,"c",(function(){return o})),i.d(t,"b",(function(){return a})),function(e){e[e.tomTom=0]="tomTom"}(n||(n={})),function(e){let t;!function(e){e[e.Any=0]="Any",e[e.Match=1]="Match",e[e.StartsWith=2]="StartsWith",e[e.Contains=3]="Contains",e[e.EndsWith=4]="EndsWith"}(t=e.StringMatch||(e.StringMatch={})),e.matchString=function(t,i){switch(i.match){case e.StringMatch.Any:return!0;case e.StringMatch.Match:return t===i.value;case e.StringMatch.StartsWith:return i.value.startsWith(t);case e.StringMatch.EndsWith:return i.value.endsWith(t);default:return t.indexOf(i.value)>=0}}}(r||(r={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.POINT=1]="POINT",e[e.LINESTRING=2]="LINESTRING",e[e.POLYGON=3]="POLYGON"}(s||(s={}));const o="omv-tile-decoder",a="omv-tiler"},function(e,t,i){"use strict";var n=i(1),r=i(3),s=i(10),o=i(19);class a extends n.L{constructor(){super(...arguments),this.exponent=2}interpolate_(e,t,i,n){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=e*o,l=a-o,h=Math.pow((i-t)/(n-t),this.exponent),c=1-h;for(let e=0;e!==o;++e)r[e]=s[l+e]*c+s[a+e]*h;return r}}var l=i(4),h=i(11),c=i(8);i.d(t,"d",(function(){return p})),i.d(t,"c",(function(){return f})),i.d(t,"b",(function(){return v})),i.d(t,"a",(function(){return y}));const d=r.d.instance.create("InterpolatedProperty"),m=[n.u,n.V,n.o,a],u=new Array(c.c);function p(e){return!!(e&&void 0===e.interpolationMode&&Array.isArray(e.values)&&e.values.length>0&&void 0!==e.values[0]&&Array.isArray(e.zoomLevels)&&e.zoomLevels.length>0&&void 0!==e.zoomLevels[0]&&e.values.length===e.zoomLevels.length)}function f(e){return void 0!==e&&void 0!==e.interpolationMode&&e.zoomLevels instanceof Float32Array&&void 0!==e.values&&e.values.length>0&&(e.zoomLevels.length===e.values.length/4||e.zoomLevels.length===e.values.length/3||e.zoomLevels.length===e.values.length)}const g=new o.b({$zoom:0,$pixelToMeters:1});function v(e,t,i=1){if(l.e.isExpr(e)){let n;return"number"==typeof t?(g.entries.$zoom=t,g.entries.$pixelToMeters=i,n=g):n=t,e.evaluate(n,l.f.Dynamic)}let o;if("number"==typeof t?o=t:(o=t.lookup("$zoom"),i=t.lookup("$pixelToMeters")),!f(e)){if("string"!=typeof e)return e;{const t=Object(c.g)(e,i);return void 0!==t?t:e}}if(void 0!==e._stringEncodedNumeralType)switch(e._stringEncodedNumeralType){case c.e.Meters:case c.e.Pixels:return _(e,o,i);case c.e.Hex:case c.e.RGB:case c.e.RGBA:case c.e.HSL:return function(e,t){const i=e.values.length/e.zoomLevels.length,o=new m[e.interpolationMode](e.zoomLevels,e.values,i);e.interpolationMode===h.a.Exponential&&void 0!==e.exponent&&(o.exponent=e.exponent);return o.evaluate(t),Object(r.l)(3===i||4===i),4===i?s.a.getHexFromRgba(n.bb.clamp(o.resultBuffer[0],0,1),n.bb.clamp(o.resultBuffer[1],0,1),n.bb.clamp(o.resultBuffer[2],0,1),n.bb.clamp(o.resultBuffer[3],0,1)):s.a.getHexFromRgb(n.bb.clamp(o.resultBuffer[0],0,1),n.bb.clamp(o.resultBuffer[1],0,1),n.bb.clamp(o.resultBuffer[2],0,1))}(e,o)}return _(e,o,i)}function _(e,t,i){const n=e.values.length/e.zoomLevels.length,r=new m[e.interpolationMode](e.zoomLevels,e.values,n);if(e.interpolationMode===h.a.Exponential&&void 0!==e.exponent&&(r.exponent=e.exponent),r.evaluate(t),void 0===e._stringEncodedNumeralDynamicMask)return r.resultBuffer[0];{const n=new m[e.interpolationMode](e.zoomLevels,e._stringEncodedNumeralDynamicMask,1);return e.interpolationMode===h.a.Exponential&&void 0!==e.exponent&&(n.exponent=e.exponent),n.evaluate(t),r.resultBuffer[0]*(1+n.resultBuffer[0]*(i-1))}}function y(e){!function(e){const t="Cubic"===e.interpolation;for(let i=0;i<e.values.length;++i){e.zoomLevels.findIndex(n=>t?Math.abs(n-e.zoomLevels[i])<.001:n===e.zoomLevels[i])!==i&&(e.zoomLevels.splice(--i,1),e.values.splice(--i,1))}}(e);const t=void 0!==e.interpolation?h.a[e.interpolation]:h.a.Discrete,i=new Float32Array(e.zoomLevels),n=e.values[0];switch(typeof n){default:case"number":case"boolean":return{interpolationMode:t,zoomLevels:i,values:new Float32Array(e.values),exponent:e.exponent};case"string":const r=c.d.find(e=>e.regExp.test(n));if(void 0===r)return t===h.a.Discrete?{interpolationMode:t,zoomLevels:i,values:e.values}:void d.error(`No StringEncodedNumeralFormat matched ${n}.`);let s=!1;const o=new Float32Array(e.values.length*r.size),a=new Float32Array(e.values.length);return s=function(e,t,i,n){let r=!1;const s=e.type===c.e.Meters||e.type===c.e.Pixels?c.b:c.a;for(let e=0;e<t.values.length;++e){let o=!1;for(const a of s){const s=t.values[e];if(o=a.decoder(s,u),o){void 0!==a.mask&&(n[e]=a.mask,r=!0);for(let t=0;t<a.size;++t)i[e*a.size+t]=u[t];break}}if(!o)throw Error(`Not all interpolation values match the same format: ${JSON.stringify(t)}`)}return r}(r,e,o,a),{interpolationMode:t,zoomLevels:i,values:o,exponent:e.exponent,_stringEncodedNumeralType:r.type,_stringEncodedNumeralDynamicMask:s?a:void 0}}}},function(e,t,i){"use strict";i.d(t,"e",(function(){return a})),i.d(t,"b",(function(){return p})),i.d(t,"a",(function(){return g})),i.d(t,"d",(function(){return _})),i.d(t,"c",(function(){return y})),i.d(t,"g",(function(){return b})),i.d(t,"f",(function(){return w}));var n=i(3),r=i(1),s=i(10);const o=new r.l;var a;!function(e){e[e.Meters=0]="Meters",e[e.Pixels=1]="Pixels",e[e.Hex=2]="Hex",e[e.RGB=3]="RGB",e[e.RGBA=4]="RGBA",e[e.HSL=5]="HSL"}(a||(a={}));const l={type:a.Meters,size:1,regExp:/^((?=\.\d|\d)(?:\d+)?(?:\.?\d*))m$/,decoder:(e,t)=>{const i=l.regExp.exec(e);return!!i&&void 0!==(t[0]=Number(i[1]))}},h={type:a.Pixels,size:1,mask:1,regExp:/^((?=\.\d|\d)(?:\d+)?(?:\.?\d*))px$/,decoder:(e,t)=>{const i=h.regExp.exec(e);return null!==i&&(t[0]=Number(i[1]),!0)}},c={type:a.Hex,size:4,regExp:/^\#((?:[0-9A-Fa-f][0-9A-Fa-f]){3,4}|[0-9A-Fa-f]{3,4})$/,decoder:(e,t)=>{const i=c.regExp.exec(e);if(null===i)return!1;const r=i[1],s=r.length;return Object(n.l)(3===s||4===s||6===s||8===s,`Matched incorrect hex format: ${e}`),3===s||4===s?(t[0]=parseInt(r.charAt(0)+r.charAt(0),16)/255,t[1]=parseInt(r.charAt(1)+r.charAt(1),16)/255,t[2]=parseInt(r.charAt(2)+r.charAt(2),16)/255,t[3]=4===s?parseInt(r.charAt(3)+r.charAt(3),16)/255:1):6!==s&&8!==s||(t[0]=parseInt(r.charAt(0)+r.charAt(1),16)/255,t[1]=parseInt(r.charAt(2)+r.charAt(3),16)/255,t[2]=parseInt(r.charAt(4)+r.charAt(5),16)/255,t[3]=8===s?parseInt(r.charAt(6)+r.charAt(7),16)/255:1),!0}},d={type:a.RGB,size:3,regExp:/^rgb\( ?(?:([0-9]{1,2}|1[0-9]{1,2}|2[0-4][0-9]|25[0-5]), ?)(?:([0-9]{1,2}|1[0-9]{1,2}|2[0-4][0-9]|25[0-5]), ?)(?:([0-9]{1,2}|1[0-9]{1,2}|2[0-4][0-9]|25[0-5])) ?\)$/,decoder:(e,t)=>{const i=d.regExp.exec(e);return null!==i&&(t[0]=parseInt(i[1],10)/255,t[1]=parseInt(i[2],10)/255,t[2]=parseInt(i[3],10)/255,!0)}},m={type:a.RGBA,size:4,regExp:/^rgba\( ?(?:([0-9]{1,2}|1[0-9]{1,2}|2[0-4][0-9]|25[0-5]), ?)(?:([0-9]{1,2}|1[0-9]{1,2}|2[0-4][0-9]|25[0-5]), ?)(?:([0-9]{1,2}|1[0-9]{1,2}|2[0-4][0-9]|25[0-5]), ?)(?:(0(?:\.[0-9]+)?|1(?:\.0+)?)) ?\)$/,decoder:(e,t)=>{const i=m.regExp.exec(e);return null!==i&&(t[0]=parseInt(i[1],10)/255,t[1]=parseInt(i[2],10)/255,t[2]=parseInt(i[3],10)/255,t[3]=parseInt(i[4],10),!0)}},u={type:a.HSL,size:3,regExp:/^hsl\( ?((?:[0-9]|[1-9][0-9]|1[0-9]{1,2}|2[0-9]{1,2}|3[0-5][0-9]|360)), ?(?:([0-9]|[1-9][0-9]|100)%), ?(?:([0-9]|[1-9][0-9]|100)%) ?\)$/,decoder:(e,t)=>{const i=u.regExp.exec(e);return null!==i&&(o.setHSL(parseInt(i[1],10)/360,parseInt(i[2],10)/100,parseInt(i[3],10)/100),t[0]=o.r,t[1]=o.g,t[2]=o.b,!0)}},p=[l,h],f=p.reduce((e,t)=>Math.max(e,t.size),0),g=[c,d,m,u],v=g.reduce((e,t)=>Math.max(e,t.size),0),_=[...p,...g],y=Math.max(v,f),x=new Array(y);function b(e,t=1){let i;return _.some(n=>{if(n.decoder(e,x)){switch(n.type){case a.Meters:i=x[0];break;case a.Pixels:i=x[0]*t;break;case a.Hex:case a.RGBA:i=s.a.getHexFromRgba(x[0],x[1],x[2],x[3]);case a.RGB:case a.HSL:i=s.a.getHexFromRgb(x[0],x[1],x[2]);break;default:i=x[0]}return!0}return!1}),i}function w(e){const t=(i=e,n=x,g.find(e=>!!e.decoder(i,n)));var i,n;if(void 0!==t)switch(t.type){case a.Hex:case a.RGBA:return s.a.getHexFromRgba(x[0],x[1],x[2],x[3]);case a.RGB:case a.HSL:return s.a.getHexFromRgb(x[0],x[1],x[2]);default:return x[0]}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n=i(3),r=i(4),s=i(7);const o=n.d.instance.create("TechniqueAttr");function a(e,t,i){const n=e instanceof r.d?e:e.env;let a;if(r.e.isExpr(t))try{a=t.evaluate(n,r.f.Dynamic,e instanceof r.d?void 0:e.cachedExprResults)}catch(e){o.error(`failed to evaluate expression '${JSON.stringify(t)}': ${e}`),a=void 0}else if(Object(s.c)(t)){const i=e instanceof r.d?e.lookup("$zoom"):e.zoomLevel;a=Object(s.b)(t,i)}else a=t;return null==a?i:a}},function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var n=i(3),r=i(1);const s=24,o=16,a=8,l=0,h=255,c=16777215,d=4294967295,m=new r.l;var u;!function(e){e.getHexFromRgba=function(e,t,i,r){return Object(n.l)(r>=0&&r<=1),h-Math.floor(r*h)<<s^e*h<<o^t*h<<a^i*h<<l},e.getHexFromRgb=function(e,t,i){return Object(n.l)(e>=0&&e<=1),Object(n.l)(t>=0&&t<=1),Object(n.l)(i>=0&&i<=1),e*h<<o^t*h<<a^i*h<<l},e.getHexFromHsl=function(e,t,i){return Object(n.l)(e>=0&&e<=1),Object(n.l)(t>=0&&t<=1),Object(n.l)(i>=0&&i<=1),m.setHSL(e,t,i).getHex()},e.getRgbaFromHex=function(e){return Object(n.l)(0==(e&~d),"Wrong hex format: #"+e.toString(16)),{r:(e>>o&h)/h,g:(e>>a&h)/h,b:(e>>l&h)/h,a:(h-(e>>s&h))/h}},e.hasAlphaInHex=function(e){return Object(n.l)(0==(e&~d),"Wrong hex format: #"+e.toString(16)),e>>s!=0},e.getAlphaFromHex=function(e){return Object(n.l)(0==(e&~d),"Wrong hex format: #"+e.toString(16)),(h-(e>>s)&h)/h},e.removeAlphaFromHex=function(e){return Object(n.l)(0==(e&~d),"Wrong hex format: #"+e.toString(16)),e&c}}(u||(u={}))},function(e,t,i){"use strict";var n;function r(e){if(void 0===e.interpolation||"Discrete"===e.interpolation){const t=["step",["zoom"],e.values[0]];for(let i=1;i<e.zoomLevels.length;++i)t.push(e.zoomLevels[i],e.values[i]);return t}const t=["interpolate"];switch(e.interpolation){case"Linear":t.push(["linear"]);break;case"Cubic":t.push(["cubic"]);break;case"Exponential":t.push(["exponential",void 0!==e.exponent?e.exponent:2]);break;default:throw new Error(`interpolation mode '${e.interpolation}' is not supported`)}t.push(["zoom"]);for(let i=0;i<e.zoomLevels.length;++i)t.push(e.zoomLevels[i],e.values[i]);return t}i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r})),function(e){e[e.Discrete=0]="Discrete",e[e.Linear=1]="Linear",e[e.Cubic=2]="Cubic",e[e.Exponential=3]="Exponential"}(n||(n={}))},function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));class n{}n.EQUATORIAL_CIRCUMFERENCE=40075016.68557849,n.EQUATORIAL_RADIUS=6378137,n.MIN_ELEVATION=-433,n.MAX_ELEVATION=8848,n.MAX_BUILDING_HEIGHT=828},,function(e,t,i){"use strict";function n(e){const t=e;return"object"==typeof t&&null!==t&&"string"==typeof t.type&&void 0!==t.value}function r(e){const t=e;return"object"==typeof t&&null!==t&&"selector"===t.type&&("string"==typeof t.value||Array.isArray(t.value))}function s(e){return Array.isArray(e)&&2===e.length&&"ref"===e[0]&&"string"==typeof e[1]}function o(e){const t=e;return"object"==typeof t&&null!==t&&!Array.isArray(t)&&"string"==typeof t.technique}i.d(t,"d",(function(){return n})),i.d(t,"c",(function(){return r})),i.d(t,"b",(function(){return s})),i.d(t,"a",(function(){return o}))},function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o})),i.d(t,"u",(function(){return a})),i.d(t,"e",(function(){return b})),i.d(t,"p",(function(){return w})),i.d(t,"l",(function(){return T})),i.d(t,"j",(function(){return S})),i.d(t,"k",(function(){return C})),i.d(t,"o",(function(){return E})),i.d(t,"m",(function(){return M})),i.d(t,"f",(function(){return A})),i.d(t,"h",(function(){return P})),i.d(t,"g",(function(){return L})),i.d(t,"q",(function(){return R})),i.d(t,"r",(function(){return O})),i.d(t,"s",(function(){return F})),i.d(t,"n",(function(){return D})),i.d(t,"i",(function(){return I})),i.d(t,"t",(function(){return z})),i.d(t,"v",(function(){return k})),i.d(t,"c",(function(){return j})),i.d(t,"d",(function(){return N}));var n=i(20),r=i(0);const s=["map","normalMap","displacementMap","roughnessMap","emissiveMap","alphaMap","metalnessMap","bumpMap"],o=["opacity","transparent"],a={},l={attrTransparencyColor:"color",attrScopes:{renderOrder:r.a.TechniqueGeometry,renderOrderOffset:r.a.TechniqueGeometry,enabled:r.a.TechniqueGeometry,kind:r.a.TechniqueGeometry,transient:r.a.TechniqueGeometry,fadeFar:r.a.TechniqueRendering,fadeNear:r.a.TechniqueRendering}},h=Object(r.b)(l,{attrScopes:{texture:r.a.TechniqueGeometry,enablePicking:r.a.TechniqueGeometry,color:r.a.TechniqueRendering,transparent:r.a.TechniqueRendering,opacity:r.a.TechniqueGeometry}}),c=Object(r.b)(l,h);a.squares=c;const d=Object(r.b)(l,h);a.circles=d;const m=Object(r.b)(l,{attrScopes:{text:r.a.FeatureGeometry,label:r.a.FeatureGeometry,useAbbreviation:r.a.FeatureGeometry,useIsoCode:r.a.FeatureGeometry,priority:r.a.TechniqueGeometry,textMinZoomLevel:r.a.TechniqueGeometry,textMaxZoomLevel:r.a.TechniqueGeometry,iconMinZoomLevel:r.a.TechniqueGeometry,iconMaxZoomLevel:r.a.TechniqueGeometry,distanceScale:r.a.TechniqueGeometry,textMayOverlap:r.a.TechniqueGeometry,iconMayOverlap:r.a.TechniqueGeometry,textReserveSpace:r.a.TechniqueGeometry,iconReserveSpace:r.a.TechniqueGeometry,renderTextDuringMovements:r.a.TechniqueGeometry,alwaysOnTop:r.a.TechniqueGeometry,textIsOptional:r.a.TechniqueGeometry,showOnMap:r.a.TechniqueGeometry,stackMode:r.a.TechniqueGeometry,minDistance:r.a.TechniqueGeometry,iconIsOptional:r.a.TechniqueGeometry,iconFadeTime:r.a.TechniqueGeometry,textFadeTime:r.a.TechniqueGeometry,xOffset:r.a.TechniqueGeometry,yOffset:r.a.TechniqueGeometry,iconXOffset:r.a.TechniqueGeometry,iconYOffset:r.a.TechniqueGeometry,iconScale:r.a.TechniqueGeometry,screenHeight:r.a.TechniqueGeometry,screenWidth:r.a.TechniqueGeometry,poiTable:r.a.TechniqueGeometry,poiName:r.a.FeatureGeometry,poiNameField:r.a.TechniqueGeometry,imageTexture:r.a.FeatureGeometry,imageTextureField:r.a.TechniqueGeometry,imageTexturePrefix:r.a.TechniqueGeometry,imageTexturePostfix:r.a.TechniqueGeometry,style:r.a.TechniqueGeometry,fontName:r.a.TechniqueGeometry,fontStyle:r.a.TechniqueGeometry,fontVariant:r.a.TechniqueGeometry,rotation:r.a.TechniqueGeometry,tracking:r.a.TechniqueGeometry,leading:r.a.TechniqueGeometry,maxLines:r.a.TechniqueGeometry,lineWidth:r.a.TechniqueGeometry,canvasRotation:r.a.TechniqueGeometry,lineRotation:r.a.TechniqueGeometry,wrappingMode:r.a.TechniqueGeometry,hAlignment:r.a.TechniqueGeometry,vAlignment:r.a.TechniqueGeometry,backgroundColor:r.a.TechniqueRendering,backgroundSize:r.a.TechniqueRendering,backgroundOpacity:r.a.TechniqueRendering,color:r.a.TechniqueRendering,opacity:r.a.TechniqueRendering,size:r.a.TechniqueRendering}});a["line-marker"]=m,a["labeled-icon"]=m;const u={attrScopes:{polygonOffset:r.a.TechniqueRendering,polygonOffsetFactor:r.a.TechniqueRendering,polygonOffsetUnits:r.a.TechniqueRendering,lineColor:r.a.TechniqueRendering,lineFadeFar:r.a.TechniqueRendering,lineFadeNear:r.a.TechniqueRendering}},p=Object(r.b)(l,u,{attrScopes:{clipping:r.a.TechniqueGeometry,secondaryRenderOrder:r.a.TechniqueGeometry,color:r.a.TechniqueRendering,opacity:r.a.TechniqueRendering,transparent:r.a.TechniqueRendering,lineWidth:r.a.TechniqueRendering,secondaryWidth:r.a.TechniqueRendering,secondaryColor:r.a.TechniqueRendering,dashSize:r.a.TechniqueRendering,gapSize:r.a.TechniqueRendering}});a["solid-line"]=p,a["dashed-line"]=p;const f=Object(r.b)(l,{attrScopes:{color:r.a.TechniqueRendering,opacity:r.a.TechniqueRendering,transparent:r.a.TechniqueRendering,lineWidth:r.a.FeatureGeometry}});a.line=f;const g=Object(r.b)(l,u,{attrScopes:{color:r.a.TechniqueRendering,opacity:r.a.TechniqueRendering,transparent:r.a.TechniqueRendering,lineWidth:r.a.TechniqueRendering}});a.fill=g;const v=Object(r.b)(l,{attrScopes:{color:r.a.FeatureGeometry,vertexColors:r.a.FeatureGeometry,wireframe:r.a.TechniqueRendering,roughness:r.a.TechniqueRendering,metalness:r.a.TechniqueRendering,alphaTest:r.a.TechniqueRendering,depthTest:r.a.TechniqueRendering,transparent:r.a.TechniqueRendering,opacity:r.a.TechniqueRendering,emissive:r.a.TechniqueRendering,emissiveIntensity:r.a.TechniqueRendering,refractionRatio:r.a.TechniqueRendering,map:r.a.TechniqueGeometry,mapProperties:r.a.TechniqueGeometry,normalMap:r.a.TechniqueGeometry,normalMapProperties:r.a.TechniqueGeometry,displacementMap:r.a.TechniqueGeometry,displacementMapProperties:r.a.TechniqueGeometry,roughnessMap:r.a.TechniqueGeometry,roughnessMapProperties:r.a.TechniqueGeometry,emissiveMap:r.a.TechniqueGeometry,emissiveMapProperties:r.a.TechniqueGeometry,bumpMap:r.a.TechniqueGeometry,bumpMapProperties:r.a.TechniqueGeometry,metalnessMap:r.a.TechniqueGeometry,metalnessMapProperties:r.a.TechniqueGeometry,alphaMap:r.a.TechniqueGeometry,alphaMapProperties:r.a.TechniqueGeometry}});a.standard=v;const _=Object(r.b)(l,v,{attrScopes:{height:r.a.FeatureGeometry,floorHeight:r.a.FeatureGeometry,color:r.a.FeatureGeometry,defaultColor:r.a.FeatureGeometry,defaultHeight:r.a.FeatureGeometry,constantHeight:r.a.FeatureGeometry,boundaryWalls:r.a.FeatureGeometry,footprint:r.a.FeatureGeometry,maxSlope:r.a.FeatureGeometry,enableDepthPrePass:r.a.TechniqueGeometry,animateExtrusionDuration:r.a.TechniqueGeometry,animateExtrusion:r.a.TechniqueRendering,opacity:r.a.TechniqueRendering,transparent:r.a.TechniqueRendering,lineWidth:r.a.TechniqueRendering,lineFadeNear:r.a.TechniqueRendering,lineFadeFar:r.a.TechniqueRendering,lineColorMix:r.a.TechniqueGeometry,lineColor:r.a.TechniqueRendering}});a["extruded-polygon"]=_;const y=Object(r.b)(l,{attrScopes:{text:r.a.FeatureGeometry,label:r.a.FeatureGeometry,useAbbreviation:r.a.FeatureGeometry,useIsoCode:r.a.FeatureGeometry,minZoomLevel:r.a.TechniqueGeometry,maxZoomLevel:r.a.TechniqueGeometry,distanceScale:r.a.TechniqueGeometry,mayOverlap:r.a.TechniqueGeometry,reserveSpace:r.a.TechniqueGeometry,textFadeTime:r.a.TechniqueGeometry,xOffset:r.a.TechniqueGeometry,yOffset:r.a.TechniqueGeometry,style:r.a.TechniqueGeometry,fontName:r.a.TechniqueGeometry,fontStyle:r.a.TechniqueGeometry,fontVariant:r.a.TechniqueGeometry,rotation:r.a.TechniqueGeometry,tracking:r.a.TechniqueGeometry,leading:r.a.TechniqueGeometry,maxLines:r.a.TechniqueGeometry,lineWidth:r.a.TechniqueGeometry,canvasRotation:r.a.TechniqueGeometry,lineRotation:r.a.TechniqueGeometry,wrappingMode:r.a.TechniqueGeometry,hAlignment:r.a.TechniqueGeometry,vAlignment:r.a.TechniqueGeometry,backgroundColor:r.a.TechniqueRendering,backgroundSize:r.a.TechniqueRendering,backgroundOpacity:r.a.TechniqueRendering,color:r.a.TechniqueRendering,opacity:r.a.TechniqueRendering,priority:r.a.TechniqueRendering,size:r.a.TechniqueRendering}});a.text=y;const x=Object(r.b)(l,{attrScopes:{primitive:r.a.TechniqueGeometry,params:r.a.TechniqueRendering}});function b(e){return"circles"===e.name}function w(e){return"squares"===e.name}function T(e){return"labeled-icon"===e.name}function S(e){return"line-marker"===e.name}function C(e){return"line"===e.name}function E(e){return"solid-line"===e.name||"dashed-line"===e.name}function M(e){return"segments"===e.name}function A(e){return"extruded-line"===e.name}function P(e){return"fill"===e.name}function L(e){return"extruded-polygon"===e.name}function R(e){return"standard"===e.name}function O(e){return"terrain"===e.name}function F(e){return"text"===e.name}function D(e){return"shader"===e.name}function I(e){return"label-rejection-line"===e.name}function z(e){return P(e)||R(e)||O(e)||function(e){return A(e)&&"standard"===e.shading}(e)}function k(e){return R(e)?e.textureCoordinateType:L(e)?e.textureCoordinateType:O(e)?e.textureCoordinateType:void 0}function j(e,t){if(R(e)||L(e)||O(e))for(const i of s){const r=e[i];Object(n.e)(r)&&r.buffer instanceof ArrayBuffer&&t.push(r.buffer)}}function N(e,t){let i=e;return"string"==typeof t.imageTexturePrefix&&(i=t.imageTexturePrefix+i),"string"==typeof t.imageTexturePostfix&&(i+=t.imageTexturePostfix),i}a.shader=x},,function(e,t,i){"use strict";i.d(t,"b",(function(){return s})),i.d(t,"a",(function(){return o})),i.d(t,"c",(function(){return a}));var n=i(2),r=i(6);class s{constructor(e){this.description=e,this.description.kindsToProcess.length>0&&(this.enabledKinds=new n.g(this.description.kindsToProcess)),this.description.kindsToIgnore.length>0&&(this.disabledKinds=new n.g(this.description.kindsToIgnore))}static matchLayer(e,t,i){for(const n of t)if(!(i<n.minLevel||i>n.maxLevel)&&r.d.matchString(e,n.name))return!0;return!1}wantsLayer(e,t){return!!s.matchLayer(e,this.description.layersToProcess,t)||!s.matchLayer(e,this.description.layersToIgnore,t)&&this.description.processLayersDefault}wantsPointFeature(e,t,i){return this.wantsFeature(this.description.pointsToProcess,this.description.pointsToIgnore,e,t,i,this.description.processPointsDefault)}wantsLineFeature(e,t,i){return this.wantsFeature(this.description.linesToProcess,this.description.linesToIgnore,e,t,i,this.description.processLinesDefault)}wantsPolygonFeature(e,t,i){return this.wantsFeature(this.description.polygonsToProcess,this.description.polygonsToIgnore,e,t,i,this.description.processPolygonsDefault)}wantsKind(e){return void 0===e||(!(void 0!==this.disabledKinds&&this.disabledKinds.hasOrIntersects(e))||void 0!==this.enabledKinds&&this.enabledKinds.hasOrIntersects(e))}get hasKindFilter(){return void 0!==this.enabledKinds||void 0!==this.disabledKinds}wantsFeature(e,t,i,n,s,o){for(const t of e)if(!(s<t.minLevel||s>t.maxLevel)&&r.d.matchString(i,t.layerName)&&void 0!==t.geometryTypes&&t.geometryTypes.indexOf(n)>=0)return!0;for(const e of t)if(r.d.matchString(i,e.layerName)&&void 0!==e.geometryTypes&&e.geometryTypes.indexOf(n)>=0)return!1;return o}}class o{constructor(e){this.filters=e}get hasKindFilter(){return this.filters.reduce((e,t)=>e&&t.hasKindFilter,!0)}wantsLayer(e,t){return this.filters.reduce((i,n)=>i&&n.wantsLayer(e,t),!0)}wantsPointFeature(e,t,i){return this.filters.reduce((n,r)=>n&&r.wantsPointFeature(e,t,i),!0)}wantsLineFeature(e,t,i){return this.filters.reduce((n,r)=>n&&r.wantsLineFeature(e,t,i),!0)}wantsPolygonFeature(e,t,i){return this.filters.reduce((n,r)=>n&&r.wantsPolygonFeature(e,t,i),!0)}wantsKind(e){return this.filters.reduce((t,i)=>t&&i.wantsKind(e),!0)}}class a{constructor(e){this.description=e}static matchItems(e,t,i){for(const n of i)if(void 0!==n.classes){if(!r.d.matchString(e,n.layerName))continue;for(const e of n.classes)if(r.d.matchString(t,e))return!0}return!1}static matchAttribute(e,t,i){for(const n of i)if(void 0!==n.featureAttribute&&r.d.matchString(e,n.layerName)&&t.lookup(n.featureAttribute.key)===n.featureAttribute.value)return!0;return!1}doProcessPointFeature(e,t){return this.doProcessFeature(this.description.pointsToProcess,this.description.pointsToIgnore,e,t,this.description.processPointsDefault)}doProcessLineFeature(e,t){return this.doProcessFeature(this.description.linesToProcess,this.description.linesToIgnore,e,t,this.description.processLinesDefault)}doProcessPolygonFeature(e,t){return this.doProcessFeature(this.description.polygonsToProcess,this.description.polygonsToIgnore,e,t,this.description.processPolygonsDefault)}doProcessFeature(e,t,i,n,r){if(void 0===i||0===e.length&&0===t.length)return r;let s;const o=n.lookup("class");return null!=o&&(s=o.toString()),!(!s||!a.matchItems(i,s,e))||(!s||!a.matchItems(i,s,t))&&(!!a.matchAttribute(i,n,e)||!a.matchAttribute(i,n,t)&&r)}}},function(e,t,i){"use strict";var n=i(22);var r=i(1);new r.Yb,new r.Yb,new r.Yb,new r.Yb;var s,o=i(4),a=i(21);!function(e){function t(e){if(e instanceof Int8Array)return"int8";if(e instanceof Uint8Array)return"uint8";if(e instanceof Int16Array)return"int16";if(e instanceof Uint16Array)return"uint16";if(e instanceof Int32Array)return"int32";if(e instanceof Uint32Array)return"uint32";if(e instanceof Float32Array)return"float";throw new Error(`Unsupported buffer type ${name}`)}function i(e){const i=e.array;return{name:e.name,buffer:i.buffer,type:t(i),itemCount:e.itemSize,normalized:e.normalized}}e.getBufferElementType=t,e.fromThreeBufferAttribute=i,e.fromThreeInterleavedBufferAttribute=function(e){throw new Error("Not implemented yet")},e.fromThreeBufferGeometry=function(e,t){const n=[],r=Object.getOwnPropertyNames(e.attributes);for(const t of r){const r=i(e.attributes[t]);r.name=t,n.push(r)}const s=null!==e.index?i(e.index):void 0;let o=0;if(void 0!==s)o=null===e.index?0:e.index.count;else{const t=e.attributes.position;if(void 0===t)throw new Error("Missing position attibute to deduce item count");o=t.count}return{type:a.a.Unspecified,vertexAttributes:n,index:s,groups:[{start:0,count:o,technique:t}]}}}(s||(s={})),i.d(t,"b",(function(){return n.a})),i.d(t,"a",(function(){return o.i}))},function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r}));class n{lookup(e){}unmap(){return{}}}class r extends n{constructor(e,t){super(),this.entries=e,this.parent=t}lookup(e){if(this.entries.hasOwnProperty(e)){const t=this.entries[e];if(void 0!==t)return t}return this.parent?this.parent.lookup(e):void 0}unmap(){const e=this.parent?this.parent.unmap():{};for(const t in this.entries)this.entries.hasOwnProperty(t)&&(e[t]=this.entries[t]);return e}}},function(e,t,i){"use strict";var n,r,s;i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o})),i.d(t,"d",(function(){return r})),i.d(t,"c",(function(){return s})),i.d(t,"e",(function(){return a})),function(e){e.All="_all_",e.Background="background",e.Terrain="terrain",e.Area="area",e.Line="line",e.Water="water",e.Border="border",e.Road="road",e.Building="building",e.Label="label",e.Detail="detail"}(n||(n={}));class o extends Set{isSuperset(e){for(const t of e)if(!this.has(t))return!1;return!0}hasIntersection(e){for(const t of e)if(this.has(t))return!0;return!1}hasOrIntersects(e){return e instanceof Set?this.hasIntersection(e):this.has(e)}hasOrIntersectsArray(e){for(const t of e)if(this.has(t))return!0;return!1}}function a(e){return e&&e.buffer&&"string"==typeof e.type}!function(e){e.TileSpace="tile-space",e.EquirectangularSpace="equirectangular-space"}(r||(r={})),function(e){e.Show="show-in-stack",e.Hide="hide-in-stack",e.ShowParent="show-parent"}(s||(s={}))},function(e,t,i){"use strict";i.d(t,"b",(function(){return s})),i.d(t,"a",(function(){return n})),i.d(t,"d",(function(){return o})),i.d(t,"e",(function(){return a})),i.d(t,"c",(function(){return l}));var n,r=i(5);function s(e){switch(e){case"float":return Float32Array;case"uint8":return Uint8Array;case"uint16":return Uint16Array;case"uint32":return Uint32Array;case"int8":return Int8Array;case"int16":return Int16Array;case"int32":return Int32Array}}function o(e){switch(e){case"mercator":return r.k;case"webMercator":return r.o;case"sphere":return r.n;case"normalizedEquirectangular":return r.l;case"equirectangular":return r.j;default:throw new Error(`Unknown projection ${e}`)}}function a(e){if(e===r.k)return"mercator";if(e===r.o)return"webMercator";if(e===r.n)return"sphere";if(e===r.l)return"normalizedEquirectangular";if(e===r.j)return"equirectangular";throw new Error("Unknown projection")}function l(e){return void 0===e?0:"number"==typeof e?e:e.hasOwnProperty("$id")?e.$id:0}!function(e){e[e.Unspecified=0]="Unspecified",e[e.Point=1]="Point",e[e.Line=2]="Line",e[e.SolidLine=3]="SolidLine",e[e.Text=4]="Text",e[e.TextPath=5]="TextPath",e[e.ExtrudedLine=6]="ExtrudedLine",e[e.Polygon=7]="Polygon",e[e.ExtrudedPolygon=8]="ExtrudedPolygon",e[e.Object3D=9]="Object3D",e[e.Other=1e3]="Other"}(n||(n={}))},function(e,t,i){"use strict";var n=i(3),r=i(4);class s{constructor(){this.m_booleanLiterals=new Map,this.m_numberLiterals=new Map,this.m_stringLiterals=new Map,this.m_objectLiterals=new Map,this.m_varExprs=new Map,this.m_hasAttributeExprs=new Map,this.m_inExprs=new Map,this.m_callExprs=new Map}add(e){return e.accept(this,void 0)}visitNullLiteralExpr(e,t){return r.k.instance}visitBooleanLiteralExpr(e,t){const i=this.m_booleanLiterals.get(e.value);return i||(this.m_booleanLiterals.set(e.value,e),e)}visitNumberLiteralExpr(e,t){const i=this.m_numberLiterals.get(e.value);return i||(this.m_numberLiterals.set(e.value,e),e)}visitStringLiteralExpr(e,t){const i=this.m_stringLiterals.get(e.value);return i||(this.m_stringLiterals.set(e.value,e),e)}visitObjectLiteralExpr(e,t){const i=this.m_objectLiterals.get(e.value);return i||(this.m_objectLiterals.set(e.value,e),e)}visitVarExpr(e,t){const i=this.m_varExprs.get(e.name);return i||(this.m_varExprs.set(e.name,e),e)}visitHasAttributeExpr(e,t){const i=this.m_hasAttributeExprs.get(e.name);return i||(this.m_hasAttributeExprs.set(e.name,e),e)}visitContainsExpr(e,t){const i=e.value.accept(this,t);this.m_inExprs.has(i)||this.m_inExprs.set(i,[]);const n=this.m_inExprs.get(i);for(const t of n){if(t.elements.length!==e.elements.length)continue;if(-1===t.elements.findIndex(t=>!e.elements.includes(t)))return t}const s=new r.c(i,e.elements);return this.m_inExprs.set(i,[s]),s}visitMatchExpr(e,t){const i=e.value.accept(this,t),n=e.branches.map(([e,i])=>[e,i.accept(this,t)]),s=e.fallback.accept(this,t);return new r.j(i,n,s)}visitCaseExpr(e,t){const i=e.branches.map(([e,i])=>[e.accept(this,t),i.accept(this,t)]),n=e.fallback.accept(this,t);return new r.b(i,n)}visitCallExpr(e,t){const i=e.args.map(e=>e.accept(this,t));this.m_callExprs.has(e.op)||this.m_callExprs.set(e.op,[]);const n=this.m_callExprs.get(e.op);for(const e of n){if(e.args.length!==i.length)continue;let t=0;for(;t<e.args.length&&e.args[t]===i[t];++t);if(t===e.args.length)return e}const s=new r.a(e.op,i);return n.push(s),s}}var o=i(7),a=i(11),l=i(0),h=i(15),c=i(14);i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return g}));const d=n.d.instance.create("StyleSetEvaluator"),m=Object(l.b)({});class u{classify(e){if(e._whenExpr){const t=this.switchStyle(e);e._whenExpr=e._whenExpr.accept(this,void 0),this._style=t}}visitNullLiteralExpr(e,t){return e}visitBooleanLiteralExpr(e,t){return e}visitNumberLiteralExpr(e,t){return e}visitStringLiteralExpr(e,t){return e}visitObjectLiteralExpr(e,t){return e}visitVarExpr(e,t){return e}visitHasAttributeExpr(e,t){return e}visitContainsExpr(e,t){return e}visitMatchExpr(e,t){return e}visitCaseExpr(e,t){return e}visitCallExpr(e,t){if("all"===e.op){const t=e.args.map(t=>t.accept(this,e)).filter(e=>void 0!==e);return new r.a(e.op,t)}if(t){const t=this.matchVarStringComparison(e);if(t){if(void 0===this._style.layer&&"$layer"===t.name)return void(this._style.layer=t.value);if(void 0===this._style._geometryType&&"$geometryType"===t.name)return void(this._style._geometryType=t.value)}}return e}matchVarStringComparison(e){if("=="===e.op){const t=e.args[0],i=e.args[1];if(t instanceof r.n&&i instanceof r.m)return{name:t.name,value:i.value};if(i instanceof r.n&&t instanceof r.m)return{name:i.name,value:t.value}}}switchStyle(e){const t=this._style;return this._style=e,t}}class p{constructor(e,t){this.key="",this.set(e,t)}set(e,t,i){let n=!1;if(void 0===e){const t=void 0!==i?i.lookup("$layer"):void 0;e="string"==typeof t?t:void 0}if(this.layer!==e&&(this.layer=e,n=!0),void 0===t){const e=void 0!==i?i.lookup("$geometryType"):void 0;t="string"==typeof e?e:void 0}return this.geometryType!==t&&(this.geometryType=t,n=!0),n&&this.updateKey(),this}updateKey(){void 0!==this.layer?void 0!==this.geometryType?this.key=`${this.layer}:${this.geometryType}`:this.key=`${this.layer}:`:void 0!==this.geometryType?this.key=`:${this.geometryType}`:this.key="all",this.cachedStyleSet=void 0}}class f{constructor(e,t){this.m_techniques=[],this.m_exprPool=new s,this.m_cachedResults=new Map,this.m_styleConditionClassifier=new u,this.m_subStyleSetCache=new Map,this.m_definitionExprCache=new Map,this.m_tmpOptimizedSubSetKey=new p,this.m_emptyEnv=new r.d,this.m_definitions=t,this.styleSet=function(e,t){return e.map(e=>(function e(t,i){if(Object(r.o)(t)){if(!Object(c.b)(t))throw new Error("invalid expression in this context, only 'ref's are supported");const n=t[1],r=i&&i[n];if(!r)throw new Error(`invalid reference '${n}' - not found`);if(!Object(c.a)(r))throw new Error(`invalid reference '${n}' - expected style definition`);return e(r,i)}return{...t}})(e,t))}(e,t),function(e){let t=0,i=0;for(const n of e)n._styleSetIndex=i++,void 0!==n.technique&&void 0===n.renderOrder&&(n.renderOrder=t++)}(this.styleSet),this.compileStyleSet()}getMatchingTechniques(e,t,i){const n=[];this.m_cachedResults.clear();const r=this.m_tmpOptimizedSubSetKey;r.set(t,i,e),this.m_layer=r.layer,this.m_geometryType=r.geometryType,this.m_zoomLevel=e.lookup("$zoom");const s=this.getOptimizedStyleSet(r);for(const t of s)if(this.processStyle(e,t,n))break;return n}wantsLayer(e){return this.getOptimizedStyleSet(this.m_tmpOptimizedSubSetKey.set(e,void 0)).length>0}wantsFeature(e,t){return this.getOptimizedStyleSet(this.m_tmpOptimizedSubSetKey.set(e,t)).length>0}get expressionEvaluatorCache(){return this.m_cachedResults}resetTechniques(){for(const e of this.m_techniques)e._index=void 0;this.m_techniques.length=0}get techniques(){return this.m_techniques}get decodedTechniques(){return this.m_techniques.map(g)}getOptimizedStyleSet(e){if(void 0!==e.cachedStyleSet)return e.cachedStyleSet;let t=this.m_subStyleSetCache.get(e.key);return void 0!==t?(e.cachedStyleSet=t,t):(t=this.createPreFilteredStyleSet(e),this.m_subStyleSetCache.set(e.key,t),e.cachedStyleSet=t,t)}createPreFilteredStyleSet(e){const{layer:t,geometryType:i}=e;return this.styleSet.filter(e=>(void 0===t||void 0===e.layer||e.layer===t)&&(void 0===i||void 0===e._geometryType||e._geometryType===i))}compileStyleSet(){this.styleSet.forEach(e=>this.compileStyle(e)),this.styleSet.forEach(e=>{this.getOptimizedStyleSet(this.m_tmpOptimizedSubSetKey.set(e.layer,e._geometryType))})}compileStyle(e){if(void 0!==e.when)try{e._whenExpr=Array.isArray(e.when)?r.e.fromJSON(e.when,this.m_definitions,this.m_definitionExprCache):r.e.parse(e.when),this.m_styleConditionClassifier.classify(e),void 0!==e._whenExpr&&(e._whenExpr=e._whenExpr.intern(this.m_exprPool)),Object(r.o)(e.minZoomLevel)&&(e._minZoomLevelExpr=r.e.fromJSON(e.minZoomLevel).intern(this.m_exprPool)),Object(r.o)(e.maxZoomLevel)&&(e._maxZoomLevelExpr=r.e.fromJSON(e.maxZoomLevel).intern(this.m_exprPool))}catch(t){d.log("failed to evaluate expression",JSON.stringify(e.when),"error",String(t))}}processStyle(e,t,i){if(!this.checkZoomLevel(e,t))return!1;if(void 0!==this.m_layer&&void 0!==t.layer&&t.layer!==this.m_layer)return!1;if(void 0!==this.m_geometryType&&void 0!==t._geometryType&&t._geometryType!==this.m_geometryType)return!1;if(t._whenExpr)try{if(!t._whenExpr.evaluate(e,r.f.Condition,this.m_cachedResults))return!1}catch(e){return d.error(`failed to evaluate expression '${JSON.stringify(t.when)}': ${e}`),!1}return void 0!==t.technique&&("none"!==t.technique&&i.push(this.getTechniqueForStyleMatch(e,t)),!0===t.final)}checkZoomLevel(e,t){if(void 0===t.minZoomLevel&&void 0===t.maxZoomLevel)return!0;const i=this.m_zoomLevel;if(void 0===i)return!0;if(void 0!==t.minZoomLevel){let n=t.minZoomLevel;if(t._minZoomLevelExpr)try{n=t._minZoomLevelExpr.evaluate(e,r.f.Condition,this.m_cachedResults)}catch(e){d.error(`failed to evaluate expression '${JSON.stringify(t._minZoomLevelExpr)}': ${e}`)}if("number"==typeof n&&i<n)return!1}if(void 0!==t.maxZoomLevel){let n=t.maxZoomLevel;if(t._maxZoomLevelExpr)try{n=t._maxZoomLevelExpr.evaluate(e,r.f.Condition,this.m_cachedResults)}catch(e){d.error(`failed to evaluate expression '${JSON.stringify(t._maxZoomLevelExpr)}': ${e}`)}if("number"==typeof n&&i>n)return!1}return!0}getTechniqueForStyleMatch(e,t){let i;if(this.checkStyleDynamicAttributes(t),void 0!==t._dynamicTechniques){const n=this.evaluateTechniqueProperties(t,e),r=this.getDynamicTechniqueKey(t,n);i=t._dynamicTechniques.get(r),void 0===i&&(i=this.createTechnique(t,r,n),t._dynamicTechniques.set(r,i))}else i=t._staticTechnique,void 0===i&&(t._staticTechnique=i=this.createTechnique(t,`${t._styleSetIndex}`,[]));return void 0===i._index&&(i._index=this.m_techniques.length,this.m_techniques.push(i)),i}getDynamicTechniqueKey(e,t){const i=t.map(([e,t])=>void 0===t?"U":JSON.stringify(t)).join(":");return`${e._styleSetIndex}:${i}`}checkStyleDynamicAttributes(e){if(void 0!==e._dynamicTechniqueAttributes||"none"===e.technique)return;e._dynamicTechniqueAttributes=[],e._dynamicFeatureAttributes=[],e._dynamicForwardedAttributes=[],e._staticAttributes=[];const t=e._dynamicFeatureAttributes,i=e._dynamicTechniqueAttributes,n=e._dynamicForwardedAttributes,s=e._staticAttributes,c=h.u[e.technique]||m,d=(e,h)=>{if(void 0!==h){if(Object(r.o)(h)?h=r.e.fromJSON(h,this.m_definitions,this.m_definitionExprCache).intern(this.m_exprPool):Object(o.d)(h)&&(h=r.e.fromJSON(Object(a.b)(h)).intern(this.m_exprPool)),r.e.isExpr(h)){const e=h.dependencies();e.zoom||0!==e.properties.size||(h=h.evaluate(this.m_emptyEnv))}if(r.e.isExpr(h)){let r=c.attrScopes[e];void 0===r&&(r=l.a.TechniqueGeometry);const s=h.dependencies();switch(r){case l.a.FeatureGeometry:t.push([e,h]);break;case l.a.TechniqueGeometry:i.push([e,h]);break;case l.a.TechniqueRendering:0===s.properties.size?n.push([e,h]):i.push([e,h])}}else null!=h&&s.push([e,h])}};if(d("renderOrder",e.renderOrder),d("label",e.labelProperty),d("secondaryRenderOrder",e.secondaryRenderOrder),void 0!==e.attr)for(const t in e.attr)e.attr.hasOwnProperty(t)&&d(t,e.attr[t]);i.length>0&&(e._dynamicTechniques=new Map)}evaluateTechniqueProperties(e,t){if(void 0===e._dynamicTechniqueAttributes)return[];const i={env:t};return e._dynamicTechniqueAttributes.map(([e,n])=>{try{if(n.isDynamic()){return[e,n.instantiate(i)]}return[e,n.evaluate(t,r.f.Value,this.m_cachedResults)]}catch(t){return d.error(`failed to evaluate expression '${n.toJSON()}': ${t}`),[e,null]}})}createTechnique(e,t,i){const n={};if(n.name=e.technique,void 0!==e._staticAttributes)for(const[t,i]of e._staticAttributes)null!==i&&(n[t]=i);for(const[e,t]of i)null!==t&&(n[e]=t);if(void 0!==e._dynamicFeatureAttributes)for(const[t,i]of e._dynamicFeatureAttributes)n[t]=i;if(void 0!==e._dynamicForwardedAttributes)for(const[t,i]of e._dynamicForwardedAttributes)r.e.isExpr(i)?n[t]=i.toJSON():n[t]=i;return n._index=this.m_techniques.length,n._styleSetIndex=e._styleSetIndex,n._key=t,this.m_techniques.push(n),n}}function g(e){const t={};for(const i in e){if(!e.hasOwnProperty(i))continue;let n=e[i];r.e.isExpr(n)&&(n=n.toJSON()),t[i]=n}return t}},,function(e,t,i){"use strict";var n;i.d(t,"a",(function(){return n})),function(e){e.DEFAULT_RATIO_MIN=0,e.DEFAULT_RATIO_MAX=1,e.MIN_BUILDING_HEIGHT=.01}(n||(n={}))},function(e,t,i){"use strict";i.d(t,"b",(function(){return c})),i.d(t,"a",(function(){return d}));var n=i(1);const r=new n.Zb(0,0,1),s=[0,1,2,1,3,2],o=[0,1,3,3,1,2,0,3,4,5,4,3],a=8,l=Math.PI/a;function h(e,t,i,n,r,s){const o=r.length/3;r.push(e,t,0);for(let h=0;h<a+1;++h){const c=l*h+Math.PI/2+i;r.push(e+n*Math.cos(c),t+n*Math.sin(c),0),s.push(o,o+h+1,o+(h+1)%(a+1)+1)}}function c(e,t,i,a,l=!0,c=l){if(e.length<3)return;const d=new n.Yb;if(l){const n=3!==e.length?d.set(e[3]-e[0],e[4]-e[1]).angle():0;h(e[0],e[1],n,t,i,a)}const m=i.length/3,u=new n.Zb,p=new n.Zb,f=new n.Zb,g=new n.Zb,v=new n.Zb,_=new n.Zb,y=new n.Zb,x=new n.Zb,b=new n.Zb,w=e.length/3;let T=0;for(let n=0;n<w;++n){let l=!1;if(p.set(e[3*n],e[3*n+1],e[3*n+2]),n+1<w){if(f.set(e[3*(n+1)],e[3*(n+1)+1],e[3*(n+1)+2]),g.copy(f).sub(p).normalize().cross(r),v.copy(g),n>0&&(v.add(u).multiplyScalar(1-.5*g.dot(u)),l=u.angleTo(g)>Math.PI/2,l)){const e=t/Math.cos(g.angleTo(u)/2);_.copy(g).add(u).normalize().multiplyScalar(-e).add(p),y.copy(u).multiplyScalar(t).add(p),x.copy(g).add(u).normalize().multiplyScalar(e).add(p),b.copy(g).multiplyScalar(t).add(p)}l?i.push(_.x,_.y,_.z,y.x,y.y,y.z,x.x,x.y,x.z,b.x,b.y,b.z):(_.copy(v).multiplyScalar(-t).add(p),y.copy(v).multiplyScalar(t).add(p),i.push(_.x,_.y,_.z,y.x,y.y,y.z)),u.copy(g)}else _.copy(u).multiplyScalar(-t).add(p),y.copy(u).multiplyScalar(t).add(p),i.push(_.x,_.y,_.z,y.x,y.y,y.z);n!==w-1&&((l?o:s).forEach(e=>a.push(m+T+e)),T+=l?4:2)}if(c){const n=2!==e.length?d.set(e[3*(w-3)]-e[3*(w-2)],e[3*(w-3)+1]-e[3*(w-2)+1]).angle():Math.PI;h(e[3*(w-2)],e[3*(w-2)+1],n,t,i,a)}}function d(e,t){const i=e[2*t+3]-e[2*t],n=e[2*t+3+1]-e[2*t+1],r=e[2*t+3+2]-e[2*t+2];return.5*Math.sqrt(i*i+n*n+r*r)}},function(e,t,i){"use strict";i.d(t,"a",(function(){return y}));var n=i(3),r=i(1);const s=new r.Zb,o=new r.Zb,a=new r.Zb,l=new r.Zb,h=new r.Zb,c=.1,d={attributes:[{name:"extrusionCoord",itemSize:3,offset:0},{name:"position",itemSize:3,offset:3},{name:"tangent",itemSize:3,offset:6},{name:"bitangent",itemSize:4,offset:9}],stride:13},m={attributes:[{name:"uv",itemSize:2,offset:d.stride},{name:"normal",itemSize:3,offset:d.stride+2}],stride:5},u={attributes:[...d.attributes,...m.attributes],stride:d.stride+m.stride},p={attributes:[{name:"extrusionCoord",itemSize:2,offset:0},{name:"position",itemSize:3,offset:2},{name:"positionLow",itemSize:3,offset:5},{name:"tangent",itemSize:3,offset:8},{name:"bitangent",itemSize:4,offset:11}],stride:15},f={attributes:[...p.attributes,...m.attributes],stride:p.stride+m.stride};class g{constructor(){this.vertices=[],this.vertexColors=[],this.indices=[]}}function v(e,t){return t?e?f:p:e?u:d}function _(e,t,i,r,d,m=new g,u=!1){if(0===t.length)return m;const p=v(void 0!==r,u).stride,f=t.length/3,_=new Array(f),y=new Array(t.length-3),x=m.vertices.length/p,b=void 0!==i&&i.length>0,w=void 0!==r&&r.length>0,T=void 0!==d&&d.length&&t.length;Object(n.l)(!b||i.length===f),Object(n.l)(!w||r.length/2===f),Object(n.l)(!T||d.length===t.length);let S=c;_[0]=S;let C=!0;for(let e=0;e<f-1;++e){let i=0;for(let n=0;n<3;++n){const r=t[3*(e+1)+n]-t[3*e+n];y[3*e+n]=r,i+=r*r,C=2===n?C&&0===t[3*(e+1)+n]:C}S+=Math.sqrt(i),_[e+1]=S}const E=b?Math.abs(i[i.length-1]-i[0]):1,M=_[_.length-1]/E;if(b)for(let e=0;e<f;++e)_[e]=i[e]*M+c;let A=!0;for(let e=0;e<3;++e)A=A&&t[e]===t[t.length-3+e];const P=[],L=(i,n,c,p,f)=>{P.length=0,m.vertices.push(p,-1*f,M),P.push(p,1*f,M);for(let e=0;e<3;++e){if(u){const n=Math.fround(t[3*i+e]),r=t[3*i+e]-n;m.vertices.push(n,r),P.push(n,r)}else m.vertices.push(t[3*i+e]),P.push(t[3*i+e]);o.setComponent(e,t[3*i+e])}for(let e=0;e<3;++e)a.setComponent(e,y[n+e]),l.setComponent(e,y[c+e]);a.normalize(),m.vertices.push(a.x,a.y,a.z),P.push(a.x,a.y,a.z);const g=function(e,t,i,n){let r=0;t.equals(i)||(r=Math.acos(t.dot(i))*Math.sign(e.dot(s.copy(t).cross(i))),Number.isNaN(r)&&(r=0));return n.copy(t).add(i).normalize().cross(e).normalize(),r}(C?o.set(0,0,1):o.add(e).normalize(),a,l.normalize(),h);m.vertices.push(h.x,h.y,h.z,g),P.push(h.x,h.y,h.z,g),w&&(m.vertices.push(r[2*i],r[2*i+1]),P.push(r[2*i],r[2*i+1]),m.vertices.push(o.x,o.y,o.z),P.push(o.x,o.y,o.z)),m.vertices.push(...P),T&&(m.vertexColors.push(d[3*i],d[3*i+1],d[3*i+2]),m.vertexColors.push(d[3*i],d[3*i+1],d[3*i+2]))};for(let e=0;e<f;++e){const t=A&&0===e?y.length-3:3*Math.max(0,e-1),i=A&&e===f-1?0:Math.min(3*e,y.length-3);e>0&&L(e,t,i,_[e-1],_[e]),e+1<f&&L(e,t,i,-1*_[Math.min(e,_.length-1)],_[Math.min(e+1,_.length-1)])}for(let e=0;e<f-1;++e){const t=x+4*e;m.indices.push(t,t+1,t+2,t+2,t+1,t+3)}return m}class y{constructor(e=!1,t=!1,i=!1){this.hasNormalsAndUvs=e,this.highPrecision=t,this.isSimple=i,this.m_geometry=new g}static createGeometry(e,t,i,n,s=!1,o=!1,a=!1){if(a)return n.setAttribute("position",new r.h(new Float32Array(e),3)),t.length===e.length&&n.setAttribute("color",new r.h(new Float32Array(t),3)),n.setIndex(new r.h(new Uint32Array(i),1)),n;{const a=v(s,o),l=new r.J(new Float32Array(e),a.stride);return a.attributes.forEach(e=>{const t=new r.K(l,e.itemSize,e.offset,!1);n.setAttribute(e.name,t)}),t.length===e.length&&n.setAttribute("color",new r.h(new Float32Array(t),3)),n.setIndex(new r.h(new Uint32Array(i),1)),n}}clear(){this.m_geometry.vertices=[],this.m_geometry.vertexColors=[],this.m_geometry.indices=[]}add(e,t,i,r,s){return this.isSimple?function(e,t,i=new g){if(0===e.length)return i;const n=e.length/3;let r=i.vertices.length/3;const s=void 0!==t&&t.length&&e.length;for(let o=0;o<n;++o,r++){o>0&&i.indices.push(r),o<n-1&&i.indices.push(r);for(let n=0;n<3;++n)i.vertices.push(e[3*o+n]),s&&i.vertexColors.push(t[3*o+n])}}(t,s,this.m_geometry):(Object(n.l)(!this.hasNormalsAndUvs||void 0!==r),_(e,t,i,r,s,this.m_geometry,this.highPrecision)),this}get vertices(){return this.m_geometry.vertices}get vertexColors(){return this.m_geometry.vertexColors}get indices(){return this.m_geometry.indices}get vertexAttributes(){return v(this.hasNormalsAndUvs,this.highPrecision).attributes}get stride(){return v(this.hasNormalsAndUvs,this.highPrecision).stride}createGeometry(e){return void 0===e&&(e=new r.i),y.createGeometry(this.m_geometry.vertices,this.m_geometry.vertexColors,this.m_geometry.indices,e,this.hasNormalsAndUvs,this.highPrecision)}}},,function(e,t,i){"use strict";var n=i(5),r=i(1);const s=new r.Zb,o=new r.Zb,a=new r.Zb;class l{constructor(){}modify(e){const t=e.getAttribute("position"),i=Array.from(t.array),n=e.getAttribute("uv"),r=void 0!==n?Array.from(n.array):void 0,l=e.getAttribute("edge"),h=void 0!==l?Array.from(l.array):void 0,c=e.getAttribute("wall"),d=void 0!==c?Array.from(c.array):void 0,m=e.getIndex(),u=Array.from(m.array),p=new Map;function f(e,t){const n=`${Math.min(e,t)}_${Math.max(e,t)}`,l=p.get(n);if(void 0!==l)return l;s.set(i[3*e],i[3*e+1],i[3*e+2]),o.set(i[3*t],i[3*t+1],i[3*t+2]),a.lerpVectors(s,o,.5);const c=i.length/3;return i.push(...a.toArray()),p.set(n,c),void 0!==r&&(s.set(r[2*e],r[2*e+1],0),o.set(r[2*t],r[2*t+1],0),a.lerpVectors(s,o,.5),r.push(a.x,a.y)),void 0!==h&&(h[e]===t?(h.push(t),h[e]=c):h[t]===e?(h.push(e),h[t]=c):h.push(-1)),void 0!==d&&(d[e]===t?(d.push(t),d[e]=c):d[t]===e?(d.push(e),d[t]=c):d.push(-1)),c}const g=[];for(;u.length>=3;){const e=u.shift(),t=u.shift(),n=u.shift();switch(s.set(i[3*e],i[3*e+1],i[3*e+2]),o.set(i[3*t],i[3*t+1],i[3*t+2]),a.set(i[3*n],i[3*n+1],i[3*n+2]),this.shouldSplitTriangle(s,o,a)){case 0:{const i=f(e,t);u.push(e,i,n,i,t,n);break}case 1:{const i=f(t,n);u.push(e,t,i,e,i,n);break}case 2:{const i=f(n,e);u.push(e,t,i,i,t,n);break}case void 0:g.push(e,t,n);break;default:throw new Error("failed to subdivide the given geometry")}}return t.array=new Float32Array(i),t.count=i.length/t.itemSize,t.needsUpdate=!0,e.setIndex(g),void 0!==r&&(n.array=new Float32Array(r),n.count=r.length/n.itemSize,n.needsUpdate=!0),void 0!==h&&(l.array=new Float32Array(h),l.count=h.length/l.itemSize,l.needsUpdate=!0),e}}i.d(t,"a",(function(){return c}));const h=[new r.Zb,new r.Zb,new r.Zb];class c extends l{constructor(e,t=n.n){super(),this.angle=e,this.projection=t}shouldSplitTriangle(e,t,i){const r=n.n.reprojectPoint(this.projection,e,h[0]),s=n.n.reprojectPoint(this.projection,t,h[1]),o=n.n.reprojectPoint(this.projection,i,h[2]),a=r.angleTo(s),l=s.angleTo(o),c=o.angleTo(r),d=Math.max(a,Math.max(l,c));if(!(d<this.angle)){if(d===a)return 0;if(d===l)return 1;if(d===c)return 2;throw new Error("failed to split triangle")}}}},,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,function(e){e.exports=JSON.parse('{"sky":{"type":"gradient","topColor":"#161719","bottomColor":"#262829","groundColor":"#262829","monomialPower":1},"fog":{"color":"#262829","startRatio":0.8},"clearColor":"#32353B","lights":[{"type":"ambient","color":"#C9CACC","name":"ambientLight","intensity":0.8},{"type":"directional","color":"#C5C7CA","name":"light1","intensity":0.4,"direction":{"x":1,"y":0,"z":1}},{"type":"directional","color":"#B6B6B6","name":"light2","intensity":0.4,"direction":{"x":-1,"y":0,"z":1}}],"styles":{"tilezen":[{"description":"pier","when":"$layer == \'roads\' && ((kind != \'rail\') && ((kind_detail == \'pier\') || (landuse_kind == \'pier\')))","technique":"solid-line","attr":{"color":"#333334","lineWidth":{"interpolation":"Linear","zoomLevels":[13,14,15],"values":[1.5,1.2,0.9]},"fadeNear":0.8,"fadeFar":0.9,"clipping":false},"renderOrder":10,"final":true},{"description":"residential - outline","category":"outline","technique":"solid-line","when":"$layer == \'roads\' && ((kind != \'rail\') && ((kind == \'minor_road\') && (((kind_detail == \'unclassified\') || (kind_detail == \'residential\')) || (kind_detail == \'service\'))))","attr":{"color":"#000","lineWidth":{"interpolation":"Linear","zoomLevels":[10,11,12,13,14],"values":[42,28,18,7,3.5]},"fadeNear":0.8,"fadeFar":0.9,"clipping":false},"renderOrder":11},{"category":"fill","when":"$layer == \'roads\' && ((kind != \'rail\') && ((kind == \'major_road\') && (kind_detail == \'secondary\')))","technique":"solid-line","attr":{"color":"#656565","secondaryColor":"#366E62","lineWidth":{"interpolation":"Linear","zoomLevels":[7,8,9,10,11,12,13,14],"values":[180,110,45,30,20,12,7,5]},"secondaryWidth":{"interpolation":"Linear","zoomLevels":[7,8,9,10,11,12,13,14],"values":[180,110,45,30,20,16,9,5.5]},"fadeNear":0.8,"fadeFar":0.9,"clipping":false},"renderOrder":15.3,"secondaryRenderOrder":10.3,"final":true},{"description":"tertiary","category":"outline","when":"$layer == \'roads\' && ((kind != \'rail\') && ((kind == \'major_road\') && kind_detail in [\'primary\',\'tertiary\']))","technique":"solid-line","attr":{"color":"#000","lineWidth":{"interpolation":"Linear","zoomLevels":[6,7,8,9,10,11,12,13,14],"values":[550,300,100,70,38,24,14,7,4.5]},"fadeNear":0.8,"fadeFar":0.9,"clipping":false},"renderOrder":10.3},{"description":"primary","category":"outline","when":"$layer == \'roads\' && ((kind != \'rail\') && ((kind == \'highway\') && ((kind_detail == \'motorway\') || (kind_detail == \'primary\'))))","technique":"solid-line","attr":{"color":"#000","lineWidth":{"interpolation":"Linear","zoomLevels":[6,7,8,9,10,11,12,13,14],"values":[700,400,200,90,50,33,16,11,6.5]},"fadeNear":0.8,"fadeFar":0.9,"clipping":false},"renderOrder":10.4},{"description":"ferry","when":"$layer == \'roads\' && ((kind != \'rail\') && kind in [\'ferry\'])","technique":"solid-line","attr":{"clipping":false,"color":"#484A4C","dashSize":{"interpolation":"Discrete","zoomLevels":[6,7,8,9,10,11,12,13,14,15,16,17,18],"values":[2000,1250,750,600,280,50,25,12,8,6,5,4,3]},"gapSize":{"interpolation":"Discrete","zoomLevels":[6,7,8,9,10,11,12,13,14,15,16,17,18],"values":[2000,1250,750,600,280,50,25,12,8,6,5,4,3]},"lineWidth":{"interpolation":"Linear","zoomLevels":[5,6,7,8,9,10,11,12,13,14,15,16,17],"values":[640,320,160,80,40,15,9,6,3,1.5,1,0.5,0.5]},"fadeNear":0.8,"fadeFar":0.9},"renderOrder":10,"final":true},{"description":"parkings etc","when":"$layer == \'roads\' && ((kind != \'rail\') && kind_detail in [\'driveway\',\'parking_aisle\',\'drive_through\'])","technique":"solid-line","attr":{"color":"#5E6062","lineWidth":5,"fadeNear":0.8,"fadeFar":0.9,"clipping":false},"renderOrder":10,"final":true},{"description":"pedestrian","when":"$layer == \'roads\' && ((kind != \'rail\') && ((kind == \'path\') && (kind_detail in [\'pedestrian\',\'path\',\'footway\'] || landuse_kind in [\'park\',\'residential\',\'footway\',\'garden\',\'pedestrian\',\'grass\',\'allotments\',\'forest\',\'cemetery\',\'natural_wood\'])))","category":"pedestrian","technique":"solid-line","attr":{"color":"#000","lineWidth":1.5,"fadeNear":0.8,"fadeFar":0.9,"clipping":false},"renderOrder":10.3},{"description":"tram","when":"$layer == \'roads\' && (((($geometryType ^= \'line\') && (kind == \'rail\')) && kind_detail in [\'rail\',\'light_rail\',\'tram\']) && (kind_detail == \'tram\'))","technique":"solid-line","attr":{"color":"#57585B","lineWidth":{"interpolation":"Linear","zoomLevels":[13,16,17],"values":[1.5,0.75,0.4]}},"renderOrder":50,"final":true},{"description":"industrial_railway","when":"$layer == \'roads\' && (((($geometryType ^= \'line\') && (kind == \'rail\')) && kind_detail in [\'rail\',\'light_rail\',\'tram\']) && service in [\'siding\',\'industrial\',\'yard\',\'spur\',\'crossover\'])","technique":"solid-line","attr":{"color":"#606164"},"renderOrder":5,"final":true},{"description":"Railway+S-Bahn background","category":"outline","when":"$layer == \'roads\' && (((($geometryType ^= \'line\') && (kind == \'rail\')) && kind_detail in [\'rail\',\'light_rail\',\'tram\']) && !(is_tunnel))","technique":"solid-line","attr":{"color":"#f0f","lineWidth":{"interpolation":"Linear","zoomLevels":[13,14.6,15],"values":[3.5,1.5,0.5]}},"renderOrder":5.2},{"description":"Railway+S-Bahn background","category":"outline","when":"$layer == \'roads\' && (((($geometryType ^= \'line\') && (kind == \'rail\')) && kind_detail in [\'rail\',\'light_rail\',\'tram\']) && is_tunnel)","technique":"solid-line","attr":{"color":"#6A6C6F","lineWidth":{"interpolation":"Linear","zoomLevels":[13,21],"values":[3.5,2.5]}},"renderOrder":5.1},{"description":"Railway+S-Bahn dashes","when":"$layer == \'roads\' && (((($geometryType ^= \'line\') && (kind == \'rail\')) && kind_detail in [\'rail\',\'light_rail\',\'tram\']) && !(is_tunnel))","technique":"solid-line","attr":{"color":"#7B7E81","dashSize":{"interpolation":"Discrete","zoomLevels":[10,11,12,13,14,15,20],"values":[30,20,12,7,4,2,1]},"gapSize":{"interpolation":"Discrete","zoomLevels":[10,11,12,13,14,15,20],"values":[100,55,50,40,25,12,8]},"lineWidth":{"interpolation":"Linear","zoomLevels":[13,21],"values":[2.75,1.75]}},"renderOrder":5.25,"final":true},{"description":"Railway+S-Bahn dashes","when":"$layer == \'roads\' && (((($geometryType ^= \'line\') && (kind == \'rail\')) && kind_detail in [\'rail\',\'light_rail\',\'tram\']) && is_tunnel)","technique":"solid-line","attr":{"color":"#454648","dashSize":{"interpolation":"Discrete","zoomLevels":[10,11,12,13,14,15,16],"values":[100,40,24,30,25,15,8]},"gapSize":{"interpolation":"Discrete","zoomLevels":[10,11,12,13,14,15,16],"values":[100,40,24,30,25,15,8]},"lineWidth":{"interpolation":"Linear","zoomLevels":[13,14],"values":[2.75,1.75]}},"renderOrder":5.15,"final":true},{"description":"water","when":"$layer == \'water\' && $geometryType ^= \'polygon\'","technique":"fill","attr":{"color":"#0F1621"},"renderOrder":5},{"description":"country border","category":"outline","when":"$layer ^= \'boundaries\' && (($geometryType ^= \'line\') && (kind == \'country\'))","technique":"solid-line","attr":{"color":"#373A3C","lineWidth":{"interpolation":"Linear","zoomLevels":[1,2,3,4,5,6,7,8,9,10,11,12,13,14],"values":[5000,4000,3500,2500,1500,1000,500,250,125,60,40,20,10,5]}},"renderOrder":5},{"description":"country border","category":"fill","when":"$layer ^= \'boundaries\' && (($geometryType ^= \'line\') && (kind == \'country\'))","technique":"solid-line","attr":{"color":"#2E3234","lineWidth":{"interpolation":"Linear","zoomLevels":[2,3,4,5,6,7,8,9,10,11,12,13,14],"values":[1000,700,500,250,110,45,25,15,10,7.5,5,2.5,1]}},"renderOrder":5},{"description":"disputed border line","when":"$layer ^= \'boundaries\' && (($geometryType ^= \'line\') && (kind in [\'disputed\',\'indefinite\',\'indeterminate\',\'lease_limit\',\'line_of_control\',\'overlay_limit\']))","technique":"solid-line","attr":{"color":"#2E3234","secondaryColor":"#373A3C","lineWidth":{"interpolation":"Linear","zoomLevels":[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],"values":[4000,2600,1500,1000,720,520,270,140,90,60,30,15,10,5,2]},"secondaryWidth":{"interpolation":"Linear","zoomLevels":[1,2,3,4,5,6,7,8,9,10,11,12,13,14],"values":[10000,8000,7000,5000,3000,2000,1000,500,250,120,80,40,20,10]},"dashSize":{"interpolation":"Cubic","zoomLevels":[10,11,12,13,14],"values":[1024,512,256,128,64]},"gapSize":{"interpolation":"Cubic","zoomLevels":[10,11,12,13,14],"values":[512,256,128,64,32]}},"renderOrder":4.1,"secondaryRenderOrder":4},{"description":"region border","category":"outline","when":"$layer ^= \'boundaries\' && (($geometryType ^= \'line\') && (kind == \'region\'))","technique":"solid-line","attr":{"color":"#7C7C7C","lineWidth":{"interpolation":"Linear","zoomLevels":[2,3,4,5,6,7,8,9,10,11,12,13,14],"values":[600,300,150,100,60,30,20,12,8,5,3,2,1]}},"renderOrder":4.1},{"description":"region border","when":"$layer ^= \'boundaries\' && (($geometryType ^= \'line\') && (kind == \'region\'))","technique":"solid-line","attr":{"color":"#7C7C7C","lineWidth":{"interpolation":"Linear","zoomLevels":[2,3,4,5,6,7,8,9,10,11,12,13,14],"values":[600,300,150,100,60,30,20,12,8,5,3,2,1]}},"renderOrder":4.1},{"description":"urban","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && (kind ^= \'urban\'))","technique":"fill","attr":{"opacity":0.8,"color":"#3B3E45"},"renderOrder":0},{"description":"park","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && kind in [\'nature\',\'forest\',\'park\',\'wood\',\'natural_wood\',\'grass\',\'meadow\',\'village_green\',\'dog_park\',\'garden\',\'nature_reserve\',\'protected_area\'])","technique":"fill","attr":{"color":"#373A40"},"renderOrder":0.2},{"description":"runway","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && (kind == \'runway\'))","technique":"fill","attr":{"color":"#2E3036"},"renderOrder":20,"final":true},{"description":"aerodrome","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && (kind ^= \'aerodrome\'))","technique":"fill","attr":{"color":"#373A40"},"renderOrder":0.3},{"description":"national_park","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && (kind ^= \'national_park\'))","technique":"fill","attr":{"color":"#373A40"},"renderOrder":1},{"description":"pitch","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && kind in [\'pitch\'])","technique":"fill","attr":{"color":"#373A40"},"renderOrder":1},{"description":"hospital","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && (kind ^= \'hospital\'))","technique":"fill","attr":{"color":"#373A40"},"renderOrder":0.1},{"description":"cemetery","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && (kind ^= \'cemetery\'))","technique":"fill","attr":{"color":"#373A40"},"renderOrder":0.1},{"description":"bridge","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && kind in [\'bridge\'])","technique":"fill","attr":{"color":"#ff0000"},"renderOrder":1},{"description":"zoo","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && kind in [\'sport\',\'sports_centre\',\'attraction\',\'zoo\'])","technique":"fill","attr":{"color":"#373A40"},"renderOrder":1},{"description":"religion","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && (kind ^= \'religion\'))","technique":"fill","attr":{"color":"#373A40"},"renderOrder":1},{"description":"industrial","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && kind in [\'common\',\'surface\',\'commercial\',\'military\',\'industrial\'])","technique":"fill","attr":{"color":"#373A40"},"renderOrder":0},{"description":"farmyard","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && kind in [\'animal\',\'aviary\',\'zoo\',\'farm\',\'farmland\',\'farmyard\'])","technique":"fill","attr":{"color":"#373A40"},"renderOrder":0},{"description":"beach","when":"$layer ^= \'landuse\' && (($geometryType ^= \'polygon\') && (kind in [\'beach\'] || (kind $= \'_site\')))","technique":"fill","attr":{"color":"#373A40"},"renderOrder":1},{"description":"building_geometry","when":"$layer ^= \'buildings\' && ($geometryType ^= \'polygon\')","technique":"extruded-polygon","attr":{"color":"#95DFCC","opacity":0.85,"defaultHeight":1,"roughness":1,"metalness":0.9,"emissive":"#383C45","emissiveIntensity":0.5,"footprint":true,"maxSlope":0.8799999999999999,"lineWidth":1,"lineColor":"#95DFCC","lineColorMix":0.1,"fadeNear":0.1,"fadeFar":1,"lineFadeNear":0.1,"lineFadeFar":0.7},"renderOrder":2000}]}}')},function(e,t,i){"use strict";i.r(t);var n=i(5),r=i(1);function s(e,t,i,n){const r=!0===n?"\t":"";return e.replace(`#include <${t}>`,`#include <${t}>\n${r}#include <${i}>`)}function o(e){e.transparent||(a(e),e.forcedBlending=!0)}function a(e){e.transparent||e.forcedBlending||(e.blending=r.p,!0===e.premultipliedAlpha?(e.blendSrc=r.pb,e.blendDst=r.qb,e.blendSrcAlpha=r.pb,e.blendDstAlpha=r.qb):(e.blendSrc=r.Ob,e.blendDst=r.qb,e.blendSrcAlpha=r.pb,e.blendDstAlpha=r.qb))}const l="\nuniform float size;\n\nvoid main() {\n    vec3 transformed = vec3(position);\n    vec4 mvPosition = modelViewMatrix * vec4(transformed, 1.0);\n\n    gl_Position = projectionMatrix * mvPosition;\n    gl_PointSize = size;\n}\n",h="\nuniform vec3 diffuse;\n\nvoid main() {\n    float alpha = 1.0;\n\n    float radius = 0.5;\n    vec2 coords = gl_PointCoord.xy - vec2(0.5);\n    float len = length(coords);\n    float falloff = fwidth(len);\n    float threshold = 1.0 - smoothstep(radius - falloff, radius, len);\n    alpha *= threshold;\n\n    gl_FragColor = vec4(diffuse, alpha);\n}",c=1;class d extends r.Lb{constructor(e={}){e.depthTest=!1,super(e),o(this),this.isCirclePointsMaterial=!0,this.type="CirclePointsMaterial",this.vertexShader=l,this.fragmentShader=h,this.m_size=e.size||c,this.m_color=new r.l,this.uniforms={diffuse:new r.Sb(this.m_color),size:new r.Sb(this.m_size)},this.extensions.derivatives=!0}get size(){return this.m_size}set size(e){this.m_size=e,this.uniforms.size.value=e}get color(){return"#"+this.m_color.getHexString()}set color(e){this.m_color.set(e),this.uniforms.diffuse.value.set(this.m_color)}}const m={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n    varying vec2 vUv;\n    void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    }",fragmentShader:"\n    uniform float opacity;\n    uniform sampler2D tDiffuse;\n    varying vec2 vUv;\n    void main() {\n        vec4 texel = texture2D( tDiffuse, vUv );\n        gl_FragColor = opacity * texel;\n    }"};class u extends r.Lb{constructor(e){super({name:"CopyMaterial",uniforms:e,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,premultipliedAlpha:!0,transparent:!1,blending:r.mb,depthTest:!1,depthWrite:!1})}}var p=i(3),f=i(24);var g,v,_,y,x,b,w={extrusion_pars_vertex:"\n// Extrusion axis (xyz: vector, w: factor).\nattribute vec4 extrusionAxis;\nuniform float extrusionRatio;\nvarying vec4 vExtrusionAxis;\nvarying float vExtrusionRatio;\n\n",extrusion_vertex:`\n// Cancel extrusionRatio (meaning, force to 1) if extrusionAxisLen < MIN_BUILDING_HEIGHT.\nconst float MIN_BUILDING_HEIGHT_SQUARED = ${f.a.MIN_BUILDING_HEIGHT*f.a.MIN_BUILDING_HEIGHT};\nfloat extrusionAxisLenSquared = dot(extrusionAxis.xyz, extrusionAxis.xyz);\nvExtrusionRatio = max(1.0 - step(extrusionAxisLenSquared, MIN_BUILDING_HEIGHT_SQUARED), extrusionRatio);\n\ntransformed = transformed + extrusionAxis.xyz * (vExtrusionRatio - 1.0);\nvExtrusionAxis = vec4(normalMatrix * extrusionAxis.xyz, extrusionAxis.w);\n`,extrusion_normal_fragment_begin:"\n#ifdef FLAT_SHADED\n    // Flattened this divergent path to prevent undefined behaviour in the following derivatives\n    // functions. For more info:\n    // http://www.aclockworkberry.com/shader-derivative-functions/#Derivatives_and_branches\n\n    // Workaround for Adreno/Nexus5 not able able to do dFdx( vViewPosition ) ...\n    vec3 fdx = vec3(dFdx(vViewPosition.x), dFdx(vViewPosition.y), dFdx(vViewPosition.z));\n    vec3 fdy = vec3(dFdy(vViewPosition.x), dFdy(vViewPosition.y), dFdy(vViewPosition.z));\n    vec3 normal = cross( fdx, fdy );\n    if (vExtrusionAxis.w > 0.999999) {\n        normal = vExtrusionAxis.xyz;\n    }\n    normal = normalize(normal);\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * (float(gl_FrontFacing) * 2.0 - 1.0);\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * (float(gl_FrontFacing) * 2.0 - 1.0);\n\t\t\tbitangent = bitangent * (float(gl_FrontFacing) * 2.0 - 1.0);\n\t\t#endif\n\t#endif\n#endif\n// non perturbed normal for clearcoat among others\nvec3 geometryNormal = normal;\n",extrusion_pars_fragment:"\nvarying float vExtrusionRatio;\nvarying vec4 vExtrusionAxis;\n",extrusion_fragment:"\ngl_FragColor.a *= smoothstep( 0.0, 0.25, vExtrusionRatio );\n"},T={fading_pars_vertex:"\nvarying float fadingDepth;\n",fading_vertex:"\nfadingDepth = -mvPosition.z;\n",fading_pars_fragment:"\nvarying float fadingDepth;\nuniform float fadeNear;\nuniform float fadeFar;\n",fading_fragment:'\n\n// lerp with "hard" edges\n//float fadingFactor = 1.0 - clamp((fadingDepth - fadeNear) / (fadeFar - fadeNear), 0.0, 1.0);\n\n// smooth transitions\nfloat fadingFactor = smoothstep( fadeNear, fadeFar, fadingDepth );\n\ngl_FragColor.a *= 1.0 - fadingFactor;\n\n// debugging color:\n// gl_FragColor = vec4(1., fadingFactor, fadingFactor, 1.0);\n'};function S(e,t){return e*t.maximum}(v=g||(g={})).updateDisplacementFeature=function(e){e.needsUpdate=!0,void 0===e.defines&&(e.defines={}),void 0!==e.displacementMap&&(e.displacementMap.needsUpdate=!0,e.defines.USE_DISPLACEMENTMAP="")},v.onBeforeCompile=function(e,t){if(void 0===e.displacementMap)return;const i=t.uniforms;i.displacementMap={value:e.displacementMap},i.displacementScale={value:1},i.displacementBias={value:0},t.vertexShader=t.vertexShader.replace("#include <skinbase_vertex>","#include <skinbase_vertex>\n#ifndef USE_ENVMAP\n    vec3 objectNormal = vec3( normal );\n#endif"),t.vertexShader=s(t.vertexShader,"uv2_pars_vertex","displacementmap_pars_vertex"),t.vertexShader=s(t.vertexShader,"skinning_vertex","displacementmap_vertex",!0)};(y=_||(_={})).DEFAULT_FADE_NEAR=-1,y.DEFAULT_FADE_FAR=-1,y.patchGlobalShaderChunks=function(){void 0===r.Jb.fading_pars_vertex&&Object.assign(r.Jb,T)},y.updateDistanceFadeFeature=function(e){e.needsUpdate=!0,void 0===e.defines&&(e.defines={}),void 0!==e.fadeFar&&e.fadeFar>0&&(e.defines.FADING_MATERIAL="")},y.onBeforeCompile=function(e,t){if(void 0===e.fadeFar||e.fadeFar<=0)return;const i=t.uniforms;i.fadeNear={value:e.fadeNear},i.fadeFar={value:e.fadeFar},t.vertexShader=s(t.vertexShader,"fog_pars_vertex","fading_pars_vertex"),t.vertexShader=s(t.vertexShader,"fog_vertex","fading_vertex",!0),t.fragmentShader=s(t.fragmentShader,"fog_pars_fragment","fading_pars_fragment"),t.fragmentShader=s(t.fragmentShader,"fog_fragment","fading_fragment",!0)},y.addRenderHelper=function(e,t,i,n,r,s){e.onBeforeRender=Object(p.n)(e.onBeforeRender,(e,o,a,l,h,c)=>{const d=h;if(d.fadeNear=void 0===i?y.DEFAULT_FADE_NEAR:S(i,t),d.fadeFar=void 0===n?y.DEFAULT_FADE_FAR:S(n,t),r){const t=e.properties.get(h);void 0!==t.shader&&void 0!==t.shader.uniforms.fadeNear&&(t.shader.uniforms.fadeNear.value=d.fadeNear,t.shader.uniforms.fadeFar.value=d.fadeFar,d.uniformsNeedUpdate=!0)}void 0!==s&&s(e,h)})};class C{constructor(){this.m_fadeNear=_.DEFAULT_FADE_NEAR,this.m_fadeFar=_.DEFAULT_FADE_FAR}getFadeNear(){return this.m_fadeNear}setFadeNear(e){this.m_fadeNear=e}getFadeFar(){return this.m_fadeFar}setFadeFar(e){this.m_fadeFar=e}addFadingProperties(){Object.defineProperty(this,"fadeNear",{get:()=>this.getFadeNear(),set:e=>{this.setFadeNear(e)}}),Object.defineProperty(this,"fadeFar",{get:()=>this.getFadeFar(),set:e=>{this.setFadeFar(e)}})}applyFadingParameters(e){void 0!==e&&(void 0!==e.fadeNear&&this.setFadeNear(e.fadeNear),void 0!==e.fadeFar&&this.setFadeFar(e.fadeFar)),this.onBeforeCompile=e=>{_.onBeforeCompile(this,e)}}copyFadingParameters(e){return this.setFadeNear(void 0===e.fadeNear?_.DEFAULT_FADE_NEAR:e.fadeNear),this.setFadeFar(void 0===e.fadeFar?_.DEFAULT_FADE_FAR:e.fadeFar),this}}(b=x||(x={})).patchGlobalShaderChunks=function(){void 0===r.Jb.extrusion_pars_vertex&&Object.assign(r.Jb,w)},b.updateExtrusionFeature=function(e){e.needsUpdate=!0,void 0===e.defines&&(e.defines={}),void 0!==e.extrusionRatio&&e.extrusionRatio>=f.a.DEFAULT_RATIO_MIN&&(e.defines.EXTRUSION_MATERIAL="")},b.onBeforeCompile=function(e,t){void 0!==e.extrusionRatio&&(t.uniforms.extrusionRatio={value:e.extrusionRatio},t.vertexShader=s(t.vertexShader,"common","extrusion_pars_vertex"),t.vertexShader=s(t.vertexShader,"begin_vertex","extrusion_vertex",!0),t.fragmentShader=s(t.fragmentShader,"fog_pars_fragment","extrusion_pars_fragment"),t.fragmentShader=t.fragmentShader.replace("#include <normal_fragment_begin>","#include <extrusion_normal_fragment_begin>"),t.fragmentShader=s(t.fragmentShader,"fog_fragment","extrusion_fragment",!0))},b.addRenderHelper=function(e){e.onBeforeRender=Object(p.n)(e.onBeforeRender,b.onBeforeRender)},b.onBeforeRender=function(e,t,i,n,r,s){const o=r,a=e.properties.get(r);void 0!==a.shader&&void 0!==a.shader.uniforms.extrusionRatio&&(a.shader.uniforms.extrusionRatio.value=o.extrusionRatio||f.a.DEFAULT_RATIO_MAX,o.uniformsNeedUpdate=!0)};class E{constructor(){this.m_extrusion=f.a.DEFAULT_RATIO_MAX}getExtrusionRatio(){return this.m_extrusion}setExtrusionRatio(e){this.needsUpdate=this.needsUpdate||e!==this.m_extrusion,this.m_extrusion=e,this.needsUpdate&&x.updateExtrusionFeature(this)}addExtrusionProperties(){Object.defineProperty(this,"extrusionRatio",{get:()=>this.getExtrusionRatio(),set:e=>{this.setExtrusionRatio(e)}})}applyExtrusionParameters(e){void 0!==e&&void 0!==e.extrusionRatio&&this.setExtrusionRatio(e.extrusionRatio),this.onBeforeCompile=e=>{x.onBeforeCompile(this,e)}}copyExtrusionParameters(e){return void 0!==e.extrusionRatio&&this.setExtrusionRatio(e.extrusionRatio),this}}class M extends r.fb{constructor(e){super(e),_.patchGlobalShaderChunks(),this.addFadingProperties(),this.applyFadingParameters(e),x.patchGlobalShaderChunks(),this.addExtrusionProperties(),this.applyExtrusionParameters(e),this.addDisplacementProperties(),this.applyDisplacementParameters(e)}clone(){return(new M).copy(this)}copy(e){return super.copy(e),this.copyFadingParameters(e),this.copyExtrusionParameters(e),this.copyDisplacementParameters(e),this}get fadeNear(){return _.DEFAULT_FADE_NEAR}set fadeNear(e){}get fadeFar(){return _.DEFAULT_FADE_FAR}set fadeFar(e){}get extrusionRatio(){return f.a.DEFAULT_RATIO_MAX}set extrusionRatio(e){}get displacementMap(){}set displacementMap(e){}addFadingProperties(){}applyFadingParameters(e){}copyFadingParameters(e){}addExtrusionProperties(){}applyExtrusionParameters(e){}copyExtrusionParameters(e){}addDisplacementProperties(){}applyDisplacementParameters(e){}copyDisplacementParameters(e){}}class A extends r.gb{constructor(e){super(e),_.patchGlobalShaderChunks(),this.addFadingProperties(),this.applyFadingParameters(e),x.patchGlobalShaderChunks(),this.addExtrusionProperties(),this.applyExtrusionParameters(e)}clone(){return(new A).copy(this)}copy(e){return super.copy(e),this.copyFadingParameters(e),this.copyExtrusionParameters(e),this}get fadeNear(){return _.DEFAULT_FADE_NEAR}set fadeNear(e){}get fadeFar(){return _.DEFAULT_FADE_FAR}set fadeFar(e){}get extrusionRatio(){return f.a.DEFAULT_RATIO_MAX}set extrusionRatio(e){}addFadingProperties(){}applyFadingParameters(e){}copyFadingParameters(e){}addExtrusionProperties(){}applyExtrusionParameters(e){}copyExtrusionParameters(e){}}Object(p.k)(M,[C]),Object(p.k)(A,[C]),Object(p.k)(M,[E]),Object(p.k)(A,[E]),Object(p.k)(M,[class{getDisplacementMap(){return this.m_displacementMap}setDisplacementMap(e){this.needsUpdate=this.needsUpdate||e!==this.m_displacementMap,this.m_displacementMap=e,this.needsUpdate&&g.updateDisplacementFeature(this)}addDisplacementProperties(){Object.defineProperty(this,"displacementMap",{get:()=>this.getDisplacementMap(),set:e=>{this.setDisplacementMap(e)}})}applyDisplacementParameters(e){void 0!==e&&void 0!==e.displacementMap&&this.setDisplacementMap(e.displacementMap),this.onBeforeCompile=e=>{g.onBeforeCompile(this,e)}}copyDisplacementParameters(e){return this.setDisplacementMap(e.displacementMap),this}}]);const P="\n#define EDGE_DEPTH_OFFSET 0.0001\n\nattribute vec3 position;\nattribute vec4 color;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 edgeColor;\nuniform float edgeColorMix;\n\n#ifdef USE_DISPLACEMENTMAP\nattribute vec3 normal;\nattribute vec2 uv;\nuniform sampler2D displacementMap;\n#endif\n\nvarying vec3 vColor;\n\n#ifdef USE_EXTRUSION\n#include <extrusion_pars_vertex>\n#endif\n\n#ifdef USE_FADING\n#include <fading_pars_vertex>\n#endif\n\nvoid main() {\n\n    #ifdef USE_COLOR\n    vColor = mix(edgeColor.rgb, color.rgb, edgeColorMix);\n    #else\n    vColor = edgeColor.rgb;\n    #endif\n\n    vec3 transformed = vec3( position );\n\n    #ifdef USE_EXTRUSION\n    #include <extrusion_vertex>\n    #endif\n\n    #ifdef USE_DISPLACEMENTMAP\n    transformed += normalize( normal ) * texture2D( displacementMap, uv ).x;\n    #endif\n\n    vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n\n    gl_Position = projectionMatrix * mvPosition;\n    // After projection gl_Position contains clip space coordinates of each vertex\n    // before perspective division (1 / w), thus only vertexes with -w < z < w should\n    // be displayed and offset. We offset only those edges which z coordinate in NDC\n    // space is between: -inf < z < 1\n    float depthOffset = step(-1.0, -gl_Position.z / gl_Position.w) * EDGE_DEPTH_OFFSET;\n    gl_Position.z -= depthOffset;\n\n    #ifdef USE_FADING\n    #include <fading_vertex>\n    #endif\n}",L="\nprecision highp float;\nprecision highp int;\n\nvarying vec3 vColor;\n\n#ifdef USE_EXTRUSION\n#include <extrusion_pars_fragment>\n#endif\n\n#ifdef USE_FADING\n#include <fading_pars_fragment>\n#endif\n\nvoid main() {\n    float alphaValue = 1.0;\n    gl_FragColor = vec4(vColor, alphaValue);\n\n    #ifdef USE_EXTRUSION\n    #include <extrusion_fragment>\n    #endif\n\n    #ifdef USE_FADING\n    #include <fading_fragment>\n    #endif\n}";class R extends r.Db{constructor(e){const t={},i=void 0!==e&&void 0!==e.displacementMap;i&&(t.USE_DISPLACEMENTMAP=""),super({name:"EdgeMaterial",vertexShader:P,fragmentShader:L,uniforms:{edgeColor:new r.Sb(new r.l(R.DEFAULT_COLOR)),edgeColorMix:new r.Sb(R.DEFAULT_COLOR_MIX),fadeNear:new r.Sb(_.DEFAULT_FADE_NEAR),fadeFar:new r.Sb(_.DEFAULT_FADE_FAR),extrusionRatio:new r.Sb(f.a.DEFAULT_RATIO_MIN),displacementMap:new r.Sb(i?e.displacementMap:new r.Pb)},depthWrite:!1,defines:t}),o(this),_.patchGlobalShaderChunks(),x.patchGlobalShaderChunks(),void 0!==e&&(void 0!==e.color&&this.color.set(e.color),void 0!==e.colorMix&&(this.colorMix=e.colorMix),void 0!==e.fadeNear&&(this.fadeNear=e.fadeNear),void 0!==e.fadeFar&&(this.fadeFar=e.fadeFar),void 0!==e.displacementMap&&(this.displacementMap=e.displacementMap))}get color(){return this.uniforms.edgeColor.value}set color(e){this.uniforms.edgeColor.value=e}get colorMix(){return this.uniforms.edgeColorMix.value}set colorMix(e){if(this.uniforms.edgeColorMix.value===e)return;this.uniforms.edgeColorMix.value=e,e>0?(this.needsUpdate=void 0===this.defines.USE_COLOR,this.defines.USE_COLOR=""):(this.needsUpdate=void 0!==this.defines.USE_COLOR,delete this.defines.USE_COLOR)}get fadeNear(){return this.uniforms.fadeNear.value}set fadeNear(e){this.uniforms.fadeNear.value=e}get fadeFar(){return this.uniforms.fadeFar.value}set fadeFar(e){if(this.uniforms.fadeFar.value===e)return;this.uniforms.fadeFar.value=e,e>0?(this.needsUpdate=void 0===this.defines.USE_FADING,this.defines.USE_FADING=""):(this.needsUpdate=void 0!==this.defines.USE_FADING,delete this.defines.USE_FADING)}get extrusionRatio(){return this.uniforms.extrusionRatio.value}set extrusionRatio(e){if(this.uniforms.extrusionRatio.value===e)return;this.uniforms.extrusionRatio.value=e,e>=f.a.DEFAULT_RATIO_MIN?(this.needsUpdate=void 0===this.defines.USE_EXTRUSION,this.defines.USE_EXTRUSION=""):(this.needsUpdate=void 0!==this.defines.USE_EXTRUSION,delete this.defines.USE_EXTRUSION)}get displacementMap(){return this.uniforms.displacementMap.value}set displacementMap(e){this.uniforms.displacementMap.value!==e&&(this.uniforms.displacementMap.value=e,void 0!==e?(this.uniforms.displacementMap.value.needsUpdate=!0,this.needsUpdate=void 0===this.defines.USE_DISPLACEMENTMAP,this.defines.USE_DISPLACEMENTMAP=""):(this.needsUpdate=void 0!==this.defines.USE_DISPLACEMENTMAP,delete this.defines.USE_DISPLACEMENTMAP))}}R.DEFAULT_COLOR=0,R.DEFAULT_COLOR_MIX=0;var O={extrude_line_vert_func:"\nvec3 extrudeLine(\n        in vec3 vertexPosition,\n        in float linePosition,\n        in float lineWidth,\n        in vec4 bitangent,\n        in vec3 tangent,\n        inout vec2 uv\n    ) {\n    vec3 result = vertexPosition;\n    // Retrieve the angle between this segment and the previous one (stored in the bitangent w\n    // component).\n    float angle = bitangent.w;\n    // Extrude according to the angle between segments to properly render narrow joints...\n    if (angle != 0.0) {\n        result += uv.y * lineWidth * bitangent.xyz / cos(angle / 2.0);\n        uv.x = linePosition + uv.x * lineWidth * uv.y * tan(angle / 2.0);\n    }\n    // ... or extrude in a simple manner for segments that keep the same direction.\n    else {\n        result += uv.y * lineWidth * bitangent.xyz + uv.x * lineWidth * tangent;\n        uv.x = linePosition + uv.x * lineWidth;\n    }\n    uv.y *= lineWidth;\n    return result;\n}\n",round_edges_and_add_caps:"\nfloat roundEdgesAndAddCaps(in vec4 coords, in vec3 range) {\n    // Compute the line's width to length ratio.\n    float widthRatio = range.y / range.x;\n\n    // Compute the inner segment distance (same for all cap mode).\n    float dist = abs(coords.y);\n    float segmentBeginMask = clamp(ceil(coords.z - coords.x), 0.0, 1.0);\n    float segmentEndMask = clamp(ceil(coords.x - coords.w), 0.0, 1.0);\n    dist = max(dist, segmentBeginMask * length(vec2((coords.x - coords.z) / widthRatio, coords.y)));\n    dist = max(dist, segmentEndMask * length(vec2((coords.x - coords.w) / widthRatio, coords.y)));\n\n    #if !CAPS_ROUND\n    // Compute the caps mask.\n    float capRangeMask = clamp(1.0 - ceil(range.z - drawRange.y), 0.0, 1.0);\n    float beginCapMask = clamp(ceil(drawRange.x - coords.x), 0.0, 1.0);\n    float endCapMask = clamp(ceil(coords.x - drawRange.y), 0.0, 1.0);\n    float capMask = capRangeMask * max(beginCapMask, endCapMask);\n\n    // Compute the outer segment distance (specific for each cap mode).\n    float capDist = max(coords.x - drawRange.y, drawRange.x - coords.x) / widthRatio;\n    #if CAPS_NONE\n    dist = mix(dist, max(abs(coords.y), (capDist + 0.1) / 0.1), capMask);\n    #elif CAPS_SQUARE\n    dist = mix(dist, max(abs(coords.y), capDist), capMask);\n    #elif CAPS_TRIANGLE_OUT\n    dist = mix(dist, abs(coords.y) + capDist, capMask);\n    #elif CAPS_TRIANGLE_IN\n    dist = mix(dist, max(abs(coords.y), (capDist - abs(coords.y)) + capDist), capMask);\n    #endif\n    #endif\n\n    return dist;\n}\n",tile_clip_func:"\nvoid tileClip(vec2 tilePos, vec2 tileSize) {\n    if (tileSize.x > 0.0 && (tilePos.x < -tileSize.x / 2.0 || tilePos.x > tileSize.x / 2.0))\n        discard;\n    if (tileSize.y > 0.0 && (tilePos.y < -tileSize.y / 2.0 || tilePos.y > tileSize.y / 2.0))\n        discard;\n}\n",high_precision_vert_func:"\nvec3 subtractDblEyePos( const in vec3 pos ) {\n    vec3 t1 = positionLow - u_eyepos_lowpart;\n    vec3 e = t1 - positionLow;\n    vec3 t2 = ((-u_eyepos_lowpart - e) + (positionLow - (t1 - e))) + pos - u_eyepos;\n    vec3 high_delta = t1 + t2;\n    vec3 low_delta = t2 - (high_delta - t1);\n    return (high_delta + low_delta);\n}\n"};const F="\n#ifdef USE_COLOR\nattribute vec4 color;\nvarying vec3 vColor;\n#endif\n\n// uniforms to implement double-precision\nuniform mat4 u_mvp;             // combined modelView and projection matrix\nuniform vec3 u_eyepos;          // eye position major\nuniform vec3 u_eyepos_lowpart;  // eye position minor ((double) eyepos - (float) eyepos)\n\n// vertex attributes\nattribute vec3 position;        // high part\nattribute vec3 positionLow;     // low part\n\n#include <high_precision_vert_func>\n\nvoid main() {\n    #ifdef USE_COLOR\n    vColor = color.rgb;\n    #endif\n\n    vec3 pos = subtractDblEyePos(position);\n    gl_Position = u_mvp * vec4(pos, 1.0);\n}",D="\nprecision highp float;\nprecision highp int;\n\nuniform vec3 diffuse;\nuniform float opacity;\n\n#ifdef USE_COLOR\nvarying vec3 color;\n#endif\n\nvoid main() {\n    #ifdef USE_COLOR\n    gl_FragColor = vec4( diffuse * vColor, opacity );\n    #else\n    gl_FragColor = vec4( diffuse, opacity );\n    #endif\n}";class I extends r.Db{constructor(e){Object.assign(r.Jb,O);const t={name:"HighPrecisionLineMaterial",vertexShader:F,fragmentShader:D,uniforms:{diffuse:new r.Sb(new r.l(I.DEFAULT_COLOR)),opacity:new r.Sb(I.DEFAULT_OPACITY),u_mvp:new r.Sb(new r.db),u_eyepos:new r.Sb(new r.Zb),u_eyepos_lowpart:new r.Sb(new r.Zb)}};Object.assign(t,e),super(t),this.type="HighPrecisionLineMaterial",this.isHighPrecisionLineMaterial=!0,void 0!==e&&(void 0!==e.color&&this.color.set(e.color),void 0!==e.opacity&&(this.opacity=e.opacity)),this.updateTransparencyFeature()}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}updateTransparencyFeature(){this.transparent=this.opacity<1}}I.DEFAULT_COLOR=80,I.DEFAULT_OPACITY=1;const z="\n#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif\n\nuniform float size;\n\n// uniforms to implement double-precision\nuniform mat4 u_mvp;             // combined modelView and projection matrix\nuniform vec3 u_eyepos;          // eye position major\nuniform vec3 u_eyepos_lowpart;  // eye position minor ((double) eyepos - (float) eyepos)\n\n// vertex attributes\nattribute vec3 positionLow;     // low part\n\n#include <high_precision_vert_func>\n\nvoid main() {\n    #ifdef USE_COLOR\n    vColor = color.rgb;\n    #endif\n\n    vec3 pos = subtractDblEyePos(position);\n    gl_Position = u_mvp * vec4(pos, 1.0);\n\n    // ignore sizeAttenuation for now!\n    gl_PointSize = size;\n}";class k extends r.yb{constructor(e){Object.assign(r.Jb,O),super(e),this.type="HighPrecisionPointMaterial",this.vertexShader=z,this.fragmentShader=r.Jb.points_frag,this.fog=!1,this.uniforms={diffuse:new r.Sb(new r.l(k.DEFAULT_COLOR)),opacity:new r.Sb(k.DEFAULT_OPACITY),size:new r.Sb(k.DEFAULT_SIZE),scale:new r.Sb(k.DEFAULT_SCALE),map:new r.Sb(new r.Pb),uvTransform:new r.Sb(new r.cb),u_mvp:new r.Sb(new r.db),u_eyepos:new r.Sb(new r.Zb),u_eyepos_lowpart:new r.Sb(new r.Zb)},this.isHighPrecisionPointMaterial=!0,void 0!==e&&(void 0!==e.color&&this.color.set(e.color),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.size&&(this.size=e.size),void 0!==e.scale&&(this.scale=e.scale),void 0!==e.uvTransform&&(this.uvTransform=e.uvTransform),void 0!==e.map&&(this.map=e.map))}get scale(){return this.uniforms.scale.value}set scale(e){this.uniforms.scale.value=e}get uvTransform(){return this.uniforms.uvTransform.value}set uvTransform(e){this.uniforms.uvTransform.value=e}}k.DEFAULT_COLOR=80,k.DEFAULT_OPACITY=1,k.DEFAULT_SIZE=1,k.DEFAULT_SCALE=1;const j="\nattribute vec4 position;\nattribute vec4 color;\nattribute vec2 uv;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\n\nvarying vec4 vColor;\nvarying vec2 vUv;\n\nvoid main() {\n    vUv = uv;\n    vColor = color;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xyz, 1.0);\n}",N="\nprecision highp float;\nprecision highp int;\n\nuniform sampler2D map;\n\nvarying vec4 vColor;\nvarying vec2 vUv;\n\nvoid main() {\n\n    vec4 color = texture2D(map, vUv.xy);\n    color *= vColor.a;\n    if (color.a < 0.05) {\n        discard;\n    }\n    gl_FragColor = color;\n}";class G extends r.Db{constructor(e){super({name:"IconMaterial",vertexShader:j,fragmentShader:N,uniforms:{map:new r.Sb(e.map)},depthTest:!0,depthWrite:!0,transparent:!0,vertexColors:r.bc,premultipliedAlpha:!0,blending:r.nb})}get map(){return this.uniforms.map.value}}const U={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new r.l(0)},defaultOpacity:{value:0}},vertexShader:"\n    varying vec2 vUv;\n    void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    }",fragmentShader:"\n    uniform sampler2D tDiffuse;\n    uniform vec3 defaultColor;\n    uniform float defaultOpacity;\n    uniform float luminosityThreshold;\n    uniform float smoothWidth;\n    varying vec2 vUv;\n    void main() {\n        vec4 texel = texture2D( tDiffuse, vUv );\n        vec3 luma = vec3( 0.299, 0.587, 0.114 );\n        float v = dot( texel.xyz, luma );\n        vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n        float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n        gl_FragColor = mix( outputColor, texel, alpha );\n    }"};class B extends r.Lb{constructor(e){super({uniforms:e,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,premultipliedAlpha:!0,transparent:!0,blending:r.a,depthTest:!1,depthWrite:!1})}}const q={uniforms:{tDiffuse:{value:null},amount:{value:1}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }",fragmentShader:"\n        uniform float amount;\n        uniform sampler2D tDiffuse;\n        varying vec2 vUv;\n        void main() {\n            vec4 color = texture2D( tDiffuse, vUv );\n            vec3 c = color.rgb;\n            color.r = dot( c, vec3( 1.0 - 0.607 * amount, 0.769 * amount, 0.189 * amount ) );\n            color.g = dot( c, vec3( 0.349 * amount, 1.0 - 0.314 * amount, 0.168 * amount ) );\n            color.b = dot( c, vec3( 0.272 * amount, 0.534 * amount, 1.0 - 0.869 * amount ) );\n            gl_FragColor = vec4( min( vec3( 1.0 ), color.rgb ), color.a );\n        }"},V={Square:"CAPS_SQUARE",Round:"CAPS_ROUND",None:"CAPS_NONE",TriangleIn:"CAPS_TRIANGLE_IN",TriangleOut:"CAPS_TRIANGLE_OUT"},W="\n#define SEGMENT_OFFSET 0.1\n\nattribute vec3 extrusionCoord;\nattribute vec3 position;\nattribute vec4 bitangent;\nattribute vec3 tangent;\nattribute vec2 uv;\nattribute vec3 normal;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform float lineWidth;\nuniform float outlineWidth;\nuniform vec2 drawRange;\n\n#ifdef USE_DISPLACEMENTMAP\nuniform sampler2D displacementMap;\n#endif\n\nvarying vec3 vPosition;\nvarying vec3 vRange;\nvarying vec4 vCoords;\n#if USE_COLOR\nattribute vec3 color;\nvarying vec3 vColor;\n#endif\n\n#ifdef USE_FADING\n#include <fading_pars_vertex>\n#endif\n\n#include <fog_pars_vertex>\n\n#include <extrude_line_vert_func>\n\nvoid main() {\n    // Calculate the segment.\n    vec2 segment = abs(extrusionCoord.xy) - SEGMENT_OFFSET;\n    float segmentPos = sign(extrusionCoord.x) / 2.0 + 0.5;\n\n    // Calculate the vertex position inside the line (segment) and extrusion direction and factor.\n    float linePos = mix(segment.x, segment.y, segmentPos);\n    vec2 extrusionDir = sign(extrusionCoord.xy);\n    float extrusionFactor = extrusionDir.y * tan(bitangent.w / 2.0);\n\n    // Calculate the extruded vertex position (and scale the extrusion direction).\n    vec3 pos = extrudeLine(\n        position, linePos, lineWidth + outlineWidth, bitangent, tangent, extrusionDir);\n\n    // Store the normalized extrusion coordinates in vCoords (with their ranges in vRange).\n    vRange = vec3(extrusionCoord.z, lineWidth, extrusionFactor);\n    vCoords = vec4(extrusionDir / vRange.xy, segment / vRange.x);\n\n    // Adjust the segment to fit the drawRange.\n    float capDist = (lineWidth + outlineWidth) / extrusionCoord.z;\n    if ((vCoords.w + capDist) < drawRange.x || (vCoords.z - capDist) > drawRange.y) {\n        vCoords.zw += 1.0;\n    }\n    if (vCoords.z < drawRange.x) {\n        vCoords.zw += vec2(drawRange.x - vCoords.z, 0.0);\n    }\n    if (vCoords.w > drawRange.y) {\n        vCoords.zw -= vec2(0.0, vCoords.w - drawRange.y);\n    }\n\n    // Transform position.\n    #ifdef USE_DISPLACEMENTMAP\n    pos += normalize( normal ) * texture2D( displacementMap, uv ).x;\n    #endif\n    vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n    gl_Position = projectionMatrix * mvPosition;\n\n    // Pass extruded position to fragment shader.\n    vPosition = pos;\n\n    #if USE_COLOR\n    // Pass vertex color to fragment shader.\n    vColor = color;\n    #endif\n\n    #ifdef USE_FADING\n    #include <fading_vertex>\n    #endif\n\n    #include <fog_vertex>\n}",Z="\nprecision highp float;\nprecision highp int;\n\nuniform vec3 diffuse;\nuniform vec3 outlineColor;\nuniform float opacity;\nuniform float lineWidth;\nuniform float outlineWidth;\nuniform vec2 tileSize;\nuniform vec2 drawRange;\n\n#if DASHED_LINE\nuniform float dashSize;\nuniform float gapSize;\nuniform vec3 dashColor;\n#endif\n\nvarying vec3 vPosition;\nvarying vec3 vRange;\nvarying vec4 vCoords;\n#if USE_COLOR\nvarying vec3 vColor;\n#endif\n\n#include <round_edges_and_add_caps>\n#include <tile_clip_func>\n\n#ifdef USE_FADING\n#include <fading_pars_fragment>\n#endif\n\n#include <fog_pars_fragment>\n\nvoid main() {\n    float alpha = opacity;\n    vec3 outputDiffuse = diffuse;\n\n    #if TILE_CLIP\n    tileClip(vPosition.xy, tileSize);\n    #endif\n\n    // Calculate distance to center (0.0: lineCenter, 1.0: lineEdge).\n    float distToCenter = roundEdgesAndAddCaps(vCoords, vRange);\n    // Calculate distance to edge (-1.0: lineCenter, 0.0: lineEdge).\n    float distToEdge = distToCenter - (lineWidth + outlineWidth) / lineWidth;\n\n    // Decrease the line opacity by the distToEdge, making the transition steeper when the slope\n    // of distToChange increases (i.e. the line is further away).\n    float width = fwidth(distToEdge);\n    alpha *= (1.0 - smoothstep(-width, width, distToEdge));\n\n    #if DASHED_LINE\n    // Compute the distance to the dash origin (0.0: dashOrigin, 1.0: dashEnd, (d+g)/d: gapEnd).\n    float d = dashSize / vRange.x;\n    float g = gapSize / vRange.x;\n    float distToDashOrigin = mod(vCoords.x, d + g) / d;\n\n    // Compute distance to dash edge (0.5: dashCenter, 0.0: dashEdge) and compute the\n    // dashBlendFactor similarly on how we did it for the line opacity.\n    float distToDashEdge = 0.5 - distance(distToDashOrigin, (d + g) / d * 0.5);\n    float dashWidth = fwidth(distToDashEdge);\n    float dashBlendFactor = 1.0 - smoothstep(-dashWidth, dashWidth, distToDashEdge);\n\n    #if USE_DASH_COLOR\n    outputDiffuse = mix(diffuse, dashColor, dashBlendFactor);\n    #endif\n    #endif\n\n    #ifdef USE_OUTLINE\n    // Calculate distance to outline (0.0: lineEdge, outlineWidth/lineWidth: outlineEdge) and\n    // compute the outlineBlendFactor (used to mix line and outline colors).\n    float distToOutline = distToCenter - 1.0;\n    float outlineWidth = fwidth(distToOutline);\n    float outlineBlendFactor = smoothstep(-outlineWidth, outlineWidth, distToOutline);\n\n    // Mix the colors using the different computed factors.\n    #if DASHED_LINE && USE_DASH_COLOR == 0\n    float colorBlendFactor = smoothstep(-1.0, 1.0, dashBlendFactor - outlineBlendFactor);\n    outputDiffuse = mix(\n      mix(\n        mix(outlineColor, diffuse, colorBlendFactor),\n        outputDiffuse,\n        dashBlendFactor\n      ),\n      outlineColor,\n      outlineBlendFactor\n    );\n    #else\n    outputDiffuse = mix(outputDiffuse, outlineColor, outlineBlendFactor);\n    #endif\n    #endif\n\n    // Multiply the alpha by the dashBlendFactor.\n    #if DASHED_LINE && defined(USE_OUTLINE) && USE_DASH_COLOR == 0\n    alpha *= clamp(dashBlendFactor + outlineBlendFactor, 0.0, 1.0);\n    #elif DASHED_LINE && USE_DASH_COLOR == 0\n    alpha *= 1.0 - dashBlendFactor;\n    #endif\n\n    #if USE_COLOR\n    gl_FragColor = vec4( outputDiffuse * vColor, alpha );\n    #else\n    gl_FragColor = vec4( outputDiffuse, alpha );\n    #endif\n\n    #include <fog_fragment>\n\n    #ifdef USE_FADING\n    #include <fading_fragment>\n    #endif\n}";class $ extends r.Db{constructor(e){Object.assign(r.Jb,O),_.patchGlobalShaderChunks();const t={DASHED_LINE:0,TILE_CLIP:0,USE_COLOR:0,USE_DASH_COLOR:0,CAPS_SQUARE:0,CAPS_ROUND:1,CAPS_NONE:0,CAPS_TRIANGLE_IN:0,CAPS_TRIANGLE_OUT:0},i=void 0!==e&&!0===e.fog;i&&(t.USE_FOG="");const n=void 0!==e&&void 0!==e.displacementMap;n&&(t.USE_DISPLACEMENTMAP=""),void 0!==e&&void 0!==e.outlineWidth&&e.outlineWidth>0&&(t.USE_OUTLINE=""),super({name:"SolidLineMaterial",vertexShader:W,fragmentShader:Z,uniforms:r.Ub.merge([{diffuse:new r.Sb(new r.l($.DEFAULT_COLOR)),dashColor:new r.Sb(new r.l($.DEFAULT_COLOR)),outlineColor:new r.Sb(new r.l($.DEFAULT_COLOR)),lineWidth:new r.Sb($.DEFAULT_WIDTH),outlineWidth:new r.Sb($.DEFAULT_OUTLINE_WIDTH),opacity:new r.Sb($.DEFAULT_OPACITY),tileSize:new r.Sb(new r.Yb),fadeNear:new r.Sb(_.DEFAULT_FADE_NEAR),fadeFar:new r.Sb(_.DEFAULT_FADE_FAR),displacementMap:new r.Sb(n?e.displacementMap:new r.Pb),drawRange:new r.Sb(new r.Yb($.DEFAULT_DRAW_RANGE_START,$.DEFAULT_DRAW_RANGE_END)),dashSize:new r.Sb($.DEFAULT_DASH_SIZE),gapSize:new r.Sb($.DEFAULT_GAP_SIZE)},r.Tb.fog]),defines:t,fog:!0}),o(this),this.extensions.derivatives=!0,void 0!==e&&(void 0!==e.color&&this.color.set(e.color),void 0!==e.outlineColor&&this.outlineColor.set(e.outlineColor),void 0!==e.lineWidth&&(this.lineWidth=e.lineWidth),void 0!==e.outlineWidth&&(this.outlineWidth=e.outlineWidth),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.depthTest&&(this.depthTest=e.depthTest),void 0!==e.depthWrite&&(this.depthWrite=e.depthWrite),void 0!==e.fadeNear&&(this.fadeNear=e.fadeNear),void 0!==e.fadeFar&&(this.fadeFar=e.fadeFar),void 0!==e.displacementMap&&(this.displacementMap=e.displacementMap),void 0!==e.caps&&(this.caps=e.caps),void 0!==e.drawRangeStart&&(this.drawRangeStart=e.drawRangeStart),void 0!==e.drawRangeEnd&&(this.drawRangeEnd=e.drawRangeEnd),void 0!==e.dashColor&&(this.dashColor.set(e.dashColor),this.defines.USE_DASH_COLOR=1),void 0!==e.dashSize&&(this.dashSize=e.dashSize),void 0!==e.gapSize&&(this.gapSize=e.gapSize),this.fog=i)}updateFog(e){e?(this.needsUpdate=void 0===this.defines.USE_FOG,this.defines.USE_FOG=""):(this.needsUpdate=void 0!==this.defines.USE_FOG,delete this.defines.USE_FOG)}updateOutline(e){e?this.defines.USE_OUTLINE="":delete this.defines.USE_OUTLINE}get opacity(){return this.uniforms.opacity.value}set opacity(e){void 0!==this.uniforms&&(this.uniforms.opacity.value=e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get outlineColor(){return this.uniforms.outlineColor.value}set outlineColor(e){this.uniforms.outlineColor.value=e}get dashColor(){return this.uniforms.dashColor.value}set dashColor(e){this.uniforms.dashColor.value=e,this.defines.USE_DASH_COLOR=1}get lineWidth(){return this.uniforms.lineWidth.value}set lineWidth(e){this.uniforms.lineWidth.value=e}get outlineWidth(){return this.uniforms.outlineWidth.value}set outlineWidth(e){this.uniforms.outlineWidth.value=e,this.updateOutline(e>0)}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e,this.defines.DASHED_LINE=this.gapSize>0?1:0}get caps(){let e="Round";return 1===this.defines.CAPS_SQUARE?e="Square":1===this.defines.CAPS_NONE?e="None":1===this.defines.CAPS_ROUND?e="Round":1===this.defines.CAPS_TRIANGLE_IN?e="TriangleIn":1===this.defines.CAPS_TRIANGLE_OUT&&(e="TriangleOut"),e}set caps(e){this.defines.CAPS_SQUARE=0,this.defines.CAPS_ROUND=0,this.defines.CAPS_NONE=0,this.defines.CAPS_TRIANGLE_IN=0,this.defines.CAPS_TRIANGLE_OUT=0,this.defines[V[e]]=1}get fadeNear(){return this.uniforms.fadeNear.value}set fadeNear(e){this.uniforms.fadeNear.value=e}get fadeFar(){return this.uniforms.fadeFar.value}set fadeFar(e){const t=this.uniforms.fadeFar.value;this.uniforms.fadeFar.value=e,void 0!==t&&t>0?this.defines.USE_FADING="":delete this.defines.USE_FADING}get displacementMap(){return this.uniforms.displacementMap.value}set displacementMap(e){this.uniforms.displacementMap.value=e,void 0!==e?(this.uniforms.displacementMap.value.needsUpdate=!0,this.defines.USE_DISPLACEMENTMAP=""):delete this.defines.USE_DISPLACEMENTMAP,this.needsUpdate=!0}get drawRangeStart(){return this.uniforms.drawRange.value.x}set drawRangeStart(e){this.uniforms.drawRange.value.x=e}get drawRangeEnd(){return this.uniforms.drawRange.value.y}set drawRangeEnd(e){this.uniforms.drawRange.value.y=e}}$.DEFAULT_COLOR=16711680,$.DEFAULT_WIDTH=1,$.DEFAULT_OUTLINE_WIDTH=0,$.DEFAULT_OPACITY=1,$.DEFAULT_DRAW_RANGE_START=0,$.DEFAULT_DRAW_RANGE_END=1,$.DEFAULT_DASH_SIZE=1,$.DEFAULT_GAP_SIZE=1;const H={uniforms:{tDiffuse:{value:null},offset:{value:1},darkness:{value:1}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }",fragmentShader:"\n        uniform float offset;\n        uniform float darkness;\n        uniform sampler2D tDiffuse;\n        varying vec2 vUv;\n        void main() {\n            vec4 texel = texture2D( tDiffuse, vUv );\n            vec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );\n            gl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );\n        }"};var K=i(2);const X={type:"update"};class Y extends r.z{constructor(e,t,i,n,r){super(),this.enabled=!0,this.cacheable=!1,this.useGeometryLoader=!1,this.addGroundPlane=!1,this.m_minZoomLevel=1,this.m_maxZoomLevel=20,this.m_maxGeometryHeight=0,this.m_storageLevelOffset=0,void 0!==e&&0!==e.length||(e=`anonymous-datasource#${++Y.uniqueNameCounter}`),this.name=e,this.styleSetName=t,void 0!==i&&(this.m_minZoomLevel=i),void 0!==n&&(this.m_maxZoomLevel=n),void 0!==r&&(this.m_storageLevelOffset=r)}get styleSetName(){return this.m_styleSetName}set styleSetName(e){this.m_styleSetName=e,void 0!==this.m_mapView&&void 0!==e&&this.setTheme(this.m_mapView.theme)}dispose(){}clearCache(){}ready(){return!0}get mapView(){if(void 0===this.m_mapView)throw new Error("This DataSource was not added to MapView");return this.m_mapView}get projection(){return this.mapView.projection}async connect(){}attach(e){this.m_mapView=e}detach(e){Object(p.l)(this.m_mapView===e),this.m_mapView=void 0}setStyleSet(e,t,i){}setTheme(e,t){}setLanguages(e){}updateTile(e){}shouldPreloadTiles(){return!1}get minZoomLevel(){return this.m_minZoomLevel}set minZoomLevel(e){this.m_minZoomLevel=e}get maxZoomLevel(){return this.m_maxZoomLevel}set maxZoomLevel(e){this.m_maxZoomLevel=e}get maxGeometryHeight(){return this.m_maxGeometryHeight}set maxGeometryHeight(e){this.m_maxGeometryHeight=e}get storageLevelOffset(){return this.m_storageLevelOffset}set storageLevelOffset(e){this.m_storageLevelOffset=e}setEnableElevationOverlay(e){}getDisplayZoomLevel(e){return r.bb.clamp(e+this.m_storageLevelOffset,this.m_minZoomLevel,this.m_maxZoomLevel)}canGetTile(e,t){return t.level<=e}shouldSubdivide(e,t){return t.level<=e}shouldRenderText(e,t){return!0}requestUpdate(){this.dispatchEvent(X)}}Y.uniqueNameCounter=0;var J,Q=i(28);!function(e){let t;e.whiteSpaceRanges=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]],e.isWhiteSpace=function(t){for(const i of e.whiteSpaceRanges)if(t>=i[0]&&t<=i[1])return!0;return!1},e.newLineRanges=[[10,13],[133,133],[8232,8233]],e.isNewLine=function(t){for(const i of e.newLineRanges)if(t>=i[0]&&t<=i[1])return!0;return!1},e.nonPrintableRanges=[[0,31],[127,159]],e.isPrintable=function(t){for(const i of e.nonPrintableRanges)if(t>=i[0]&&t<=i[1])return!1;return!0},function(e){e[e.Neutral=0]="Neutral",e[e.Weak=.5]="Weak",e[e.LTR=1]="LTR",e[e.RTL=-1]="RTL"}(t=e.Direction||(e.Direction={})),e.rtlBlocks=["Hebrew","Alphabetic Presentation Forms","Arabic","Arabic Supplement","Arabic Extended-A","Arabic Presentation Forms-A","Arabic Presentation Forms-B","Arabic Mathematical Alphabetic Symbols","Indic Siyaq Numbers","Rumi Numeral Symbols","Syriac","Syriac Supplement","Samaritan","Mandaic","Thaana","Mende Kikakui","NKo","Adlam","Hanifi Rohingya"],e.neutralBidirectionalRanges=[[32,47],[58,64],[91,96],[123,126]],e.weakBidirectionalRanges=[[48,57],[1632,1641],[1776,1785]],e.getDirection=function(i,n){for(const n of e.weakBidirectionalRanges)if(i>=n[0]&&i<=n[1])return t.Weak;for(const n of e.neutralBidirectionalRanges)if(i>=n[0]&&i<=n[1])return t.Neutral;return void 0!==e.rtlBlocks.find(e=>e===n)?t.RTL:t.LTR},e.rtlMirroredCodePoints=[40,41,60,62,91,93,123,125],e.isRtlMirrored=function(t){return void 0!==e.rtlMirroredCodePoints.find(e=>e===t)}}(J||(J={}));class ee{constructor(e,t,i,n,s,o,a,l,h,c,d,m,u){this.codePoint=e,this.block=t,this.width=i,this.height=n,this.advanceX=s,this.offsetX=o,this.offsetY=a,this.texture=m,this.font=u,this.positions=[],this.sourceTextureCoordinates=[],this.dynamicTextureCoordinates=[],this.copyIndex=0,this.isInCache=!1,this.character=String.fromCodePoint(e),this.direction=J.getDirection(e,t);const p=this.offsetX,f=p+this.width,g=u.metrics.lineHeight-this.offsetY,v=g-this.height;this.positions.push(new r.Zb(p,v,1),new r.Zb(f,v,1),new r.Zb(p,g,1),new r.Zb(f,g,1)),this.sourceTextureCoordinates.push(new r.Yb(l,h),new r.Yb(c,h),new r.Yb(l,d),new r.Yb(c,d)),this.dynamicTextureCoordinates.push(new r.Yb(0,0),new r.Yb(1,0),new r.Yb(0,1),new r.Yb(1,1))}clone(){return new ee(this.codePoint,this.block,this.width,this.height,this.advanceX,this.offsetX,this.offsetY,this.sourceTextureCoordinates[0].x,this.sourceTextureCoordinates[0].y,this.sourceTextureCoordinates[3].x,this.sourceTextureCoordinates[3].y,this.texture,this.font)}}class te{constructor(e,t,i,n,r){this.key=e,this.value=t,this.size=i,this.newer=n,this.older=r}}class ie{constructor(e,t=(()=>1)){this.m_size=0,this.m_map=new Map,this.m_newest=null,this.m_oldest=null,this.m_capacity=e,this.m_sizeFunction=t}forEach(e,t){let i=this.m_newest;for(;null!==i;){const n=i.older;e.call(t,i.value,i.key,this),i=n}}get size(){return this.m_size}get capacity(){return this.m_capacity}get map(){return this.m_map}get newest(){return this.m_newest}get oldest(){return this.m_oldest}setCapacity(e){this.m_capacity=e,this.evict()}setCapacityAndMeasure(e,t=(()=>1)){this.m_capacity=e,this.m_sizeFunction=t,this.shrinkToCapacity()}shrinkToCapacity(){let e=0;const t=this.m_sizeFunction;let i=this.m_newest;for(;null!==i;){const n=t(i.value);i.size=n,e+=n,i=i.older}this.m_size=e,this.evict()}set(e,t){const i=this.m_sizeFunction(t);let n=this.m_map.get(e);if(void 0!==n)this.m_size=this.m_size-n.size+i,n.value=t,n.size=i,this.promoteEntry(n),this.evict();else{if(i>this.m_capacity)return;if(n=new te(e,t,i,null,null),0===this.m_map.size)this.m_newest=this.m_oldest=n;else{Object(p.l)(null!==this.m_newest);const e=this.m_newest;n.older=this.m_newest,e.newer=n,this.m_newest=n}this.m_map.set(e,n),this.m_size+=i,this.evict()}}get(e){const t=this.m_map.get(e);if(void 0!==t)return this.promoteEntry(t),t.value}has(e){return this.m_map.has(e)}clear(){this.m_newest=this.m_oldest=null,this.m_size=0,this.m_map.clear()}evictAll(){const e=this.evictionCallback;void 0!==e&&this.forEach((t,i)=>e(i,t)),this.clear()}evictSelected(e,t){const i=this.evictionCallback;let n=this.m_newest;for(;null!==n;){const r=n.older;e.call(t,n.value,n.key)&&(void 0!==i&&i(n.key,n.value),this.deleteEntry(n),this.m_map.delete(n.key)),n=r}}delete(e){const t=this.m_map.get(e);return void 0!==t&&(this.deleteEntry(t),this.m_map.delete(e))}evict(){for(;null!==this.m_oldest&&this.m_size>this.m_capacity;){if(void 0===this.evictOldest())return}}evictOldest(){Object(p.l)(null!==this.m_oldest);const e=this.m_oldest;Object(p.l)(null===e.older);let t=e;if(void 0!==this.canEvict)for(;!this.canEvict(t.key,t.value);){if(null===t.newer)return;t=t.newer}if(t===e)this.m_oldest=t.newer,null!==t.newer&&(Object(p.l)(t.newer.older===t),t.newer.older=null);else{if(null===t.newer)return;Object(p.l)(t.newer.older===t),t.newer.older=t.older,null!==t.older&&(t.older.newer=t.newer)}const i=this.m_map.delete(t.key);return Object(p.l)(!0===i),i&&void 0!==this.evictionCallback&&this.evictionCallback(t.key,t.value),this.m_size-=t.size,t}deleteEntry(e){e===this.m_newest?this.m_newest=e.older:e.newer?e.newer.older=e.older:Object(p.l)(!1),e===this.m_oldest?this.m_oldest=e.newer:e.older?e.older.newer=e.newer:Object(p.l)(!1),this.m_size-=e.size}promoteEntry(e){if(e===this.m_newest)return;e.newer&&(Object(p.l)(e.newer.older===e),e.newer.older=e.older),e.older&&(Object(p.l)(e.older.newer===e),e.older.newer=e.newer),e===this.m_oldest&&(this.m_oldest=e.newer),e.newer=null,e.older=this.m_newest,Object(p.l)(null!==this.m_newest);const t=this.m_newest;Object(p.l)(null===t.newer),t.newer=e,this.m_newest=e}}const ne={sdf_attributes:"\n        attribute vec4 position;\n        attribute vec4 uv;\n        attribute vec4 color;\n        attribute vec4 bgColor;\n        ",sdf_varying:"\n        varying vec4 vColor;\n        varying float vWeight;\n        varying vec2 vUv;\n        varying float vRotation;\n        ",sdf_varying_computation:"\n        #if BG_TEXT\n        vColor = bgColor;\n        vWeight = uv.w;\n        #else\n        vColor = color;\n        vWeight = uv.z;\n        #endif\n        vUv = vec2(uv.xy);\n        vRotation = position.w;\n        ",sdf_frag_uniforms:"\n        uniform sampler2D sdfTexture;\n        uniform vec4 sdfParams;\n        ",sdf_sampling_functions:"\n        float median(float r, float g, float b) {\n            return max(min(r, g), min(max(r, g), b));\n        }\n\n        float getDistance(vec2 uvOffset) {\n            vec3 sample = texture2D(sdfTexture, vUv.xy + uvOffset).rgb;\n            #if MSDF\n            return median(sample.r, sample.g, sample.b);\n            #else\n            return sample.r;\n            #endif\n        }\n\n        float getOpacity(vec2 uvOffset, float weight) {\n            vec2 uv = vUv + uvOffset;\n            vec2 rotatedUVs = abs(vec2(\n                cos(vRotation) * uv.x - sin(vRotation) * uv.y,\n                sin(vRotation) * uv.x + cos(vRotation) * uv.y));\n\n            float dx = dFdx(rotatedUVs.x) * sdfParams.x;\n            float dy = dFdy(rotatedUVs.y) * sdfParams.y;\n            float toPixels = sdfParams.w * inversesqrt( dx * dx + dy * dy );\n\n            float dist = getDistance(uvOffset) + min(weight, 0.5 - 1.0 / sdfParams.w) - 0.5;\n            return clamp(dist * toPixels + 0.5, 0.0, 1.0);\n        }\n        "};Object.assign(r.Jb,ne);const re="\n    attribute vec2 position;\n\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n\n    void main() {\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xy, 0.0, 1.0);\n    }",se="\n    precision highp float;\n    precision highp int;\n\n    void main() {\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n    }",oe="\n    attribute vec3 position;\n    attribute vec2 uv;\n\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n\n    varying vec3 vUv;\n\n    void main() {\n        vUv = vec3(uv.xy, position.z);\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xy, 0.0, 1.0);\n    }",ae="\n    precision highp float;\n    precision highp int;\n\n    uniform float pageOffset;\n    uniform sampler2D page0;\n    uniform sampler2D page1;\n    uniform sampler2D page2;\n    uniform sampler2D page3;\n    uniform sampler2D page4;\n    uniform sampler2D page5;\n    uniform sampler2D page6;\n    uniform sampler2D page7;\n\n    varying vec3 vUv;\n\n    void main() {\n        vec4 sample = vec4(0.0);\n        if (vUv.z < pageOffset || vUv.z > (pageOffset + 7.0)) discard;\n        else if (vUv.z < pageOffset + 1.0) sample = texture2D(page0, vUv.xy);\n        else if (vUv.z < pageOffset + 2.0) sample = texture2D(page1, vUv.xy);\n        else if (vUv.z < pageOffset + 3.0) sample = texture2D(page2, vUv.xy);\n        else if (vUv.z < pageOffset + 4.0) sample = texture2D(page3, vUv.xy);\n        else if (vUv.z < pageOffset + 5.0) sample = texture2D(page4, vUv.xy);\n        else if (vUv.z < pageOffset + 6.0) sample = texture2D(page5, vUv.xy);\n        else if (vUv.z < pageOffset + 7.0) sample = texture2D(page6, vUv.xy);\n        else sample = texture2D(page7, vUv.xy);\n\n        gl_FragColor = sample;\n    }",le="\n    #include <sdf_attributes>\n    #include <sdf_varying>\n\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n\n    void main() {\n        #include <sdf_varying_computation>\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xyz, 1.0);\n    }",he="\n    precision highp float;\n    precision highp int;\n\n    #include <sdf_varying>\n    #include <sdf_frag_uniforms>\n    #include <sdf_sampling_functions>\n\n    void main() {\n        vec4 color = vColor;\n        color.a *= getOpacity(vec2(0.0), vWeight);\n        if (color.a < 0.05) {\n            discard;\n        }\n        gl_FragColor = color;\n    }";class ce extends r.Db{constructor(){super({name:"GlyphClearMaterial",vertexShader:re,fragmentShader:se,uniforms:{},depthTest:!1,depthWrite:!1})}}class de extends r.Db{constructor(){super({name:"GlyphCopyMaterial",vertexShader:oe,fragmentShader:ae,uniforms:{pageOffset:new r.Sb(0),page0:new r.Sb(r.Pb.DEFAULT_IMAGE),page1:new r.Sb(r.Pb.DEFAULT_IMAGE),page2:new r.Sb(r.Pb.DEFAULT_IMAGE),page3:new r.Sb(r.Pb.DEFAULT_IMAGE),page4:new r.Sb(r.Pb.DEFAULT_IMAGE),page5:new r.Sb(r.Pb.DEFAULT_IMAGE),page6:new r.Sb(r.Pb.DEFAULT_IMAGE),page7:new r.Sb(r.Pb.DEFAULT_IMAGE)},depthTest:!1,depthWrite:!1})}}class me extends r.Db{constructor(e){super({name:"SdfTextMaterial",vertexShader:void 0!==e.vertexSource?e.vertexSource:le,fragmentShader:void 0!==e.fragmentSource?e.fragmentSource:he,uniforms:{sdfTexture:new r.Sb(e.texture),sdfParams:new r.Sb(new r.ac(e.textureSize.x,e.textureSize.y,e.size,e.distanceRange))},defines:{MSDF:e.isMsdf?1:0,BG_TEXT:e.isBackground?1:0},depthTest:!0,depthWrite:!0,side:r.v,transparent:!0}),this.extensions.derivatives=!0}}const ue=8,pe=4096;class fe{constructor(e,t,i){this.capacity=e,this.entryWidth=t,this.entryHeight=i;const n=Math.floor(Math.sqrt(e));this.m_cacheHeight=n*n<e?n+1:n,this.m_cacheWidth=n*this.m_cacheHeight<e?n+1:n,this.m_textureSize=new r.Yb(this.m_cacheWidth*t,this.m_cacheHeight*i),(this.m_textureSize.y>pe||this.m_textureSize.x>pe)&&console.warn("GlyphTextureCache texture size ("+this.m_textureSize.x+", "+this.m_textureSize.y+") exceeds WebGL's widely supported MAX_TEXTURE_SIZE ("+pe+").\nThis could result in rendering errors on some devices.\nPlease consider reducing its capacity or input assets size."),this.m_entryCache=new ie(e),this.initCacheEntries(),this.m_scene=new r.Ib,this.m_camera=new r.rb(0,this.m_textureSize.x,this.m_textureSize.y,0),this.m_camera.position.z=1,this.m_camera.updateMatrixWorld(!1),this.m_rt=new r.cc(this.m_textureSize.x,this.m_textureSize.y,{wrapS:r.k,wrapT:r.k,depthBuffer:!1,stencilBuffer:!1}),this.m_copyTextureSet=new Set,this.m_copyTransform=new r.cb,this.m_copyPositions=[],this.m_copyPositions.push(new r.Yb,new r.Yb,new r.Yb,new r.Yb),this.m_copyMaterial=new de,this.m_copyVertexBuffer=new r.J(new Float32Array(20*e),5),this.m_copyVertexBuffer.setUsage(r.w),this.m_copyPositionAttribute=new r.K(this.m_copyVertexBuffer,3,0),this.m_copyUVAttribute=new r.K(this.m_copyVertexBuffer,2,3),this.m_copyGeometry=new r.i,this.m_copyGeometry.setAttribute("position",this.m_copyPositionAttribute),this.m_copyGeometry.setAttribute("uv",this.m_copyUVAttribute);const s=new r.h(new Uint32Array(6*e),1);s.setUsage(r.w),this.m_copyGeometry.setIndex(s),this.m_copyMesh=new r.eb(this.m_copyGeometry,this.m_copyMaterial),this.m_copyMesh.frustumCulled=!1,this.m_copyGeometryDrawCount=0,this.m_clearMaterial=new ce,this.m_clearPositionAttribute=new r.h(new Float32Array(8*e),2),this.m_clearPositionAttribute.setUsage(r.w),this.m_clearGeometry=new r.i,this.m_clearGeometry.setAttribute("position",this.m_clearPositionAttribute);const o=new r.h(new Uint32Array(6*e),1);o.setUsage(r.w),this.m_clearGeometry.setIndex(o),this.m_clearMesh=new r.eb(this.m_clearGeometry,this.m_clearMaterial),this.m_clearMesh.frustumCulled=!1,this.m_clearGeometryDrawCount=0,this.m_scene.add(this.m_clearMesh,this.m_copyMesh)}dispose(){this.m_entryCache.clear(),this.m_scene.remove(this.m_clearMesh,this.m_copyMesh),this.m_rt.dispose(),this.m_clearMaterial.dispose(),this.m_copyMaterial.dispose(),this.m_copyTextureSet.clear(),this.m_clearGeometry.dispose(),this.m_copyGeometry.dispose()}get texture(){return this.m_rt.texture}get textureSize(){return this.m_textureSize}add(e,t){if(void 0!==this.m_entryCache.get(e))return;const i=this.m_entryCache.oldest;if(null===i)throw new Error("GlyphTextureCache is uninitialized!");this.clearCacheEntry(i.value),this.copyGlyphToCache(e,t,i.value.location)}has(e){return this.m_entryCache.has(e)}get(e){return this.m_entryCache.get(e)}clear(){this.m_copyGeometryDrawCount=0,this.m_clearGeometryDrawCount=0,this.m_entryCache.clear(),this.m_copyTextureSet.clear(),this.initCacheEntries()}update(e){let t=null;const i=this.m_clearGeometryDrawCount>0,n=this.m_copyGeometryDrawCount>0;if((i||n)&&(t=e.getRenderTarget(),e.setRenderTarget(this.m_rt)),i){if(null===this.m_clearGeometry.index)throw new Error("GlyphTextureCache clear geometry index is uninitialized!");this.m_clearPositionAttribute.needsUpdate=!0,this.m_clearPositionAttribute.updateRange.offset=0,this.m_clearPositionAttribute.updateRange.count=8*this.m_clearGeometryDrawCount,this.m_clearGeometry.index.needsUpdate=!0,this.m_clearGeometry.index.updateRange.offset=0,this.m_clearGeometry.index.updateRange.count=6*this.m_clearGeometryDrawCount,this.m_clearGeometry.setDrawRange(0,6*this.m_clearGeometryDrawCount),this.m_clearMesh.visible=!0,this.m_copyMesh.visible=!1,e.render(this.m_scene,this.m_camera),this.m_clearGeometryDrawCount=0,this.m_clearMesh.visible=!1}if(n){if(null===this.m_copyGeometry.index)throw new Error("GlyphTextureCache copy geometry index is uninitialized!");this.m_copyVertexBuffer.needsUpdate=!0,this.m_copyVertexBuffer.updateRange.offset=0,this.m_copyVertexBuffer.updateRange.count=20*this.m_copyGeometryDrawCount,this.m_copyGeometry.index.needsUpdate=!0,this.m_copyGeometry.index.updateRange.offset=0,this.m_copyGeometry.index.updateRange.count=6*this.m_copyGeometryDrawCount,this.m_copyGeometry.setDrawRange(0,6*this.m_copyGeometryDrawCount),this.m_copyMesh.visible=!0;const t=Array.from(this.m_copyTextureSet),i=Math.ceil(this.m_copyTextureSet.size/ue);for(let n=0;n<i;n++){const i=n*ue;this.m_copyMaterial.uniforms.pageOffset.value=i;for(let e=0;e<ue;e++){const n=i+e;n<this.m_copyTextureSet.size&&(this.m_copyMaterial.uniforms["page"+e].value=t[n])}e.render(this.m_scene,this.m_camera)}this.m_copyTextureSet.clear(),this.m_copyGeometryDrawCount=0}(i||n)&&e.setRenderTarget(t)}initCacheEntries(){const e={name:"",metrics:{size:0,distanceRange:0,base:0,lineHeight:0,lineGap:0,capHeight:0,xHeight:0},charset:""},t=new ee(0,"",0,0,0,0,0,0,0,0,0,r.Pb.DEFAULT_IMAGE,e);for(let e=0;e<this.m_cacheHeight;e++)for(let i=0;i<this.m_cacheWidth;i++){const n={glyphData:t,location:new r.Yb(i,e)};this.m_entryCache.set(`Dummy_${e*this.m_cacheHeight+i}`,n)}}copyGlyphToCache(e,t,i){this.m_copyTextureSet.add(t.texture);let n=0;for(const e of this.m_copyTextureSet.values()){if(e===t.texture)break;n++}t.copyIndex=n,this.m_copyTransform.set(1,0,i.x*this.entryWidth-t.offsetX,0,1,i.y*this.entryHeight-t.positions[0].y,0,0,0);for(let e=0;e<4;++e)this.m_copyPositions[e].set(t.positions[e].x,t.positions[e].y),this.m_copyPositions[e].applyMatrix3(this.m_copyTransform);if(this.m_copyGeometryDrawCount>=this.capacity)return;const r=4*this.m_copyGeometryDrawCount,s=6*this.m_copyGeometryDrawCount;for(let e=0;e<4;++e)this.m_copyPositionAttribute.setXYZ(r+e,this.m_copyPositions[e].x,this.m_copyPositions[e].y,t.copyIndex),this.m_copyUVAttribute.setXY(r+e,t.sourceTextureCoordinates[e].x,t.sourceTextureCoordinates[e].y);if(null===this.m_copyGeometry.index)throw new Error("GlyphTextureCache copy geometry index is uninitialized!");this.m_copyGeometry.index.setX(s,r),this.m_copyGeometry.index.setX(s+1,r+1),this.m_copyGeometry.index.setX(s+2,r+2),this.m_copyGeometry.index.setX(s+3,r+2),this.m_copyGeometry.index.setX(s+4,r+1),this.m_copyGeometry.index.setX(s+5,r+3),++this.m_copyGeometryDrawCount;const o=this.m_copyPositions[0].x/this.m_textureSize.x,a=this.m_copyPositions[0].y/this.m_textureSize.y,l=this.m_copyPositions[3].x/this.m_textureSize.x,h=this.m_copyPositions[3].y/this.m_textureSize.y;t.dynamicTextureCoordinates[0].set(o,a),t.dynamicTextureCoordinates[1].set(l,a),t.dynamicTextureCoordinates[2].set(o,h),t.dynamicTextureCoordinates[3].set(l,h),t.isInCache=!0,this.m_entryCache.set(e,{glyphData:t,location:i})}clearCacheEntry(e){if(e.glyphData.isInCache=!1,this.m_copyPositions[0].set(e.location.x*this.entryWidth,e.location.y*this.entryHeight),this.m_copyPositions[1].set((e.location.x+1)*this.entryWidth,e.location.y*this.entryHeight),this.m_copyPositions[2].set(e.location.x*this.entryWidth,(e.location.y+1)*this.entryHeight),this.m_copyPositions[3].set((e.location.x+1)*this.entryWidth,(e.location.y+1)*this.entryHeight),this.m_clearGeometryDrawCount>=this.capacity)return;const t=4*this.m_clearGeometryDrawCount,i=6*this.m_clearGeometryDrawCount;for(let e=0;e<4;++e)this.m_clearPositionAttribute.setXY(t+e,this.m_copyPositions[e].x,this.m_copyPositions[e].y);if(null===this.m_clearGeometry.index)throw new Error("GlyphTextureCache clear geometry index is uninitialized!");this.m_clearGeometry.index.setX(i,t),this.m_clearGeometry.index.setX(i+1,t+1),this.m_clearGeometry.index.setX(i+2,t+2),this.m_clearGeometry.index.setX(i+3,t+2),this.m_clearGeometry.index.setX(i+4,t+1),this.m_clearGeometry.index.setX(i+5,t+3),++this.m_clearGeometryDrawCount}}var ge,ve,_e,ye,xe,be,we,Te;!function(e){e[e.Em=0]="Em",e[e.Pixel=1]="Pixel",e[e.Point=2]="Point",e[e.Percent=3]="Percent"}(ge||(ge={})),function(e){e[e.Regular=0]="Regular",e[e.Bold=1]="Bold",e[e.Italic=2]="Italic",e[e.BoldItalic=3]="BoldItalic"}(ve||(ve={})),function(e){e[e.Regular=0]="Regular",e[e.AllCaps=1]="AllCaps",e[e.SmallCaps=2]="SmallCaps"}(_e||(_e={})),function(e){e[e.Above=0]="Above",e[e.Center=-.5]="Center",e[e.Below=-1]="Below"}(ye||(ye={})),function(e){e[e.Left=0]="Left",e[e.Center=-.5]="Center",e[e.Right=-1]="Right"}(xe||(xe={})),function(e){e[e.None=0]="None",e[e.Character=1]="Character",e[e.Word=2]="Word"}(be||(be={})),(Te=we||(we={})).DEFAULT_FONT_NAME="",Te.DEFAULT_FONT_SIZE={unit:Object.freeze(ge.Pixel),size:Object.freeze(16),backgroundSize:Object.freeze(0)},Te.DEFAULT_FONT_STYLE=ve.Regular,Te.DEFAULT_FONT_VARIANT=_e.Regular,Te.DEFAULT_ROTATION=0,Te.DEFAULT_COLOR=new r.l(0),Te.DEFAULT_OPACITY=1,Te.DEFAULT_BACKGROUND_COLOR=new r.l(0),Te.DEFAULT_BACKGROUND_OPACITY=0,Te.DEFAULT_TRACKING=0,Te.DEFAULT_LEADING=0,Te.DEFAULT_MAX_LINES=1/0,Te.DEFAULT_LINE_WIDTH=1/0,Te.DEFAULT_CANVAS_ROTATION=0,Te.DEFAULT_LINE_ROTATION=0,Te.DEFAULT_WRAPPING_MODE=be.Word,Te.DEFAULT_VERTICAL_ALIGNMENT=ye.Above,Te.DEFAULT_HORIZONTAL_ALIGNMENT=xe.Left;class Se{constructor(e={}){this.m_params={fontName:void 0!==e.fontName?e.fontName:we.DEFAULT_FONT_NAME,fontSize:void 0!==e.fontSize?e.fontSize:{unit:we.DEFAULT_FONT_SIZE.unit,size:we.DEFAULT_FONT_SIZE.size,backgroundSize:we.DEFAULT_FONT_SIZE.backgroundSize},fontStyle:void 0!==e.fontStyle?e.fontStyle:we.DEFAULT_FONT_STYLE,fontVariant:void 0!==e.fontVariant?e.fontVariant:we.DEFAULT_FONT_VARIANT,rotation:void 0!==e.rotation?e.rotation:we.DEFAULT_ROTATION,color:void 0!==e.color?e.color:new r.l(we.DEFAULT_COLOR),opacity:void 0!==e.opacity?e.opacity:we.DEFAULT_OPACITY,backgroundColor:void 0!==e.backgroundColor?e.backgroundColor:new r.l(we.DEFAULT_BACKGROUND_COLOR),backgroundOpacity:void 0!==e.backgroundOpacity?e.backgroundOpacity:we.DEFAULT_BACKGROUND_OPACITY}}get params(){return this.m_params}set params(e){this.m_params={...this.m_params,...e}}get fontName(){return this.m_params.fontName}set fontName(e){this.m_params.fontName=e}get fontSize(){return this.m_params.fontSize}set fontSize(e){this.m_params.fontSize=e}get fontStyle(){return this.m_params.fontStyle}set fontStyle(e){this.m_params.fontStyle=e}get fontVariant(){return this.m_params.fontVariant}set fontVariant(e){this.m_params.fontVariant=e}get rotation(){return this.m_params.rotation}set rotation(e){this.m_params.rotation=e}get color(){return this.m_params.color}set color(e){this.m_params.color=e}get backgroundColor(){return this.m_params.backgroundColor}set backgroundColor(e){this.m_params.backgroundColor=e}get opacity(){return this.m_params.opacity}set opacity(e){this.m_params.opacity=e}get backgroundOpacity(){return this.m_params.backgroundOpacity}set backgroundOpacity(e){this.m_params.backgroundOpacity=e}clone(e={}){return new Se({...this.m_params,...e})}}class Ce{constructor(e={}){this.m_params={tracking:void 0!==e.tracking?e.tracking:we.DEFAULT_TRACKING,leading:void 0!==e.leading?e.leading:we.DEFAULT_LEADING,maxLines:void 0!==e.maxLines?e.maxLines:we.DEFAULT_MAX_LINES,lineWidth:void 0!==e.lineWidth?e.lineWidth:we.DEFAULT_LINE_WIDTH,canvasRotation:void 0!==e.canvasRotation?e.canvasRotation:we.DEFAULT_CANVAS_ROTATION,lineRotation:void 0!==e.lineRotation?e.lineRotation:we.DEFAULT_LINE_ROTATION,wrappingMode:void 0!==e.wrappingMode?e.wrappingMode:we.DEFAULT_WRAPPING_MODE,verticalAlignment:void 0!==e.verticalAlignment?e.verticalAlignment:we.DEFAULT_VERTICAL_ALIGNMENT,horizontalAlignment:void 0!==e.horizontalAlignment?e.horizontalAlignment:we.DEFAULT_HORIZONTAL_ALIGNMENT}}get params(){return this.m_params}set params(e){this.m_params={...this.m_params,...e}}get tracking(){return this.m_params.tracking}set tracking(e){this.m_params.tracking=e}get leading(){return this.m_params.leading}set leading(e){this.m_params.leading=e}get maxLines(){return this.m_params.maxLines}set maxLines(e){this.m_params.maxLines=e}get lineWidth(){return this.m_params.lineWidth}set lineWidth(e){this.m_params.lineWidth=e}get canvasRotation(){return this.m_params.canvasRotation}set canvasRotation(e){this.m_params.canvasRotation=e}get lineRotation(){return this.m_params.lineRotation}set lineRotation(e){this.m_params.lineRotation=e}get wrappingMode(){return this.m_params.wrappingMode}set wrappingMode(e){this.m_params.wrappingMode=e}get verticalAlignment(){return this.m_params.verticalAlignment}set verticalAlignment(e){this.m_params.verticalAlignment=e}get horizontalAlignment(){return this.m_params.horizontalAlignment}set horizontalAlignment(e){this.m_params.horizontalAlignment=e}clone(e={}){return new Ce({...this.m_params,...e})}}const Ee="_Assets/",Me="_BoldAssets/",Ae="_ItalicAssets/",Pe="_BoldItalicAssets/",Le="_Assets/Extra/";class Re{constructor(e,t,i,n,r,s,o,a,l,h,c){this.url=e,this.name=t,this.type=i,this.size=n,this.maxWidth=r,this.maxHeight=s,this.distanceRange=o,this.fonts=a,this.unicodeBlocks=l,this.maxCodePointCount=h,this.m_replacementGlyph=c,this.m_glyphTextureCache=new fe(h,this.maxWidth+1,this.maxHeight+1),this.m_loadingJson=new Map,this.m_loadingPages=new Map,this.m_loadingGlyphs=new Map,this.m_loadedJson=new Map,this.m_loadedPages=new Map,this.m_loadedGlyphs=new Map}static async load(e,t){const i=new URL(e,window.location.href),n=await Re.loadJSON(i.href),s=new URL(`${n.name}${Le}`,i),o=await Re.loadJSON(s.href+"Specials.json"),a=await Re.loadTexture(s.href+"Specials.png");a.wrapS=r.k,a.wrapT=r.k,a.minFilter=r.ib,a.needsUpdate=!0;const l=n.fonts.find(e=>"Extra"===e.name),h=new ee(65533,"Specials",o.chars[0].width,o.chars[0].height,o.chars[0].xadvance,o.chars[0].xoffset,o.chars[0].yoffset,0,0,1,1,a,l);return new Re(i.href.substr(0,i.href.lastIndexOf("/")),n.name,n.type,n.size,n.maxWidth,n.maxHeight,n.distanceRange,n.fonts,n.supportedBlocks,t,h)}static async loadTexture(e){return new Promise(t=>{(new r.Qb).load(e,t)})}static async loadJSON(e){const t=await fetch(e);if(!t.ok)throw new Error(`${e} Status Text:  ${t.statusText}`);const i=await t.text();return JSON.parse(i)}dispose(){this.fonts.length=0,this.unicodeBlocks.length=0,this.m_glyphTextureCache.dispose(),this.m_loadingJson.clear(),this.m_loadingPages.clear(),this.m_loadingGlyphs.clear(),this.m_loadedJson.clear(),this.m_loadedPages.clear(),this.m_loadedGlyphs.clear()}clear(){this.m_glyphTextureCache.clear(),this.m_loadingJson.clear(),this.m_loadingPages.clear(),this.m_loadingGlyphs.clear(),this.m_loadedJson.clear(),this.m_loadedPages.clear(),this.m_loadedGlyphs.clear()}update(e){this.m_glyphTextureCache.update(e)}get texture(){return this.m_glyphTextureCache.texture}get textureSize(){return this.m_glyphTextureCache.textureSize}get isLoading(){return this.m_loadingJson.size>0||this.m_loadingPages.size>0||this.m_loadingGlyphs.size>0}async loadBlock(e,t,i,n){const r=this.getAssetsPath(i,t),s=`${r}/${e.name.replace(/ /g,"_")}.json`;let o=this.m_loadedJson.get(s);if(void 0===o){let e=this.m_loadingJson.get(s);if(void 0===e)try{e=Re.loadJSON(s),this.m_loadingJson.set(s,e),o=await e,this.m_loadingJson.delete(s),this.m_loadedJson.set(s,o)}catch(e){console.error(e),this.m_loadingJson.delete(s)}else o=await e}const a=[];if(!0===n)for(const e of o.pages)a.push(this.loadPage(`${r}/${e}`));return await Promise.all(a),o}removeBlock(e,t,i){const n=this.getAssetsPath(i,t),r=`${n}/${e.name.replace(/ /g,"_")}.json`,s=this.m_loadedJson.get(r);if(void 0!==s){for(const e of s.pages){const t=`${n}/${e}`;this.m_loadingPages.delete(t),this.m_loadedPages.delete(t)}this.m_loadingJson.delete(r),this.m_loadedJson.delete(r)}}async loadCharset(e,t){const i=t.fontName,n=t.fontStyle,r=(t.fontVariant===_e.AllCaps||t.fontVariant===_e.SmallCaps?e.toUpperCase():e).replace(/[\s\S](?=([\s\S]+))/g,(e,t)=>t.indexOf(e)+1?"":e),s=[];for(const e of r){const t=e.codePointAt(0),r=this.getFont(t,i),o=`${r.name}_${n}`,a=`${o}_${t}`;let l=this.m_loadedGlyphs.get(o);void 0===l&&(l=new Map,this.m_loadedGlyphs.set(o,l));const h=l.get(t);if(void 0===h){let i=this.m_loadingGlyphs.get(a);if(void 0===i){if(-1===r.charset.indexOf(String.fromCodePoint(t))){const i=this.createReplacementGlyph(t,e,r);l.set(t,i),this.m_glyphTextureCache.add(a,i);continue}let s;for(const e of this.unicodeBlocks)if(t>=e.min&&t<=e.max){s=e;break}i=this.loadAssets(t,n,s,r),this.m_loadingGlyphs.set(a,i),i.then(e=>{this.m_loadingGlyphs.delete(a),l.set(t,e),this.m_glyphTextureCache.add(a,e)})}s.push(i)}else this.m_glyphTextureCache.has(a)||(s.push(Promise.resolve(h)),this.m_glyphTextureCache.add(a,h))}return Promise.all(s)}getGlyph(e,t,i){const n=this.m_loadedGlyphs.get(`${t.name}_${i}`);if(void 0!==n)return n.get(e)}getGlyphs(e,t,i){const n=[],r=t.fontName,s=t.fontStyle,o=t.fontVariant,a=o===_e.AllCaps||o===_e.SmallCaps;for(const t of e){const e=a?t.toUpperCase():t;for(const o of e){const e=o.codePointAt(0),a=this.getFont(e,r),l=this.getGlyph(e,a,s);if(void 0===l)return;n.push(l),void 0!==i&&i.push(o!==t)}}return n}getFont(e,t){let i=this.fonts[0].name;for(const n of this.unicodeBlocks)if(e>=n.min&&e<=n.max){i=void 0!==t&&void 0!==n.fonts.find(e=>e===t)?t:n.fonts[0];break}return this.fonts.find(e=>e.name===i)}updateMemoryUsage(e){let t=0;for(const e of this.unicodeBlocks)t+=2*(e.max-e.min);let i=this.m_glyphTextureCache.textureSize.x*this.m_glyphTextureCache.textureSize.y*4;for(const e in this.m_loadedPages.entries)if(void 0!==this.m_loadedPages.get(e)){const t=this.m_loadedPages.get(e);void 0!==t&&(i+=t.image.width*t.image.height*4)}e.heapSize+=t+i,e.gpuSize+=i}createReplacementGlyph(e,t,i){const n=this.m_replacementGlyph.clone();return n.codePoint=e,n.character=t,n.font=i,n}async loadAssets(e,t,i,n){const r=await this.loadBlock(i,n,t);if(void 0===r)return this.m_replacementGlyph;const s=r.chars.find(t=>t.id===e),o=`${this.getAssetsPath(t,n)}/${r.pages[s.page]}`,a=await this.loadPage(o);return new ee(s.id,i.name,s.width,s.height,s.xadvance,s.xoffset,s.yoffset,s.x/a.image.width,1-(s.y+s.height)/a.image.height,(s.x+s.width)/a.image.width,1-s.y/a.image.height,a,n)}async loadPage(e){let t=this.m_loadedPages.get(e);if(void 0===t){let i=this.m_loadingPages.get(e);void 0===i?(i=Re.loadTexture(e),this.m_loadingPages.set(e,i),t=await i,t.wrapS=r.k,t.wrapT=r.k,t.minFilter=r.ib,t.needsUpdate=!0,this.m_loadingPages.delete(e)&&this.m_loadedPages.set(e,t),this.m_loadingPages.delete(e)):t=await i}return t}getAssetsPath(e,t){let i=Ee;switch(e){case ve.Bold:void 0!==t.bold&&(i=Me);break;case ve.Italic:void 0!==t.italic&&(i=Ae);break;case ve.BoldItalic:void 0!==t.boldItalic?i=Pe:void 0!==t.italic?i=Ae:void 0!==t.bold&&(i=Me)}return`${this.url}/${this.name}${i}${t.name}`}}class Oe{constructor(e,t,i,n,r,s){this.glyphs=e,this.buffer=t,this.bounds=i,this.characterBounds=n,this.textRenderStyle=r,this.textLayoutStyle=s}}const Fe=65536,De=16,Ie=1,ze=4,ke=6,je=ze*De,Ne=ke*Ie,Ge=4,Ue=4;class Be{constructor(e,t,i,n,s){this.scene=e,this.capacity=Math.min(s,Fe),this.m_currentCapacity=Math.min(n,s),this.m_drawCount=0,this.m_updateOffset=0,this.m_pickingCount=0,this.m_vertexBuffer=new r.J(new Float32Array(this.m_currentCapacity*je),De),this.m_vertexBuffer.setUsage(r.w),this.m_positionAttribute=new r.K(this.m_vertexBuffer,4,0),this.m_uvAttribute=new r.K(this.m_vertexBuffer,4,4),this.m_colorAttribute=new r.K(this.m_vertexBuffer,4,8),this.m_bgColorAttribute=new r.K(this.m_vertexBuffer,4,12),this.m_indexBuffer=new r.h(new Uint32Array(this.m_currentCapacity*Ne),Ie),this.m_indexBuffer.setUsage(r.w),this.m_geometry=new r.i,this.m_geometry.setAttribute("position",this.m_positionAttribute),this.m_geometry.setAttribute("uv",this.m_uvAttribute),this.m_geometry.setAttribute("color",this.m_colorAttribute),this.m_geometry.setAttribute("bgColor",this.m_bgColorAttribute),this.m_geometry.setIndex(this.m_indexBuffer),this.m_pickingDataArray=new Array(this.m_currentCapacity),this.m_mesh=new r.eb(this.m_geometry,t),this.m_bgMesh=new r.eb(this.m_geometry,i),this.m_mesh.renderOrder=Number.MAX_SAFE_INTEGER,this.m_bgMesh.renderOrder=Number.MAX_SAFE_INTEGER-1,this.m_mesh.frustumCulled=!1,this.m_bgMesh.frustumCulled=!1,this.scene.add(this.m_bgMesh,this.m_mesh)}get drawCount(){return this.m_drawCount}get mesh(){return this.m_mesh}get backgroundMesh(){return this.m_bgMesh}dispose(){this.scene.remove(this.m_bgMesh,this.m_mesh),this.m_geometry.dispose()}clear(){this.m_drawCount=0,this.m_updateOffset=0,this.m_pickingCount=0}update(){this.drawCount>this.m_updateOffset&&(this.m_vertexBuffer.needsUpdate=!0,this.m_vertexBuffer.updateRange.offset=this.m_updateOffset*je,this.m_vertexBuffer.updateRange.count=(this.m_drawCount-this.m_updateOffset)*je,this.m_indexBuffer.needsUpdate=!0,this.m_indexBuffer.updateRange.offset=this.m_updateOffset*Ne,this.m_indexBuffer.updateRange.count=(this.m_drawCount-this.m_updateOffset)*Ne),this.m_updateOffset=this.m_drawCount,this.m_geometry.setDrawRange(0,this.m_drawCount*ke)}add(e,t,i,n,r,s){if(this.m_drawCount>=this.capacity)return!1;if(this.m_drawCount>=this.m_currentCapacity){const e=Math.min(2*this.m_currentCapacity,this.capacity);this.resizeBuffers(e)}const o=this.m_drawCount*ze,a=this.m_drawCount*ke;for(let a=0;a<ze;++a){this.m_positionAttribute.setXYZW(o+a,t[a].x,t[a].y,t[a].z,(r?-1:1)*s.rotation);const l=r?(a+1)%2+2*Math.floor(a/2):a;this.m_uvAttribute.setXYZW(o+a,e.dynamicTextureCoordinates[l].x,e.dynamicTextureCoordinates[l].y,i,n),this.m_colorAttribute.setXYZW(o+a,s.color.r,s.color.g,s.color.b,s.opacity),this.m_bgColorAttribute.setXYZW(o+a,s.backgroundColor.r,s.backgroundColor.g,s.backgroundColor.b,s.backgroundOpacity)}return this.m_indexBuffer.setX(a,o),this.m_indexBuffer.setX(a+1,o+1),this.m_indexBuffer.setX(a+2,o+2),this.m_indexBuffer.setX(a+3,o+2),this.m_indexBuffer.setX(a+4,o+1),this.m_indexBuffer.setX(a+5,o+3),++this.m_drawCount,!0}addToBuffer(e,t,i,n,r,s,o,a){for(let l=0;l<ze;++l){const h=t+De*l;e[h]=n[l].x,e[h+1]=n[l].y,e[h+2]=n[l].z,e[h+3]=(o?-1:1)*a.rotation;const c=o?(l+1)%2+2*Math.floor(l/2):l;e[h+4]=i.dynamicTextureCoordinates[c].x,e[h+5]=i.dynamicTextureCoordinates[c].y,e[h+6]=r,e[h+7]=s,e[h+8]=a.color.r,e[h+9]=a.color.g,e[h+10]=a.color.b,e[h+11]=a.opacity,e[h+12]=a.backgroundColor.r,e[h+13]=a.backgroundColor.g,e[h+14]=a.backgroundColor.b,e[h+15]=a.backgroundOpacity}}addTextBufferObject(e,t,i,n,r,s,o,a){if(this.m_drawCount+e.glyphs.length>=this.capacity)return!1;if(this.m_drawCount+e.glyphs.length>=this.m_currentCapacity){const e=Math.min(2*this.m_currentCapacity,this.capacity);this.resizeBuffers(e)}const l=i||1,h=n||0,c=Math.cos(h),d=Math.sin(h),m=void 0!==t?t.x:0,u=void 0!==t?t.y:0,p=void 0!==t?t.z:0,f=e.buffer,g=f[3]<0?-1:1,v=void 0!==r?r.r:f[8],_=void 0!==r?r.g:f[9],y=void 0!==r?r.b:f[10],x=void 0!==s?s:f[11],b=void 0!==o?o.r:f[12],w=void 0!==o?o.g:f[13],T=void 0!==o?o.b:f[14],S=void 0!==a?a:f[15],C=this.m_drawCount*ze;for(let t=0;t<e.glyphs.length;++t){const i=t*je,n=e.glyphs[t];if(!n.isInCache)return!1;const r=f[i+4]>f[i+De+4],s=f[i+6],o=f[i+7];for(let e=0;e<ze;++e){const a=f[i+e*De],E=f[i+e*De+1];this.m_positionAttribute.setXYZW(C+t*ze+e,a*l*c+E*l*-d+m,a*l*d+E*l*c+u,f[i+e*De+2]+p,f[i+e*De+3]+g*h);const M=r?(e+1)%2+2*Math.floor(e/2):e;this.m_uvAttribute.setXYZW(C+t*ze+e,n.dynamicTextureCoordinates[M].x,n.dynamicTextureCoordinates[M].y,s,(o-s)/l+s),this.m_colorAttribute.setXYZW(C+t*ze+e,v,_,y,x),this.m_bgColorAttribute.setXYZW(C+t*ze+e,b,w,T,S)}this.m_indexBuffer.setX((this.m_drawCount+t)*ke,(this.m_drawCount+t)*ze),this.m_indexBuffer.setX((this.m_drawCount+t)*ke+1,(this.m_drawCount+t)*ze+1),this.m_indexBuffer.setX((this.m_drawCount+t)*ke+2,(this.m_drawCount+t)*ze+2),this.m_indexBuffer.setX((this.m_drawCount+t)*ke+3,(this.m_drawCount+t)*ze+2),this.m_indexBuffer.setX((this.m_drawCount+t)*ke+4,(this.m_drawCount+t)*ze+1),this.m_indexBuffer.setX((this.m_drawCount+t)*ke+5,(this.m_drawCount+t)*ze+3)}return this.m_drawCount+=e.glyphs.length,!0}addPickingData(e,t,i){return!(this.m_pickingCount>=this.m_currentCapacity)&&(this.m_pickingDataArray[this.m_pickingCount]={start:Math.min(e,this.capacity),end:Math.min(t,this.capacity),data:i},++this.m_pickingCount,!0)}pick(e,t){for(const i of this.m_pickingDataArray){if(void 0===i)return;for(let n=i.start;n<i.end;++n){const r=n*ze,s=Math.min(this.m_positionAttribute.getX(r+2),this.m_positionAttribute.getX(r+1));if(e.x<s)continue;const o=Math.max(this.m_positionAttribute.getX(r+2),this.m_positionAttribute.getX(r+1));if(e.x>o)continue;const a=Math.min(this.m_positionAttribute.getY(r+2),this.m_positionAttribute.getY(r+1));if(e.y<a)continue;const l=Math.max(this.m_positionAttribute.getY(r+2),this.m_positionAttribute.getY(r+1));if(!(e.y>l)){t(i.data);break}}}}updateMemoryUsage(e){const t=this.m_vertexBuffer.count*Ge+this.m_indexBuffer.count*Ue;e.heapSize+=t,e.gpuSize+=t}resizeBuffers(e){this.m_currentCapacity=e;const t=new Float32Array(e*je);t.set(this.m_vertexBuffer.array),this.m_vertexBuffer=new r.J(t,De),this.m_vertexBuffer.setUsage(r.w),this.m_positionAttribute=new r.K(this.m_vertexBuffer,4,0),this.m_uvAttribute=new r.K(this.m_vertexBuffer,4,4),this.m_colorAttribute=new r.K(this.m_vertexBuffer,4,8),this.m_bgColorAttribute=new r.K(this.m_vertexBuffer,4,12);const i=new Uint32Array(e*Ne);i.set(this.m_indexBuffer.array),this.m_indexBuffer=new r.h(i,Ie),this.m_indexBuffer.setUsage(r.w),this.m_geometry.dispose(),this.m_geometry=new r.i,this.m_geometry.setAttribute("position",this.m_positionAttribute),this.m_geometry.setAttribute("uv",this.m_uvAttribute),this.m_geometry.setAttribute("color",this.m_colorAttribute),this.m_geometry.setAttribute("bgColor",this.m_bgColorAttribute),this.m_geometry.setIndex(this.m_indexBuffer),this.m_pickingDataArray.length=this.m_currentCapacity,this.scene.remove(this.m_bgMesh,this.m_mesh),this.m_mesh=new r.eb(this.m_geometry,this.m_mesh.material),this.m_bgMesh=new r.eb(this.m_geometry,this.m_bgMesh.material),this.m_mesh.renderOrder=Number.MAX_SAFE_INTEGER,this.m_bgMesh.renderOrder=Number.MAX_SAFE_INTEGER-1,this.m_mesh.frustumCulled=!1,this.m_bgMesh.frustumCulled=!1,this.scene.add(this.m_bgMesh,this.m_mesh)}}var qe,Ve;(Ve=qe||(qe={})).EM_TO_PX=16,Ve.PT_TO_PX=1.25,Ve.OBLIQUE_ANGLE=.174533,Ve.OBLIQUE_OFFSET=Math.tan(Ve.OBLIQUE_ANGLE),Ve.getPixelSize=function(e,t,i){let n=e;switch(t){case ge.Em:n*=Ve.EM_TO_PX;break;case ge.Point:n*=Ve.PT_TO_PX;break;case ge.Percent:n*=.01*i}return n},Ve.getSmallCapsScale=function(e,t,i,n){return t[i]&&n===_e.SmallCaps?e[i].font.metrics.xHeight/e[i].font.metrics.capHeight:1},Ve.getDirection=function(e,t){let i=J.Direction.LTR,n=t;for(;e[n].direction!==J.Direction.LTR&&e[n].direction!==J.Direction.RTL&&n<e.length-1;)++n;return 1===Math.abs(e[n].direction)&&(i=e[n].direction),i},Ve.computeGlyphTransform=function(e,t,i,n,r){const s=Math.cos(n),o=Math.sin(n),a=Math.cos(r),l=Math.sin(r);e.set(i*a,i*-l,s*t.x-o*t.y,i*l,i*a,o*t.x+s*t.y,0,0,1)},Ve.updateBounds=function(e,t,i){const n=Math.min(e[0].x,e[1].x,e[2].x,e[3].x),s=Math.max(e[0].x,e[1].x,e[2].x,e[3].x),o=Math.min(e[0].y,e[1].y,e[2].y,e[3].y),a=Math.max(e[0].y,e[1].y,e[2].y,e[3].y);void 0!==i&&(void 0!==i.array[i.offset]?(i.array[i.offset].min.set(n,o),i.array[i.offset].max.set(s,a)):i.array.push(new r.f(new r.Yb(n,o),new r.Yb(s,a))),++i.offset),t.min.set(Math.min(t.min.x,n),Math.min(t.min.y,o)),t.max.set(Math.max(t.max.x,s),Math.max(t.max.y,a))};class We{constructor(){this.m_tempTransform=new r.cb,this.m_tempCorners=[new r.Zb,new r.Zb,new r.Zb,new r.Zb],this.m_tempLineDirection=J.Direction.LTR,this.m_tempRunDirection=J.Direction.LTR,this.m_tempPixelSize=1,this.m_tempPixelBgSize=1,this.m_tempScale=1,this.m_tempSmallCaps=!1}arrangeGlyphs(e){this.m_currentParams=e,this.m_tempLineDirection=qe.getDirection(this.m_currentParams.glyphs,0),this.m_tempRunDirection=this.m_tempLineDirection,this.m_tempPixelSize=qe.getPixelSize(this.m_currentParams.textRenderStyle.fontSize.size,this.m_currentParams.textRenderStyle.fontSize.unit,this.m_currentParams.fontCatalog.size),this.m_tempScale=this.m_tempPixelSize/this.m_currentParams.fontCatalog.size,this.m_tempPixelBgSize=Math.min(qe.getPixelSize(this.m_currentParams.textRenderStyle.fontSize.backgroundSize,this.m_currentParams.textRenderStyle.fontSize.unit,this.m_currentParams.fontCatalog.size),this.m_currentParams.fontCatalog.distanceRange*this.m_tempScale),this.m_tempSmallCaps=void 0!==this.m_currentParams.smallCapsArray,this.m_currentParams.position.y+=this.m_currentParams.textLayoutStyle.verticalAlignment*this.m_currentParams.glyphs[0].font.metrics.capHeight*this.m_tempScale;const t=void 0!==this.m_currentParams.globalBounds&&void 0===this.m_currentParams.vertexBuffer,i=this.m_currentParams.position.x,n=this.m_currentParams.glyphs[0].font.metrics.lineHeight+this.m_currentParams.textLayoutStyle.leading;let r=0,s=0,o=0,a=0,l=0,h=0,c=0,d=0,m=!1;for(let e=0;e<this.m_currentParams.glyphs.length&&!(d>this.m_currentParams.textLayoutStyle.maxLines-1);++e){const u=this.m_currentParams.glyphs[e];if(!u.isInCache&&!t)return!1;const p=J.isNewLine(u.codePoint),f=J.isWhiteSpace(u.codePoint);if(m||u.direction!==-this.m_tempLineDirection||(m=!0),J.isPrintable(u.codePoint)&&(l+=(u.advanceX+this.m_currentParams.textLayoutStyle.tracking)*this.m_tempScale*(this.m_tempSmallCaps?qe.getSmallCapsScale(this.m_currentParams.glyphs,this.m_currentParams.smallCapsArray,e,this.m_currentParams.textRenderStyle.fontVariant):1)),e===r&&(a=l,h=l,c=l),p||this.m_currentParams.textLayoutStyle.wrappingMode===be.Character&&l>this.m_currentParams.textLayoutStyle.lineWidth||this.m_currentParams.textLayoutStyle.wrappingMode===be.Word&&l>this.m_currentParams.textLayoutStyle.lineWidth&&c!==a){if(this.m_currentParams.textLayoutStyle.wrappingMode!==be.None){let t=s,i=h;this.m_currentParams.textLayoutStyle.wrappingMode===be.Word&&c!==a&&(t=o,i=c),l=i,e=Math.min(p?r===e?t:e:t,this.m_currentParams.glyphs.length-1)}const t=this.m_tempLineDirection===J.Direction.RTL&&m?1+this.m_currentParams.textLayoutStyle.horizontalAlignment:this.m_currentParams.textLayoutStyle.horizontalAlignment;if(this.m_currentParams.position.x=this.m_currentParams.position.x+l*t,!this.placeLine(r,e,this.m_tempLineDirection,m))return!1;for(this.m_currentParams.position.y-=n*this.m_tempScale,this.m_currentParams.position.x=i;e!==r&&e+1<this.m_currentParams.glyphs.length&&J.isWhiteSpace(this.m_currentParams.glyphs[e+1].codePoint);)++e;if(r=e+1,r===this.m_currentParams.glyphs.length)break;p&&(this.m_tempLineDirection=qe.getDirection(this.m_currentParams.glyphs,r),this.m_tempRunDirection=this.m_tempLineDirection),a=0,l=0,s=r,h=0,o=r,c=0,m=!1,d++}else this.m_currentParams.textLayoutStyle.wrappingMode===be.None||f||(s=e,h=l,this.m_currentParams.textLayoutStyle.wrappingMode===be.Word&&e+1<this.m_currentParams.glyphs.length&&(J.isWhiteSpace(this.m_currentParams.glyphs[e+1].codePoint)||J.isNewLine(this.m_currentParams.glyphs[e+1].codePoint))&&(o=e,c=l))}if(d<=this.m_currentParams.textLayoutStyle.maxLines-1&&r<=this.m_currentParams.glyphs.length-1){const e=this.m_tempLineDirection===J.Direction.RTL&&m?1+this.m_currentParams.textLayoutStyle.horizontalAlignment:this.m_currentParams.textLayoutStyle.horizontalAlignment;if(this.m_currentParams.position.setX(this.m_currentParams.position.x+l*e),!this.placeLine(r,this.m_currentParams.glyphs.length-1,this.m_tempLineDirection,m))return!1}return!0}placeLine(e,t,i,n){if(!n)return this.placeRun(e,t,i);const r=this.m_currentParams.glyphs,s=this.m_currentParams.smallCapsArray,o=this.m_currentParams.textRenderStyle,a=this.m_currentParams.textLayoutStyle,l=this.m_currentParams.position,h=i===J.Direction.RTL,c=l.x;let d=0,m=e;for(let n=e;n<=t;++n){const e=r[n];if(e.direction===-this.m_tempRunDirection){if(h&&(l.x=c+d),!this.placeRun(m,n-1,this.m_tempRunDirection))return!1;h||(l.x=c+d),m=n,this.m_tempRunDirection*=-1}else if(e.direction===J.Direction.Neutral&&this.m_tempRunDirection===-i){let e=n;for(;e+1<r.length&&1!==Math.abs(r[e].direction);)++e;if(r[e].direction!==this.m_tempRunDirection){if(h&&(l.x=c+d),!this.placeRun(m,n-1,this.m_tempRunDirection))return!1;h||(l.x=c+d),m=n,this.m_tempRunDirection*=-1}}d+=(e.advanceX+a.tracking)*this.m_tempScale*(this.m_tempSmallCaps?qe.getSmallCapsScale(r,s,n,o.fontVariant):1)*i}if(m<=t){if(h&&(l.x=c+d),!this.placeRun(m,t,this.m_tempRunDirection))return!1;h||(l.x=c+d)}return!0}placeRun(e,t,i){const n=this.m_currentParams.glyphs,r=this.m_currentParams.smallCapsArray,s=this.m_currentParams.fontCatalog,o=this.m_currentParams.textRenderStyle,a=this.m_currentParams.textLayoutStyle,l=this.m_currentParams.position,h=this.m_currentParams.geometry,c=this.m_currentParams.globalBounds,d=this.m_currentParams.individualBounds,m=this.m_currentParams.vertexBuffer,u=i===J.Direction.LTR?e:t,p=i===J.Direction.LTR?t:e;for(let f=u;i===J.Direction.RTL?f>=p:f<=p;f+=i){const u=n[f];if(!J.isPrintable(u.codePoint))continue;if(e!==t&&0!==f&&i===J.Direction.RTL&&u.direction===J.Direction.Weak){let t=f,i=n[t-1];for(;t!==e&&(i.direction===J.Direction.Weak||i.direction===J.Direction.Neutral&&!J.isWhiteSpace(i.codePoint));)--t,i=n[t-1];this.placeRun(Math.max(t,e),f,J.Direction.LTR),f=t;continue}const p=u.font,g=p.metrics,v=o.fontStyle,_=v===ve.Bold&&void 0===p.bold||v===ve.BoldItalic&&void 0===p.bold&&void 0===p.boldItalic,y=v===ve.Italic&&void 0===p.italic||v===ve.BoldItalic&&void 0===p.italic&&void 0===p.boldItalic,x=!!this.m_tempSmallCaps&&(r[f]&&o.fontVariant===_e.SmallCaps),b=x?g.xHeight/g.capHeight:1,w=this.m_tempScale*b,T=((_?.02:0)+(x?.01:0))*(s.size/s.distanceRange),S=.5*this.m_tempPixelBgSize/(s.distanceRange*Math.max(w,1)),C=J.isRtlMirrored(u.codePoint)&&i===J.Direction.RTL,E=g.lineHeight-g.base-.5*g.distanceRange;qe.computeGlyphTransform(this.m_tempTransform,l,w,a.canvasRotation,o.rotation);for(let e=0;e<4;++e){const t=u.positions[e],i=y&&e>1?qe.OBLIQUE_OFFSET*g.size:0;this.m_tempCorners[e].set(t.x+i,t.y-E,t.z),this.m_tempCorners[e].applyMatrix3(this.m_tempTransform)}if(void 0===c&&void 0===m){if(!h.add(u,this.m_tempCorners,T,T+S,C,o))return!1}else void 0!==c&&qe.updateBounds(this.m_tempCorners,c,d),void 0!==m&&h.addToBuffer(m,f*je,u,this.m_tempCorners,T,T+S,C,o);l.set(l.x+(u.advanceX+a.tracking)*w*Math.cos(a.lineRotation),l.y+(u.advanceX+a.tracking)*w*Math.sin(a.lineRotation),l.z)}return!0}}class Ze{constructor(){this.m_tempTransform=new r.cb,this.m_tempCorners=[new r.Zb,new r.Zb,new r.Zb,new r.Zb],this.m_tempLineDirection=J.Direction.LTR,this.m_tempRunDirection=J.Direction.LTR,this.m_tempPixelSize=1,this.m_tempPixelBgSize=1,this.m_tempScale=1,this.m_tempSmallCaps=!1,this.m_tempPathPosition=new r.Zb,this.m_tempPathLength=0,this.m_tempPathOffset=0}arrangeGlyphs(e){this.m_currentParams=e,this.m_tempLineDirection=qe.getDirection(this.m_currentParams.glyphs,0),this.m_tempRunDirection=this.m_tempLineDirection,this.m_tempPixelSize=qe.getPixelSize(this.m_currentParams.textRenderStyle.fontSize.size,this.m_currentParams.textRenderStyle.fontSize.unit,this.m_currentParams.fontCatalog.size),this.m_tempScale=this.m_tempPixelSize/this.m_currentParams.fontCatalog.size,this.m_tempPixelBgSize=Math.min(qe.getPixelSize(this.m_currentParams.textRenderStyle.fontSize.backgroundSize,this.m_currentParams.textRenderStyle.fontSize.unit,this.m_currentParams.fontCatalog.size),this.m_currentParams.fontCatalog.distanceRange*this.m_tempScale),this.m_tempSmallCaps=void 0!==this.m_currentParams.smallCapsArray,this.m_tempPathLength=this.m_currentParams.path.getLength(),this.m_tempPathOffset=0;const t=void 0!==this.m_currentParams.globalBounds&&void 0===this.m_currentParams.vertexBuffer;let i=!1,n=0;for(let e=0;e<this.m_currentParams.glyphs.length;++e){const r=this.m_currentParams.glyphs[e];if(!r.isInCache&&!t)return!1;J.isPrintable(r.codePoint)&&(i||r.direction!==-this.m_tempLineDirection||(i=!0),n+=(r.advanceX+this.m_currentParams.textLayoutStyle.tracking)*this.m_tempScale*(this.m_tempSmallCaps?qe.getSmallCapsScale(this.m_currentParams.glyphs,this.m_currentParams.smallCapsArray,e,this.m_currentParams.textRenderStyle.fontVariant):1))}return this.m_tempPathOffset=Math.min(Math.max(-this.m_currentParams.textLayoutStyle.horizontalAlignment+this.m_currentParams.textLayoutStyle.horizontalAlignment*n/this.m_tempPathLength,0),1),this.placeLine(this.m_tempLineDirection,i)}placeLine(e,t){if(!t)return this.placeRun(0,this.m_currentParams.glyphs.length-1,e);const i=this.m_currentParams.glyphs;let n=0;for(let t=n;t<i.length;++t){const r=i[t];if(r.direction===-this.m_tempRunDirection){if(!this.placeRun(n,t-1,this.m_tempRunDirection))return!1;n=t,this.m_tempRunDirection*=-1}else if(r.direction===J.Direction.Neutral&&this.m_tempRunDirection===-e){let e=t;for(;e+1<i.length&&1!==Math.abs(i[e].direction);)++e;if(i[e].direction!==this.m_tempRunDirection){if(!this.placeRun(n,t-1,this.m_tempRunDirection))return!1;n=t,this.m_tempRunDirection*=-1}}}return!(n<i.length&&!this.placeRun(n,i.length-1,this.m_tempRunDirection))}placeRun(e,t,i){const n=this.m_currentParams.glyphs,s=this.m_currentParams.smallCapsArray,o=this.m_currentParams.fontCatalog,a=this.m_currentParams.textRenderStyle,l=this.m_currentParams.textLayoutStyle,h=this.m_currentParams.position,c=this.m_currentParams.geometry,d=this.m_currentParams.globalBounds,m=this.m_currentParams.individualBounds,u=this.m_currentParams.vertexBuffer,p=this.m_currentParams.path,f=a.rotation,g=l.verticalAlignment*n[0].font.metrics.capHeight*this.m_tempScale,v=i===J.Direction.LTR?e:t,_=i===J.Direction.LTR?t:e;for(let y=v;i===J.Direction.RTL?y>=_:y<=_;y+=i){const v=n[y];if(!J.isPrintable(v.codePoint))continue;if(e!==t&&0!==y&&i===J.Direction.RTL&&v.direction===J.Direction.Weak){let t=y,i=n[t-1];for(;t!==e&&(i.direction===J.Direction.Weak||i.direction===J.Direction.Neutral&&!J.isWhiteSpace(i.codePoint));)--t,i=n[t-1];this.placeRun(Math.max(t,e),y,J.Direction.LTR),y=t;continue}const _=v.font,x=_.metrics,b=a.fontStyle,w=b===ve.Bold&&void 0===_.bold||b===ve.BoldItalic&&void 0===_.bold&&void 0===_.boldItalic,T=b===ve.Italic&&void 0===_.italic||b===ve.BoldItalic&&void 0===_.italic&&void 0===_.boldItalic,S=!!this.m_tempSmallCaps&&(s[y]&&a.fontVariant===_e.SmallCaps),C=S?x.xHeight/x.capHeight:1,E=this.m_tempScale*C,M=((w?.02:0)+(S?.01:0))*(o.size/o.distanceRange),A=.5*this.m_tempPixelBgSize/(o.distanceRange*Math.max(E,1)),P=J.isRtlMirrored(v.codePoint)&&i===J.Direction.RTL,L=x.lineHeight-x.base-.5*x.distanceRange,R=p.getPoint(this.m_tempPathOffset);if(null===R)return this.m_currentParams.pathOverflow;const O=p.getTangent(this.m_tempPathOffset),F=new r.Yb(-O.y,O.x).multiplyScalar(g),D=Math.atan2(O.y,O.x);this.m_tempPathPosition.set(F.x+R.x,F.y+R.y,h.z),a.rotation=f+D,qe.computeGlyphTransform(this.m_tempTransform,this.m_tempPathPosition,E,0,a.rotation);for(let e=0;e<4;++e){const t=v.positions[e],i=T&&e>1?qe.OBLIQUE_OFFSET*x.size:0;this.m_tempCorners[e].set(t.x+i,t.y-L,t.z),this.m_tempCorners[e].applyMatrix3(this.m_tempTransform),this.m_tempCorners[e].x-=h.x,this.m_tempCorners[e].y-=h.y}if(void 0===d&&void 0===u){if(!c.add(v,this.m_tempCorners,M,M+A,P,a))return!1}else void 0!==d&&qe.updateBounds(this.m_tempCorners,d,m),void 0!==u&&c.addToBuffer(u,y*je,v,this.m_tempCorners,M,M+A,P,a);a.rotation=f,this.m_tempPathOffset+=(v.advanceX+l.tracking)*E/this.m_tempPathLength}return!0}}function $e(e){return new me({texture:e.fontCatalog.texture,textureSize:e.fontCatalog.textureSize,size:e.fontCatalog.size,distanceRange:e.fontCatalog.distanceRange,isMsdf:"msdf"===e.fontCatalog.type,isBackground:!0===e.isBackground,vertexSource:e.vertexSource,fragmentSource:e.fragmentSource})}const He=new r.Zb,Ke={array:[new r.f],offset:0};let Xe=new Float32Array;const Ye=0;class Je{constructor(e){this.m_renderer=e.renderer,this.m_fontCatalog=e.fontCatalog,this.minGlyphCount=e.minGlyphCount,this.maxGlyphCount=e.maxGlyphCount,void 0===e.material?(this.m_ownsMaterial=!0,this.m_material=$e({fontCatalog:e.fontCatalog})):(this.m_ownsMaterial=!1,this.m_material=e.material),void 0===e.backgroundMaterial?(this.m_ownsBgMaterial=!0,this.m_bgMaterial=$e({fontCatalog:e.fontCatalog,isBackground:!0})):(this.m_ownsBgMaterial=!1,this.m_bgMaterial=e.backgroundMaterial),this.m_defaultLayer={id:Ye,storage:new Be(new r.Ib,this.m_material,this.m_bgMaterial,this.minGlyphCount,this.maxGlyphCount)},this.m_layers=[this.m_defaultLayer],this.m_defaultTextRenderStyle=new Se,this.m_currentTextRenderStyle=this.m_defaultTextRenderStyle,this.m_defaultTextLayoutStyle=new Ce,this.m_currentTextLayoutStyle=this.m_defaultTextLayoutStyle,this.m_lineTypesetter=new We,this.m_pathTypesetter=new Ze}get fontCatalog(){return this.m_fontCatalog}set fontCatalog(e){this.m_fontCatalog=e;const t=this.m_material;t.uniforms.sdfTexture.value=this.m_fontCatalog.texture,t.uniforms.sdfParams.value=new r.ac(this.m_fontCatalog.textureSize.x,this.m_fontCatalog.textureSize.y,this.m_fontCatalog.size,this.m_fontCatalog.distanceRange),t.defines.MSDF="msdf"===this.m_fontCatalog.type?1:0;const i=this.m_bgMaterial;i.uniforms.sdfTexture.value=this.m_fontCatalog.texture,i.uniforms.sdfParams.value=new r.ac(this.m_fontCatalog.textureSize.x,this.m_fontCatalog.textureSize.y,this.m_fontCatalog.size,this.m_fontCatalog.distanceRange),i.defines.MSDF="msdf"===this.m_fontCatalog.type?1:0}get material(){return this.m_material}set material(e){this.m_ownsMaterial&&(this.m_material.dispose(),this.m_ownsMaterial=!1),this.m_material=e;for(const e of this.m_layers)e.storage.mesh.material=this.m_material}get backgroundMaterial(){return this.m_bgMaterial}set backgroundMaterial(e){this.m_ownsBgMaterial&&(this.m_bgMaterial.dispose(),this.m_ownsBgMaterial=!1),this.m_bgMaterial=e;for(const e of this.m_layers)e.storage.backgroundMesh.material=this.m_bgMaterial}get textRenderStyle(){return this.m_currentTextRenderStyle}set textRenderStyle(e){this.m_currentTextRenderStyle=e}get textLayoutStyle(){return this.m_currentTextLayoutStyle}set textLayoutStyle(e){this.m_currentTextLayoutStyle=e}clear(){for(const e of this.m_layers)e.storage.clear();this.m_currentTextRenderStyle=this.m_defaultTextRenderStyle}render(e,t,i){this.m_fontCatalog.update(this.m_renderer);let n=null;void 0!==t&&(n=this.m_renderer.getRenderTarget(),this.m_renderer.setRenderTarget(t)),!0===i&&this.m_renderer.clear(!0);for(const t of this.m_layers)t.storage.update(),this.m_renderer.clear(!1,!0),this.m_renderer.render(t.storage.scene,e);void 0!==t&&this.m_renderer.setRenderTarget(n)}addLayer(e){let t=this.getLayer(e);return void 0===t&&(t={id:e,storage:new Be(new r.Ib,this.m_material,this.m_bgMaterial,this.minGlyphCount,this.maxGlyphCount)},this.m_layers.push(t),this.m_layers.sort((e,t)=>e.id-t.id)),t}getLayer(e){return this.m_layers.find(t=>t.id===e)}getAllLayers(){return this.m_layers}measureText(e,t,i){let n,r,s,o;if(He.set(0,0,0),void 0!==i){if(n=i.path,r=i.pathOverflow,o=i.outputCharacterBounds,void 0!==i.path){const e=i.path.getPoint(0);if(null===e)return!1;He.set(e.x,e.y,0)}i.letterCaseArray&&(s=i.letterCaseArray)}return this.placeText({input:e,layer:this.m_defaultLayer,textPath:n,textPathOverflow:r,bounds:t,individualBounds:o,letterCaseArray:s})}addText(e,t,i){let n,r,s;He.copy(t);let o=this.m_defaultLayer;if(void 0!==i){if(n=i.path,r=i.pathOverflow,void 0!==i.layer){let e=this.getLayer(i.layer);void 0===e&&(e=this.addLayer(i.layer)),o=e}void 0!==i.path&&He.set(0,0,He.z),i.letterCaseArray&&(s=i.letterCaseArray)}const a=o.storage.drawCount,l=this.placeText({input:e,textPath:n,textPathOverflow:r,layer:o,letterCaseArray:s});return l&&void 0!==i?(!0===i.updatePosition&&t.copy(He),void 0!==i.pickingData&&o.storage.addPickingData(a,o.storage.drawCount,i.pickingData)):l||(o.storage.m_drawCount=a),l}createTextBufferObject(e,t){let i,n;He.set(0,0,0);const s=this.m_currentTextRenderStyle.fontVariant===_e.SmallCaps;if("string"!=typeof e)i=e,void 0!==t&&t.letterCaseArray&&(n=t.letterCaseArray);else if(n=[],i=this.m_fontCatalog.getGlyphs(e,this.m_currentTextRenderStyle,s?n:void 0),void 0===i)return;let o,a,l,h,c,d;return void 0!==t&&(o=t.path,a=t.pathOverflow,!0===t.outputBounds&&(l=new r.f),!0===t.outputCharacterBounds&&(h=[]),!0===t.storeStyles&&(c=this.m_currentTextRenderStyle,d=this.m_currentTextLayoutStyle)),this.placeText({input:e,layer:this.m_defaultLayer,computeTextBuffer:!0,textPath:o,textPathOverflow:a,bounds:l,individualBounds:h,letterCaseArray:n}),new Oe(i,new Float32Array(Xe),l,h,c,d)}addTextBufferObject(e,t){let i,n,r,s,o,a,l,h=this.m_defaultLayer;if(void 0!==t){if(void 0!==t.layer){let e=this.getLayer(t.layer);void 0===e&&(e=this.addLayer(t.layer)),h=e}i=t.position,n=t.scale,r=t.rotation,s=t.color,o=t.opacity,a=t.backgroundColor,l=t.backgroundOpacity}const c=h.storage.drawCount,d=h.storage.addTextBufferObject(e,i,n,r,s,o,a,l);return d&&void 0!==t?void 0!==t.pickingData&&h.storage.addPickingData(c,h.storage.drawCount,t.pickingData):d||(h.storage.m_drawCount=c),d}pickText(e,t){for(const i of this.m_layers)i.storage.pick(e,t)}getMemoryUsage(e){this.m_fontCatalog.updateMemoryUsage(e);for(const t of this.m_layers)t.storage.updateMemoryUsage(e)}placeText(e){if(0===e.input.length||0===this.m_currentTextLayoutStyle.maxLines)return void 0!==e.bounds&&(e.bounds.min.set(0,0),e.bounds.max.set(0,0)),void 0!==e.individualBounds&&(e.individualBounds.length=0),!0;let t,i;const n=this.m_currentTextRenderStyle.fontVariant===_e.SmallCaps;if("string"!=typeof e.input)t=e.input,e.letterCaseArray&&(i=e.letterCaseArray);else if(i=[],t=this.m_fontCatalog.getGlyphs(e.input,this.m_currentTextRenderStyle,n?i:void 0),void 0===t)return!1;let r;void 0!==e.individualBounds&&(Ke.array=e.individualBounds,Ke.offset=0,r=Ke),void 0!==e.bounds&&(e.bounds.min.set(1/0,1/0),e.bounds.max.set(-1/0,-1/0)),!0===e.computeTextBuffer&&(Xe=new Float32Array(t.length*je));const s=void 0!==e.textPath,o={glyphs:t,fontCatalog:this.m_fontCatalog,textRenderStyle:this.m_currentTextRenderStyle,textLayoutStyle:this.m_currentTextLayoutStyle,position:He,geometry:e.layer.storage,smallCapsArray:n?i:void 0,globalBounds:e.bounds,individualBounds:r,vertexBuffer:!0===e.computeTextBuffer?Xe:void 0};let a=!0;return s?(Object.assign(o,{path:e.textPath,pathOverflow:!0===e.textPathOverflow}),a=this.m_pathTypesetter.arrangeGlyphs(o)):a=this.m_lineTypesetter.arrangeGlyphs(o),void 0!==r&&(r.array.length=r.offset),a}}var Qe,et;!function(e){e[e.Initial=0]="Initial",e[e.Medial=1]="Medial",e[e.Final=2]="Final"}(Qe||(Qe={})),function(e){e[e.Isolated=0]="Isolated",e[e.Connected=1]="Connected"}(et||(et={}));class tt{constructor(){this.m_singleCharactersMap=new Map,this.m_combinedCharactersMap=new Map,this.m_singleCharactersMap.set(1569,[void 0,void 0,void 0]),this.m_singleCharactersMap.set(1570,[void 0,void 0,65154]),this.m_singleCharactersMap.set(1571,[void 0,void 0,65156]),this.m_singleCharactersMap.set(1572,[void 0,void 0,65158]),this.m_singleCharactersMap.set(1573,[void 0,void 0,65160]),this.m_singleCharactersMap.set(1574,[65163,65164,65162]),this.m_singleCharactersMap.set(1575,[void 0,void 0,65166]),this.m_singleCharactersMap.set(1576,[65169,65170,65168]),this.m_singleCharactersMap.set(1577,[void 0,void 0,65172]),this.m_singleCharactersMap.set(1578,[65175,65176,65174]),this.m_singleCharactersMap.set(1579,[65179,65180,65178]),this.m_singleCharactersMap.set(1580,[65183,65184,65182]),this.m_singleCharactersMap.set(1581,[65187,65188,65186]),this.m_singleCharactersMap.set(1582,[65191,65192,65190]),this.m_singleCharactersMap.set(1583,[void 0,void 0,65194]),this.m_singleCharactersMap.set(1584,[void 0,void 0,65196]),this.m_singleCharactersMap.set(1585,[void 0,void 0,65198]),this.m_singleCharactersMap.set(1586,[void 0,void 0,65200]),this.m_singleCharactersMap.set(1587,[65203,65204,65202]),this.m_singleCharactersMap.set(1588,[65207,65208,65206]),this.m_singleCharactersMap.set(1589,[65211,65212,65210]),this.m_singleCharactersMap.set(1590,[65215,65216,65214]),this.m_singleCharactersMap.set(1591,[65219,65220,65218]),this.m_singleCharactersMap.set(1592,[65223,65224,65222]),this.m_singleCharactersMap.set(1593,[65227,65228,65226]),this.m_singleCharactersMap.set(1594,[65231,65232,65230]),this.m_singleCharactersMap.set(1600,[1600,1600,1600]),this.m_singleCharactersMap.set(1601,[65235,65236,65234]),this.m_singleCharactersMap.set(1602,[65239,65240,65238]),this.m_singleCharactersMap.set(1603,[65243,65244,65242]),this.m_singleCharactersMap.set(1604,[65247,65248,65246]),this.m_singleCharactersMap.set(1605,[65251,65252,65250]),this.m_singleCharactersMap.set(1606,[65255,65256,65254]),this.m_singleCharactersMap.set(1607,[65259,65260,65258]),this.m_singleCharactersMap.set(1608,[void 0,void 0,65262]),this.m_singleCharactersMap.set(1609,[void 0,void 0,65264]),this.m_singleCharactersMap.set(1610,[65267,65268,65266]),this.m_singleCharactersMap.set(1662,[64344,64345,64343]),this.m_singleCharactersMap.set(1740,[64510,64511,64509]),this.m_singleCharactersMap.set(1670,[64380,64381,64379]),this.m_singleCharactersMap.set(1705,[64400,64401,64399]),this.m_singleCharactersMap.set(1711,[64404,64405,64403]),this.m_singleCharactersMap.set(1688,[void 0,void 0,64395]),this.m_combinedCharactersMap.set(1604,new Map),this.m_combinedCharactersMap.get(1604).set(1570,[65269,65270]),this.m_combinedCharactersMap.get(1604).set(1571,[65271,65272]),this.m_combinedCharactersMap.get(1604).set(1573,[65273,65274]),this.m_combinedCharactersMap.get(1604).set(1575,[65275,65276]),this.m_neutralCharacters=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773]}static get instance(){return void 0===this.m_instance&&(this.m_instance=new tt),this.m_instance}convert(e){let t="";for(let i=0;i<e.length;++i){const n=e.charCodeAt(i);if(this.isArabicCharacter(n)){let r=i-1;for(;r>=0&&this.isNeutral(e.charCodeAt(r));--r);let s=r>=0?e.charCodeAt(r):void 0;if(void 0!==s){const e=this.getCharacterMap(s);(void 0===e||void 0===e[Qe.Initial]&&void 0===e[Qe.Medial])&&(s=void 0)}let o=i+1;for(;o<e.length&&this.isNeutral(e.charCodeAt(o));++o);let a=o<e.length?e.charCodeAt(o):void 0;if(void 0!==a){const e=this.getCharacterMap(a);(void 0===e||void 0===e[Qe.Medial]&&void 0===e[Qe.Final])&&(a=void 0)}if(1604===n&&void 0!==a&&(1570===a||1571===a||1573===a||1575===a)){const e=this.getCombinedCharacterMap(n,a);t+=void 0!==s?String.fromCharCode(e[et.Connected]):String.fromCharCode(e[et.Isolated]),++i;continue}const l=this.getCharacterMap(n);void 0!==s&&void 0!==a&&void 0!==l[Qe.Medial]?t+=String.fromCharCode(l[Qe.Medial]):void 0!==s&&void 0!==l[Qe.Final]?t+=String.fromCharCode(l[Qe.Final]):void 0!==a&&void 0!==l[Qe.Initial]?t+=String.fromCharCode(l[Qe.Initial]):t+=String.fromCharCode(n)}else t+=String.fromCharCode(n)}return t}isArabicCharacter(e){return this.m_singleCharactersMap.has(e)}getCharacterMap(e){return this.m_singleCharactersMap.get(e)}getCombinedCharacterMap(e,t){const i=this.m_combinedCharactersMap.get(e);if(void 0!==i)return i.get(t)}isNeutral(e){for(const t of this.m_neutralCharacters)if(t===e)return!0;return!1}}class it{constructor(){this.m_map=new Map}static get instance(){return this.m_instance}getColor(e){"number"==typeof e&&(e="#"+e.toString(16).padStart(6,"0"));let t=this.m_map.get(e);return void 0!==t?t:(t=new r.l(e),this.m_map.set(e,t),t)}get size(){return this.m_map.size}clear(){this.m_map.clear()}}it.m_instance=new it;class nt extends r.xb{constructor(){super(...arguments),this.enableRayTesting=!0}raycast(e,t){if(!this.enableRayTesting)return;const i=this.geometry,n=this.matrixWorld,s=e.ray.origin.clone().add(e.ray.direction).project(e.mapView.camera),{clientWidth:o,clientHeight:a}=e.mapView.canvas,l=new r.Yb(Math.ceil((s.x+1)/2*o),Math.ceil((1-s.y)/2*a));if(i instanceof r.i){const s=new r.Zb,h=i.index,c=i.attributes.position.array;if(null!==h){const i=h.array;for(let r=0,h=i.length;r<h;r++){const h=i[r];s.fromArray(c,3*h);const d=rt(s,n,e,o,a);d.pointIsOnScreen&&this.testPoint(s,d.absoluteScreenPosition,l,r,d.distance,t)}}else for(let i=0,r=c.length/3;i<r;i++){s.fromArray(c,3*i);const r=rt(s,n,e,o,a);r.pointIsOnScreen&&this.testPoint(s,r.absoluteScreenPosition,l,i,r.distance,t)}}else{const r=i.vertices;for(let i=0;i<r.length;i++){const s=r[i],h=rt(s,n,e,o,a);h.pointIsOnScreen&&this.testPoint(s,h.absoluteScreenPosition,l,i,h.distance,t)}}}}function rt(e,t,i,n,s){const o=e.clone();o.applyMatrix4(t);const a=o.distanceTo(i.ray.origin);o.project(i.mapView.camera);const l=new r.Yb(o.x,o.y),h=l.x<1&&l.x>-1&&l.y<1&&l.y>-1;if(h){return o.x=(o.x+1)/2*n,o.y=(1-o.y)/2*s,{absoluteScreenPosition:new r.Yb(o.x,o.y),pointIsOnScreen:h,distance:a}}return{pointIsOnScreen:h}}class st extends nt{testPoint(e,t,i,n,r,s){const o=t.x-i.x,a=t.y-i.y;Math.sqrt(o*o+a*a)<=this.material.size/2&&s.push({point:e,distance:r,index:n,object:this})}}class ot extends nt{testPoint(e,t,i,n,r,s){const o=t.x-i.x,a=t.y-i.y,l=this.material.size/2;Math.abs(o)<=l&&Math.abs(a)<=l&&s.push({point:e,distance:r,index:n,object:this})}}function at(e){switch(e){case"clamp":return r.k;case"repeat":return r.Gb;case"mirror":return r.hb;default:throw new Error(`invalid wrapping mode: ${e}`)}}function lt(e){switch(e){case"nearest":return r.ib;case"nearestMipMapNearest":return r.kb;case"nearestMipMapLinear":return r.jb;case"linear":return r.U;case"linearMipMapNearest":return r.X;case"linearMipMapLinear":return r.W;default:throw new Error(`invalid texture filter: ${e}`)}}const ht=p.d.instance.create("DecodedTileHelpers"),ct=[...K.k,"mapProperties","normalMapProperties","displacementMapProperties","roughnessMapProperties","emissiveMapProperties","alphaMapProperties","metalnessMapProperties","bumpMapProperties"];function dt(e,t){const i=e.technique,n=function(e){if(void 0===e.name)return;switch(e.name){case"extruded-line":if(!Object(K.y)(e))throw new Error("Invalid extruded-line technique");return"standard"===e.shading?A:M;case"standard":case"terrain":case"extruded-polygon":return A;case"dashed-line":case"solid-line":return $;case"fill":return M;case"squares":return r.yb;case"circles":return d;case"line":case"segments":return r.Q;case"shader":return r.Lb;case"text":case"labeled-icon":case"line-marker":case"label-rejection-line":return}}(i),s={};if(void 0===n)return;n.prototype instanceof r.Db&&n!==I&&(s.fog=e.fog);const o=new n(s);return void 0!==i.id&&(o.name=i.id),Object(K.z)(i)&&(o.flatShading=!0,!0===i.vertexColors&&delete i.color),o.depthTest=Object(K.z)(i)&&!1!==i.depthTest,(Object(K.L)(i)||Object(K.M)(i)||Object(K.z)(i))&&K.k.forEach(e=>{const n=i[e];if(void 0===n)return;const s=n=>{const r=i[e+"Properties"];void 0!==r&&(void 0!==r.wrapS&&(n.wrapS=at(r.wrapS)),void 0!==r.wrapT&&(n.wrapT=at(r.wrapT)),void 0!==r.magFilter&&(n.magFilter=lt(r.magFilter)),void 0!==r.minFilter&&(n.minFilter=lt(r.minFilter)),void 0!==r.flipY&&(n.flipY=r.flipY),void 0!==r.repeatU&&(n.repeat.x=r.repeatU),void 0!==r.repeatV&&(n.repeat.y=r.repeatV)),o[e]=n,n.needsUpdate=!0,o.needsUpdate=!0,t&&t(n)},a=e=>{ht.error("#createMaterial: Failed to load texture: ",e)};let l;if("string"==typeof n)l=n;else if(Object(K.O)(n))if("image/raw"===n.type){const e=n.dataTextureProperties;if(void 0!==e){const t=e.type?function(e){switch(e){case"UnsignedByte":return r.Vb;case"Byte":return r.j;case"Short":return r.Mb;case"UnsignedShort":return r.Xb;case"Int":return r.I;case"UnsignedInt":return r.Wb;case"Float":return r.C;case"HalfFloat":return r.G;default:throw new Error(`invalid texture data type: ${e}`)}}(e.type):void 0,i=function(e,t){if(void 0===t)return new Uint8Array(e);switch(t){case r.Vb:return new Uint8Array(e);case r.j:return new Int8Array(e);case r.Mb:return new Int16Array(e);case r.Xb:return new Uint16Array(e);case r.I:return new Int32Array(e);case r.Wb:return new Uint32Array(e);case r.C:return new Float32Array(e);case r.G:return new Uint16Array(e)}throw new Error("Unsupported texture data type")}(n.buffer,t);s(new r.q(i,e.width,e.height,e.format?function(e){switch(e){case"Alpha":return r.b;case"RGB":return r.Cb;case"RGBA":return r.Ab;case"Luminance":return r.Z;case"LuminanceAlpha":return r.Y;case"RGBE":return r.Bb;case"Depth":return r.r;case"DepthStencil":return r.s;case"Red":return r.Fb;default:throw new Error(`invalid pixel format: ${e}`)}}(e.format):void 0,t))}else a("no data texture properties provided.")}else{const e=new Blob([n.buffer],{type:n.type});l=URL.createObjectURL(e)}l&&(new r.Qb).load(l,s,void 0,a)}),Object(K.I)(i)?function(e,t){const i=e.params,n=bt(e),r=n&&n in e.params;if(Object.getOwnPropertyNames(i).filter(e=>{if(n===e||r&&K["l"].indexOf(e)!==-1){return false}const t=e;if(t==="name"){return false}return true}).forEach(e=>{gt(t,e,i[e])}),r){const r=n;_t(t,t[r],e,i[r])}}(i,o):function(e,t,i,n){const r=bt(e),s=r&&r in e;Object.getOwnPropertyNames(e).filter(e=>{if(e.startsWith("_")||pt.indexOf(e)!==-1||ct.indexOf(e)!==-1||n!==undefined&&n.indexOf(e)!==-1){return false}if(r===e||s&&K["l"].indexOf(e)!==-1){return false}const i=e;const o=t;if(typeof o[i]==="undefined"){return false}return true}).forEach(n=>{const r=e[n];void 0!==r&&gt(t,n,r,i)}),s&&_t(t,t[r],e,e[r],i)}(i,o,e.level,e.skipExtraProps),o}function mt(e){switch(e.type){case"float":return new r.h(new Float32Array(e.buffer),e.itemCount);case"uint8":return new r.h(new Uint8Array(e.buffer),e.itemCount,e.normalized);case"uint16":return new r.h(new Uint16Array(e.buffer),e.itemCount,e.normalized);case"uint32":return new r.h(new Uint32Array(e.buffer),e.itemCount,e.normalized);case"int8":return new r.h(new Int8Array(e.buffer),e.itemCount,e.normalized);case"int16":return new r.h(new Int16Array(e.buffer),e.itemCount,e.normalized);case"int32":return new r.h(new Int32Array(e.buffer),e.itemCount,e.normalized);default:throw new Error(`unsupported buffer of type ${e.type}`)}}function ut(e){if(void 0!==e.name)switch(e.name){case"extruded-line":case"standard":case"terrain":case"extruded-polygon":case"fill":case"dashed-line":case"solid-line":return r.eb;case"circles":return st;case"squares":return ot;case"line":case"segments":return r.T;case"shader":if(!Object(K.I)(e))throw new Error("Invalid technique");switch(e.primitive){case"line":return r.O;case"segments":return r.T;case"point":return r.xb;case"mesh":return r.eb;default:return}case"text":case"labeled-icon":case"line-marker":case"label-rejection-line":return}}const pt=["name","id","renderOrder","transient"];function ft(e,t){const i=function(e){const t=bt(e);if(void 0!==t){if(Object(K.I)(e)){return e.params[t]}return e[t]}return}(e);if(void 0!==i)return xt(i,t)}function gt(e,t,i,n){const s=e;s[t]instanceof r.l?vt(e[t],i,n):s[t]=yt(i,n)}function vt(e,t,i){let n=xt(t,i);K.a.hasAlphaInHex(n)&&(ht.warn("Used RGBA value for technique color without transparency support!"),n=K.a.removeAlphaFromHex(n)),e.setHex(n)}function _t(e,t,i,n,s){const o=xt(n,s),{r:l,g:h,b:c,a:d}=K.a.getRgbaFromHex(o),m=i;let u=d;void 0!==m.opacity&&(u*=yt(m.opacity,s)),u=r.bb.clamp(u,0,1),e.opacity=u,t.setRGB(l,h,c),u>=1?function(e){e.transparent||e.forcedBlending||(e.blending=r.nb)}(e):a(e)}function yt(e,t){return void 0!==t&&(Object(K.B)(e)||K.b.isExpr(e))&&(e=Object(K.w)(e,t)),e}function xt(e,t){if("number"==typeof(e=yt(e,t)))return e;if("string"==typeof e){const t=Object(K.Q)(e);if(void 0!==t)return t}throw new Error(`Unsupported color format: '${e}'`)}function bt(e){const t=K.R[e.name];return void 0!==t?t.attrTransparencyColor:void 0}var wt=i(10);const Tt=1,St=1e-6;function Ct(e){if(!1===e.enableDepthPrePass)return!1;let t=void 0!==e.opacity&&e.opacity>0&&e.opacity<1;if(!t){const i=ft(e);if(void 0!==i){const e=wt.a.getAlphaFromHex(i);t=e>0&&e<1}}return t}function Et(e){e.depthWrite=!1,e.depthFunc=r.x,e.colorWrite=!0,o(e);const t=e.clone();return t.depthWrite=!0,t.depthTest=!0,t.depthFunc=r.N,t.colorWrite=!1,t.opacity=1,t.blending=r.mb,t}function Mt(e){const t=e.geometry;if(!(t instanceof r.i))throw new Error("#createDepthPassMesh only BufferGeometry is supported");const i=t.getAttribute("position");if(!i)throw new Error("#createDepthPassMesh position attribute not found");const n=new r.i;n.setAttribute("position",i);const s=t.getAttribute("uv");s&&n.setAttribute("uv",s);const o=t.getAttribute("normal");o&&n.setAttribute("normal",o);const a=t.getAttribute("extrusionAxis");a&&n.setAttribute("extrusionAxis",a),t.index&&n.setIndex(t.index);for(const e of t.groups){const{start:t,count:i,materialIndex:r}=e;n.addGroup(t,i,r)}const l=e.material instanceof Array?e.material.map(Et):Et(e.material),h=new r.eb(n,l);return h.renderOrder=e.renderOrder-St,h}function At(e,t){const i=e.material;i.stencilWrite=!0,i.stencilFail=r.M,i.stencilZFail=r.M,i.stencilZPass=r.Hb,i.stencilFunc=r.c,i.stencilRef=255,i.stencilFuncMask=Tt;const n=t.material;n.stencilWrite=!0,n.stencilFail=r.M,n.stencilZFail=r.M,n.stencilZPass=r.fc,n.stencilFunc=r.y,n.stencilRef=255,n.stencilFuncMask=Tt}class Pt{constructor(e){this.points=e,this.screenSpaceLines=new Array(e.length>=2?e.length-1:0);for(let e=0;e<this.screenSpaceLines.length;e++)this.screenSpaceLines[e]=new r.P(new r.Zb,new r.Zb)}}var Lt,Rt;!function(e){e[e.PoiLabel=0]="PoiLabel",e[e.PathLabel=1]="PathLabel",e[e.LineMarker=2]="LineMarker"}(Lt||(Lt={})),function(e){e[e.Requested=0]="Requested",e[e.Loaded=1]="Loaded",e[e.Initialized=2]="Initialized"}(Rt||(Rt={}));class Ot{constructor(e,t,i,n,s=0,o=0,a=0,l,h,c,d,m){this.text=e,this.points=t,this.renderParams=i,this.layoutParams=n,this.priority=s,this.xOffset=o,this.yOffset=a,this.featureId=l,this.style=h,this.fadeNear=c,this.fadeFar=d,this.tileOffset=m,this.visible=!0,this.distanceScale=.5,this.renderOrder=0,i instanceof Se&&(this.renderStyle=i),n instanceof Ce&&(this.layoutStyle=n),this.type=t instanceof r.Zb?Lt.PoiLabel:Lt.PathLabel}get position(){if(this.points instanceof Array){return this.points[0]}return this.points}get path(){if(this.points instanceof Array)return this.points}get textMayOverlap(){return!0===this.mayOverlap}set textMayOverlap(e){this.mayOverlap=e}get textReservesSpace(){return!1!==this.reserveSpace}set textReservesSpace(e){this.reserveSpace=e}get poiInfo(){return this.m_poiInfo}set poiInfo(e){if(this.m_poiInfo=e,void 0!==e){void 0!==this.path&&(this.type=Lt.LineMarker);const t=void 0!==this.renderOrder?this.renderOrder:0;e.renderOrder=t}}get renderStyle(){return this.m_renderStyle}set renderStyle(e){this.m_renderStyle=e}get layoutStyle(){return this.m_layoutStyle}set layoutStyle(e){this.m_layoutStyle=e}hasFeatureId(){return void 0!==this.featureId&&0!==this.featureId}updateMinMaxZoomLevelsFromPoiInfo(){void 0!==this.poiInfo&&(void 0===this.minZoomLevel&&(this.minZoomLevel=p.f.min2(this.poiInfo.iconMinZoomLevel,this.poiInfo.textMinZoomLevel)),void 0===this.maxZoomLevel&&(this.maxZoomLevel=p.f.max2(this.poiInfo.iconMaxZoomLevel,this.poiInfo.textMaxZoomLevel)))}}const Ft="undefined"==typeof window;class Dt extends r.z{constructor(e){super(),this.value=e}set(e,t){this.value=e,this.dispatchEvent({type:Dt.SET_EVENT_TYPE,name:t,value:e})}}Dt.SET_EVENT_TYPE="set";const It=new class{constructor(){if(this.m_optionsMap=new Map,!Ft&&"undefined"!=typeof window&&window){window.__debugContext=this}}setValue(e,t){let i=this.m_optionsMap.get(e);i?i.set(t,e):(i=new Dt(t),this.m_optionsMap.set(e,i))}getValue(e){const t=this.m_optionsMap.get(e);return t?t.value:void 0}hasOption(e){return void 0!==this.m_optionsMap.get(e)}addEventListener(e,t){const i=this.m_optionsMap.get(e);if(!i)throw Error("Unknown option: "+e);i.addEventListener(Dt.SET_EVENT_TYPE,t)}hasEventListener(e,t){const i=this.m_optionsMap.get(e);if(i)return i.hasEventListener(Dt.SET_EVENT_TYPE,t);throw Error("Unknown option: "+e)}removeEventListener(e,t){const i=this.m_optionsMap.get(e);if(!i)throw Error("Unknown option: "+e);i.removeEventListener(Dt.SET_EVENT_TYPE,t)}get options(){return this.m_optionsMap}clear(){this.m_optionsMap.forEach(e=>{e.set(void 0,"")})}};var zt=i(4);const kt=p.d.instance.create("RoadPicker"),jt=.01;class Nt{constructor(e){this.m_mapView=e}registerTile(e){if(Object(p.l)(void 0!==e.decodedTile),void 0===e.decodedTile||void 0===e.decodedTile.tileInfo)return;const t=e.decodedTile.tileInfo,i=t.lineGroup;if(void 0===i||0===i.numFeatures)return;const n=[];n.length=i.numFeatures;const r=this.m_mapView;for(let e=0;e<i.numFeatures;e++){const s=t.techniqueCatalog[i.techniqueIndex[e]],o="Pixel"===s.metricUnit||zt.e.isExpr(s.lineWidth)||"string"==typeof s.lineWidth;n[e]=void 0!==s.lineWidth?o?()=>{const e="Pixel"===s.metricUnit?r.pixelToWorld:1;return Object(K.w)(s.lineWidth,r.zoomLevel,r.pixelToWorld)*e*.5}:s.lineWidth:1}const s=t.lineGroup.userData;return{ids:i.featureIds,techniqueIndex:i.techniqueIndex,starts:i.positionIndex,widths:n,positions:i.positions,techniques:t.techniqueCatalog,objInfos:s}}intersectRoads(e,t,i,n){if(e.boundingBox.distanceToPoint(i)>jt)return!1;const r=e.roadIntersectionData;if(void 0===r)return!1;const s=r.ids,o=r.techniques,a=r.techniqueIndex,l=s.length,h=r.positions,c=r.widths,d=i.x-e.center.x,m=i.y-e.center.y,u=i.distanceTo(t);if(c.length!==s.length||s.length!==a.length||a.length!==r.starts.length)return kt.error("The amount of widths, ids, techniqueIndices and starts has to be the same"),!1;for(let e=0;e<l;e++){const t=o[a[e]];if(!0===t.transient)continue;const f=r.starts[e],g=e<l-1?r.starts[e+1]:r.positions.length;let v=h[f],_=h[f+1];const y=c[e],x=Math.max(1,"function"==typeof y?y():y),b=x*x;let w=Number.MAX_VALUE;for(let e=f+2;e<g;e+=2){const t=h[e],i=h[e+1],n=p.e.distToSegmentSquared(d,m,v,_,t,i);n<b&&n<w&&(w=n),v=t,_=i}if(w<Number.MAX_VALUE){const o={type:Gt.Line,point:i,distance:u,distFromCenter:Math.sqrt(w),featureId:s[e],positions:h.slice(f,g),technique:t};this.addUserData(o,e,r.objInfos),n.push(o)}}return!1}addUserData(e,t,i){void 0!==i&&i.length>0&&(e.userData={...i[t]})}}var Gt;!function(e){e[e.Unspecified=0]="Unspecified",e[e.Point=1]="Point",e[e.Line=2]="Line",e[e.Area=3]="Area",e[e.Text=4]="Text",e[e.Icon=5]="Icon",e[e.Object3D=6]="Object3D"}(Gt||(Gt={}));class Ut{constructor(e,t,i=!0){this.mapView=e,this.camera=t,this.enableRoadPicking=i,this.m_plane=new r.ub(new r.Zb(0,0,1)),i&&(this.m_roadPicker=new Nt(e))}registerTile(e){return void 0!==this.m_roadPicker?this.m_roadPicker.registerTile(e):void 0}intersectMapObjects(e,t){const i=this.mapView.getNormalizedScreenCoordinates(e,t),n=this.mapView.raycasterFromScreenPoint(e,t),s=[];if(void 0!==this.mapView.textElementsRenderer){const{clientWidth:e,clientHeight:t}=this.mapView.canvas,n=i.x*e*.5*this.mapView.pixelRatio,o=i.y*t*.5*this.mapView.pixelRatio,a=new r.Yb(n,o);this.mapView.textElementsRenderer.pickTextElements(a,s)}const o=n.intersectObjects(this.mapView.worldRootObject.children,!0);for(const e of o){const t={type:Gt.Unspecified,point:e.point,distance:e.distance,intersection:e};if(void 0===e.object.userData||void 0===e.object.userData.feature){s.push(t);continue}const i=e.object.userData.feature;if(this.addObjInfo(i,e,t),void 0!==i.objInfos){const e=1===i.objInfos.length?Object(K.t)(i.objInfos[0]):void 0;t.featureId=e}let n;switch(i.geometryType){case K.h.Point:case K.h.Text:n=Gt.Point;break;case K.h.Line:case K.h.ExtrudedLine:case K.h.SolidLine:case K.h.TextPath:n=Gt.Line;break;case K.h.Polygon:case K.h.ExtrudedPolygon:n=Gt.Area;break;case K.h.Object3D:n=Gt.Object3D;break;default:n=Gt.Unspecified}t.type=n,s.push(t)}if(this.enableRoadPicking){const e=new r.Zb,t=this.mapView.camera.position.clone();n.setFromCamera(i,this.mapView.camera),n.ray.intersectPlane(this.m_plane,e),this.mapView.forEachVisibleTile(i=>{this.m_roadPicker.intersectRoads(i,t,e,s)})}return s.sort((e,t)=>e.distance-t.distance),s}addObjInfo(e,t,i){if(i.intersection.object instanceof nt)i.userData=e.objInfos[t.index];else if(void 0!==e.objInfos&&void 0!==e.starts&&void 0!==t.faceIndex)if(e.starts.length>1){let n=0;for(const i of e.starts){if(i>3*t.faceIndex)break;n++}i.userData=e.objInfos[n-1]}else i.userData=e.objInfos[0]}}function Bt(e,t,i,n){let r;if((e=>void 0!==e.close)(i))void 0===n&&(n=document.createElement("canvas")),r=function(e,t,i,n){if(t>e.width||t<0||i>e.height||i<0)return;let r;n.width=e.width,n.height=e.height;const s=n.getContext("2d");null!==s&&(s.drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),r=s.getImageData(t,i,1,1).data);return r}(i,e,t,n);else{const n=i;r=function(e,t,i,n){if(t>e.width||t<0||i>e.height||i<0)return;return((e,t,i)=>{const n=t*i,r=e.data,s=new Uint8ClampedArray(i);for(let e=0;e<i;e++)s[0]=r[n+e];return s})(e,i*e.width+t,n)}(n,e,t,n.data.length/(n.height*n.width))}return r}const qt=0,Vt=32768,Wt=4,Zt=6,$t=3,Ht=4,Kt=4,Xt=1,Yt=4,Jt=4;class Qt extends r.eb{constructor(e,t){super(e,t),this.type="BoxBufferMesh"}get isEmpty(){if(void 0===this.geometry)return!0;{const e=this.geometry;return null===e.index||0===e.index.count}}}class ei{constructor(e,t=0,i=qt,n=Vt){this.material=e,this.renderOrder=t,this.startElementCount=i,this.maxElementCount=n,this.m_size=0,this.resizeBuffer(i),this.pickInfos=new Array}clone(){return new ei(this.material,this.renderOrder)}dispose(){void 0!==this.geometry&&(this.geometry.dispose(),this.geometry=void 0),this.internalMesh=void 0}get size(){return this.m_size}reset(){void 0!==this.positionAttribute&&(this.positionAttribute.count=0,this.colorAttribute.count=0,this.uvAttribute.count=0,this.indexAttribute.count=0,this.pickInfos.length=0)}canAddElements(e=1){const t=this.indexAttribute;if(t.count+e*Zt>=t.array.length){if(t.array.length>=this.maxElementCount*Zt)return!1;const e=Math.min(this.maxElementCount,0===this.size?256:2*this.size);this.resize(e)}return!0}saveState(){return{positionAttributeCount:this.positionAttribute.count,colorAttributeCount:this.colorAttribute.count,uvAttributeCount:this.uvAttribute.count,indexAttributeCount:this.indexAttribute.count,pickInfoCount:this.pickInfos.length}}restoreState(e){this.positionAttribute.count=e.positionAttributeCount,this.colorAttribute.count=e.colorAttributeCount,this.uvAttribute.count=e.uvAttributeCount,this.indexAttribute.count=e.indexAttributeCount,this.pickInfos.length=e.pickInfoCount}addBox(e,t,i,n,r,s){if(!this.canAddElements())return!1;const{s0:o,t0:a,s1:l,t1:h}=t,{x:c,y:d,w:m,h:u}=e,p=Math.round(255*i.r),f=Math.round(255*i.g),g=Math.round(255*i.b),v=Math.round(255*n),_=this.positionAttribute,y=this.colorAttribute,x=this.uvAttribute,b=this.indexAttribute,w=_.count,T=b.count;return _.setXYZ(w,c,d,r),_.setXYZ(w+1,c+m,d,r),_.setXYZ(w+2,c,d+u,r),_.setXYZ(w+3,c+m,d+u,r),y.setXYZW(w,p,f,g,v),y.setXYZW(w+1,p,f,g,v),y.setXYZW(w+2,p,f,g,v),y.setXYZW(w+3,p,f,g,v),x.setXY(w,o,a),x.setXY(w+1,l,a),x.setXY(w+2,o,h),x.setXY(w+3,l,h),b.setX(T,w),b.setX(T+1,w+1),b.setX(T+2,w+2),b.setX(T+3,w+2),b.setX(T+4,w+1),b.setX(T+5,w+3),_.count+=Wt,y.count+=Wt,x.count+=Wt,b.count+=Zt,this.pickInfos.push(s),!0}updateBufferGeometry(){const e=this.positionAttribute,t=this.colorAttribute,i=this.uvAttribute,n=this.indexAttribute;e.count>0&&(e.needsUpdate=!0,e.updateRange.offset=0,e.updateRange.count=e.count*Wt),t.count>0&&(t.needsUpdate=!0,t.updateRange.offset=0,t.updateRange.count=t.count*Wt),i.count>0&&(i.needsUpdate=!0,i.updateRange.offset=0,i.updateRange.count=i.count*Wt),n.count>0&&(n.needsUpdate=!0,n.updateRange.offset=0,n.updateRange.count=n.count),void 0!==this.geometry&&(this.geometry.clearGroups(),this.geometry.addGroup(0,this.indexAttribute.count))}cleanUp(){0===this.indexAttribute.count&&this.size>qt&&this.clearAttributes()}get isEmpty(){return this.internalMesh.isEmpty}get mesh(){return void 0===this.internalMesh&&this.resize(),this.internalMesh}pickBoxes(e,t,i){const n=this.pickInfos.length,r=this.pickInfos,s=this.positionAttribute,o=e.x,a=e.y,l=document.createElement("canvas");for(let e=0;e<n;e++){const n=e*Wt,h=s.getX(n);if(o<h)continue;const c=s.getX(n+1);if(o>c)continue;const d=s.getY(n);if(a<d)continue;const m=s.getY(n+2);if(a>m)continue;const u=new p.e.Box(h,d,c-h,m-d);void 0!==i&&void 0!==r[e].poiInfo&&void 0!==r[e].poiInfo.uvBox&&this.isPixelTransparent(i,o,a,u,r[e].poiInfo.uvBox,l)||void 0!==r[e]&&t(r[e])}}resize(e,t){return void 0!==this.geometry&&this.geometry.dispose(),this.geometry=new r.i,void 0!==e&&(!0===t||e>this.size)&&this.resizeBuffer(e),this.geometry.setAttribute("position",this.positionAttribute),this.geometry.setAttribute("color",this.colorAttribute),this.geometry.setAttribute("uv",this.uvAttribute),this.geometry.setIndex(this.indexAttribute),this.geometry.addGroup(0,this.indexAttribute.count),void 0===this.internalMesh?(this.internalMesh=new Qt(this.geometry,this.material),this.internalMesh.renderOrder=this.renderOrder):this.internalMesh.geometry=this.geometry,this.internalMesh}updateMemoryUsage(e){const t=this.positionAttribute.count*$t*Yt+this.colorAttribute.count*Ht+this.uvAttribute.count*Kt*Yt+this.indexAttribute.count*Jt;e.heapSize+=t,e.gpuSize+=t}isPixelTransparent(e,t,i,n,r,s){let o=!1;const{u:a,v:l}=function(e,t,i,n){const r=i.x,s=i.x+i.w,o=i.y,a=i.y+i.h;return{u:p.f.map(e,r,s,n.s0,n.s1),v:p.f.map(t,o,a,n.t0,n.t1)}}(t,i,n,r),h=Bt(e.width*a,e.height*l,e,s);return void 0!==h&&0===h[3]&&(o=!0),o}clearAttributes(){this.positionAttribute=void 0,this.colorAttribute=void 0,this.uvAttribute=void 0,this.indexAttribute=void 0,this.resize(qt,!0)}resizeBuffer(e){const t=new Float32Array(e*Wt*$t);if(void 0!==this.positionAttribute&&this.positionAttribute.array.length>0){const e=this.positionAttribute.count;t.set(this.positionAttribute.array),this.positionAttribute.array=t,this.positionAttribute.count=e}else this.positionAttribute=new r.h(t,$t),this.positionAttribute.count=0,this.positionAttribute.setUsage(r.w);const i=new Uint8Array(e*Wt*Ht);if(void 0!==this.colorAttribute){const e=this.colorAttribute.count;i.set(this.colorAttribute.array),this.colorAttribute.array=i,this.colorAttribute.count=e}else this.colorAttribute=new r.h(i,Ht,!0),this.colorAttribute.count=0,this.colorAttribute.setUsage(r.w);const n=new Float32Array(e*Wt*Kt);if(void 0!==this.uvAttribute){const e=this.uvAttribute.count;n.set(this.uvAttribute.array),this.uvAttribute.array=n,this.uvAttribute.count=e}else this.uvAttribute=new r.h(n,Kt),this.uvAttribute.count=0,this.uvAttribute.setUsage(r.w);const s=e*Zt*Xt,o=s>65535?new Uint32Array(s):new Uint16Array(s);if(void 0!==this.indexAttribute){const e=this.indexAttribute.count;o.set(this.indexAttribute.array),this.indexAttribute.array=o,this.indexAttribute.count=e}else this.indexAttribute=new r.h(o,Xt),this.indexAttribute.count=0,this.indexAttribute.setUsage(r.w);this.m_size=e}}var ti;!function(e){e[e.TopLeft=0]="TopLeft",e[e.BottomLeft=1]="BottomLeft"}(ti||(ti={}));class ii{constructor(e){this.image=e}}const ni=p.d.instance.create("PoiRenderer"),ri=-1,si=new r.Zb(0);class oi{constructor(e,t,i,n){this.mapView=e,this.scene=t,this.imageItem=i,this.renderOrder=n,this.color=it.instance.getColor("#000000")}init(){void 0===this.boxBuffer&&this.setup()}reset(){void 0===this.boxBuffer&&this.init(),this.boxBuffer.reset()}update(){void 0===this.boxBuffer&&this.init(),this.boxBuffer.updateBufferGeometry()}updateMemoryUsage(e){void 0!==this.boxBuffer&&this.boxBuffer.updateMemoryUsage(e)}setup(){const e=new ii(this.imageItem),t=new r.Pb(e.image.imageData,r.Rb,void 0,void 0,r.U,r.U,r.Ab);t.needsUpdate=!0,t.premultiplyAlpha=!0,t.generateMipmaps=!1,this.m_material=new G({map:t}),this.boxBuffer=new ei(this.m_material,this.renderOrder);const i=this.boxBuffer.mesh;i.frustumCulled=!1,this.scene.add(i),this.mapView.update()}}class ai{constructor(e,t){this.mapView=e,this.textCanvas=t,this.batches=[],this.m_batchMap=new Map}registerPoi(e){const{imageItem:t,imageTexture:i,imageTextureName:n}=e;if(void 0===t||void 0===n||void 0===i)return ri;const r=e.renderOrder,s=i.image;let o,a,l=this.m_batchMap.get(s);if(void 0===l&&(l=new Map,this.m_batchMap.set(s,l)),o=l.get(r),void 0!==o)return o;o=this.batches.length;let h=this.textCanvas.getLayer(r);return void 0===h&&(this.textCanvas.addText("",si,{layer:r}),h=this.textCanvas.getLayer(r)),a=new oi(this.mapView,h.storage.scene,t,r),a.init(),l.set(r,o),this.batches.push(a),o}addPoi(e,t,i,n){const r=void 0!==e.poiRenderBatch&&e.poiRenderBatch!==ri?e.poiRenderBatch:this.registerPoi(e);return r===ri?ri:(Object(p.l)(r>=0),Object(p.l)(r<this.batches.length),Object(p.l)(void 0!==e.uvBox),void 0===this.batches[r].boxBuffer&&this.batches[r].init(),this.batches[r].boxBuffer.addBox(t,e.uvBox,this.batches[r].color,n,i,e.textElement),r)}getBatch(e){if(e>=0)return Object(p.l)(e<this.batches.length),this.batches[e]}reset(){for(const e of this.batches)e.reset()}update(){for(const e of this.batches)e.update()}pickTextElements(e,t){for(const i of this.batches)void 0===i.boxBuffer&&i.init(),i.boxBuffer.pickBoxes(e,t,i.imageItem.imageData)}updateMemoryUsage(e){for(const t of this.batches){if(void 0!==t.imageItem.imageData){const i=t.imageItem.imageData.width*t.imageItem.imageData.height*4;e.heapSize+=i,e.gpuSize+=i}void 0!==t.boxBuffer&&t.boxBuffer.updateMemoryUsage(e)}}}class li{constructor(e,t){this.mapView=e,this.textCanvas=t,this.m_tempScreenBox=new p.e.Box,this.m_renderBuffer=new ai(e,t)}static computeIconScreenBox(e,t,i,n,r=new p.e.Box){Object(p.l)(void 0!==e.poiRenderBatch),Object(p.l)(e.poiRenderBatch!==ri);const s=e.computedWidth*i,o=e.computedHeight*i,a=e.technique,l=Object(K.w)(a.iconXOffset,n),h=Object(K.w)(a.iconYOffset,n),c=t.x+("number"==typeof l?l:0),d=t.y+("number"==typeof h?h:0);return r.x=c-s/2,r.y=d-o/2,r.w=s,r.h=o,r}prepareRender(e,t){const i=e.poiInfo;return void 0!==i&&(void 0===i.poiRenderBatch&&this.preparePoi(e,t),void 0!==i.poiRenderBatch)}reset(){this.m_renderBuffer.reset()}renderPoi(e,t,i,n,r,s,o,a){Object(p.l)(void 0!==e.poiRenderBatch),li.computeIconScreenBox(e,t,r,a,this.m_tempScreenBox),s&&i.allocate(this.m_tempScreenBox),this.m_renderBuffer.addPoi(e,this.m_tempScreenBox,n,o)}update(){this.m_renderBuffer.update()}pickTextElements(e,t){this.m_renderBuffer.pickTextElements(e,t)}getMemoryUsage(e){this.m_renderBuffer.updateMemoryUsage(e)}preparePoi(e,t){const i=e.poiInfo;if(void 0===i||!e.visible)return;if(void 0!==i.poiRenderBatch||!1===i.isValid)return;if(void 0!==i.poiTableName){if(!this.mapView.poiManager.updatePoiFromPoiTable(e))return;if(!e.visible)return}const n=i.imageTextureName,r=this.mapView.poiManager.getImageTexture(n);if(void 0===r)return void 0===li.m_missingTextureName.get(n)&&(li.m_missingTextureName.set(n,!0),ni.error(`preparePoi: No imageTexture with name '${n}' found`)),void(i.isValid=!1);const s=r.image;let o=this.mapView.imageCache.findImageByName(s);if(void 0===o)return ni.error(`init: No imageItem found with name '${s}'`),void(i.isValid=!1);if(!o.loaded){if(void 0!==o.loadingPromise)return;const e=o.url,n=this.mapView.imageCache.loadImage(o);if(n instanceof Promise)return void n.then(n=>{void 0!==n?this.setupPoiInfo(i,r,n,t):ni.error(`preparePoi: Failed to load imageItem: '${e}`)}).catch(t=>{ni.error(`preparePoi: Failed to load imageItem: '${e}`,t),i.isValid=!1});o=n}this.setupPoiInfo(i,r,o,t)}setupPoiInfo(e,t,i,n){if(Object(p.l)(void 0===e.uvBox),void 0===i||void 0===i.imageData)return ni.error("setupPoiInfo: No imageItem/imageData found"),e.poiRenderBatch=ri,void(e.isValid=!1);const r=e.technique,s=i.imageData.width,o=i.imageData.height,a=void 0!==t.width?t.width:s,l=void 0!==t.height?t.height:o;let h=0,c=1,d=0,m=1,u=void 0!==r.iconScale?r.iconScale:1,f=void 0!==r.iconScale?r.iconScale:1;const g=void 0!==t.width?t.width:s,v=void 0!==t.height?t.height:o,_=void 0!==t.xOffset?t.xOffset:0,y=void 0!==t.yOffset?t.yOffset:0;h=_/s,c=(_+g)/s;d=(o-y)/o,m=(o-y-v)/o;const x=Object(K.w)(r.screenWidth,n);void 0!==x&&(f=u=x/a);const b=Object(K.w)(r.screenHeight,n);void 0!==b&&(f=b/l,void 0!==x&&(u=f)),e.computedWidth=a*u,e.computedHeight=l*f,e.uvBox={s0:h,t0:m,s1:c,t1:d},e.imageItem=i,e.imageTexture=t,e.poiRenderBatch=this.m_renderBuffer.registerPoi(e),e.isValid=!0,Object(p.l)(void 0!==e.poiRenderBatch)}}li.m_missingTextureName=new Map;const hi=new r.Zb(0,0,0),ci=new r.Zb(0,0,0),di=.5877852522924731;function mi(e,t){let i;if(Array.isArray(t.points)&&t.points.length>1){const n=e.distanceTo(t.points[0]),r=e.distanceTo(t.points[t.points.length-1]);i=Math.min(n,r)}else i=e.distanceTo(t.points);return i}function ui(e,t){return e.maxVisibilityDist*t}var pi;function fi(e,t,i,r,s,o){let a;return e.visible?r.updatePoiFromPoiTable(e)?e.visible&&p.f.isClamped(t.zoomLevel,e.minZoomLevel,e.maxZoomLevel)?(a=void 0===o?mi(t.worldCenter,e):function(e,t,i,r,s){const o=mi(e,t);return i!==n.f.Spherical?o<=s?o:void 0:(hi.copy(t.position).normalize(),r.getWorldPosition(ci).normalize(),hi.dot(ci)>di&&o<=s?o:void 0)}(t.worldCenter,e,s,i,o),void 0===a?{result:pi.TooFar,viewDistance:a}:{result:pi.Ok,viewDistance:a}):{result:pi.Invisible,viewDistance:a}:{result:pi.NotReady,viewDistance:a}:{result:pi.Invisible,viewDistance:a}}!function(e){e[e.Ok=0]="Ok",e[e.NotReady=1]="NotReady",e[e.Invisible=2]="Invisible",e[e.TooFar=3]="TooFar",e[e.Duplicate=4]="Duplicate",e[e.Count=5]="Count"}(pi||(pi={}));class gi extends r.R{constructor(e,t){super(e,t)}getLengths(){return void 0===this.m_lengths&&(this.m_lengths=[0,this.v2.distanceTo(this.v1)]),this.m_lengths}}class vi{constructor(e,t,i){this.path=e,this.index=t,this.t=i}get curve(){return this.path.curves[this.index]}get point(){return void 0===this.m_point&&(this.m_point=this.curve.getPoint(this.t)),this.m_point}}class _i extends r.sb{constructor(){super()}getLengths(){if(this.m_cache)return this.m_cache;let e=0;const t=new Array;return t.push(0),this.curves.forEach(i=>{const n=i;e+=n.v1.distanceTo(n.v2),t.push(e)}),this.m_cache=t,t}getParamAt(e){const t=e*this.getLength(),i=this.getCurveLengths();for(let e=0;e<i.length;++e){if(i[e]<t)continue;const n=i[e]-t,r=this.curves[e].getLength();return new vi(this,e,0===r?0:1-n/r)}return null}}const yi="./resources/fonts/Default_FontCatalog.json",xi=500,bi=300,wi=.99,Ti=.7,Si=1.5,Ci=1024,Ei=32768;var Mi;!function(e){e[e.Undefined=0]="Undefined",e[e.FadingIn=1]="FadingIn",e[e.FadedIn=2]="FadedIn",e[e.FadingOut=-1]="FadingOut",e[e.FadedOut=-2]="FadedOut"}(Mi||(Mi={}));const Ai=800;class Pi{constructor(e=0,t=0,i=1){this.value=e,this.startTime=t,this.opacity=i,this.m_state=Mi.Undefined}reset(){this.m_state=Mi.Undefined,this.value=0,this.startTime=0,this.opacity=1}isUndefined(){return this.m_state===Mi.Undefined}isFading(){return this.m_state===Mi.FadingIn||this.m_state===Mi.FadingOut}isFadingIn(){return this.m_state===Mi.FadingIn}isFadingOut(){return this.m_state===Mi.FadingOut}isFadedIn(){return this.m_state===Mi.FadedIn}isFadedOut(){return this.m_state===Mi.FadedOut}isVisible(){return this.m_state!==Mi.FadedOut&&this.m_state!==Mi.Undefined}startFadeIn(e){this.m_state!==Mi.FadingIn&&this.m_state!==Mi.FadedIn&&(this.m_state===Mi.FadingOut?(this.value=1-this.value,this.startTime=e-this.value*Ai):(this.startTime=e,this.value=0,this.opacity=0),this.m_state=Mi.FadingIn)}startFadeOut(e){this.m_state!==Mi.FadingOut&&this.m_state!==Mi.FadedOut&&(this.m_state===Mi.FadingIn?(this.startTime=e-this.value*Ai,this.value=1-this.value):(this.startTime=e,this.value=0,this.opacity=1),this.m_state=Mi.FadingOut)}updateFading(e,t){if(this.m_state!==Mi.FadingIn&&this.m_state!==Mi.FadingOut)return;0===this.startTime&&(this.startTime=e);const i=e-this.startTime,n=this.m_state===Mi.FadingIn?0:1,s=this.m_state===Mi.FadingIn?1:0;t||i>=Ai?(this.value=1,this.opacity=s,this.m_state=this.m_state===Mi.FadingIn?Mi.FadedIn:Mi.FadedOut):(this.value=i/Ai,this.opacity=r.bb.clamp(p.f.smootherStep(n,s,this.value),0,1),Object(p.l)(this.isFading()))}}class Li{constructor(e){this.element=e}get initialized(){return void 0!==this.m_textRenderState||void 0!==this.m_iconRenderStates}get visible(){if(void 0!==this.m_textRenderState&&this.m_textRenderState.isVisible())return!0;const e=this.iconRenderState;if(void 0!==e&&e.isVisible())return!0;const t=this.iconRenderStates;if(void 0===t)return!1;for(const e of t)if(e.isVisible())return!0;return!1}reset(){if(void 0!==this.m_textRenderState&&this.m_textRenderState.reset(),this.iconRenderState)this.m_iconRenderStates.reset();else if(void 0!==this.m_iconRenderStates)for(const e of this.m_iconRenderStates)e.reset();this.m_viewDistance=void 0}replace(e){this.m_textRenderState=e.m_textRenderState,this.m_iconRenderStates=e.m_iconRenderStates,e.m_textRenderState=void 0,e.m_iconRenderStates=void 0,void 0===this.element.glyphs&&(this.element.glyphs=e.element.glyphs,this.element.bounds=e.element.bounds,this.element.glyphCaseArray=e.element.glyphCaseArray)}get viewDistance(){return this.m_viewDistance}update(e){this.initialized?this.setViewDistance(e):void 0!==e&&this.initialize(e)}setViewDistance(e){e!==this.m_viewDistance&&(this.m_viewDistance=e)}get renderDistance(){return!0===this.element.alwaysOnTop?0:void 0!==this.m_viewDistance?-this.m_viewDistance:0}get textRenderState(){return this.m_textRenderState}get iconRenderState(){if(void 0!==this.m_iconRenderStates)return this.m_iconRenderStates instanceof Pi?this.m_iconRenderStates:void 0}get iconRenderStates(){if(void 0!==this.m_iconRenderStates)return this.m_iconRenderStates instanceof Pi?void 0:this.m_iconRenderStates}updateFading(e,t){if(void 0!==this.m_textRenderState&&this.m_textRenderState.updateFading(e,t),void 0!==this.iconRenderState){this.m_iconRenderStates.updateFading(e,t)}else if(void 0!==this.iconRenderStates)for(const i of this.m_iconRenderStates)i.updateFading(e,t)}initialize(e){if(Object(p.l)(void 0===this.m_textRenderState),Object(p.l)(void 0===this.m_iconRenderStates),this.setViewDistance(e),this.element.type!==Lt.LineMarker)this.m_textRenderState=new Pi,this.element.type===Lt.PoiLabel&&(this.m_iconRenderStates=new Pi);else{this.m_iconRenderStates=new Array;for(const e of this.element.points){const e=this.m_iconRenderStates,t=new Pi;e.push(t)}}}}class Ri{constructor(e,t){this.group=e,this.m_visited=!1,Object(p.l)(e.elements.length>0);const i=e.elements.length;this.m_textElementStates=new Array(i),this.m_visited=!0;for(let n=0;n<i;++n){const i=e.elements[n],r=new Li(i),s=t(r);r.update(s),this.m_textElementStates[n]=r}}get visited(){return this.m_visited}set visited(e){this.m_visited=e}get priority(){return this.m_textElementStates[0].element.priority}updateFading(e,t){for(const i of this.m_textElementStates)void 0!==i&&i.updateFading(e,t)}traverseVisibleElements(e){for(const t of this.m_textElementStates)void 0!==t&&t.visible&&e(t)}updateElements(e){for(const t of this.m_textElementStates){const i=e(t);t.update(i)}}get size(){return this.m_textElementStates.length}get textElementStates(){return this.m_textElementStates}}const Oi=p.d.instance.create("TextElementsStateCache",{level:p.c.Log});const Fi={entries:[],index:-1};function Di(e){return e.hasFeatureId()?e.featureId:e.text}class Ii{constructor(){this.m_referenceMap=new Map,this.m_textMap=new Map}getOrSet(e,t){let i=this.get(e);return void 0!==i?(Object(p.l)(i.size===e.elements.length),i.updateElements(t),[i,!0]):(i=new Ri(e,t),this.set(e,i),[i,!1])}get size(){return this.m_referenceMap.size}get sortedGroupStates(){return void 0===this.m_sortedGroupStates&&(this.m_sortedGroupStates=Array.from(this.m_referenceMap.values()),this.m_sortedGroupStates.sort((e,t)=>t.group.priority-e.group.priority)),Object(p.l)(this.m_referenceMap.size===this.m_sortedGroupStates.length),this.m_sortedGroupStates}update(e,t,i,n){const r=i?this.replaceElement.bind(this,n):void 0;let s=!1;for(const[n,o]of this.m_referenceMap.entries())o.visited?o.updateFading(e,t):(i&&o.traverseVisibleElements(r),this.m_referenceMap.delete(n),this.m_sortedGroupStates=void 0,s=!0);return s}clearVisited(){for(const e of this.m_referenceMap.values())e.visited=!1}clearTextCache(){this.m_textMap.clear()}clear(){this.m_referenceMap.clear(),this.m_sortedGroupStates=void 0,this.m_textMap.clear()}deduplicateElement(e,t){const i=this.findDuplicate(t,e);if(void 0===i)return this.m_textMap.set(Di(t.element),[t]),!0;if(-1===i.index)return i.entries.push(t),!0;const n=i.entries[i.index];return!(n.visible||!t.visible)&&(i.entries[i.index]=t,n.reset(),!0)}replaceElement(e,t){Object(p.l)(t.visible);const i=this.findDuplicate(t,e);if(void 0===i||-1===i.index)return;const n=i.entries[i.index];Object(p.l)(!n.visible),n.replace(t)}get(e){const t=this.m_referenceMap.get(e);return void 0!==t&&(t.visited=!0),t}set(e,t){Object(p.l)(e.elements.length>0),this.m_referenceMap.set(e,t),this.m_sortedGroupStates=void 0}findDuplicate(e,t){const i=e.element,n=this.m_textMap.get(Di(i));if(void 0===n)return;if(Fi.entries=n,i.hasFeatureId()){if(Fi.index=n.findIndex(e=>e.element.tileOffset===i.tileOffset),-1===Fi.index)return Fi;const r=n[Fi.index].element;return Object(p.l)(i.featureId===r.featureId),r.text!==i.text?(Oi.warn(`Text feature id ${i.featureId} collision between "${i.text} and                      ${r.text}`),i.featureId=void 0,this.findDuplicate(e,t)):Fi}const r=function(e){return 100<<(Math.min(4,13-Math.min(13,Math.floor(e)))<<2)}(t),s=n.length,o=i.position,a=e.visible;let l=-1;for(let e=0;e<s;++e){const t=n[e];if((!a||!t.visible)&&o.distanceToSquared(t.element.position)<r){l=e;break}}return Fi.index=l,Fi}}const zi=p.d.instance.create("TextStyleCache"),ki="Default";function ji(e,t,i){return`${e}_${t._key}_${i}`}class Ni{constructor(){this.m_map=new Map,this.m_map.set(ki,new Se({fontSize:{unit:ge.Pixel,size:32,backgroundSize:8},color:it.instance.getColor("#6d7477"),backgroundColor:it.instance.getColor("#f7fbfd"),backgroundOpacity:.5}))}get size(){return this.m_map.size}get(e){return this.m_map.get(e)}set(e,t){this.m_map.set(e,t)}clear(){this.m_map.clear(),this.m_map.set(ki,new Se({fontSize:{unit:ge.Pixel,size:32,backgroundSize:8},color:it.instance.getColor("#6d7477"),backgroundColor:it.instance.getColor("#f7fbfd"),backgroundOpacity:.5}))}}class Gi{constructor(){this.m_map=new Map,this.m_map.set(ki,new Ce({verticalAlignment:ye.Center,horizontalAlignment:xe.Center}))}get size(){return this.m_map.size}get(e){return this.m_map.get(e)}set(e,t){this.m_map.set(e,t)}clear(){this.m_map.clear(),this.m_map.set(ki,new Ce({verticalAlignment:ye.Center,horizontalAlignment:xe.Center}))}}const Ui="default";class Bi{constructor(e){this.m_theme=e,this.m_textRenderStyleCache=new Ni,this.m_textLayoutStyleCache=new Gi,this.m_colorMap=new Map,this.m_textStyles=new Map,this.m_defaultStyle={name:Ui,fontCatalog:"",renderParams:this.m_textRenderStyleCache.get(ki).params,layoutParams:this.m_textLayoutStyleCache.get(ki).params}}initializeDefaultTextElementStyle(e){void 0===this.m_theme.textStyles&&(this.m_theme.textStyles=[]);const t=this.m_theme.textStyles,i=t.find(e=>e.name===Ui);void 0!==i?this.m_defaultStyle=this.createTextElementStyle(i,Ui):void 0!==this.m_theme.defaultTextStyle?this.m_defaultStyle=this.createTextElementStyle(this.m_theme.defaultTextStyle,Ui):t.length>0&&(this.m_defaultStyle=this.createTextElementStyle(t[0],Ui)),this.m_defaultStyle.fontCatalog=e}initializeTextElementStyles(e,t,i){if(void 0!==this.m_defaultStyle.fontCatalog){const e=i.find(e=>e.fontCatalog===this.m_defaultStyle.fontCatalog);this.m_defaultStyle.textCanvas=void 0!==e?e.textCanvas:void 0,this.m_defaultStyle.poiRenderer=void 0!==e?e.poiRenderer:void 0}void 0===this.m_defaultStyle.textCanvas&&(void 0!==this.m_defaultStyle.fontCatalog&&zi.warn(`FontCatalog '${this.m_defaultStyle.fontCatalog}' set in TextStyle '${this.m_defaultStyle.name}' not found, using default fontCatalog(${t.fontCatalog.name}).`),this.m_defaultStyle.textCanvas=t,this.m_defaultStyle.poiRenderer=e),this.m_theme.textStyles.forEach(e=>{this.m_textStyles.set(e.name,this.createTextElementStyle(e,e.name))});for(const[,n]of this.m_textStyles)if(void 0===n.textCanvas){if(void 0!==n.fontCatalog){const e=i.find(e=>e.fontCatalog===n.fontCatalog);n.textCanvas=void 0!==e?e.textCanvas:void 0,n.poiRenderer=void 0!==e?e.poiRenderer:void 0}void 0===n.textCanvas&&(void 0!==n.fontCatalog&&zi.warn(`FontCatalog '${n.fontCatalog}' set in TextStyle '${n.name}' not found, using default fontCatalog(${t.fontCatalog.name}).`),n.textCanvas=t,n.poiRenderer=e)}}getTextElementStyle(e){let t;return void 0===e?t=this.m_defaultStyle:(t=this.m_textStyles.get(e),void 0===t&&(t=this.m_defaultStyle)),t}getRenderStyle(e,t){const i=e.mapView,n=e.dataSource,r=i.zoomLevel,s=ji(n.name,t,Math.floor(r));let o=this.m_textRenderStyleCache.get(s);if(void 0===o){const e=this.m_defaultStyle.renderParams;let i=Object(K.w)(Object(p.r)(t.opacity,e.opacity),Math.floor(r));if(void 0!==t.color){let e=xt(t.color,Math.floor(r));if(K.a.hasAlphaInHex(e)){i*=K.a.getAlphaFromHex(e),e=K.a.removeAlphaFromHex(e)}this.m_colorMap.set(s,it.instance.getColor(e))}let n=void 0!==t.backgroundOpacity?Object(K.w)(t.backgroundOpacity,Math.floor(r)):void 0!==t.backgroundColor&&void 0!==t.backgroundSize&&Object(K.w)(t.backgroundSize,Math.floor(r))>0?1:e.backgroundOpacity;if(void 0!==t.backgroundColor){let e=xt(t.backgroundColor,Math.floor(r));if(K.a.hasAlphaInHex(e)){n*=K.a.getAlphaFromHex(e),e=K.a.removeAlphaFromHex(e)}this.m_colorMap.set(s+"_bg",it.instance.getColor(e))}const a={fontName:Object(p.r)(t.fontName,e.fontName),fontSize:{unit:ge.Pixel,size:void 0!==t.size?Object(K.w)(t.size,Math.floor(r)):e.fontSize.size,backgroundSize:void 0!==t.backgroundSize?Object(K.w)(t.backgroundSize,Math.floor(r)):e.fontSize.backgroundSize},fontStyle:"Regular"===t.fontStyle||"Bold"===t.fontStyle||"Italic"===t.fontStyle||"BoldItalic"===t.fontStyle?ve[t.fontStyle]:e.fontStyle,fontVariant:"Regular"===t.fontVariant||"AllCaps"===t.fontVariant||"SmallCaps"===t.fontVariant?_e[t.fontVariant]:e.fontVariant,rotation:Object(p.r)(t.rotation,e.rotation),color:Object(p.r)(this.m_colorMap.get(s),e.color),backgroundColor:Object(p.r)(this.m_colorMap.get(s+"_bg"),e.backgroundColor),opacity:i,backgroundOpacity:n},l=this.getTextElementStyle(t.style).renderParams;o=new Se({...l,...a}),this.m_textRenderStyleCache.set(s,o)}return o}getLayoutStyle(e,t){const i=Math.floor(e.mapView.zoomLevel),n=ji(e.dataSource.name,t,i);let r=this.m_textLayoutStyleCache.get(n);if(void 0===r){var s,o,a,l,h,c;const e=this.m_defaultStyle.layoutParams,d=Object(K.w)(t.hAlignment,i),m=Object(K.w)(t.vAlignment,i),u=Object(K.w)(t.wrappingMode,i),p="Left"===d||"Center"===d||"Right"===d?xe[d]:e.horizontalAlignment,f="Above"===m||"Center"===m||"Below"===m?ye[m]:e.verticalAlignment,g={tracking:null!==(s=Object(K.w)(t.tracking,i))&&void 0!==s?s:e.tracking,leading:null!==(o=Object(K.w)(t.leading,i))&&void 0!==o?o:e.leading,maxLines:null!==(a=Object(K.w)(t.maxLines,i))&&void 0!==a?a:e.maxLines,lineWidth:null!==(l=Object(K.w)(t.lineWidth,i))&&void 0!==l?l:e.lineWidth,canvasRotation:null!==(h=Object(K.w)(t.canvasRotation,i))&&void 0!==h?h:e.canvasRotation,lineRotation:null!==(c=Object(K.w)(t.lineRotation,i))&&void 0!==c?c:e.lineRotation,wrappingMode:"None"===u||"Character"===u||"Word"===u?be[u]:e.wrappingMode,horizontalAlignment:p,verticalAlignment:f},v=this.getTextElementStyle(t.style);r=new Ce({...v,...g}),this.m_textLayoutStyleCache.set(n,r)}return r}createTextElementStyle(e,t){return{name:t,fontCatalog:Object(p.r)(e.fontCatalogName,this.m_defaultStyle.fontCatalog),renderParams:{fontName:e.fontName,fontSize:{unit:ge.Pixel,size:32,backgroundSize:e.backgroundSize||8},fontStyle:"Regular"===e.fontStyle||"Bold"===e.fontStyle||"Italic"===e.fontStyle||"BoldItalic"===e.fontStyle?ve[e.fontStyle]:void 0,fontVariant:"Regular"===e.fontVariant||"AllCaps"===e.fontVariant||"SmallCaps"===e.fontVariant?_e[e.fontVariant]:void 0,rotation:e.rotation,color:void 0!==e.color?it.instance.getColor(e.color):void 0,backgroundColor:void 0!==e.backgroundColor?it.instance.getColor(e.backgroundColor):void 0,opacity:e.opacity,backgroundOpacity:e.backgroundOpacity},layoutParams:{tracking:e.tracking,leading:e.leading,maxLines:e.maxLines,lineWidth:e.lineWidth,canvasRotation:e.canvasRotation,lineRotation:e.lineRotation,wrappingMode:"None"===e.wrappingMode||"Character"===e.wrappingMode||"Word"===e.wrappingMode?be[e.wrappingMode]:be.Word,verticalAlignment:"Above"===e.vAlignment||"Center"===e.vAlignment||"Below"===e.vAlignment?ye[e.vAlignment]:ye.Center,horizontalAlignment:"Left"===e.hAlignment||"Center"===e.hAlignment||"Right"===e.hAlignment?xe[e.hAlignment]:xe.Center}}}}const qi=1/0;var Vi;!function(e){e[e.PersistentLabels=0]="PersistentLabels",e[e.NewLabels=1]="NewLabels"}(Vi||(Vi={}));const Wi=.5,Zi=2e4,$i=100,Hi=5,Ki=10,Xi=5,Yi=p.d.instance.create("TextElementsRenderer",{level:p.c.Log}),Ji=!1,Qi=Ji?new class{constructor(e){this.m_logger=e,this.tiles=0,this.totalGroups=0,this.newGroups=0,this.totalLabels=0,this.results=new Array(pi.Count),this.results.fill(0)}clear(){this.tiles=0,this.totalGroups=0,this.newGroups=0,this.totalLabels=0,this.results.fill(0)}log(){this.m_logger.debug("Tiles",this.tiles),this.m_logger.debug("Total groups",this.totalGroups),this.m_logger.debug("New groups",this.newGroups),this.m_logger.debug("Total labels",this.totalLabels),this.m_logger.debug("Placed labels",this.results[pi.Ok]),this.m_logger.debug("Invisible",this.results[pi.Invisible]),this.m_logger.debug("Poi not ready",this.results[pi.NotReady]),this.m_logger.debug("Too far",this.results[pi.TooFar]),this.m_logger.debug("Duplicate",this.results[pi.Duplicate])}}(Yi):void 0,en=Ji?new class{constructor(e){this.m_logger=e,this.totalGroups=0,this.resortedGroups=0,this.total=0,this.uninitialized=0,this.tooFar=0,this.numNotVisible=0,this.numPathTooSmall=0,this.numCannotAdd=0,this.numRenderedPoiIcons=0,this.numRenderedPoiTexts=0,this.numPoiTextsInvisible=0,this.numRenderedTextElements=0}clear(){this.totalGroups=0,this.resortedGroups=0,this.total=0,this.uninitialized=0,this.tooFar=0,this.numNotVisible=0,this.numPathTooSmall=0,this.numCannotAdd=0,this.numRenderedPoiIcons=0,this.numRenderedPoiTexts=0,this.numPoiTextsInvisible=0,this.numRenderedTextElements=0}log(){const e=this.uninitialized+this.numPoiTextsInvisible+this.tooFar+this.numNotVisible+this.numCannotAdd;this.m_logger.debug("Total groups",this.totalGroups),this.m_logger.debug("Resorted groups",this.resortedGroups),this.m_logger.debug("Total labels",this.total),this.m_logger.debug("Rendered labels",this.numRenderedTextElements),this.m_logger.debug("Rejected labels",e),this.m_logger.debug("Unitialized labels",this.uninitialized),this.m_logger.debug("Rendered poi icons",this.numRenderedPoiIcons),this.m_logger.debug("Rendered poi texts",this.numRenderedPoiTexts),this.m_logger.debug("Poi text invisible",this.numPoiTextsInvisible),this.m_logger.debug("Too far",this.tooFar),this.m_logger.debug("Not visible",this.numNotVisible),this.m_logger.debug("Path too small",this.numPathTooSmall),this.m_logger.debug("Rejected, max glyphs reached",this.numCannotAdd)}}(Yi):void 0,tn=new r.f,nn=[],rn=new p.e.Box,sn=new r.Zb,on=new r.Yb,an=[],ln=new r.Yb,hn=new r.Yb,cn={};class dn{constructor(e,t){this.tile=e,this.group=t}}class mn{constructor(e){this.lists=e}get priority(){return Object(p.l)(this.lists.length>0),this.lists[0].group.priority}count(){let e=0;for(const t of this.lists)e+=t.group.elements.length;return e}}function un(e){if(void 0===e||Ki<=0)return!1;return p.g.now()-e>Ki&&(Yi.debug("Placement time limit exceeded."),!0)}class pn{constructor(e,t,i,n,s,o,a,l,h,c,d){this.m_viewState=e,this.m_viewCamera=t,this.m_viewUpdateCallback=i,this.m_screenCollisions=n,this.m_screenProjector=s,this.m_textCanvasFactory=o,this.m_poiManager=a,this.m_poiRendererFactory=l,this.m_fontCatalogLoader=h,this.m_theme=c,this.m_initialized=!1,this.m_glyphLoadingCount=0,this.m_initializedTextElementCount=0,this.m_textRenderers=[],this.m_tmpVector=new r.Yb,this.m_overloaded=!1,this.m_cacheInvalidated=!1,this.m_forceNewLabelsPass=!1,this.m_textElementStateCache=new Ii,this.m_textStyleCache=new Bi(this.m_theme),this.m_options={...d},function(e){void 0===e.fontCatalog&&(e.fontCatalog=yi),void 0===e.minNumGlyphs&&(e.minNumGlyphs=Ci),void 0===e.maxNumGlyphs&&(e.maxNumGlyphs=Ei),void 0===e.maxNumVisibleLabels&&(e.maxNumVisibleLabels=xi),void 0===e.numSecondChanceLabels&&(e.numSecondChanceLabels=bi),void 0===e.labelDistanceScaleMin&&(e.labelDistanceScaleMin=Ti),void 0===e.labelDistanceScaleMax&&(e.labelDistanceScaleMax=Si),void 0===e.maxDistanceRatioForTextLabels&&(e.maxDistanceRatioForTextLabels=wi),void 0===e.maxDistanceRatioForPoiLabels&&(e.maxDistanceRatioForPoiLabels=wi),void 0===e.disableFading&&(e.disableFading=!1)}(this.m_options),this.m_textCanvasFactory.setGlyphCountLimits(this.m_options.minNumGlyphs,this.m_options.maxNumGlyphs)}set disableFading(e){this.m_options.disableFading=e}get disableFading(){return!0===this.m_options.disableFading}get styleCache(){return this.m_textStyleCache}renderText(e){if(this.initialized){this.updateGlyphDebugMesh();for(const t of this.m_textRenderers)t.textCanvas.render(e)}}invalidateCache(){this.m_cacheInvalidated=!0}movementStarted(){}movementFinished(){this.invalidateCache()}get overloaded(){return this.m_overloaded}placeText(e,t,i){const n=function(e){let t=!1;return e.forEach(({renderedTiles:e})=>{e.forEach(e=>{e.textElementsChanged&&(e.textElementsChanged=!1,t=!0)})}),t}(e),r=this.hasOverlayText()||n;if(!this.initialize(r))return;const s=this.m_cacheInvalidated||n||this.m_viewState.renderedTilesChanged;Yi.debug(`FRAME: ${this.m_viewState.frameNumber}, ZOOM LEVEL: ${this.m_viewState.zoomLevel}`),s&&(this.m_textElementStateCache.clearVisited(),this.updateTextElements(e,t));const o=s,a=this.m_textElementStateCache.update(i,this.m_options.disableFading,o,this.m_viewState.zoomLevel);this.reset(),this.prepopulateScreenWithBlockingElements(e);const l=s||a;this.placeTextElements(i,l),this.placeOverlayTextElements(),this.updateTextRenderers()}addOverlayText(e){0!==e.length&&(this.m_overlayTextElements=void 0===this.m_overlayTextElements?e.slice():this.m_overlayTextElements.concat(e))}clearOverlayText(){this.m_overlayTextElements=[]}hasOverlayText(){return void 0!==this.m_overlayTextElements&&this.m_overlayTextElements.length>0}get overlayText(){return this.m_overlayTextElements}pickTextElements(e,t){const i=(i,n)=>{const r=i;if(void 0===r)return;let s=!1;if(void 0!==r.featureId&&(s=t.some(e=>void 0!==e&&n===e.type&&(void 0!==e.featureId&&e.featureId===r.featureId||void 0!==e.userData&&e.userData===r.userData)),!s)){const i={type:n,point:e,distance:0,featureId:r.featureId,userData:r.userData,text:r.text};t.push(i)}};for(const t of this.m_textRenderers)t.textCanvas.pickText(e,e=>{i(e,Gt.Text)}),t.poiRenderer.pickTextElements(e,e=>{i(e,Gt.Icon)})}get loading(){return this.m_fontCatalogLoader.loading||this.m_glyphLoadingCount>0}async waitLoaded(){return!!await this.waitInitialized()&&(void 0!==this.m_loadPromise&&(await this.m_loadPromise,!0))}clearRenderStates(){this.m_textElementStateCache.clear()}getMemoryUsage(){const e={heapSize:0,gpuSize:0};for(const t of this.m_textRenderers)t.textCanvas.getMemoryUsage(e),t.poiRenderer.getMemoryUsage(e);return e}get initialized(){return this.m_initialized}get initializing(){return void 0!==this.m_initPromise}async waitInitialized(){return!!this.initialized||!!this.initializing&&(await this.m_initPromise,!0)}initialize(e){return this.initialized||this.initializing||!e||(this.initializeDefaultAssets(),this.m_initPromise=this.initializeTextCanvases().then(()=>{this.m_initialized=!0,this.m_initPromise=void 0,this.invalidateCache(),this.m_viewUpdateCallback()})),this.initialized}reset(){this.m_screenCollisions.reset();for(const e of this.m_textRenderers)e.textCanvas.clear(),e.poiRenderer.reset();this.m_initializedTextElementCount=0}updateTextRenderers(){for(const e of this.m_textRenderers)e.poiRenderer.update()}prepopulateScreenWithBlockingElements(e){const t=[];e.forEach(e=>{const i=new r.Zb,n=new r.Zb;for(const r of e.renderedTiles.values())for(const e of r.blockingElements)if(!(e.points.length<2)){this.m_screenProjector.project3(e.points[0],i);for(let r=1;r<e.points.length;r++){this.m_screenProjector.project3(e.points[r],n);const s=e.screenSpaceLines[r-1];s.start.copy(i),s.end.copy(n);const o={minX:Math.min(i.x,n.x),maxX:Math.max(i.x,n.x),minY:Math.min(i.y,n.y),maxY:Math.max(i.y,n.y),type:"line",line:s};t.push(o),i.copy(n)}}}),this.m_screenCollisions.allocateIBoxes(t)}placeTextElementGroup(e,t,i,n){if(Object(p.l)(e.visited),0===this.m_textRenderers.length)return Yi.warn("No text renderers initialized."),!1;const r=[],s={additionParams:{},poiMeasurementParams:{},measurementParams:{},bufferAdditionParams:{}},o=this.m_viewState.hiddenGeometryKinds;for(const a of e.textElementStates){if(n===Vi.PersistentLabels&&en&&++en.total,i>=0&&t.numRenderedTextElements>=i)return Yi.debug("Placement label limit exceeded."),!1;if(!a.initialized){en&&++en.uninitialized;continue}if(void 0===a.viewDistance){en&&++en.tooFar;continue}const e=a.visible;if(n===Vi.PersistentLabels&&!e||n===Vi.NewLabels&&e)continue;const l=a.element,h=this.m_textStyleCache.getTextElementStyle(l.style),c=h.textCanvas,d=h.poiRenderer;if(void 0===c||void 0===d){Yi.warn("Text canvas or poi renderer not ready.");continue}if(void 0!==o&&void 0!==l.kind&&o.hasOrIntersects(l.kind))continue;const m=l.type;if(m===Lt.PathLabel&&!this.checkForSmallLabels(l,an)){en&&en.numNotVisible++,!0===l.dbgPathTooSmall&&en&&en.numPathTooSmall++,a.textRenderState.reset();continue}if(!this.initializeGlyphs(l,h,s))continue;const u=c.getLayer(l.renderOrder||Ye);if(void 0!==u&&u.storage.drawCount+l.glyphs.length>u.storage.capacity)en&&++en.numCannotAdd,Yi.warn("layer glyph storage capacity exceeded.");else switch(c.textRenderStyle=l.renderStyle,c.textLayoutStyle=l.layoutStyle,m){case Lt.PoiLabel:this.addPoiLabel(a,d,c,t,s);break;case Lt.LineMarker:this.addLineMarkerLabel(a,d,r,c,t,s);break;case Lt.PathLabel:this.addPathLabel(a,an,c,t,s)}}return!0}initializeGlyphs(e,t,i){if(e.loadingState===Rt.Initialized)return!0;Object(p.l)(void 0!==t.textCanvas);const n=t.textCanvas;if(void 0===e.loadingState)if(e.loadingState=Rt.Requested,void 0===e.renderStyle&&(e.renderStyle=new Se({...t.renderParams,...e.renderParams})),void 0===e.layoutStyle&&(e.layoutStyle=new Ce({...t.layoutParams,...e.layoutParams})),""===e.text)e.loadingState=Rt.Loaded;else{const t=n.fontCatalog.loadCharset(e.text,e.renderStyle).then(()=>{--this.m_glyphLoadingCount,e.loadingState=Rt.Loaded,this.m_forceNewLabelsPass=!0,this.m_viewUpdateCallback()});0===this.m_glyphLoadingCount&&(this.m_loadPromise=void 0),++this.m_glyphLoadingCount,this.m_loadPromise=void 0===this.m_loadPromise?t:Promise.all([this.m_loadPromise,t])}return e.loadingState===Rt.Loaded&&this.m_initializedTextElementCount<qi&&(n.textRenderStyle=e.renderStyle,n.textLayoutStyle=e.layoutStyle,e.glyphCaseArray=[],e.glyphs=n.fontCatalog.getGlyphs(e.text,n.textRenderStyle,e.glyphCaseArray),e.type!==Lt.PathLabel&&(e.bounds=new r.f,i.poiMeasurementParams.letterCaseArray=e.glyphCaseArray,n.measureText(e.glyphs,e.bounds,i.poiMeasurementParams)),e.loadingState=Rt.Initialized,++this.m_initializedTextElementCount),void 0!==e.glyphs}initializeDefaultAssets(){const e=this.m_fontCatalogLoader.initialize(this.m_options.fontCatalog);this.m_textStyleCache.initializeDefaultTextElementStyle(e)}async initializeTextCanvases(){return this.m_fontCatalogLoader.loadCatalogs((e,t)=>{const i=this.m_textCanvasFactory.createTextCanvas(t);this.m_textRenderers.push({fontCatalog:e,textCanvas:i,poiRenderer:this.m_poiRendererFactory.createPoiRenderer(i)})}).then(()=>{let e;this.m_textRenderers.forEach(t=>{void 0===e&&(e=t.textCanvas)});const t=this.m_poiRendererFactory.createPoiRenderer(e);this.m_textStyleCache.initializeTextElementStyles(t,e,this.m_textRenderers)})}updateGlyphDebugMesh(){const e=It.getValue("DEBUG_GLYPHS");void 0!==e&&(e&&void 0===this.m_debugGlyphTextureCacheMesh&&this.initializeGlyphDebugMesh(),Object(p.l)(void 0!==this.m_debugGlyphTextureCacheMesh),Object(p.l)(void 0!==this.m_debugGlyphTextureCacheWireMesh),this.m_debugGlyphTextureCacheMesh.visible=e,this.m_debugGlyphTextureCacheWireMesh.visible=e)}initializeGlyphDebugMesh(){const e=this.m_textRenderers[0].textCanvas.fontCatalog,t=new r.wb(e.textureSize.width/2.5,e.textureSize.height/2.5,e.textureSize.width/e.maxWidth,e.textureSize.height/e.maxHeight),i=new r.fb({transparent:!0,depthWrite:!1,depthTest:!1,map:e.texture});this.m_debugGlyphTextureCacheMesh=new r.eb(t,i),this.m_debugGlyphTextureCacheMesh.renderOrder=1e4,this.m_debugGlyphTextureCacheMesh.visible=!1,this.m_debugGlyphTextureCacheMesh.name="glyphDebug";const n=new r.ec(t),s=new r.Q({transparent:!0,color:10066329,depthWrite:!1,depthTest:!1});this.m_debugGlyphTextureCacheWireMesh=new r.T(n,s),this.m_debugGlyphTextureCacheWireMesh.renderOrder=9999,this.m_debugGlyphTextureCacheWireMesh.visible=!1,this.m_debugGlyphTextureCacheWireMesh.name="glyphDebug",this.m_textRenderers[0].textCanvas.getLayer(Ye).storage.scene.add(this.m_debugGlyphTextureCacheMesh,this.m_debugGlyphTextureCacheWireMesh)}updateTextElements(e,t){Yi.debug("updateTextElements"),Qi&&Qi.clear(),this.m_textElementStateCache.clearTextCache(),this.m_cacheInvalidated=!1,this.checkIfOverloaded(e);const i=this.overloaded&&this.m_viewState.isDynamic?p.g.now():void 0;e.forEach(e=>{this.updateTextElementsFromSource(e.dataSource,e.storageLevel,Array.from(e.renderedTiles.values()),t,i)}),Qi&&Qi.log()}updateTextElementsFromSource(e,t,i,n,r){Qi&&(Qi.tiles+=i.length);const s=i;s.sort((e,t)=>e.tileKey.mortonCode()-t.tileKey.mortonCode());for(const e of s)this.prepareTextElementGroup(e.userTextElements,n);const o=[];this.createSortedGroupsForSorting(e,t,s,o);let a=0;for(const e of o)if(this.selectTextElementsToUpdateByDistance(e,n),void 0!==r){if(Hi>0){if(p.g.now()-r>Hi){Yi.debug("Update time limit exceeded.");break}}if(a+=e.count(),a>=$i){Yi.debug("Update label limit exceeded.");break}}}prepareTextElementGroup(e,t,i){if(0===e.elements.length)return;const[,n]=this.m_textElementStateCache.getOrSet(e,e=>{let{result:n,viewDistance:r}=fi(e.element,this.m_viewState,this.m_viewCamera,this.m_poiManager,t.type,i);return n!==pi.Ok||this.m_textElementStateCache.deduplicateElement(this.m_viewState.zoomLevel,e)||(n=pi.Duplicate,r=void 0),Qi&&(Qi.totalLabels++,Qi.results[n]++),r});Qi&&(++Qi.totalGroups,n||++Qi.newGroups)}createSortedGroupsForSorting(e,t,i,n){if(0===i.length)return;const r=[];for(const n of i)e.shouldRenderText(t,n.tileKey)&&r.push(n);const s=new Map;for(const e of r)for(const t of e.textElementGroups.groups.values()){if(0===t.elements.length)continue;const i=s.get(t.priority);void 0===i?s.set(t.priority,new mn([new dn(e,t)])):i.lists.push(new dn(e,t))}if(0===s.size)return;for(const e of s){const t=e[1];n.push(t)}n.sort((e,t)=>t.priority-e.priority)}selectTextElementsToUpdateByDistance(e,t){const i=Math.max(this.m_options.maxDistanceRatioForTextLabels,this.m_options.maxDistanceRatioForPoiLabels),n=ui(this.m_viewState,i);for(const i of e.lists)this.prepareTextElementGroup(i.group,t,n)}placeTextElements(e,t){const i={numRenderedTextElements:0,fadeAnimationRunning:!1,time:e},n=this.overloaded&&this.m_viewState.isDynamic?p.g.now():void 0;if(en&&en.clear(),0===this.m_textElementStateCache.size)return void Yi.debug("Text element cache empty.");const r=this.m_forceNewLabelsPass||t;this.m_forceNewLabelsPass&&(t||Yi.debug("Force new label pass"),this.m_forceNewLabelsPass=!1);const s=this.m_options.maxNumVisibleLabels,o=this.m_textElementStateCache.sortedGroupStates;let a=o[0].priority,l=0;for(let e=0;e<o.length;++e){const t=o[e];en&&++en.totalGroups;const h=t.priority;if(r&&a!==h){if(this.placeNewTextElements(l,e,i),un(n))break;a=h,l=e}if(!this.placeTextElementGroup(t,i,s,Vi.PersistentLabels))break;if(un(n))break}r&&this.placeNewTextElements(l,o.length,i),en&&(en.numRenderedTextElements=i.numRenderedTextElements,en.log()),!this.m_options.disableFading&&i.fadeAnimationRunning&&this.m_viewUpdateCallback()}placeNewTextElements(e,t,i){const n=this.m_textElementStateCache.sortedGroupStates;for(let r=e;r<t&&this.placeTextElementGroup(n[r],i,this.m_options.maxNumVisibleLabels,Vi.NewLabels);++r);}placeOverlayTextElements(){if(void 0===this.m_overlayTextElements||0===this.m_overlayTextElements.length)return;const e=this.m_tmpVector.set(this.m_screenProjector.width,this.m_screenProjector.height),t=-e.width/2,i=e.height/2,n={},s={};for(const o of this.m_overlayTextElements){const a=this.m_textStyleCache.getTextElementStyle(o.style),l=a.textCanvas;if(void 0===l)continue;const h=l.getLayer(o.renderOrder||Ye);if(void 0===o.loadingState&&(o.loadingState=Rt.Requested,void 0===o.renderStyle&&(o.renderStyle=new Se({...a.renderParams,...o.renderParams})),void 0===o.layoutStyle&&(o.layoutStyle=new Ce({...a.layoutParams,...o.layoutParams})),""===o.text?o.loadingState=Rt.Loaded:l.fontCatalog.loadCharset(o.text,o.renderStyle).then(()=>{o.loadingState=Rt.Loaded,this.m_viewUpdateCallback()})),o.loadingState===Rt.Loaded&&this.m_initializedTextElementCount<qi&&(l.textRenderStyle=o.renderStyle,l.textLayoutStyle=o.layoutStyle,o.glyphCaseArray=[],o.glyphs=l.fontCatalog.getGlyphs(o.text,l.textRenderStyle,o.glyphCaseArray),o.loadingState=Rt.Initialized,++this.m_initializedTextElementCount),o.loadingState!==Rt.Initialized)continue;if(void 0!==h&&h.storage.drawCount+o.glyphs.length>h.storage.capacity)continue;let c;if(l.textRenderStyle=o.renderStyle,l.textLayoutStyle=o.layoutStyle,o.type!==Lt.PathLabel)on.x=t+o.position.x*e.width,on.y=i-o.position.y*e.height,void 0!==o.xOffset&&(on.x+=o.xOffset),void 0!==o.yOffset&&(on.y-=o.yOffset),sn.x=on.x,sn.y=on.y,sn.z=0,s.position=sn,n.layer=o.renderOrder,n.letterCaseArray=o.glyphCaseArray,n.pickingData=o.userData?o:void 0,l.addText(o.glyphs,sn,n);else{on.x=t,on.y=i,void 0!==o.xOffset&&(on.x+=o.xOffset),void 0!==o.yOffset&&(on.y-=o.yOffset);const s=[];for(const t of o.path){const i=on.x+t.x*e.width,n=on.y-t.y*e.height;s.push(new r.Yb(i,n))}c=new _i;for(let e=0;e<s.length-1;++e)c.add(new r.R(s[e],s[e+1]));n.path=c,n.pathOverflow=!0,n.layer=o.renderOrder,n.letterCaseArray=o.glyphCaseArray,n.pickingData=o.userData?o:void 0,l.addText(o.glyphs,sn,n)}}}getDistanceScalingFactor(e,t,i){let n=i/t;return n=1+(n-1)*e.distanceScale,n=Math.max(n,this.m_options.labelDistanceScaleMin),n=Math.min(n,this.m_options.labelDistanceScaleMax),n}getDistanceFadingFactor(e,t,i){let n=1;const s=t.viewDistance;if(void 0!==s&&void 0!==e.fadeFar&&e.fadeFar>0){const t=void 0===e.fadeNear?0:e.fadeNear,o=e.fadeFar;o>t&&(n=1-r.bb.clamp((s/i-t)/(o-t),0,1))}return n}addPointLabel(e,t,i,n,s,o,a,l){const h=e.element,c=e.textRenderState;Object(p.l)(void 0===l||void 0!==e.iconRenderStates);const d=void 0!==l?e.iconRenderStates[l]:e.iconRenderState;Object(p.l)(void 0!==d);const m=ui(this.m_viewState,this.m_options.maxDistanceRatioForPoiLabels),u=void 0!==c&&""!==h.text;on.x=ln.x=i.x,on.y=ln.y=i.y;let f=1,g=1;const v=this.m_viewState.worldCenter.distanceTo(t);if(void 0!==v){if(void 0!==h.fadeFar&&(h.fadeFar<=0||h.fadeFar*this.m_viewState.maxVisibilityDist<v))return en&&++en.tooFar,!1;e.setViewDistance(v),g=this.getDistanceScalingFactor(h,v,this.m_viewState.lookAtDistance),f*=g}const _=this.getDistanceFadingFactor(h,e,this.m_viewState.maxVisibilityDist),y=h.poiInfo;let x=!1;const b=void 0!==y&&p.f.isClamped(this.m_viewState.zoomLevel,y.iconMinZoomLevel,y.iconMaxZoomLevel)&&!1!==y.isValid,w=b&&n.prepareRender(h,this.m_viewState.zoomLevel);if(w){if(li.computeIconScreenBox(y,ln,g,this.m_viewState.zoomLevel,rn),!this.m_screenCollisions.isVisible(rn))return d.reset(),en&&++en.numNotVisible,!1;const e=!0===y.mayOverlap||!this.m_screenCollisions.isAllocated(rn);if(!e&&!d.isVisible())return en&&++en.numNotVisible,!1;x=!e}else b&&!1!==y.isValid&&(this.m_forceNewLabelsPass=!0);if(u&&(void 0===y||void 0===this.m_viewState.zoomLevel||p.f.isClamped(this.m_viewState.zoomLevel,y.iconMinZoomLevel,y.iconMaxZoomLevel))&&(!0===h.ignoreDistance||void 0===e.viewDistance||e.viewDistance<m)&&(void 0===y||!0===y.isValid||!1!==y.iconIsOptional)){if(on.add(function(e,t=new r.Yb){Object(p.l)(e.type===Lt.PoiLabel),Object(p.l)(void 0!==e.layoutStyle),Object(p.l)(void 0!==e.bounds);const i=e.layoutStyle.horizontalAlignment,n=e.layoutStyle.verticalAlignment;switch(i){case xe.Right:t.x=-e.xOffset;break;default:t.x=e.xOffset}switch(n){case ye.Below:t.y=-e.yOffset;break;case ye.Above:t.y=e.yOffset-e.bounds.min.y;break;default:t.y=e.yOffset}return void 0!==e.poiInfo&&void 0!==e.poiInfo.poiRenderBatch&&(Object(p.l)(void 0!==e.poiInfo.computedWidth),Object(p.l)(void 0!==e.poiInfo.computedHeight),t.x+=e.poiInfo.computedWidth*(.5+i),t.y+=e.poiInfo.computedHeight*(.5+n)),t}(h,hn)),sn.x=on.x,sn.y=on.y,sn.z=e.renderDistance,rn.x=on.x+h.bounds.min.x*f,rn.y=on.y+h.bounds.min.y*f,rn.w=(h.bounds.max.x-h.bounds.min.x)*f,rn.h=(h.bounds.max.y-h.bounds.min.y)*f,rn.x-=4*f,rn.y-=2*f,rn.w+=8*f,rn.h+=4*f,!this.m_screenCollisions.isVisible(rn))return en&&en.numPoiTextsInvisible++,e.reset(),!1;const t=void 0!==h.poiInfo&&!0===h.poiInfo.textIsOptional;let i=!0;if(x||(i=!h.textMayOverlap&&this.m_screenCollisions.isAllocated(rn),x=i&&!t),i&&!e.visible)return en&&en.numPoiTextsInvisible++,!1;if(i&&c.startFadeOut(o.time),(!i||c.isFading())&&(h.textReservesSpace&&!i&&this.m_screenCollisions.allocate(rn),(c.isFading()||!this.m_viewState.cameraIsMoving||void 0===y||!0===y.renderTextDuringMovements)&&!d.isFadedOut())){i||c.startFadeIn(o.time),o.fadeAnimationRunning=o.fadeAnimationRunning||c.isFading();const e=c.opacity*_*h.renderStyle.opacity;if(e>0){cn.letterCaseArray=h.glyphCaseArray,void 0===h.textBufferObject&&(h.textBufferObject=s.createTextBufferObject(h.glyphs,cn));const t=h.renderStyle.backgroundOpacity>0&&s.textRenderStyle.fontSize.backgroundSize>0;a.bufferAdditionParams.layer=h.renderOrder,a.bufferAdditionParams.position=sn,a.bufferAdditionParams.scale=f,a.bufferAdditionParams.opacity=e,a.bufferAdditionParams.backgroundOpacity=t?a.bufferAdditionParams.opacity*h.renderStyle.backgroundOpacity:0,a.bufferAdditionParams.pickingData=h.userData?h:void 0,s.addTextBufferObject(h.textBufferObject,a.bufferAdditionParams),en&&en.numRenderedPoiTexts++}}}if(w){if(x?d.startFadeOut(o.time):d.startFadeIn(o.time),o.fadeAnimationRunning=o.fadeAnimationRunning||d.isFading(),d.opacity*_>0){const t=!1!==y.reserveSpace&&!x;n.renderPoi(y,ln,this.m_screenCollisions,e.renderDistance,g,t,d.opacity*_,this.m_viewState.zoomLevel),en&&en.numRenderedPoiIcons++}}return o.numRenderedTextElements++,!0}addPoiLabel(e,t,i,n,r){const s=e.element.points;return void 0!==this.m_screenProjector.project(s,on)&&this.addPointLabel(e,s,on,t,i,n,r)}addLineMarkerLabel(e,t,i,n,r,s){const o=e.element,a=o.points,l=o.poiInfo;if(0===a.length||!t.prepareRender(o,this.m_viewState.zoomLevel))return;let h;void 0!==l.shieldGroupIndex&&(h=i[l.shieldGroupIndex],void 0===h&&(h=[],i[l.shieldGroupIndex]=h));const c=l.technique,d=void 0!==c.minDistance?c.minDistance*c.minDistance:0;if(d>0&&void 0!==h)for(let i=0;i<a.length;++i){const o=a[i];if(void 0!==this.m_screenProjector.project(o,on)){let a=!1;for(let e=0;e<h.length;e+=2){if(a=p.e.distSquared(h[e],h[e+1],on.x,on.y)<d,a)break}a||this.addPointLabel(e,o,on,t,n,r,s,i)&&h.push(on.x,on.y)}}else for(let i=0;i<a.length;++i){const o=a[i];void 0!==this.m_screenProjector.project(o,on)&&this.addPointLabel(e,o,on,t,n,r,s,i)}}addPathLabel(e,t,i,n,s){const o=ui(this.m_viewState,this.m_options.maxDistanceRatioForTextLabels),a=e.element;if(!(!0===a.ignoreDistance||void 0===e.viewDistance||e.viewDistance<o))return en&&++en.tooFar,e.textRenderState.reset(),!1;if(void 0!==a.fadeFar&&(a.fadeFar<=0||a.fadeFar*this.m_viewState.maxVisibilityDist<e.renderDistance))return en&&++en.tooFar,e.textRenderState.reset(),!1;let l=i.textRenderStyle.fontSize.size/100,h=a.renderStyle.opacity,c=new r.sb;on.copy(t[0]);for(let e=0;e<t.length-1;++e)c.add(new gi(t[e],t[e+1]));if(c.getPoint(.5).x-c.getPoint(.51).x>0){on.copy(t[t.length-1]),c=new r.sb;for(let e=t.length-1;e>0;--e)c.add(new gi(t[e],t[e-1]))}e.setViewDistance(mi(this.m_viewState.worldCenter,a));const d=-e.renderDistance;l*=this.getDistanceScalingFactor(a,d,this.m_viewState.lookAtDistance);const m=i.textRenderStyle.fontSize.size;if(i.textRenderStyle.fontSize.size=100*l,s.measurementParams.path=c,s.measurementParams.outputCharacterBounds=nn,s.measurementParams.letterCaseArray=a.glyphCaseArray,!i.measureText(a.glyphs,tn,s.measurementParams))return i.textRenderStyle.fontSize.size=m,en&&++en.numNotVisible,e.textRenderState.reset(),!1;for(const t of nn)if(rn.x=on.x+t.min.x,rn.y=on.y+t.min.y,rn.w=t.max.x-t.min.x,rn.h=t.max.y-t.min.y,!this.m_screenCollisions.isVisible(rn)||!a.textMayOverlap&&this.m_screenCollisions.isAllocated(rn))return i.textRenderStyle.fontSize.size=m,en&&++en.numNotVisible,e.textRenderState.reset(),!1;e.textRenderState.startFadeIn(n.time),e.textRenderState.isFading()&&(h=e.textRenderState.opacity*a.renderStyle.opacity,n.fadeAnimationRunning=!0);const u=i.textRenderStyle.opacity,p=i.textRenderStyle.backgroundOpacity,f=this.getDistanceFadingFactor(a,e,this.m_viewState.maxVisibilityDist);return i.textRenderStyle.opacity=h*f,i.textRenderStyle.backgroundOpacity=i.textRenderStyle.opacity*a.renderStyle.backgroundOpacity,sn.z=e.renderDistance,s.additionParams.path=c,s.additionParams.layer=a.renderOrder,s.additionParams.letterCaseArray=a.glyphCaseArray,s.additionParams.pickingData=a.userData?a:void 0,i.addText(a.glyphs,sn,s.additionParams),a.textReservesSpace&&(rn.x=on.x+tn.min.x,rn.y=on.y+tn.min.y,rn.w=tn.max.x-tn.min.x,rn.h=tn.max.y-tn.min.y,this.m_screenCollisions.allocate(rn)),n.numRenderedTextElements++,i.textRenderStyle.fontSize.size=m,i.textRenderStyle.opacity=u,i.textRenderStyle.backgroundOpacity=p,!0}checkForSmallLabels(e,t){t.length=0;let i=!1;for(const n of e.points){void 0!==(i?this.m_screenProjector.project(n,on):this.m_screenProjector.projectOnScreen(n,on))&&(i=!0,t.push(on.clone()))}if(!i)return!1;const n=e.text.length*Xi;return tn.setFromPoints(t),!(tn.max.sub(tn.min).lengthSq()<n*n)||(e.dbgPathTooSmall=!0,!1)}checkIfOverloaded(e){let t=0;e.forEach(e=>{for(const i of e.renderedTiles.values())t+=i.textElementGroups.count(),t+=i.userTextElements.elements.length});const i=t>Zi;return i&&!this.m_overloaded&&Yi.debug("Overloaded Mode enabled."),this.m_overloaded=i,this.m_overloaded}}const fn=p.d.instance.create("Statistics");class gn{constructor(e){this.capacity=e,this.buffer=new Array(e),this.capacity=e,this.head=this.tail=this.size=0}clear(){this.head=this.tail=this.size=0}enqOne(e){let t=this.head+1;t>=this.capacity&&(t=0),this.size<this.capacity&&this.size++,this.buffer[this.head]=e,this.head=t,this.size===this.capacity&&(this.tail=this.head)}enq(...e){for(const t of e)this.enqOne(t)}deq(){if(0===this.size)throw new Error("Ringbuffer underrun");const e=this.buffer[this.tail];let t=this.tail+1;return t>=this.capacity&&(t=0),this.size>0&&this.size--,this.tail=t,e}get top(){if(0===this.size)throw new Error("Ringbuffer underrun");return this.buffer[this.tail]}get bottom(){if(0===this.size)throw new Error("Ringbuffer underrun");let e=this.head-1;return e<0&&(e=this.capacity-1),this.buffer[e]}iterator(){return new gn.Iterator(this)}asArray(){const e=new Array;for(let t=0;t<this.size;t++)e.push(this.buffer[(this.tail+t)%this.capacity]);return e}}!function(e){e.Iterator=class{constructor(e,t=0){this.m_buffer=e,this.m_index=t}get value(){return this.m_buffer.buffer[(this.m_buffer.tail+this.m_index)%this.m_buffer.capacity]}next(){return this.m_index++,this.m_index<this.m_buffer.size}}}(gn||(gn={}));function vn(e){if(0===e.length)return;e.sort((e,t)=>e-t);const t=e[0],i=e[e.length-1];let n,r,s,o,a,l,h;if(1===e.length)r=s=o=a=l=h=n=e[0];else if(2===e.length)n=.5*e[0]+.5*e[1],r=s=o=a=l=h=e[1];else{const t=Math.floor(e.length/2);n=e.length%2==0?.5*e[t-1]+.5*e[t]:e[t],r=e[Math.round(.75*e.length)-1],s=e[Math.round(.9*e.length)-1],o=e[Math.round(.95*e.length)-1],a=e[Math.round(.97*e.length)-1],l=e[Math.round(.99*e.length)-1],h=e[Math.round(.999*e.length)-1]}let c=0;for(let t=0,i=e.length;t<i;t++)c+=e[t];return{min:t,max:i,avg:c/e.length,median:n,median75:r,median90:s,median95:o,median97:a,median99:l,median999:h,numSamples:e.length}}class _n{constructor(){this.entries=new Map,this.messages=void 0}getValue(e){return this.entries.get(e)}setValue(e,t){this.entries.set(e,t)}addValue(e,t){const i=this.entries.get(e);this.entries.set(e,t+(void 0===i?0:i))}addMessage(e){void 0===this.messages&&(this.messages=[]),this.messages.push(e)}reset(){this.entries.forEach((e,t)=>{this.entries.set(t,0)}),this.messages=void 0}}class yn{constructor(e=0){this.capacity=e,this.frameEntries=new Map,this.messages=new gn(e)}get length(){return this.messages.size}reset(){this.frameEntries.forEach((e,t)=>{e.clear()}),this.messages.clear()}addFrame(e){const t=this.length,i=this.frameEntries;e.entries.forEach((e,n)=>{let r=i.get(n);if(void 0===r){r=new gn(this.capacity);for(let e=0;e<t;e++)r.enqOne(0);this.frameEntries.set(n,r)}r.enqOne(e)}),this.messages.enq(e.messages)}log(){let e=0;this.frameEntries.forEach((t,i)=>{e=Math.max(e,i.length)});const t=e=>void 0!==e?e.toFixed(5):"?";this.frameEntries.forEach((i,n)=>{let r=n+": "+" ".repeat(e-n.length);const s=vn(i.asArray());void 0!==s&&(r+=`  [ min=${t(s.min)}, max=${t(s.max)}, `+`avg=${t(s.avg)}, med=${t(s.median)}, `+`med95=${t(s.median95)}, med99=${t(s.median99)}, `+`N=${t(s.numSamples)} ]`),fn.log(r)})}}class xn{constructor(e=!0,t=1e3){this.enabled=e,this.maxNumFrames=t,this.currentFrame=new _n,this.appResults=new Map,this.configs=new Map,xn.m_instance=this,this.m_frameEvents=new yn(t)}get isFull(){return this.m_frameEvents.length>=this.maxNumFrames}static get instance(){return void 0===xn.m_instance&&(xn.m_instance=new xn(!1,0)),xn.m_instance}get frameEvents(){return this.m_frameEvents}clear(){this.clearFrames(),this.configs.clear(),this.appResults.clear()}clearFrames(){this.m_frameEvents.reset(),this.currentFrame.reset()}storeFrameInfo(e){if(this.m_frameEvents.length>=this.maxNumFrames)return!1;if(void 0!==e&&(void 0!==e.render&&(this.currentFrame.setValue("gl.numCalls",null===e.render.calls?0:e.render.calls),this.currentFrame.setValue("gl.numPoints",null===e.render.points?0:e.render.points),this.currentFrame.setValue("gl.numLines",null===e.render.lines?0:e.render.lines),this.currentFrame.setValue("gl.numTriangles",null===e.render.triangles?0:e.render.triangles)),void 0!==e.memory&&(this.currentFrame.setValue("gl.numGeometries",null===e.memory.geometries?0:e.memory.geometries),this.currentFrame.setValue("gl.numTextures",null===e.memory.textures?0:e.memory.textures)),void 0!==e.programs&&this.currentFrame.setValue("gl.numPrograms",null===e.programs?0:e.programs.length)),void 0!==window&&void 0!==window.performance){const e=window.performance.memory;void 0!==e&&(this.currentFrame.setValue("memory.totalJSHeapSize",e.totalJSHeapSize),this.currentFrame.setValue("memory.usedJSHeapSize",e.usedJSHeapSize),this.currentFrame.setValue("memory.jsHeapSizeLimit",e.jsHeapSizeLimit))}return this.m_frameEvents.addFrame(this.currentFrame),this.currentFrame.reset(),!0}log(e,t){fn.log(void 0!==e?e:"PerformanceStatistics"),this.appResults.forEach((e,t)=>{fn.log(t,e)}),this.configs.forEach((e,t)=>{fn.log(t,e)}),this.m_frameEvents.log(),void 0!==t&&fn.log(t)}getAsPlainObject(e=!1){const t={},i={},n={},r={configs:i,appResults:t,frames:n};if(this.appResults.forEach((e,i)=>{t[i]=e}),this.configs.forEach((e,t)=>{i[t]=e}),e)for(const[e,t]of this.m_frameEvents.frameEntries)n[e]=t.bottom;else for(const[e,t]of this.m_frameEvents.frameEntries)n[e]=t.asArray();return r.messages=this.m_frameEvents.messages.asArray(),r}getLastFrameStatistics(){return this.getAsPlainObject(!0)}getAsSimpleFrameStatistics(e=!1){const t=new Map,i=new Map,n=new Map,r={configs:t,appResults:i,frames:n,messages:this.m_frameEvents.messages.asArray()};if(this.appResults.forEach((e,t)=>{i.set(t,e)}),this.configs.forEach((e,i)=>{t.set(i,e)}),e)for(const[e,t]of this.m_frameEvents.frameEntries)n.set(e,t.bottom);else for(const[e,t]of this.m_frameEvents.frameEntries)n.set(e,t.asArray());return r}}var bn;xn.m_instance=void 0,function(e){function t(e){let t=e.kind;return void 0===t&&(t=Object(K.A)(e)?K.f.Area:Object(K.F)(e)||Object(K.J)(e)||Object(K.H)(e)||Object(K.y)(e)?K.f.Line:Object(K.z)(e)?K.f.Building:Object(K.G)(e)||Object(K.E)(e)||Object(K.N)(e)?K.f.Label:K.f.All,e.kind=t),t}e.prepareDecodedTile=function(e){const i=new K.g;for(const n of e.techniques){let e=n.kind;if(void 0===e&&(e=t(n)),Array.isArray(e)&&(e=new K.g(e)),e instanceof Set)for(const t of e)i.add(t);else i.add(e)}return i},e.setDefaultGeometryKind=t}(bn||(bn={}));class wn{constructor(e){this.m_tile=e,this.m_isFinished=!1}get tile(){return this.m_tile}get isFinished(){return this.m_isFinished}get basicGeometryLoaded(){return this.m_tile.hasGeometry}get allGeometryLoaded(){return this.m_isFinished}setDecodedTile(e){return this.m_decodedTile=e,void 0!==this.m_decodedTile&&(this.m_availableGeometryKinds=bn.prepareDecodedTile(this.m_decodedTile)),this.m_decodedTile}get availableGeometryKinds(){return this.m_availableGeometryKinds}update(e,t){const i=this.tile;void 0===this.m_decodedTile&&void 0!==i.decodedTile&&(Cn.instance.processTechniques(i.decodedTile,e,t),this.setDecodedTile(i.decodedTile),this.prepareForRender(e,t))}dispose(){this.m_decodedTile=void 0}reset(){this.m_decodedTile=void 0,this.m_isFinished=!1,void 0!==this.m_availableGeometryKinds&&this.m_availableGeometryKinds.clear(),void 0!==this.m_timeout&&clearTimeout(this.m_timeout)}finish(){this.m_tile.loadingFinished(),this.m_tile.removeDecodedTile(),this.m_isFinished=!0,this.m_timeout=void 0}prepareForRender(e,t){const i=this.tile,n=this.m_decodedTile;this.m_decodedTile=void 0,void 0!==n&&!i.disposed&&i.isVisible?this.m_timeout=setTimeout(()=>{const r=xn.instance;if(!i.isVisible)return i.mapView.visibleTileSet.disposeTile(i),r.enabled&&r.currentFrame.addMessage(`Decoded tile: ${i.dataSource.name} # lvl=${i.tileKey.level} col=${i.tileKey.column} row=${i.tileKey.row} DISCARDED - invisible`),void this.finish();let s=0;r.enabled&&(s=p.g.now());const o=Cn.instance;if(i.clear(),o.initDecodedTile(n,e,t),o.createAllGeometries(i,n),r.enabled){const e=p.g.now()-s,t=r.currentFrame;t.addValue("geometry.geometryCreationTime",e),t.addValue("geometryCount.numGeometries",n.geometries.length),t.addValue("geometryCount.numTechniques",n.techniques.length),t.addValue("geometryCount.numPoiGeometries",void 0!==n.poiGeometries?n.poiGeometries.length:0),t.addValue("geometryCount.numTextGeometries",void 0!==n.textGeometries?n.textGeometries.length:0),t.addValue("geometryCount.numTextPathGeometries",void 0!==n.textPathGeometries?n.textPathGeometries.length:0),t.addValue("geometryCount.numPathGeometries",void 0!==n.pathGeometries?n.pathGeometries.length:0),t.addMessage(`Decoded tile: ${i.dataSource.name} # lvl=${i.tileKey.level} col=${i.tileKey.column} row=${i.tileKey.row}`)}this.finish(),i.dataSource.requestUpdate()},0):this.finish()}}const Tn=p.d.instance.create("TileGeometryCreator"),Sn=.1;class Cn{constructor(){}static get instance(){return this.m_instance||(this.m_instance=new Cn)}initDecodedTile(e,t,i){for(const n of e.techniques)void 0===n.enabled&&(void 0!==n.kind&&(Array.isArray(n.kind)?n.kind=new K.g(n.kind):"string"!=typeof n.kind&&(Tn.warn("Technique has unknown type of kind:",n),n.kind=void 0)),void 0===n.kind||n.kind instanceof Set&&0===n.kind.size?n.enabled=!0:n.enabled=!(void 0!==i&&i.hasOrIntersects(n.kind))||void 0!==t&&t.hasOrIntersects(n.kind));for(const t of e.geometries)for(const e of t.groups)e.createdOffsets=[];e.techniques.forEach(e=>{for(const t in e){if(!e.hasOwnProperty(t))continue;const i=e[t];if(Object(K.C)(i)&&"kind"!==t)try{e[t]=K.b.fromJSON(i)}catch(e){Tn.error("#initDecodedTile: Failed to compile expression:",e)}}})}createAllGeometries(e,t){const i=e=>!1!==e.enabled;void 0!==t.maxGeometryHeight&&(e.maxGeometryHeight=t.maxGeometryHeight),this.createObjects(e,t,i),this.preparePois(e,t);this.createTextElements(e,t,e=>!!(Object(K.G)(e)||Object(K.E)(e)||Object(K.N)(e))&&i(e)),this.createLabelRejectionElements(e,t),e.dataSource.addGroundPlane&&e.projection.type===n.f.Planar&&Cn.instance.addGroundPlane(e,-qs/2)}createLabelRejectionElements(e,t){if(void 0!==t.pathGeometries)for(const i of t.pathGeometries)e.addBlockingElement(new Pt(i.path))}processTechniques(e,t,i){if(void 0!==e){for(const t of e.techniques)void 0===t.kind&&bn.setDefaultGeometryKind(t);this.initDecodedTile(e,t,i)}}registerTileObject(e,t,i){void 0===t.userData&&(t.userData={});const n=t.userData;n.tileKey=e.tileKey,n.dataSource=e.dataSource.name,n.kind=i instanceof Set?Array.from(i.values()):Array.isArray(i)?i:[i],e.resetVisibilityCounter()}prepareTextPaths(e,t,i){const n=new Array,r=e.slice();for(;r.length>0;){const e=r.pop();if(void 0===e)break;const s=t.techniques[e.technique];Object(K.N)(s)&&(void 0===i||i(s))&&n.push(e)}return n}createTextElements(e,t,i){const n=e.mapView,s=n.textElementsRenderer,o=Math.floor(n.zoomLevel),a=e.computeWorldOffsetX();if(void 0!==t.textPathGeometries){const l=this.prepareTextPaths(t.textPathGeometries,t,i);let h=0;for(const e of l){const i=t.techniques[e.technique];!1!==i.enabled&&Object(K.N)(i)&&(e.pathLengthSqr>h&&(h=e.pathLengthSqr))}for(const c of l){const l=t.techniques[c.technique];if(!1===l.enabled||!Object(K.N)(l)||void 0!==i&&!i(l))continue;const d=[];for(let e=0;e<c.path.length;e+=3)d.push(new r.Zb(c.path[e]+a,c.path[e+1],c.path[e+2]));const m=(void 0!==l.priority?Object(K.w)(l.priority,o):0)+(h>0?Sn*c.pathLengthSqr/h:0),u=void 0!==l.fadeNear?Object(K.w)(l.fadeNear,o):l.fadeNear,p=void 0!==l.fadeFar?Object(K.w)(l.fadeFar,o):l.fadeFar,f=c.objInfos,g=Object(K.t)(f),v=new Ot(tt.instance.convert(c.text),d,s.styleCache.getRenderStyle(e,l),s.styleCache.getLayoutStyle(e,l),m,void 0!==l.xOffset?l.xOffset:0,void 0!==l.yOffset?l.yOffset:0,g,l.style,u,p,e.offset);v.minZoomLevel=void 0!==l.minZoomLevel?l.minZoomLevel:n.minZoomLevel,v.maxZoomLevel=void 0!==l.maxZoomLevel?l.maxZoomLevel:n.maxZoomLevel,v.distanceScale=void 0!==l.distanceScale?l.distanceScale:Wi,v.mayOverlap=!0===l.mayOverlap,v.reserveSpace=!1!==l.reserveSpace,v.kind=l.kind,v.userData=c.objInfos,e.addTextElement(v)}}if(void 0!==t.textGeometries)for(const l of t.textGeometries){if(void 0===l.technique||void 0===l.stringCatalog)continue;const h=t.techniques[l.technique];if(!1===h.enabled||!Object(K.N)(h)||void 0!==i&&!i(h))continue;const c=new r.h(new Float32Array(l.positions.buffer),l.positions.itemCount),d=c.count;if(d<1)continue;const m=void 0!==h.priority?Object(K.w)(h.priority,o):0,u=void 0!==h.fadeNear?Object(K.w)(h.fadeNear,o):h.fadeNear,p=void 0!==h.fadeFar?Object(K.w)(h.fadeFar,o):h.fadeFar;for(let t=0;t<d;++t){const i=c.getX(t)+a,o=c.getY(t),d=c.getZ(t),f=l.stringCatalog[l.texts[t]];if(void 0===f)continue;const g=void 0!==l.objInfos?l.objInfos[t]:void 0,v=Object(K.t)(g),_=new Ot(tt.instance.convert(f),new r.Zb(i,o,d),s.styleCache.getRenderStyle(e,h),s.styleCache.getLayoutStyle(e,h),m,h.xOffset||0,h.yOffset||0,v,h.style,void 0,void 0,e.offset);_.minZoomLevel=void 0!==h.minZoomLevel?h.minZoomLevel:n.minZoomLevel,_.maxZoomLevel=void 0!==h.maxZoomLevel?h.maxZoomLevel:n.maxZoomLevel,_.mayOverlap=!0===h.mayOverlap,_.reserveSpace=!1!==h.reserveSpace,_.kind=h.kind,_.fadeNear=u,_.fadeFar=p,_.userData=g,e.addTextElement(_)}}}createObjects(e,t,i){const s=[],o=e.mapView,a=e.dataSource,l=Math.floor(o.zoomLevel),h=e.objects,c=o.viewRanges;for(const d of t.geometries){const m=d.groups,u=m.length;for(let p=0;p<u;){const f=m[p++],g=f.start,v=f.technique,y=t.techniques[v];if(-1!==f.createdOffsets.indexOf(e.offset)||!1===y.enabled||void 0!==i&&!i(y))continue;let x=f.count;for(f.createdOffsets.push(e.offset);p<u&&m[p].technique===v&&g+x===m[p].start;++p)x+=m[p].count,m[p].createdOffsets.push(e.offset);const b=ut(y);if(void 0===b)continue;let w=s[v];if(void 0===w){const t=t=>{a.requestUpdate(),void 0!==t&&e.addOwnedTexture(t)};if(w=dt({technique:y,level:l,fog:null!==o.scene.fog},t),void 0===w)continue;s[v]=w}Object(K.M)(y)&&this.setupTerrainMaterial(y,w,e.mapView.clearColor);const T=new r.i;if(d.vertexAttributes.forEach(e=>{const t=mt(e);T.setAttribute(e.name,t)}),void 0!==d.interleavedVertexAttributes&&d.interleavedVertexAttributes.forEach(e=>{const t=Object(K.s)(e.type),i=new r.J(new t(e.buffer),e.stride);e.attributes.forEach(e=>{const t=new r.K(i,e.itemSize,e.offset,!1);T.setAttribute(e.name,t)})}),d.index&&T.setIndex(mt(d.index)),!T.getAttribute("normal")&&Object(K.P)(y)&&T.computeVertexNormals(),T.addGroup(g,x),Object(K.J)(y)){const t=w;if(t.uniforms.opacity.value=w.opacity,!1!==y.clipping&&e.projection.type===n.f.Planar){const i=t.uniforms.tileSize,n=new r.Zb;e.boundingBox.getSize(n),i.value.x=n.x,i.value.y=n.y,t.defines.TILE_CLIP=1}T.getAttribute("color")&&(t.defines.USE_COLOR=1),void 0!==y.caps&&V.hasOwnProperty(y.caps)&&(t.defines[V[y.caps]]=1)}const S=Object(K.J)(y)&&void 0!==y.secondaryWidth,C=new b(T,w);if(C.renderOrder=y.renderOrder,void 0!==f.renderOrderOffset&&(C.renderOrder+=f.renderOrderOffset),void 0!==d.uuid&&(C.userData.geometryId=d.uuid),(Object(K.x)(y)||Object(K.K)(y))&&void 0!==y.enablePicking&&(C.enableRayTesting=y.enablePicking),Object(K.F)(y)||Object(K.H)(y)&&void 0!==y.color&&K.b.isExpr(y.color)){const e=this.getFadingParams(l,y);_.addRenderHelper(C,c,e.fadeNear,e.fadeFar,!1,(e,t)=>{_t(t,t.color,y,y.color,o.zoomLevel)})}if(Object(K.J)(y)){const e=this.getFadingParams(l,y);_.addRenderHelper(C,c,e.fadeNear,e.fadeFar,!1,(e,t)=>{const i=t,n="Pixel"===y.metricUnit?o.pixelToWorld:1;void 0!==y.color&&_t(i,i.color,y,y.color,o.zoomLevel),i.lineWidth=Object(K.w)(y.lineWidth,o.zoomLevel,o.pixelToWorld)*n*.5,void 0!==y.outlineWidth&&(i.outlineWidth=Object(K.w)(y.outlineWidth,o.zoomLevel,o.pixelToWorld)*n),void 0!==y.dashSize&&(i.dashSize=Object(K.w)(y.dashSize,o.zoomLevel,o.pixelToWorld)*n*.5),void 0!==y.gapSize&&(i.gapSize=Object(K.w)(y.gapSize,o.zoomLevel,o.pixelToWorld)*n*.5)})}if(Object(K.y)(y)&&(void 0!==y.fadeFar||K.b.isExpr(y.color))){const e=this.getFadingParams(l,y);_.addRenderHelper(C,c,e.fadeNear,e.fadeFar,!0,void 0!==y.color&&K.b.isExpr(y.color)?(e,t)=>{_t(t,t.color,y,y.color,o.zoomLevel)}:void 0)}if(this.addFeatureData(d,y,C),this.addGeometryObjInfos(e,d,y,C),Object(K.z)(y)||Object(K.A)(y)){const e=void 0!==y.color&&K.b.isExpr(y.color)||Object(K.z)(y)&&K.b.isExpr(y.emissive);if(void 0!==y.fadeFar||e){const t=this.getFadingParams(l,y);_.addRenderHelper(C,c,t.fadeNear,t.fadeFar,!0,e?(e,t)=>{if(_t(t,t.color,y,y.color,o.zoomLevel),Object(K.z)(y)&&void 0!==y.emissive){vt(t.emissive,y.emissive,o.zoomLevel)}}:void 0)}}const E=[],M=o.animatedExtrusionHandler;let A=!1;if(Object(K.z)(y)&&void 0!==M){let e=Object(K.w)(y.animateExtrusion,l);void 0!==e&&(e="boolean"==typeof e?e:"number"==typeof e&&0!==e),A=void 0!==e&&!1===M.forceEnabled?e:M.enabled}if(Object(K.z)(y)&&Ct(y)){const t=Mt(C);this.registerTileObject(e,t,y.kind),h.push(t),A&&E.push({object:t,materialFeature:!0}),At(t,C)}if(this.registerTileObject(e,C,y.kind),h.push(C),Object(K.z)(y)&&void 0!==d.edgeIndex){const t=new r.i;t.setAttribute("position",T.getAttribute("position"));const i=T.getAttribute("color");void 0!==i&&t.setAttribute("color",i);const n=T.getAttribute("extrusionAxis");void 0!==n&&t.setAttribute("extrusionAxis",n);const s=T.getAttribute("normal");void 0!==s&&t.setAttribute("normal",s);const a=T.getAttribute("uv");void 0!==a&&t.setAttribute("uv",a),t.setIndex(mt(d.edgeIndex));const m=y,u=this.getPolygonFadingParams(l,m),p={color:u.color,colorMix:u.colorMix,fadeNear:u.lineFadeNear,fadeFar:u.lineFadeFar},f=new R(p),g=new r.T(t,f);g.renderOrder=C.renderOrder+.1,_.addRenderHelper(g,c,u.lineFadeNear,u.lineFadeFar,!1,void 0!==m.lineColor&&K.b.isExpr(m.lineColor)?(e,t)=>{_t(f,f.color,m,m.lineColor,o.zoomLevel)}:void 0),A&&E.push({object:g,materialFeature:!1}),this.registerTileObject(e,g,y.kind),h.push(g)}if(Object(K.z)(y)&&A){E.push({object:C,materialFeature:!0});const t=void 0!==y.animateExtrusionDuration&&!1===M.forceEnabled?y.animateExtrusionDuration:M.duration;e.animatedExtrusionTileHandler=new vo(e,E,t),o.animatedExtrusionHandler.add(e.animatedExtrusionTileHandler)}if(Object(K.A)(y)&&void 0!==d.edgeIndex){const t=new r.i;t.setAttribute("position",T.getAttribute("position")),t.setIndex(mt(d.edgeIndex));const i=y,n=this.getPolygonFadingParams(l,i),s={color:n.color,colorMix:n.colorMix,fadeNear:n.lineFadeNear,fadeFar:n.lineFadeFar},a=new R(s),m=new r.T(t,a);m.renderOrder=C.renderOrder+.1,_.addRenderHelper(m,c,n.lineFadeNear,n.lineFadeFar,!1,void 0!==i.lineColor&&K.b.isExpr(i.lineColor)?(e,t)=>{_t(t,t.color,i,i.lineColor,o.zoomLevel)}:void 0),this.registerTileObject(e,m,y.kind),h.push(m)}if(S){const t=y,i=w.clone(),n=it.instance.getColor(void 0!==t.secondaryColor?Object(K.w)(t.secondaryColor,l):0);i.uniforms.diffuse.value=n,void 0!==t.secondaryCaps&&(i.caps=t.secondaryCaps);const r=new b(T,i);r.renderOrder=void 0!==t.secondaryRenderOrder?t.secondaryRenderOrder:y.renderOrder-1e-7,void 0!==f.renderOrderOffset&&(r.renderOrder+=f.renderOrderOffset);const s=this.getFadingParams(l,y);_.addRenderHelper(r,c,s.fadeNear,s.fadeFar,!1,(e,i)=>{const n=i,r="Pixel"===t.metricUnit?o.pixelToWorld:1;if(void 0!==t.secondaryColor&&_t(n,n.color,t,t.secondaryColor,o.zoomLevel),void 0!==t.secondaryWidth){const e=Object(K.w)(t.lineWidth,o.zoomLevel,o.pixelToWorld),i=Object(K.w)(t.secondaryWidth,o.zoomLevel,o.pixelToWorld),s=Object(K.w)(t.opacity,o.zoomLevel),a=i<=e&&(void 0===s||1===s)?0:i;n.lineWidth=a*r*.5}}),this.registerTileObject(e,r,y.kind),h.push(r)}}}}preparePois(e,t){void 0!==t.poiGeometries&&e.mapView.poiManager.addPois(e,t)}addGroundPlane(e,t){const i=e.mapView,s=e.dataSource,o=e.projection,a=i.clearColor,l=new r.Zb;if(e.projection.type===n.f.Spherical){const{east:i,west:h,north:c,south:d}=e.geoBox,m=s.getTilingScheme().projection,u=new r.i,p=new r.h(new Float32Array([...m.projectPoint(new n.b(d,h),l).toArray(),...m.projectPoint(new n.b(d,i),l).toArray(),...m.projectPoint(new n.b(c,h),l).toArray(),...m.projectPoint(new n.b(c,i),l).toArray()]),3);u.setAttribute("position",p),u.setIndex(new r.h(new Uint16Array([0,1,2,2,1,3]),1)),new Q.a(r.bb.degToRad(10),m).modify(u);for(let t=0;t<p.array.length;t+=3)l.set(p.array[t],p.array[t+1],p.array[t+2]),o.reprojectPoint(m,l,l),l.sub(e.center),p.array[t]=l.x,p.array[t+1]=l.y,p.array[t+2]=l.z;p.needsUpdate=!0;const f=new M({color:a,visible:!0,depthWrite:!0}),g=new r.eb(u,f);g.renderOrder=t,this.registerTileObject(e,g,K.f.Background),e.objects.push(g)}else{e.boundingBox.getSize(l);const i=this.createPlane(l.x,l.y,e.center,a,!0,t);this.registerTileObject(e,i,K.f.Background),e.objects.push(i)}}setupTerrainMaterial(e,t,i){if(void 0!==e.displacementMap)t.onBeforeCompile=e=>{e.fragmentShader=e.fragmentShader.replace("#include <map_pars_fragment>","#include <map_pars_fragment>\n    uniform sampler2D displacementMap;\n    uniform float displacementScale;\n    uniform float displacementBias;"),e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",`#ifdef USE_MAP\n    float minElevation = ${n.a.MIN_ELEVATION.toFixed(1)};\n    float maxElevation = ${n.a.MAX_ELEVATION.toFixed(1)};\n    float elevationRange = maxElevation - minElevation;\n\n    float disp = texture2D( displacementMap, vUv ).x * displacementScale + displacementBias;\n    vec4 texelColor = texture2D( map, vec2((disp - minElevation) / elevationRange, 0.0) );\n    texelColor = mapTexelToLinear( texelColor );\n    diffuseColor *= texelColor;\n#endif`),e.vertexShader=e.vertexShader.replace("#include <displacementmap_vertex>","")},t.displacementMap.needsUpdate=!0;else{t.color.set(i)}}createPlane(e,t,i,n,s,o){const a=new r.wb(e,t,1),l=new M({color:n,visible:s,depthWrite:!1}),h=new r.eb(a,l);return h.position.copy(i),h.renderOrder=o,h}addFeatureData(e,t,i){if((void 0!==e.objInfos&&e.objInfos.length>0||Object(K.x)(t)||Object(K.K)(t))&&!Object(K.J)(t)){const t={geometryType:e.type,starts:e.featureStarts,objInfos:e.objInfos};i.userData.feature=t}}addGeometryObjInfos(e,t,i,n){if(!(void 0===t.objInfos||Object.keys(n.userData).length>0))if(Object(K.M)(i)){if("number"==typeof t.objInfos[0])return void Object(p.l)(!1,"Wrong attribute map type for terrain geometry");const i=t.objInfos[0],s={tileKey:e.tileKey,texture:new r.q(i.buffer,i.xCountVertices,i.yCountVertices,r.Z,r.C),displacementMap:i};n.userData=s}else n.userData=t.objInfos}getFadingParams(e,t){return{fadeNear:void 0!==t.fadeNear?Object(K.w)(t.fadeNear,e):_.DEFAULT_FADE_NEAR,fadeFar:void 0!==t.fadeFar?Object(K.w)(t.fadeFar,e):_.DEFAULT_FADE_FAR}}getPolygonFadingParams(e,t){let i,n=R.DEFAULT_COLOR_MIX;if(void 0!==t.lineColor&&(i=Object(K.w)(t.lineColor,e),Object(K.z)(t))){const e=t;n=void 0!==e.lineColorMix?e.lineColorMix:R.DEFAULT_COLOR_MIX}const r=void 0!==t.fadeNear?Object(K.w)(t.fadeNear,e):_.DEFAULT_FADE_NEAR,s=void 0!==t.fadeFar?Object(K.w)(t.fadeFar,e):_.DEFAULT_FADE_FAR,o=void 0!==t.lineFadeNear?Object(K.w)(t.lineFadeNear,e):r,a=void 0!==t.lineFadeFar?Object(K.w)(t.lineFadeFar,e):s;return void 0===i&&(i=R.DEFAULT_COLOR),{color:i,colorMix:n,fadeNear:r,fadeFar:s,lineFadeNear:o,lineFadeFar:a}}}class En extends p.h{}class Mn extends p.b{}var An=i(12);const Pn=p.d.instance.create("MapViewUtils"),Ln=1e3,Rn=56,On=new r.Zb(0,0,1),Fn=new r.ub(On.clone()),Dn=new r.Nb(void 0,An.a.EQUATORIAL_RADIUS),In=new r.Eb,zn={x:new r.Zb,y:new r.Zb,z:new r.Zb},kn={x:new r.Zb,y:new r.Zb,z:new r.Zb},jn={quaternions:[new r.zb,new r.zb],vector3:[new r.Zb,new r.Zb],matrix4:[new r.db,new r.db],transforms:[{xAxis:new r.Zb,yAxis:new r.Zb,zAxis:new r.Zb,position:new r.Zb}]};var Nn;!function(e){function t(e,t,i,n=Math.PI/2){const o=s(e,0,0);if(null===o)throw new Error("MapView does not support a view pointing in the void");const a=e.projection.unprojectPoint(o),l=c(e,e.camera,a),h=Math.max(Math.min(r.bb.radToDeg(n),i+r.bb.radToDeg(l.tilt)),0);e.lookAt(a,o.distanceTo(e.camera.position),h,r.bb.radToDeg(l.azimuth+Math.PI)+t)}function i(e,t,i,s,o,a=new r.Zb){const l=r.bb.degToRad(s),h=Math.cos(l)*t,c=r.bb.degToRad(i);o.projectPoint(e,a);const d=t*Math.sin(l);if(o.type===n.f.Planar)a.x=a.x+Math.sin(c)*d,a.y=a.y-Math.cos(c)*d,a.z=a.z+h;else if(o.type===n.f.Spherical){kn.z.copy(a).normalize(),kn.y.set(0,0,1).projectOnPlane(kn.z).normalize(),jn.quaternions[0].setFromAxisAngle(kn.z,c-Math.PI),kn.y.applyQuaternion(jn.quaternions[0]),kn.y.setLength(d);const e=t*Math.cos(l);a.add(kn.y).add(kn.z.setLength(e));const i=An.a.EQUATORIAL_RADIUS+h,n=Math.sin(l)*t,r=Math.sqrt(i*i+n*n);a.setLength(r)}return a}function s(e,t,i,s){const o=new r.Zb(t,i,0);jn.vector3[1].copy(e.camera.position),jn.matrix4[0].extractRotation(e.camera.matrixWorld),jn.matrix4[1].multiplyMatrices(jn.matrix4[0],jn.matrix4[1].getInverse(e.camera.projectionMatrix));const a=o.applyMatrix4(jn.matrix4[1]);In.set(jn.vector3[1],a.normalize()),void 0!==s&&(Fn.constant=-s);const l=new r.Zb,h=e.projection.type===n.f.Planar?In.ray.intersectPlane(Fn,l):In.ray.intersectSphere(Dn,l);return Fn.constant=0,h}function o(e,t,i){e.camera.position.x+=t,e.camera.position.y+=i}function a(e,t,i){jn.quaternions[0].setFromUnitVectors(t.normalize(),i.normalize()).inverse(),jn.matrix4[0].makeRotationFromQuaternion(jn.quaternions[0]),e.camera.applyMatrix(jn.matrix4[0]),e.camera.updateMatrixWorld()}function l(e,t,i,n,s=new r.zb){const o=jn.transforms[0];return e.localTangentSpace(t,o),jn.matrix4[0].makeBasis(o.xAxis,o.yAxis,o.zAxis),s.setFromRotationMatrix(jn.matrix4[0]),jn.quaternions[0].setFromAxisAngle(jn.vector3[1].set(0,0,1),r.bb.degToRad(i)),jn.quaternions[1].setFromAxisAngle(jn.vector3[1].set(1,0,0),r.bb.degToRad(n)),s.multiply(jn.quaternions[0]),s.multiply(jn.quaternions[1]),s}function h(e,t){jn.vector3[1].setFromMatrixPosition(t.matrixWorld),e.projection.localTangentSpace(e.projection.unprojectPoint(jn.vector3[1]),{xAxis:kn.x,yAxis:kn.y,zAxis:kn.z,position:jn.vector3[0]}),jn.matrix4[1].makeBasis(kn.x,kn.y,kn.z),jn.matrix4[0].getInverse(jn.matrix4[1]).multiply(t.matrixWorld),zn.x.setFromMatrixColumn(jn.matrix4[0],0),zn.y.setFromMatrixColumn(jn.matrix4[0],1),zn.z.setFromMatrixColumn(jn.matrix4[0],2);let i=0,n=0,r=0;const s=zn.z.dot(jn.vector3[1].set(0,0,1));return s<.99999?s>1e-5-1?(i=Math.atan2(zn.z.x,-zn.z.y),n=Math.acos(zn.z.z),r=Math.atan2(zn.x.z,zn.y.z)):(i=-Math.atan2(-zn.y.x,zn.x.x),n=180,r=0):(i=Math.atan2(-zn.y.x,zn.x.x),n=0,r=0),{yaw:i,pitch:n,roll:r}}function c(e,t,i){e.projection.localTangentSpace(i,{xAxis:kn.x,yAxis:kn.y,zAxis:kn.z,position:jn.vector3[0]});let n=0,r=0;return jn.vector3[1].copy(t.position).sub(jn.vector3[0]).normalize(),jn.vector3[1].dot(kn.z)>.99999?(r=Math.PI-h(e,t).yaw,r=Math.atan2(Math.sin(r),Math.cos(r)),n=0,{tilt:n,azimuth:r}):(n=jn.vector3[1].angleTo(kn.z),jn.vector3[1].copy(t.position).sub(jn.vector3[0]).projectOnPlane(kn.z).normalize(),r=jn.vector3[1].angleTo(kn.y),jn.vector3[1].cross(kn.y).dot(kn.z)<0&&(r=-r),{tilt:n,azimuth:r})}function d(e,t){const i=h(e,e.camera).pitch,n=An.a.EQUATORIAL_CIRCUMFERENCE/Math.pow(2,t);return e.focalLength*n/256*Math.cos(i)}function m(e,t,i){if(null==e||void 0===e.image)return;if(void 0!==e.uuid&&!0===i.get(e.uuid))return;i.set(e.uuid,!0);const n=e.image,r=4*n.width*n.height;t.heapSize+=r,t.gpuSize+=r}function u(e,t,i){if(void 0===e.uuid||!0!==i.get(e.uuid))if(i.set(e.uuid,!0),e instanceof r.Db||e instanceof r.Lb){const n=e;for(const e in n.uniforms)if(void 0!==n.uniforms[e]){const s=n.uniforms[e];s instanceof r.Pb&&m(s,t,i)}}else if(e instanceof r.fb||e instanceof M){const n=e;m(n.map,t,i),m(n.aoMap,t,i),m(n.specularMap,t,i),m(n.alphaMap,t,i),m(n.envMap,t,i)}else if(e instanceof A){const n=e;m(n.map,t,i),m(n.lightMap,t,i),m(n.aoMap,t,i),m(n.emissiveMap,t,i),m(n.bumpMap,t,i),m(n.normalMap,t,i),m(n.displacementMap,t,i),m(n.roughnessMap,t,i),m(n.metalnessMap,t,i),m(n.alphaMap,t,i),m(n.envMap,t,i)}else e instanceof r.Q||e instanceof r.S||Pn.warn("estimateMeshSize: unidentified material: ",e)}function p(e,t,i,n){if(void 0===e.uuid&&(e.uuid=r.bb.generateUUID()),!0===n.get(e.uuid))return;n.set(e.uuid,!0);let s=0,o=4;void 0!==e.array.BYTES_PER_ELEMENT&&(o=e.array.BYTES_PER_ELEMENT),e instanceof r.K||e instanceof r.h?s=o*e.count*e.itemSize:Pn.warn("estimateMeshSize: unidentified attribute: ",t),i.heapSize+=s+Rn,i.gpuSize+=s}function f(e){return e.substring(0,2)}e.zoomOnTargetPosition=function(e,i,r,l,h=Math.PI/2){const m=s(e,i,r),u=d(e,l);if(e.projection.type===n.f.Planar?e.camera.position.setZ(u):e.projection.type===n.f.Spherical&&e.camera.position.setLength(An.a.EQUATORIAL_RADIUS+u),e.projection.type===n.f.Spherical){const i=s(e,0,0);if(null!==i){const n=c(e,e.camera,e.projection.unprojectPoint(i)).tilt-h;n>0&&t(e,0,n,h)}}const p=s(e,i,r);m&&p&&(e.projection.type===n.f.Planar?(m.sub(p),o(e,m.x,m.y)):e.projection.type===n.f.Spherical&&a(e,m,p))},e.orbitFocusPoint=t,e.getCameraPositionFromTargetCoordinates=i,e.getCameraCoordinatesFromTargetCoordinates=function(e,t,n,r,s){return s.projection.unprojectPoint(i(e,t,n,r,s.projection,jn.vector3[1]))},e.rayCastWorldCoordinates=s,e.panCameraAboveFlatMap=o,e.panCameraAroundGlobe=a,e.rotate=function(t,i,s=0,o=Math.PI/4){if(t.camera.rotateOnWorldAxis(t.projection.type===n.f.Spherical?jn.vector3[0].copy(t.camera.position).normalize():jn.vector3[0].set(0,0,1),n.c.degToRad(-i)),t.camera.updateMatrixWorld(),0===s)return;const a=e.extractAttitude(t,t.camera).pitch;let l=r.bb.clamp(a+r.bb.degToRad(s),0,o);if(t.projection.type===n.f.Spherical){const e=Math.asin(An.a.EQUATORIAL_RADIUS*Math.sin(Math.PI-o)/t.camera.position.length());l=Math.min(l,e)}t.camera.rotateX(l-a)},e.getCameraRotationAtTarget=l,e.setRotation=function(e,t,i){l(e.projection,e.geoCenter,t,i,e.camera.quaternion)},e.extractAttitude=h,e.extractSphericalCoordinatesFromLocation=c,e.getCameraFrustumPlanes=function(e){const t=e.near,i=e.far;let n=t*Math.tan(r.bb.degToRad(.5*e.fov))/e.zoom,s=2*n,o=e.aspect*s,a=-.5*o;const l=e.view;if(null!==l&&l.enabled){const e=l.fullWidth,t=l.fullHeight;a+=l.offsetX*o/e,n-=l.offsetY*s/t,o*=l.width/e,s*=l.height/t}return a+=0!==e.filmOffset?t*e.filmOffset/e.getFilmWidth():0,{left:a,right:a+o,top:n,bottom:n-s,near:t,far:i}},e.rayCastGeoCoordinates=function(e,t,i){const n=s(e,t,i);return n?e.projection.unprojectPoint(n):null},e.calculateDistanceToGroundFromZoomLevel=d,e.calculateZoomLevelFromDistance=function(e,t){const i=256*e/t.focalLength,n=r.bb.clamp(Math.log2(An.a.EQUATORIAL_CIRCUMFERENCE/i),t.minZoomLevel,t.maxZoomLevel);return Math.round(1e16*n)/1e16},e.calculateDepthFromClipDistance=function(e,t){const i=t,n=i.far-i.near,r=e*i.far;return(1-i.near/r)*(i.far/n)},e.cameraToWorldDistance=function(e,t){return e*t.far},e.calculateVerticalFovByHorizontalFov=function(e,t){return 2*Math.atan(Math.tan(e/2)/t)},e.calculateHorizontalFovByVerticalFov=function(e,t){return 2*Math.atan(Math.tan(e/2)*t)},e.calculateFocalLengthByVerticalFov=function(e,t){return t/2/Math.tan(e/2)},e.calculateFovByFocalLength=function(e,t){return r.bb.radToDeg(2*Math.atan(t/2/e))},e.calculateScreenSizeByFocalLength=function(e,t,i){return e*i/t},e.calculateWorldSizeByFocalLength=function(e,t,i){return t*i/e},e.estimateObject3dSize=function e(t,i,n){const s=void 0!==i?i:{heapSize:0,gpuSize:0};if(void 0===n&&(n=new Map),function(e,t,i){if(!e.isObject3D||e instanceof r.Ib)return;if(void 0!==e.uuid&&!0===i.get(e.uuid))return;if(i.set(e.uuid,!0),e.isMesh||e.isLine||e.isPoints){let n=Ln;const s=0,o=e;if(void 0!==o.material)if(Array.isArray(o.material)){const e=o.material;for(const n of e)u(n,t,i)}else{u(o.material,t,i)}void 0!==o.geometry&&function(e,t,i){if(void 0!==e.uuid&&!0===i.get(e.uuid))return;let n;i.set(e.uuid,!0),e instanceof r.F?(t.heapSize+=24*e.vertices.length,t.heapSize+=48*e.faces.length,n=e._bufferGeometry):e instanceof r.i&&(n=e);if(void 0===n)return;const s=n.attributes;if(void 0===s)return void Pn.warn("estimateGeometrySize: unidentified geometry: ",e);for(const e in s)void 0!==s[e]&&p(s[e],e,t,i);null!==n.index&&p(n.index,"index",t,i)}(o.geometry,t,i);const a=void 0!==e.userData?e.userData.feature:void 0;void 0!==a&&(n+=function(e){let t=Vn;void 0!==e.starts&&(t+=8*e.starts.length);void 0!==e.objInfos&&(t+=e.objInfos.length*qn);return t}(a)),t.heapSize+=n,t.gpuSize+=s}else Pn.warn("estimateMeshSize: unidentified object",e)}(t,s,n),t.children.length>0)for(const i of t.children)e(i,s,n);return s},e.mapViewIsLoading=function(e){let t=0;for(const i of e.visibleTileSet.dataSourceTileList){t+=i.numTilesLoading;for(const e of i.visibleTiles)void 0===e.tileLoader||e.tileLoader.isFinished||t++,void 0===e.tileGeometryLoader||e.tileGeometryLoader.isFinished||t++}let i=t>0;return void 0!==e.textElementsRenderer&&(i=i||e.textElementsRenderer.loading),i=i||!e.poiTableManager.finishedLoading||!e.visibleTileSet.allVisibleTilesLoaded,i},e.getBrowserLanguages=function(){if(void 0!==navigator.languages&&navigator.languages.length>0){const e=[];for(const t of navigator.languages)e.push(f(t));return e}if(void 0!==navigator.language)return[f(navigator.language)]}}(Nn||(Nn={}));const Gn=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648,4294967296,8589934592,17179869184,34359738368,68719476736,137438953472,274877906944,549755813888,1099511627776,2199023255552,4398046511104,8796093022208,17592186044416,35184372088832,70368744177664,0x800000000000,281474976710656,562949953421312,0x4000000000000,0x8000000000000,4503599627370496];var Un;!function(e){function t(e,t,i=4){const n=function(e,t=4){let i=0;const n=Gn[t];e+=n/2;for(;e<0;)e+=n;for(;e>=n;)e-=n;for(let n=0;n<t&&e>0;n++)1&e&&(i+=Gn[53-t+n]),e>>>=1;return Object(p.l)(0===e),i}(t,i);return e.mortonCode()+n}function i(e,t=4){let i=0,n=e,r=0;for(;r<t;r++){const e=Gn[52-r];n>=e&&(n-=e,i+=Gn[t-1-r])}return i-=Gn[t-1],{offset:i,mortonCode:n}}e.getKeyForTileKeyAndOffset=t,e.extractOffsetAndMortonKeyFromKey=i,e.getParentKeyFromKey=function(e,r=4){const{offset:s,mortonCode:o}=i(e,r);return t(n.g.fromMortonCode(n.g.parentMortonCode(o)),s,r)}}(Un||(Un={}));const Bn=p.d.instance.create("Tile"),qn=16,Vn=100;var Wn;!function(e){e[e.Initialized=0]="Initialized",e[e.Loading=1]="Loading",e[e.Loaded=2]="Loaded",e[e.Decoding=3]="Decoding",e[e.Ready=4]="Ready",e[e.Canceled=5]="Canceled",e[e.Failed=6]="Failed"}(Wn||(Wn={}));class Zn{constructor(e,t,i=0,r){this.dataSource=e,this.tileKey=t,this.offset=i,this.objects=[],this.dependencies=new Array,this.boundingBox=new n.e,this.maxGeometryHeight=0,this.frameNumLastRequested=-1,this.frameNumVisible=-1,this.frameNumLastVisible=-1,this.numFramesVisible=0,this.visibilityCounter=-1,this.levelOffset=0,this.m_disposed=!1,this.m_localTangentSpace=!1,this.m_forceHasGeometry=void 0,this.m_userTextElements=new En(Number.MAX_SAFE_INTEGER),this.m_textElementGroups=new Mn,this.m_pathBlockingElements=[],this.m_textElementsChanged=!1,this.m_visibleArea=0,this.m_minElevation=0,this.m_maxElevation=0,this.m_ownedTextures=new WeakSet,this.m_nextTextElementToOverlay={groupIndex:0,elementIndex:0},this.geoBox=this.dataSource.getTilingScheme().getGeoBox(this.tileKey),this.projection.projectBox(this.geoBox,this.boundingBox),this.m_localTangentSpace=void 0!==r&&r}get isVisible(){return this.frameNumLastRequested>=this.dataSource.mapView.frameNumber-1}set isVisible(e){this.frameNumLastRequested=e?this.dataSource.mapView.frameNumber:-1}get projection(){return this.dataSource.projection}get mapView(){return this.dataSource.mapView}get localTangentSpace(){return this.m_localTangentSpace}get memoryUsage(){return void 0===this.m_resourceInfo&&this.computeResourceInfo(),this.m_resourceInfo.heapSize}get center(){return this.boundingBox.position}getResourceInfo(){return void 0===this.m_resourceInfo&&this.computeResourceInfo(),this.m_resourceInfo}invalidateResourceInfo(){this.m_resourceInfo=void 0}addOwnedTexture(e){this.m_ownedTextures.add(e)}get userTextElements(){return this.m_userTextElements}addUserTextElement(e){this.m_userTextElements.elements.push(e),this.textElementsChanged=!0}removeUserTextElement(e){const t=this.m_userTextElements.elements.indexOf(e);return t>=0&&(this.m_userTextElements.elements.splice(t,1),this.textElementsChanged=!0,!0)}addTextElement(e){this.textElementGroups.add(e),this.textElementsChanged=!0}addBlockingElement(e){this.m_pathBlockingElements.push(e)}removeTextElement(e){return!!this.textElementGroups.remove(e)&&(this.textElementsChanged=!0,!0)}get textElementGroups(){return this.m_textElementGroups}get textElementsChanged(){return this.m_textElementsChanged}set textElementsChanged(e){this.m_textElementsChanged=e}hasTextElements(){return this.m_textElementGroups.count()>0||this.m_userTextElements.elements.length>0}get blockingElements(){return this.m_pathBlockingElements}prepareTileInfo(){void 0!==this.m_decodedTile&&!this.m_disposed&&this.isVisible&&void 0!==this.m_decodedTile.tileInfo&&(this.roadIntersectionData=this.dataSource.mapView.pickHandler.registerTile(this))}willRender(e){return!0}didRender(){}get visibleArea(){return this.m_visibleArea}set visibleArea(e){this.m_visibleArea=e,void 0!==this.tileLoader&&this.tileLoader.updatePriority(e)}get minElevation(){return this.m_minElevation}set minElevation(e){this.m_minElevation=e}get maxElevation(){return this.m_maxElevation}set maxElevation(e){this.m_maxElevation=e}get decodedTile(){return this.m_decodedTile}set decodedTile(e){if(this.m_decodedTile=e,this.invalidateResourceInfo(),void 0===e)return;0===e.geometries.length&&this.forceHasGeometry(!0),void 0!==e.boundingBox&&this.boundingBox.copy(e.boundingBox);const t=xn.instance;t.enabled&&void 0!==e.decodeTime&&(t.currentFrame.addValue("decode.decodingTime",e.decodeTime),t.currentFrame.addValue("decode.decodedTiles",1)),void 0!==e.copyrightHolderIds&&(this.copyrightInfo=e.copyrightHolderIds.map(e=>({id:e}))),this.dataSource.requestUpdate()}removeDecodedTile(){this.m_decodedTile=void 0,this.invalidateResourceInfo()}loadingFinished(){}shouldDisposeObjectGeometry(e){return!0}shouldDisposeObjectMaterial(e){return!0}shouldDisposeTexture(e){return this.m_ownedTextures.has(e)}get disposed(){return this.m_disposed}get tileGeometryLoader(){return this.m_tileGeometryLoader}set tileGeometryLoader(e){this.m_tileGeometryLoader=e}get basicGeometryLoaded(){return void 0===this.m_tileGeometryLoader?this.hasGeometry:this.m_tileGeometryLoader.basicGeometryLoaded||this.m_tileGeometryLoader.isFinished}get allGeometryLoaded(){return void 0===this.m_tileGeometryLoader?this.hasGeometry:this.m_tileGeometryLoader.allGeometryLoaded||this.m_tileGeometryLoader.isFinished}get hasGeometry(){return void 0===this.m_forceHasGeometry?0!==this.objects.length:this.m_forceHasGeometry}forceHasGeometry(e){this.m_forceHasGeometry=e}resetVisibilityCounter(){this.visibilityCounter=-1}get tileLoader(){return this.m_tileLoader}set tileLoader(e){this.m_tileLoader=e}load(){const e=this.tileLoader;void 0!==e&&e.loadAndDecode().then(t=>{Object(p.l)(t===Wn.Ready);const i=e.decodedTile;this.decodedTile=i}).catch(e=>{e!==Wn.Canceled&&e!==Wn.Failed&&Bn.error("Unknown error"+e)})}get animatedExtrusionTileHandler(){return this.m_animatedExtrusionTileHandler}set animatedExtrusionTileHandler(e){this.m_animatedExtrusionTileHandler=e}get allTextElementsOverlaid(){return this.allGeometryLoaded&&this.nextTextElementToOverlay.groupIndex>=this.m_textElementGroups.groups.size}get nextTextElementToOverlay(){return this.m_nextTextElementToOverlay}set nextTextElementToOverlay(e){this.m_nextTextElementToOverlay=e}clear(){const e=e=>{Object.getOwnPropertyNames(e).forEach(t=>{const i=e[t];if(void 0!==i&&i instanceof r.Pb){const e=i;this.shouldDisposeTexture(e)&&e.dispose()}}),e.dispose()},t=t=>{void 0!==t.geometry&&this.shouldDisposeObjectGeometry(t)&&t.geometry.dispose(),void 0!==t.material&&this.shouldDisposeObjectMaterial(t)&&(t.material instanceof Array?t.material.forEach(t=>{void 0!==t&&e(t)}):e(t.material))};this.objects.forEach(e=>{e.traverse(e=>{t(e)}),t(e)}),this.objects.length=0,this.preparedTextPaths&&(this.preparedTextPaths=[]),void 0!==this.m_animatedExtrusionTileHandler&&this.m_animatedExtrusionTileHandler.dispose(),this.clearTextElements(),this.invalidateResourceInfo()}clearTextElements(){this.textElementsChanged=this.hasTextElements(),this.m_pathBlockingElements.splice(0),this.textElementGroups.clear(),this.userTextElements.elements.length=0}dispose(){this.m_disposed||(this.m_tileLoader&&(this.m_tileLoader.cancel(),this.m_tileLoader=void 0),void 0!==this.m_tileGeometryLoader&&(this.m_tileGeometryLoader.dispose(),this.m_tileGeometryLoader=void 0),this.clear(),this.userTextElements.elements.length=0,this.m_disposed=!0,this.frameNumLastRequested=0)}computeWorldOffsetX(){return this.projection.worldExtent(0,0).max.x*this.offset}computeResourceInfo(){let e=0,t=0,i=0,n=0;const r={heapSize:0,gpuSize:0},s=new Map;for(const e of this.objects)e.visible&&t++,Nn.estimateObject3dSize(e,r,s);for(const e of this.textElementGroups.groups)i+=e[1].elements.length;n=this.userTextElements.elements.length,e+=312*(i+n),void 0!==this.m_decodedTile&&void 0!==this.m_decodedTile.tileInfo&&(r.heapSize+=this.m_decodedTile.tileInfo.numBytes),void 0!==this.roadIntersectionData&&(e+=function(e){let t=Vn;const i=32+Vn,n=e.techniqueIndex.length;return t+=e.techniqueIndex.length*i,void 0!==e.ids&&(t+=8*n),void 0!==e.objInfos&&(t+=n*qn),t}(this.roadIntersectionData)),this.m_resourceInfo={heapSize:r.heapSize+e,gpuSize:r.gpuSize,num3dObjects:t,numTextElements:i,numUserTextElements:n}}}class $n extends Y{constructor(){super("background"),this.m_tilingScheme=$n.DEFAULT_TILING_SCHEME,this.cacheable=!0}updateStorageLevelOffset(){let e;this.mapView.dataSources.forEach(t=>{if(t===this)return;t.getTilingScheme()===this.m_tilingScheme&&(e=void 0===e?t.storageLevelOffset:Math.max(e,t.storageLevelOffset))}),void 0===e&&(e=0),e!==this.storageLevelOffset&&(this.storageLevelOffset=e,this.mapView.clearTileCache(this.name))}setTheme(e,t){this.mapView.clearTileCache(this.name)}setTilingScheme(e){const t=e||$n.DEFAULT_TILING_SCHEME;t!==this.m_tilingScheme&&(this.m_tilingScheme=t,this.updateStorageLevelOffset(),this.mapView.clearTileCache(this.name))}getTilingScheme(){return this.m_tilingScheme}getTile(e){const t=new Zn(this,e);return t.forceHasGeometry(!0),t.removeDecodedTile(),Cn.instance.addGroundPlane(t,Number.MIN_SAFE_INTEGER),t}}$n.DEFAULT_TILING_SCHEME=n.p;const Hn=300;class Kn{constructor(e,t,i){this.m_throttlingTimeout=e,this.m_movementStartedFunc=t,this.m_movementFinishedFunc=i,this.m_lastCameraPos=new r.Zb,this.m_newCameraPos=new r.Zb,this.m_throttlingTimerId=void 0,this.m_movementDetectorDeadline=0,this.onDeadlineTimer=()=>{this.m_throttlingTimerId=void 0;const e=performance.now();e>=this.m_movementDetectorDeadline?this.movementFinished():this.startMovementFinishedTimer(e)},void 0===this.m_throttlingTimeout&&(this.m_throttlingTimeout=Hn)}checkCameraMoved(e,t){const i=Nn.extractAttitude(e,e.camera),n=e.camera.getWorldPosition(this.m_newCameraPos);if(void 0===this.m_lastAttitude)return this.m_lastCameraPos.copy(n),this.m_lastAttitude=i,!1;const r=!this.m_lastCameraPos.equals(n)||i.yaw!==this.m_lastAttitude.yaw||i.pitch!==this.m_lastAttitude.pitch||i.roll!==this.m_lastAttitude.roll;return r&&(this.m_lastCameraPos.copy(n),this.m_lastAttitude=i),r!==this.m_cameraMovedLastFrame&&(r&&this.movementStarted(),this.m_cameraMovedLastFrame=r),r&&(this.m_movementDetectorDeadline=t+this.m_throttlingTimeout,this.startMovementFinishedTimer(t)),this.m_cameraMovedLastFrame}clear(e){const t=e.camera.getWorldPosition(this.m_newCameraPos);this.m_lastCameraPos.set(t.x,t.y,t.z);const i=Nn.extractAttitude(e,e.camera);this.m_lastAttitude=i}forceMoved(){this.m_lastCameraPos.set(Number.NaN,Number.NaN,Number.NaN)}get cameraIsMoving(){return void 0!==this.m_throttlingTimerId}dispose(){this.removeMovementFinishedTimer(),this.m_movementStartedFunc=void 0,this.m_movementFinishedFunc=void 0}get cameraMovedLastFrame(){return!0===this.m_cameraMovedLastFrame}movementStarted(){void 0!==this.m_movementStartedFunc&&this.m_movementStartedFunc()}movementFinished(){this.removeMovementFinishedTimer(),void 0!==this.m_movementFinishedFunc&&this.m_movementFinishedFunc()}startMovementFinishedTimer(e){if(void 0===this.m_throttlingTimerId){const t=Math.max(0,this.m_movementDetectorDeadline-e);this.m_throttlingTimerId=setTimeout(this.onDeadlineTimer,t)}}removeMovementFinishedTimer(){void 0!==this.m_throttlingTimerId&&(clearTimeout(this.m_throttlingTimerId),this.m_throttlingTimerId=void 0)}}const Xn=1e-6;class Yn{constructor(e,t){Object(p.l)(e>=t),this.m_minElevation=t,this.m_maxElevation=e}set maxElevation(e){this.m_maxElevation=e,this.m_minElevation=Math.min(e,this.m_minElevation)}get maxElevation(){return this.m_maxElevation}set minElevation(e){this.m_minElevation=e,this.m_maxElevation=Math.max(e,this.m_maxElevation)}get minElevation(){return this.m_minElevation}}class Jn extends Yn{constructor(e=n.a.MAX_BUILDING_HEIGHT,t=0,i=1,s=.05,o=1.8){super(e,t),this.nearMin=i,this.nearFarMarginRatio=s,this.farMaxRatio=o,this.m_tmpVectors=[new r.Zb,new r.Zb,new r.Zb],this.m_tmpQuaternion=new r.zb,Object(p.l)(i>0),Object(p.l)(s>Xn),Object(p.l)(o>1);const a=s*i;this.m_minimumViewRange={near:i,far:i+a,minimum:this.nearMin,maximum:Math.max(i*o,i+a)}}evaluateClipPlanes(e){return e.projection.type===n.f.Spherical?this.evaluateDistanceSphericalProj(e):e.projection.type===n.f.Planar?this.evaluateDistancePlanarProj(e):(Object(p.l)(!1,"Unsupported projection type"),{...this.minimumViewRange})}get minimumViewRange(){return this.m_minimumViewRange}getCameraAltitude(e,t){return t.groundDistance(e.position)}evaluateDistancePlanarProj(e){const{camera:t,projection:i}=e;Object(p.l)(i.type!==n.f.Spherical);let r=this.nearMin,s=this.nearMin*this.farMaxRatio;const o=this.getCameraAltitude(t,i),a=o*this.farMaxRatio;r=o-this.maxElevation,s=o-this.minElevation,r=Math.max(r,this.nearMin),s=Math.min(s,a);const l=this.nearFarMarginRatio*(r+s)/2;return r=Math.max(r-l/2,this.nearMin),s=Math.max(s+l/2,r+l),{near:r,far:s,minimum:this.nearMin,maximum:Math.max(a,s)}}evaluateDistanceSphericalProj(e){const{camera:t,projection:i}=e;Object(p.l)(i.type===n.f.Spherical);let s=this.nearMin,o=this.nearMin*this.farMaxRatio;const a=this.getCameraAltitude(t,i);s=a-this.maxElevation;let l=a*this.farMaxRatio;const h=n.a.EQUATORIAL_RADIUS;let c=t.position.length();if(c=0===c?Xn:c,"PerspectiveCamera"===t.type){const e=Math.asin(h/c),n=t,s=n.aspect>1?n.aspect:1/n.aspect,a=r.bb.degToRad(n.fov*s/2),d=this.getTangentBasedFarPlane(n,c,h,e);o=a>e?d:this.getFovBasedFarPlane(n,c,h,2*a,i),l=Math.max(l,d)}else o=this.getOrthoBasedFarPlane(c,h);const d=a-this.minElevation;s=Math.max(s,this.nearMin),o=Math.max(o,d);const m=this.nearFarMarginRatio*(s+o)/2;return s=Math.max(s-m/2,this.nearMin),o=Math.max(o+m/2,s+m),{near:s,far:o,minimum:this.nearMin,maximum:l}}getTangentDistance(e,t){return e-t<Xn?0:Math.sqrt(e*e-t*t)}getTangentBasedFarPlane(e,t,i,n){const r=this.getTangentDistance(t,i),s=this.getTangentDistance(i+this.maxElevation,i);return Math.cos(n)*(r+s)}getFovBasedFarPlane(e,t,i,n,r){const s=e.position;e.matrixWorld.extractBasis(this.m_tmpVectors[0],this.m_tmpVectors[1],this.m_tmpVectors[2]),this.m_tmpQuaternion.setFromAxisAngle(this.m_tmpVectors[0],n/2);const o=this.m_tmpVectors[2],a=this.m_tmpVectors[1].copy(o).applyQuaternion(this.m_tmpQuaternion),l=s.dot(a);if(l<0){return this.getCameraAltitude(e,r)*this.farMaxRatio}const h=s.dot(s)-l*l,c=i*i;return Object(p.l)(h<=c,"Please use this evaluator only for top view camera poses."),l-Math.sqrt(c-h)}getOrthoBasedFarPlane(e,t){return e+(this.maxElevation<Xn?0:Math.sqrt(t+this.maxElevation)*(t+this.maxElevation)-t*t)}}class Qn extends Jn{getCameraLookAtDistance(e,t){Object(p.l)(t.type!==n.f.Spherical);const i=this.m_tmpVectors[0];e.getWorldDirection(i).normalize();const r=this.m_tmpVectors[1];t.surfaceNormal(e.position,r),r.negate();let s=i.dot(r);return s=0===s?Xn:s,this.getCameraAltitude(e,t)/s}getFrustumGroundIntersectionDist(e){Object(p.l)(e.projection.type!==n.f.Spherical);const t=e.camera,i=e.projection,s=Math.PI/2-Xn,o=this.getCameraAltitude(t,i),a=Nn.rayCastWorldCoordinates(e,0,0);if(null===a)throw new Error("MapView does not support a view pointing in the void.");const l=Nn.extractSphericalCoordinatesFromLocation(e,t,i.unprojectPoint(a)).tilt;let h,c,d,m;if("PerspectiveCamera"===t.type){const e=t,i=1,n=r.bb.degToRad(e.fov*i/2);h=r.bb.clamp(l+n,-s,s),c=r.bb.clamp(l-n,-s,s),d=m=o}else{const e=t;h=c=l;const i=Math.sin(l);m=o+i*e.top,d=o-i*e.bottom}const u=(m-this.minElevation)/Math.cos(h),f=(d-this.maxElevation)/Math.cos(c);return{top:Math.max(u,0),bottom:Math.max(f,0)}}evaluateDistancePlanarProj(e){Object(p.l)(e.projection.type!==n.f.Spherical);const t={...this.minimumViewRange},i=this.getFrustumGroundIntersectionDist(e),{camera:s,projection:o}=e;if("PerspectiveCamera"===s.type){const e=s,n=1,o=r.bb.degToRad(e.fov*n/2),a=Math.cos(o);t.near=i.bottom*a,t.far=i.top*a}else t.near=i.bottom,t.far=i.top;const a=this.getCameraLookAtDistance(s,o)*this.farMaxRatio;t.near=Math.max(t.near,this.nearMin),t.far=Math.min(t.far,a);const l=this.nearFarMarginRatio*(t.near+t.far)/2;return t.near=Math.max(t.near-l/2,this.nearMin),t.far=Math.max(t.far+l/2,t.near+l),t.minimum=this.nearMin,t.maximum=a,t}evaluateDistanceSphericalProj(e){const{camera:t,projection:i}=e;Object(p.l)(i.type===n.f.Spherical);const s={...this.minimumViewRange},o=this.getCameraAltitude(t,i);s.near=o-this.maxElevation;const a=t.aspect>1?t.aspect:1/t.aspect,l=r.bb.degToRad(t.fov*a/2);t instanceof r.tb&&(s.near*=Math.cos(l));const h=this.m_tmpVectors[0].copy(t.position).negate(),c=n.a.EQUATORIAL_RADIUS,d=h.length();let m,u=e.lookAtDistance*this.farMaxRatio;if(t instanceof r.tb){const e=Math.asin(c/d),i=this.getCameraPitch(h,t),n=Math.abs(e-i),r=this.getTangentBasedFarPlane(t,d,c,n);m=l>=n?r:this.getTiltedFovBasedFarPlane(d,c,l,i),u=Math.max(u,r)}else m=this.getOrthoBasedFarPlane(d,c);s.far=m;const f=o-this.minElevation;s.near=Math.max(s.near,this.nearMin),s.far=Math.max(s.far,f);const g=this.nearFarMarginRatio*(s.near+s.far)/2;return s.near=Math.max(s.near-g/2,this.nearMin),s.far=Math.max(s.far+g/2,s.near+g),s.minimum=this.nearMin,s.maximum=u,s}getTiltedFovBasedFarPlane(e,t,i,n){const r=Math.cos(n+i),s=e*e,o=e*r-Math.sqrt(s*r*r-s+t*t);return Object(p.l)(!isNaN(o),"Field of view does not intersect sphere. Use tangent based far plane instead."),Math.cos(i)*o}getCameraPitch(e,t){e.normalize();const i=t.getWorldDirection(this.m_tmpVectors[1]).normalize(),n=e.dot(i);return Math.acos(r.bb.clamp(n,-1,1))}}const er=()=>new Qn;class tr{constructor(){this.enabled=!1,this.renderToScreen=!1}setSize(e,t){}render(e,t,i,n,r,s){}}class ir extends tr{constructor(){super()}render(e,t,i,n,r){e.setRenderTarget(this.renderToScreen?null:n),e.render(t,i)}}class nr extends tr{constructor(e,t="tDiffuse"){super(),this.textureID=t,e instanceof r.Lb?(this.uniforms=e.uniforms,this.material=e):(this.uniforms=r.Ub.clone(e.uniforms),this.material=new r.Lb({defines:{...e.defines},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new rr(this.material)}render(e,t,i,n,r,s){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this.fsQuad.material=this.material,e.setRenderTarget(this.renderToScreen?null:n),this.fsQuad.render(e)}}class rr{constructor(e){this.m_camera=new r.rb(-1,1,1,-1,0,1);const t=new r.vb(2,2);this.m_mesh=new r.eb(t,e)}get material(){return this.m_mesh.material}set material(e){this.m_mesh.material=e}render(e){e.render(this.m_mesh,this.m_camera)}}class sr extends tr{constructor(e){super(),this.lowResPixelRatio=e,this.m_renderTarget=null,this.m_localCamera=new r.rb(-1,1,1,-1,0,1),this.m_quadScene=new r.Ib,this.m_quadUniforms=m.uniforms,this.m_quadMaterial=new u(this.m_quadUniforms),this.m_quad=new r.eb(new r.vb(2,2),this.m_quadMaterial),this.m_savedWidth=0,this.m_savedHeight=0,this.m_quad.frustumCulled=!1,this.m_quadScene.add(this.m_quad),this.m_pixelRatio=e}dispose(){this.m_quadMaterial.dispose(),this.m_quad.geometry.dispose(),null!==this.m_renderTarget&&(this.m_renderTarget.dispose(),this.m_renderTarget=null)}set pixelRatio(e){this.m_pixelRatio=e,this.m_renderTarget&&void 0!==this.pixelRatio&&this.m_renderTarget.setSize(Math.floor(this.m_savedWidth*this.pixelRatio),Math.floor(this.m_savedHeight*this.pixelRatio))}get pixelRatio(){return this.m_pixelRatio}render(e,t,i,n,s){if(!this.enabled||void 0===this.pixelRatio)return;null===this.m_renderTarget&&(this.m_savedWidth=s.width,this.m_savedHeight=s.height,this.m_renderTarget=new r.cc(Math.floor(this.m_savedWidth*this.pixelRatio),Math.floor(this.m_savedHeight*this.pixelRatio),{minFilter:r.U,magFilter:r.U,format:r.Ab,depthBuffer:!0,stencilBuffer:!0}),this.m_renderTarget.texture.name="LowResRenderPass.sample"),this.m_quadUniforms.tDiffuse.value=this.m_renderTarget.texture,this.m_quadUniforms.opacity.value=1;const o=e.getRenderTarget();e.setRenderTarget(this.m_renderTarget),e.clear(),e.render(t,i),e.setRenderTarget(this.renderToScreen?null:n),e.clear(),e.render(this.m_quadScene,this.m_localCamera),e.setRenderTarget(o)}setSize(e,t){this.m_savedWidth=e,this.m_savedHeight=t,this.m_renderTarget&&void 0!==this.pixelRatio&&this.m_renderTarget.setSize(Math.floor(e*this.pixelRatio),Math.floor(t*this.pixelRatio))}}var or;!function(e){e[e.Level_0=0]="Level_0",e[e.Level_1=1]="Level_1",e[e.Level_2=2]="Level_2",e[e.Level_3=3]="Level_3",e[e.Level_4=4]="Level_4",e[e.Level_5=5]="Level_5"}(or||(or={}));class ar extends tr{constructor(){super(),this.samplingLevel=or.Level_1,this.m_renderTarget=null,this.m_localCamera=new r.rb(-1,1,1,-1,0,1),this.m_quadScene=new r.Ib,this.m_quadUniforms=m.uniforms,this.m_quadMaterial=new B(this.m_quadUniforms),this.m_quad=new r.eb(new r.vb(2,2),this.m_quadMaterial),this.m_quad.frustumCulled=!1,this.m_quadScene.add(this.m_quad)}dispose(){null!==this.m_renderTarget&&(this.m_renderTarget.dispose(),this.m_renderTarget=null)}render(e,t,i,n,s){if(!this.enabled)return;null===this.m_renderTarget&&(this.m_renderTarget=new r.cc(s.width,s.height,{minFilter:r.U,magFilter:r.U,format:r.Ab}),this.m_renderTarget.texture.name="MSAARenderPass.sample"),this.m_quadUniforms.tDiffuse.value=this.m_renderTarget.texture;const o=ar.OffsetVectors[this.samplingLevel],a=e.getClearColor(),l=void 0!==a?a.getHex():0,h={enabled:null!==i.view&&i.view.enabled,fullWidth:s.width,fullHeight:s.height,x:0,y:0,width:s.width,height:s.height};h.enabled&&null!==i.view&&(h.fullWidth=i.view.fullWidth,h.fullHeight=i.view.fullHeight,h.x=i.view.offsetX,h.y=i.view.offsetY,h.width=i.view.width,h.height=i.view.height);const c=e.getRenderTarget();for(let r=0;r<o.length;r++){const s=o[r];i.setViewOffset(h.fullWidth,h.fullHeight,h.x+s[0]/16,h.y+s[1]/16,h.width,h.height);const c=(r+.5)/o.length-.5,d=1/o.length+c/32;this.m_quadUniforms.opacity.value=d,e.setRenderTarget(this.m_renderTarget),e.clear(),e.render(t,i),e.setRenderTarget(this.renderToScreen?null:n),0===r&&(e.setClearColor(0),e.clear()),e.render(this.m_quadScene,this.m_localCamera),0===r&&void 0!==a&&e.setClearColor(l)}e.setRenderTarget(c),null!==i.view&&(i.view.enabled=h.enabled,i.view.offsetX=h.x,i.view.offsetY=h.y)}setSize(e,t){this.m_renderTarget&&this.m_renderTarget.setSize(e,t)}}ar.OffsetVectors=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]];const lr="\n    uniform float outlineThickness;\n\n    vec4 calculateOutline( vec4 pos, vec3 objectNormal, vec4 skinned ) {\n\n        float thickness = outlineThickness;\n        const float ratio = 1.0;\n        vec4 pos2 = projectionMatrix * modelViewMatrix * vec4( skinned.xyz + objectNormal, 1.0 );\n        vec4 norm = normalize( pos - pos2 );\n        return pos + norm * thickness * pos.w * ratio;\n\n    }",hr="\n    #if ! defined( LAMBERT ) && ! defined( PHONG ) && ! defined( TOON ) && ! defined( STANDARD )\n        #ifndef USE_ENVMAP\n            vec3 objectNormal = normalize( normal );\n        #endif\n    #endif\n\n    #ifdef FLIP_SIDED\n        objectNormal = -objectNormal;\n    #endif\n\n    #ifdef DECLARE_TRANSFORMED\n        vec3 transformed = vec3( position );\n    #endif\n\n    gl_Position = calculateOutline( gl_Position, objectNormal, vec4( transformed, 1.0 ) );\n\n    #include <fog_vertex>",cr="\n    #include <common>\n    #include <fog_pars_fragment>\n\n    uniform vec3 outlineColor;\n    uniform float outlineAlpha;\n\n    void main() {\n\n        gl_FragColor = vec4( outlineColor, outlineAlpha );\n\n        #include <fog_fragment>\n\n    }";class dr{constructor(e){this.m_renderer=e,this.enabled=!0,this.m_defaultThickness=.02,this.m_defaultColor=new r.l(0,0,0),this.m_defaultAlpha=1,this.m_defaultKeepAlive=!1,this.m_ghostExtrudedPolygons=!1,this.m_cache={},this.m_removeThresholdCount=60,this.m_originalMaterials={},this.m_originalOnBeforeRenders={},this.m_shaderIDs={MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical"},this.m_uniformsChunk={outlineThickness:{value:this.m_defaultThickness},outlineColor:{value:this.m_defaultColor},outlineAlpha:{value:this.m_defaultAlpha}},this.autoClear=e.autoClear,this.domElement=e.domElement,this.shadowMap=e.shadowMap}set thickness(e){this.m_defaultThickness=e,this.m_uniformsChunk.outlineThickness.value=e,this.m_cache={}}set color(e){this.m_defaultColor.set(e),this.m_cache={}}set ghostExtrudedPolygons(e){this.m_ghostExtrudedPolygons=e}clear(e,t,i){this.m_renderer.clear(e,t,i)}getPixelRatio(){return this.m_renderer.getPixelRatio()}setPixelRatio(e){this.m_renderer.setPixelRatio(e)}getSize(e){return this.m_renderer.getSize(e)}setSize(e,t,i){this.m_renderer.setSize(e,t,i)}setViewport(e,t,i,n){this.m_renderer.setViewport(e,t,i,n)}setScissor(e,t,i,n){this.m_renderer.setScissor(e,t,i,n)}setScissorTest(e){this.m_renderer.setScissorTest(e)}setRenderTarget(e){this.m_renderer.setRenderTarget(e)}render(e,t){if(this.m_ghostExtrudedPolygons){if(!this.enabled)return void this.m_renderer.render(e,t);const i=this.m_renderer.autoClear;this.m_renderer.autoClear=this.autoClear,this.m_renderer.render(e,t),this.m_renderer.autoClear=i}this.renderOutline(e,t)}renderOutline(e,t){const i=this.m_renderer.autoClear,n=e.autoUpdate,r=e.background,s=this.m_renderer.shadowMap.enabled;e.autoUpdate=!1,e.background=null,this.m_renderer.autoClear=!1,this.m_renderer.shadowMap.enabled=!1,e.traverse(this.setOutlineMaterial.bind(this)),this.m_renderer.render(e,t),e.traverse(this.restoreOriginalMaterial.bind(this)),this.cleanupCache(),e.autoUpdate=n,e.background=r,this.m_renderer.autoClear=i,this.m_renderer.shadowMap.enabled=s}createInvisibleMaterial(){return new r.Lb({name:"invisible",visible:!1})}createMaterial(e){const t=this.m_shaderIDs[e.type];let i,n;if(void 0!==t){const e=r.Kb[t];i=e.uniforms,n=e.vertexShader}else if(!0===e.isRawShaderMaterial){if(i=e.uniforms,n=e.vertexShader,!/attribute\s+vec3\s+position\s*;/.test(n)||!/attribute\s+vec3\s+normal\s*;/.test(n))return this.createInvisibleMaterial()}else{if(!0!==e.isShaderMaterial)return this.createInvisibleMaterial();i=e.uniforms,n=e.vertexShader}const s={...i,...this.m_uniformsChunk},o=n.replace(/void\s+main\s*\(\s*\)/,lr+"\nvoid main()").replace(/\}\s*$/,hr+"\n}").replace(/#include\s+<[\w_]*light[\w_]*>/g,""),a={};return/vec3\s+transformed\s*=/.test(n)||/#include\s+<begin_vertex>/.test(n)||(a.DECLARE_TRANSFORMED=!0),new r.Lb({defines:a,uniforms:s,vertexShader:o,fragmentShader:cr,side:r.e,skinning:!1,morphTargets:!1,morphNormals:!1,fog:!1})}getOutlineMaterialFromCache(e){let t=this.m_cache[e.uuid];return void 0===t&&(t={material:this.createMaterial(e),used:!0,keepAlive:this.m_defaultKeepAlive,count:0},this.m_cache[e.uuid]=t),t.used=!0,t.material}getOutlineMaterial(e){const t=this.getOutlineMaterialFromCache(e);return this.m_originalMaterials[t.uuid]=e,this.updateOutlineMaterial(t,e),t}setOutlineMaterial(e){if(void 0!==e.material){if(Array.isArray(e.material))for(let t=0,i=e.material.length;t<i;t++)e.material[t]=this.getOutlineMaterial(e.material[t]);else e.material=this.getOutlineMaterial(e.material);this.m_originalOnBeforeRenders[e.uuid]=e.onBeforeRender,e.onBeforeRender=Object(p.n)(e.onBeforeRender,this.onBeforeRender.bind(this))}}restoreOriginalMaterial(e){if(void 0!==e.material){if(Array.isArray(e.material))for(let t=0,i=e.material.length;t<i;t++)e.material[t]=this.m_originalMaterials[e.material[t].uuid];else e.material=this.m_originalMaterials[e.material.uuid];e.onBeforeRender=this.m_originalOnBeforeRenders[e.uuid]}}onBeforeRender(e,t,i,n,r,s){const o=this.m_originalMaterials[r.uuid];void 0!==o&&this.updateUniforms(r,o)}updateUniforms(e,t){const i=t.userData.outlineParameters;e.uniforms.outlineAlpha.value=t.opacity,void 0!==i&&(void 0!==i.thickness&&(e.uniforms.outlineThickness.value=i.thickness),void 0!==i.color&&e.uniforms.outlineColor.value.fromArray(i.color),void 0!==i.alpha&&(e.uniforms.outlineAlpha.value=i.alpha))}updateOutlineMaterial(e,t){if("invisible"===e.name)return;const i=t.userData.outlineParameters;e.skinning=t.skinning,e.morphTargets=t.morphTargets,e.morphNormals=t.morphNormals,e.fog=t.fog,void 0!==i?(e.visible=!1!==t.visible&&(void 0===i.visible||i.visible),e.transparent=void 0!==i.alpha&&i.alpha<1||t.transparent,void 0!==i.keepAlive&&(this.m_cache[t.uuid].keepAlive=i.keepAlive)):(e.transparent=t.transparent,e.visible=t.visible),!0!==t.wireframe&&!1!==t.depthTest||(e.visible=!1)}cleanupCache(){let e;e=Object.keys(this.m_originalMaterials);for(let t=0,i=e.length;t<i;t++)this.m_originalMaterials[e[t]]=void 0;e=Object.keys(this.m_originalOnBeforeRenders);for(let t=0,i=e.length;t<i;t++)this.m_originalOnBeforeRenders[e[t]]=void 0;e=Object.keys(this.m_cache);for(const t of e)!1===this.m_cache[t].used?(this.m_cache[t].count++,!1===this.m_cache[t].keepAlive&&this.m_cache[t].count>this.m_removeThresholdCount&&delete this.m_cache[t]):(this.m_cache[t].used=!1,this.m_cache[t].count=0)}}const mr=new r.Yb(1,0),ur=new r.Yb(0,1);class pr extends tr{constructor(e,t,i,n){super(),this.resolution=new r.Yb(256,256),this.m_renderTargetsHorizontal=[],this.m_renderTargetsVertical=[],this.m_nMips=5,this.m_separableBlurMaterials=[],this.m_camera=new r.rb(-1,1,1,-1,0,1),this.m_scene=new r.Ib,this.m_basic=new r.fb,this.m_quad=new r.eb(new r.vb(2,2)),this.m_bloomTintColors=[new r.Zb(1,1,1),new r.Zb(1,1,1),new r.Zb(1,1,1),new r.Zb(1,1,1),new r.Zb(1,1,1)],this.strength=t,this.radius=i,this.threshold=n,this.resolution=e,this.m_quad.frustumCulled=!1,this.m_scene.add(this.m_quad);const s={minFilter:r.U,magFilter:r.U,format:r.Ab};let o=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.m_renderTargetBright=new r.cc(o,a,s),this.m_renderTargetBright.texture.name="UnrealBloomPass.bright",this.m_renderTargetBright.texture.generateMipmaps=!1;for(let e=0;e<this.m_nMips;e++){const t=new r.cc(o,a,s);t.texture.name="UnrealBloomPass.h"+e,t.texture.generateMipmaps=!1,this.m_renderTargetsHorizontal.push(t);const i=new r.cc(o,a,s);i.texture.name="UnrealBloomPass.v"+e,i.texture.generateMipmaps=!1,this.m_renderTargetsVertical.push(i),o=Math.round(o/2),a=Math.round(a/2)}this.m_highPassUniforms=r.Ub.clone(U.uniforms),this.m_highPassUniforms.luminosityThreshold.value=n,this.m_highPassUniforms.smoothWidth.value=.01,this.m_materialHighPassFilter=new r.Lb({uniforms:this.m_highPassUniforms,vertexShader:U.vertexShader,fragmentShader:U.fragmentShader,defines:{}});const l=[3,5,7,9,11];o=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);for(let e=0;e<this.m_nMips;e++)this.m_separableBlurMaterials.push(this.getSeperableBlurMaterial(l[e])),this.m_separableBlurMaterials[e].uniforms.texSize.value=new r.Yb(o,a),o=Math.round(o/2),a=Math.round(a/2);this.m_compositeMaterial=this.getCompositeMaterial(this.m_nMips),this.m_compositeMaterial.uniforms.blurTexture1.value=this.m_renderTargetsVertical[0].texture,this.m_compositeMaterial.uniforms.blurTexture2.value=this.m_renderTargetsVertical[1].texture,this.m_compositeMaterial.uniforms.blurTexture3.value=this.m_renderTargetsVertical[2].texture,this.m_compositeMaterial.uniforms.blurTexture4.value=this.m_renderTargetsVertical[3].texture,this.m_compositeMaterial.uniforms.blurTexture5.value=this.m_renderTargetsVertical[4].texture,this.m_compositeMaterial.uniforms.bloomStrength.value=t,this.m_compositeMaterial.uniforms.bloomRadius.value=.1,this.m_compositeMaterial.needsUpdate=!0;this.m_compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.m_compositeMaterial.uniforms.bloomTintColors.value=this.m_bloomTintColors,this.m_copyUniforms=r.Ub.clone(m.uniforms),this.m_copyUniforms.opacity.value=1,this.m_materialCopy=new r.Lb({uniforms:this.m_copyUniforms,vertexShader:m.vertexShader,fragmentShader:m.fragmentShader,blending:r.a,depthTest:!1,depthWrite:!1,transparent:!0})}dispose(){for(const e of this.m_renderTargetsHorizontal)e.dispose();for(const e of this.m_renderTargetsVertical)e.dispose();this.m_renderTargetBright.dispose()}setSize(e,t){let i=Math.round(e/2),n=Math.round(t/2);this.m_renderTargetBright.setSize(i,n);for(let e=0;e<this.m_nMips;e++)this.m_renderTargetsHorizontal[e].setSize(i,n),this.m_renderTargetsVertical[e].setSize(i,n),this.m_separableBlurMaterials[e].uniforms.texSize.value=new r.Yb(i,n),i=Math.round(i/2),n=Math.round(n/2)}render(e,t,i,n,r){this.renderToScreen&&(this.m_quad.material=this.m_basic,this.m_basic.map=r.texture,e.setRenderTarget(null),e.clear(),e.render(this.m_scene,this.m_camera)),this.m_highPassUniforms.tDiffuse.value=r.texture,this.m_highPassUniforms.luminosityThreshold.value=this.threshold,this.m_quad.material=this.m_materialHighPassFilter,e.setRenderTarget(this.m_renderTargetBright),e.clear(),e.render(this.m_scene,this.m_camera);let s=this.m_renderTargetBright;for(let t=0;t<this.m_nMips;t++)this.m_quad.material=this.m_separableBlurMaterials[t],this.m_separableBlurMaterials[t].uniforms.colorTexture.value=s.texture,this.m_separableBlurMaterials[t].uniforms.direction.value=mr,e.setRenderTarget(this.m_renderTargetsHorizontal[t]),e.clear(),e.render(this.m_scene,this.m_camera),this.m_separableBlurMaterials[t].uniforms.colorTexture.value=this.m_renderTargetsHorizontal[t].texture,this.m_separableBlurMaterials[t].uniforms.direction.value=ur,e.setRenderTarget(this.m_renderTargetsVertical[t]),e.clear(),e.render(this.m_scene,this.m_camera),s=this.m_renderTargetsVertical[t];this.m_quad.material=this.m_compositeMaterial,this.m_compositeMaterial.uniforms.bloomStrength.value=this.strength,this.m_compositeMaterial.uniforms.bloomRadius.value=this.radius,this.m_compositeMaterial.uniforms.bloomTintColors.value=this.m_bloomTintColors,e.setRenderTarget(this.m_renderTargetsHorizontal[0]),e.clear(),e.render(this.m_scene,this.m_camera),this.m_quad.material=this.m_materialCopy,this.m_copyUniforms.tDiffuse.value=this.m_renderTargetsHorizontal[0].texture,this.renderToScreen?(e.setRenderTarget(null),e.render(this.m_scene,this.m_camera)):(e.setRenderTarget(r),e.render(this.m_scene,this.m_camera))}getSeperableBlurMaterial(e){return new r.Lb({defines:{KERNEL_RADIUS:e,SIGMA:e},uniforms:{colorTexture:{value:null},texSize:{value:new r.Yb(.5,.5)},direction:{value:new r.Yb(.5,.5)}},vertexShader:"varying vec2 vUv;\n            void main() {\n                vUv = uv;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            }",fragmentShader:"#include <common>\n            varying vec2 vUv;\n            uniform sampler2D colorTexture;\n            uniform vec2 texSize;\n            uniform vec2 direction;\n\n            float gaussianPdf(in float x, in float sigma) {\n                return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\n            }\n            void main() {\n                vec2 invSize = 1.0 / texSize;\n                float fSigma = float(SIGMA);\n                float weightSum = gaussianPdf(0.0, fSigma);\n                vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\n                for( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n                    float x = float(i);\n                    float w = gaussianPdf(x, fSigma);\n                    vec2 uvOffset = direction * invSize * x;\n                    vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\n                    vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\n                    diffuseSum += (sample1 + sample2) * w;\n                    weightSum += 2.0 * w;\n                }\n                gl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n            }"})}getCompositeMaterial(e){return new r.Lb({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},dirtTexture:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n                void main() {\n                    vUv = uv;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                }",fragmentShader:"varying vec2 vUv;\n                uniform sampler2D blurTexture1;\n                uniform sampler2D blurTexture2;\n                uniform sampler2D blurTexture3;\n                uniform sampler2D blurTexture4;\n                uniform sampler2D blurTexture5;\n                uniform sampler2D dirtTexture;\n                uniform float bloomStrength;\n                uniform float bloomRadius;\n                uniform float bloomFactors[NUM_MIPS];\n                uniform vec3 bloomTintColors[NUM_MIPS];\n\n                float lerpBloomFactor(const in float factor) {\n                    float mirrorFactor = 1.2 - factor;\n                    return mix(factor, mirrorFactor, bloomRadius);\n                }\n\n                void main() {\n                    gl_FragColor = bloomStrength * (\nlerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +\nlerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +\nlerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +\nlerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +\nlerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\n                }"})}}const fr=or.Level_1,gr=or.Level_4;class vr{constructor(e,t,i,n={msaaEnabled:!1}){this.bloom={enabled:!1,strength:1.5,radius:.4,threshold:.85},this.outline={enabled:!1,thickness:.005,color:"#000000",ghostExtrudedPolygons:!1,needsUpdate:!1},this.vignette={enabled:!1,offset:1,darkness:1},this.sepia={enabled:!1,amount:.5},this.m_width=1,this.m_height=1,this.m_renderPass=new ir,this.m_target1=new r.cc(1,1),this.m_target2=new r.cc(1,1),this.m_sepiaPass=new nr(q),this.m_vignettePass=new nr(H),this.m_readBuffer=new r.cc(e,t),this.m_msaaPass=new ar,this.m_msaaPass.enabled=void 0!==n&&!0===n.msaaEnabled,this.m_dynamicMsaaSamplingLevel=void 0===n.dynamicMsaaSamplingLevel?fr:n.dynamicMsaaSamplingLevel,this.m_staticMsaaSamplingLevel=void 0===n.staticMsaaSamplingLevel?gr:n.staticMsaaSamplingLevel,this.m_lowResPass=new sr(i),this.m_lowResPass.enabled=void 0!==i}updateOutline(e){this.outline.color=e.color,this.outline.thickness=e.thickness,this.outline.ghostExtrudedPolygons=e.ghostExtrudedPolygons,this.outline.needsUpdate=!0}render(e,t,i,n){if(!n&&void 0!==this.m_lowResPass.pixelRatio)return this.m_lowResPass.renderToScreen=!0,void this.m_lowResPass.render(e,t,i,null,this.m_readBuffer);const s=this.bloom.enabled||this.outline.enabled||this.vignette.enabled||this.sepia.enabled;let o=null;if((this.bloom.enabled||this.vignette.enabled||this.sepia.enabled)&&(e.setRenderTarget(this.m_target1),e.clearDepth()),this.m_msaaPass.enabled?(this.m_msaaPass.samplingLevel=n?this.m_staticMsaaSamplingLevel:this.m_dynamicMsaaSamplingLevel,this.m_msaaPass.renderToScreen=!s,this.m_msaaPass.render(e,t,i,null,this.m_readBuffer)):this.bloom.enabled||this.vignette.enabled||this.sepia.enabled?(o=this.m_target1,this.m_renderPass.render(e,t,i,this.m_target1,null)):(!this.outline.enabled||this.outline.enabled&&!this.bloom.enabled)&&e.render(t,i),this.outline.enabled){void 0===this.m_outlineEffect&&(this.m_outlineEffect=new dr(e)),this.outline.needsUpdate&&(this.m_outlineEffect.color=this.outline.color,this.m_outlineEffect.thickness=this.outline.thickness,this.m_outlineEffect.ghostExtrudedPolygons=this.outline.ghostExtrudedPolygons,this.outline.needsUpdate=!1);const n=this.bloom.enabled||this.vignette.enabled||this.sepia.enabled;n&&(o=this.m_target1),e.setRenderTarget(n?o:null),this.m_outlineEffect.render(t,i)}if(this.bloom.enabled){void 0===this.m_bloomPass&&(this.m_bloomPass=new pr(new r.Yb(this.m_width,this.m_height),this.bloom.strength,this.bloom.radius,this.bloom.threshold));const n=this.vignette.enabled||this.sepia.enabled;this.m_bloomPass.renderToScreen=!n,this.m_bloomPass.radius=this.bloom.radius,this.m_bloomPass.strength=this.bloom.strength,this.m_bloomPass.threshold=this.bloom.threshold,this.m_bloomPass.render(e,t,i,null,o)}else void 0!==this.m_bloomPass&&(this.m_bloomPass.dispose(),this.m_bloomPass=void 0);if(this.vignette.enabled){const n=o,r=this.sepia.enabled;this.m_vignettePass.uniforms.offset.value=this.vignette.offset,this.m_vignettePass.uniforms.darkness.value=this.vignette.darkness,this.m_vignettePass.renderToScreen=!r,r&&(o=o===this.m_target1?this.m_target2:this.m_target1),this.m_vignettePass.render(e,t,i,o,n)}this.sepia.enabled&&(this.m_sepiaPass.renderToScreen=!0,this.m_sepiaPass.uniforms.amount.value=this.sepia.amount,this.m_sepiaPass.render(e,t,i,null,o))}setSize(e,t){this.m_readBuffer.setSize(e,t),this.m_msaaPass.setSize(e,t),void 0!==this.m_bloomPass&&this.m_bloomPass.setSize(e,t),this.m_lowResPass.setSize(e,t),this.m_target1.setSize(e,t),this.m_target2.setSize(e,t),this.m_width=e,this.m_height=t}get lowResPixelRatio(){return this.m_lowResPass.pixelRatio}set lowResPixelRatio(e){this.m_lowResPass.pixelRatio=e,this.m_lowResPass.enabled=void 0!==e}set dynamicMsaaSamplingLevel(e){this.m_dynamicMsaaSamplingLevel=e}get dynamicMsaaSamplingLevel(){return this.m_dynamicMsaaSamplingLevel}set msaaEnabled(e){this.m_msaaPass.enabled=e}get msaaEnabled(){return this.m_msaaPass.enabled}set staticMsaaSamplingLevel(e){this.m_staticMsaaSamplingLevel=e}get staticMsaaSamplingLevel(){return this.m_staticMsaaSamplingLevel}}i(54);const _r=p.d.instance.create("WorkerLoader");class yr{static startWorker(e,t=1e4){return e.startsWith("blob:")?this.startWorkerImmediately(e,t):this.directlyFallbackToBlobBasedLoading?this.startWorkerBlob(e,t):this.startWorkerImmediately(e,t).catch(i=>{if("undefined"!=typeof window){const n=window.location.href,r=new URL(e,n).href;if(Object(p.s)(r)===Object(p.s)(n))throw i;return _r.log("#startWorker: cross-origin worker construction failed, trying load with blob"),this.directlyFallbackToBlobBasedLoading=!0,yr.startWorkerBlob(e,t)}throw i})}static startWorkerImmediately(e,t){try{const i=new Worker(e);return this.waitWorkerInitialized(i,t)}catch(e){return Promise.reject(e)}}static startWorkerBlob(e,t){return this.fetchScriptSourceToBlobUrl(e).then(e=>this.startWorkerImmediately(e,t))}static fetchScriptSourceToBlobUrl(e){let t=this.sourceLoaderCache.get(e);return void 0!==t?t:(t=fetch(e).then(e=>e.text()).catch(e=>{throw new Error(`WorkerLoader#fetchScriptSourceToBlob: failed to load worker script: ${e}`)}).then(t=>{this.sourceLoaderCache.delete(e);const i=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(i)}),this.sourceLoaderCache.set(e,t),t)}static waitWorkerInitialized(e,t){return new Promise((i,n)=>{const r=t=>{const r=t.data;if(function(e){return e&&"worker-bootstrap-request"===e.type&&Array.isArray(e.dependencies)}(r)){const t=r.dependencies,i=[];for(const e of t){const t=this.dependencyUrlMapping[e];if(!t)return o(),void n(new Error(`#waitWorkerInitialized: Unable to resolve '${e}'`+" as needed by worker script."));i.push(t)}const s={type:"worker-bootstrap-response",resolvedDependencies:i};e.postMessage(s)}else o(),i(e),setTimeout(()=>{e.dispatchEvent(t)},0)},s=e=>{o();let t="Error during worker initialization";e.message&&(t+=`: ${e.message}`),"string"==typeof e.filename&&"number"==typeof e.lineno&&(t+=` in ${e.filename}:${e.lineno}`),n(new Error(t))},o=()=>{clearTimeout(a),e.removeEventListener("message",r),e.removeEventListener("error",s)};e.addEventListener("error",s),e.addEventListener("message",r);const a=setTimeout(()=>{o(),n(new Error("Timeout exceeded when waiting for first message from worker."))},t)})}}yr.directlyFallbackToBlobBasedLoading=!1,yr.sourceLoaderCache=new Map,yr.dependencyUrlMapping={};const xr=p.d.instance.create("ConcurrentWorkerSet");const br=2,wr=1e4;class Tr{constructor(e){this.m_options=e,this.m_workerChannelLogger=p.d.instance.create("WorkerChannel"),this.m_eventListeners=new Map,this.m_workers=new Array,this.m_availableWorkers=new Array,this.m_workerPromises=new Array,this.m_readyPromises=new Map,this.m_requests=new Map,this.m_workerRequestQueue=[],this.m_nextMessageId=0,this.m_stopped=!0,this.m_referenceCount=0,this.onWorkerMessage=(e,t)=>{if(K.o.isResponseMessage(t.data)){const i=t.data;if(null===i.messageId)return void xr.error(`[${this.m_options.scriptUrl}]: Bad ResponseMessage: no messageId`);const n=this.m_requests.get(i.messageId);if(void 0===n)return void xr.error(`[${this.m_options.scriptUrl}]: Bad ResponseMessage: invalid messageId`);if(e>=0&&e<this.m_workers.length){const t=this.m_workers[e];this.m_availableWorkers.push(t),this.checkWorkerRequestQueue()}else xr.error(`[${this.m_options.scriptUrl}]: onWorkerMessage: invalid workerId`);if(void 0!==i.errorMessage){const e=new Error(i.errorMessage);void 0!==i.errorStack&&(e.stack=i.errorStack),n.resolver(e)}else n.resolver(void 0,i.response)}else if(K.o.isInitializedMessage(t.data)){const e=this.getReadyPromise(t.data.service);++e.count===this.m_workerPromises.length&&e.resolve()}else if(function(e){return e&&"number"==typeof e.level&&e.type===p.j}(t.data))switch(t.data.level){case p.c.Trace:this.m_workerChannelLogger.trace(...t.data.message);break;case p.c.Debug:this.m_workerChannelLogger.debug(...t.data.message);break;case p.c.Log:this.m_workerChannelLogger.log(...t.data.message);break;case p.c.Info:this.m_workerChannelLogger.info(...t.data.message);break;case p.c.Warn:this.m_workerChannelLogger.warn(...t.data.message);break;case p.c.Error:this.m_workerChannelLogger.error(...t.data.message)}else this.eventHandler(t)},this.start()}addReference(){this.m_referenceCount+=1,1===this.m_referenceCount&&this.m_stopped&&this.start()}removeReference(){this.m_referenceCount-=1,0===this.m_referenceCount&&this.destroy()}start(e){if(void 0!==e&&(this.m_options=e),!this.m_stopped)throw new Error("ConcurrentWorker set already started");this.m_workerCount=Object(p.r)(this.m_options.workerCount,"undefined"!=typeof navigator&&void 0!==navigator.hardwareConcurrency?r.bb.clamp(navigator.hardwareConcurrency-1,1,2):void 0,br);const t=Object(p.r)(this.m_options.workerConnectionTimeout,wr);for(let e=0;e<this.m_workerCount;++e){const i=yr.startWorker(this.m_options.scriptUrl,t).then(t=>{const i=t=>{this.onWorkerMessage(e,t)};return t.addEventListener("message",i),this.m_workers.push(t),this.m_availableWorkers.push(t),{worker:t,listener:i}});this.m_workerPromises.push(i)}this.m_stopped=!1}get workerCount(){return this.m_workerCount}async stop(){this.m_stopped=!0,await this.waitForAllResponses().then(()=>{this.terminateWorkers()})}destroy(){this.m_stopped=!0,this.m_requests.forEach(e=>{e.resolver(new Error("worker destroyed"))}),this.m_requests.clear(),this.m_workerRequestQueue=[],this.terminateWorkers(),this.m_eventListeners.clear()}async connect(e){return this.ensureStarted(),await Promise.all(this.m_workerPromises),this.getReadyPromise(e).promise}addEventListener(e,t){this.m_eventListeners.set(e,t)}removeEventListener(e){this.m_eventListeners.delete(e)}invokeRequest(e,t,i,n){this.ensureStarted();const r=this.m_nextMessageId++;let s;const o=new Promise((e,t)=>{s=(i,n)=>{this.m_requests.delete(r),void 0!==i?t(i):e(n)}});this.m_requests.set(r,{promise:o,resolver:s});const a={service:e,type:K.o.ServiceMessageName.Request,messageId:r,request:t};return this.postRequestMessage(a,i,n),o}broadcastRequest(e,t,i){this.ensureStarted();const n=[];for(const r of this.m_workers){const s=this.m_nextMessageId++;let o;const a=new Promise((e,t)=>{o=(i,n)=>{this.m_requests.delete(s),void 0!==i?t(i):e(n)}});n.push(a),this.m_requests.set(s,{promise:a,resolver:o});const l={service:e,type:K.o.ServiceMessageName.Request,messageId:s,request:t};void 0!==i?r.postMessage(l,i):r.postMessage(l)}return Promise.all(n)}broadcastMessage(e,t){this.ensureStarted(),void 0!==t?this.m_workers.forEach(i=>i.postMessage(e,t)):this.m_workers.forEach(t=>t.postMessage(e))}get requestQueueSize(){return this.m_workerRequestQueue.length}get numWorkers(){return this.m_workers.length}get numIdleWorkers(){return this.m_availableWorkers.length}eventHandler(e){"string"==typeof e.data.type&&this.dispatchEvent(e.data.type,e)}postRequestMessage(e,t,i){if(this.ensureStarted(),0===this.m_workers.length)throw new Error("ConcurrentWorkerSet#postMessage: no workers started");if(void 0!==i&&i.signal.aborted){const t=this.m_requests.get(e.messageId);if(void 0===t)return void xr.error(`[${this.m_options.scriptUrl}]: Bad RequestMessage: invalid messageId`);const i=new Error("Aborted");return i.name="AbortError",void t.resolver(i,void 0)}if(this.m_availableWorkers.length>0){const i=this.m_availableWorkers.pop();void 0!==t?i.postMessage(e,t):i.postMessage(e)}else void 0===i&&(i=new K.j(0)),0===i.priority&&(i.priority=-this.m_nextMessageId),this.m_workerRequestQueue.unshift({message:e,buffers:t,requestController:i})}ensureStarted(){if(this.m_stopped)throw new Error("ConcurrentWorkerSet stopped")}async waitForAllResponses(){const e=new Array;this.m_requests.forEach(t=>{e.push(t.promise)}),await Promise.all(e)}dispatchEvent(e,t){const i=this.m_eventListeners.get(e);void 0!==i&&i(t)}terminateWorkers(){this.m_workerPromises.forEach(e=>{e.then(e=>{void 0!==e&&(e.worker.removeEventListener("message",e.listener),e.worker.terminate())})}),this.m_workers=[],this.m_workerPromises=[],this.m_availableWorkers=[],this.m_readyPromises.clear()}getReadyPromise(e){const t=this.m_readyPromises.get(e);if(void 0!==t)return t;const i={count:0,promise:void 0,resolve:()=>{},reject:e=>{i.error=e},error:void 0};return i.promise=new Promise((e,t)=>{const n=i;void 0!==n.error?t(n.error):n.count===this.m_workerPromises.length&&e(),n.resolve=e,n.reject=t}),this.m_readyPromises.set(e,i),i}checkWorkerRequestQueue(){if(0!==this.m_workerRequestQueue.length&&0!==this.m_availableWorkers.length)for(this.m_workerRequestQueue.sort((e,t)=>e.requestController.priority-t.requestController.priority);this.m_availableWorkers.length>0&&this.m_workerRequestQueue.length>0;){const e=this.m_workerRequestQueue.pop();this.postRequestMessage(e.message,e.buffers,e.requestController)}}}let Sr=0;class Cr{constructor(e,t){this.workerSet=e,this.decoderServiceType=t,this.m_serviceCreated=!1,this.workerSet.addReference(),this.serviceId=`${this.decoderServiceType}-${Sr++}`}dispose(){this.m_serviceCreated&&this.workerSet.broadcastRequest(K.o.WORKER_SERVICE_MANAGER_SERVICE_ID,{type:K.o.Requests.DestroyService,targetServiceId:this.serviceId}).catch(()=>{}),this.workerSet.removeReference()}async connect(){await this.workerSet.connect(K.o.WORKER_SERVICE_MANAGER_SERVICE_ID),this.m_serviceCreated||(await this.workerSet.broadcastRequest(K.o.WORKER_SERVICE_MANAGER_SERVICE_ID,{type:K.o.Requests.CreateService,targetServiceType:this.decoderServiceType,targetServiceId:this.serviceId}),this.m_serviceCreated=!0)}decodeTile(e,t,i,n){const r=t.mortonCode(),s={type:K.n.Requests.DecodeTileRequest,tileKey:r,data:e,projection:Object(K.v)(i)},o=e instanceof ArrayBuffer?[e]:void 0;return this.workerSet.invokeRequest(this.serviceId,s,o,n)}getTileInfo(e,t,i,n){const r=t.mortonCode(),s={type:K.n.Requests.TileInfoRequest,tileKey:r,data:e,projection:Object(K.v)(i)},o=e instanceof ArrayBuffer?[e]:void 0;return this.workerSet.invokeRequest(this.serviceId,s,o,n)}configure(e,t,i,n){const r={service:this.serviceId,type:K.n.DecoderMessageName.Configuration,styleSet:e,definitions:t,options:n,languages:i};this.workerSet.broadcastMessage(r)}get workerCount(){return this.workerSet.workerCount}}class Er{static getTileDecoder(e,t,i){const n=this.getWorkerSet(t,i);return new Cr(n,e)}static getWorkerSet(e,t){void 0===e&&(e=this.defaultScriptUrl);let i=this.workerSets[e];return void 0===i&&(i=new Tr({scriptUrl:e,workerCount:void 0===t?this.defaultWorkerCount:t}),this.workerSets[e]=i),i}static destroyWorkerSet(e){const t=this.workerSets[e];void 0!==t&&(t.destroy(),delete this.workerSets[e])}static destroy(){Object.keys(this.workerSets).forEach(e=>{this.workerSets[e].destroy()}),this.workerSets={}}}var Mr,Ar,Pr;Er.defaultScriptUrl="./decoder.bundle.js",Er.defaultWorkerCount=void 0,Er.workerSets={},(Ar=Mr||(Mr={})).mergeArrays=function(e,t){const i=[];for(const n of[e,t])if(void 0!==n)for(const e of n){const t=i.find(t=>t.id===e.id||void 0!==t.label&&t.label===e.label);void 0===t?i.push({...e}):(t.year=p.f.max2(e.year,t.year),t.label=Object(p.r)(e.label,t.label),t.link=Object(p.r)(e.link,t.link))}return i},Ar.formatAsHtml=function(e){if(0===e.length)return"";const t=e.filter(e=>""!==e.label);return 0===t.length?"":" "+t.map(e=>{const t=void 0!==e.label?e.label:e.id,i=void 0!==e.year?`${e.year} ${t}`:t;return e.link?`<a href="${e.link}">${i}</a>`:`${i}`}).join(", ")},function(e){e[e.PendingApproximate=0]="PendingApproximate",e[e.FinalPrecise=1]="FinalPrecise"}(Pr||(Pr={}));class Lr{constructor(e){this.m_camera=e,this.m_globalFrustumMin=new r.Zb,this.m_globalFrustumMax=new r.Zb,this.m_frustumCorners=[new r.Zb,new r.Zb,new r.Zb,new r.Zb,new r.Zb,new r.Zb,new r.Zb,new r.Zb]}setup(){const e=this.getFrustumCorners(),t=this.m_camera.matrixWorld;this.m_globalFrustumMin.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.m_globalFrustumMax.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(const i of e)i.applyMatrix4(t),this.m_globalFrustumMin.x=Math.min(this.m_globalFrustumMin.x,i.x),this.m_globalFrustumMin.y=Math.min(this.m_globalFrustumMin.y,i.y),this.m_globalFrustumMin.z=Math.min(this.m_globalFrustumMin.z,i.z),this.m_globalFrustumMax.x=Math.max(this.m_globalFrustumMax.x,i.x),this.m_globalFrustumMax.y=Math.max(this.m_globalFrustumMax.y,i.y),this.m_globalFrustumMax.z=Math.max(this.m_globalFrustumMax.z,i.z)}frustumIntersectsTileBox(e){const t=this.m_globalFrustumMin,i=this.m_globalFrustumMax;return!(i.x<e.min.x||i.y<e.min.y||i.z<e.min.z||t.x>e.max.x||t.y>e.max.y||t.z>e.max.z)}getFrustumCorners(){const e=this.m_frustumCorners,t=this.m_camera.projectionMatrixInverse;let i=0;function n(n,r,s){e[i++].set(n,r,s).applyMatrix4(t)}return n(-1,-1,-1),n(1,-1,-1),n(-1,1,-1),n(1,1,-1),n(-1,-1,1),n(1,-1,1),n(-1,1,1),n(1,1,1),e}}const Rr=[new r.Zb,new r.Zb],Or=new r.ac;class Fr{constructor(e,t,i=0,n=0,r=0,s=0){this.tileKey=e,this.area=t,this.offset=i,this.minElevation=n,this.maxElevation=r,this.distance=s}}function Dr(e,t,i){const n=e.getGeoBox(t),r=360*i;return n.northEast.longitude+=r,n.southWest.longitude+=r,n}class Ir{constructor(e,t,i,n,s){this.m_camera=e,this.mapView=t,this.m_extendedFrustumCulling=i,this.m_tileWrappingEnabled=n,this.m_enableMixedLod=s,this.m_frustum=new r.E,this.m_viewProjectionMatrix=new r.db,this.m_rootTileKeys=[],this.m_tileKeyEntries=new Map,this.m_mapTileCuller=new Lr(e)}get camera(){return this.m_camera}get projection(){return this.mapView.projection}updateFrustum(e){this.m_viewProjectionMatrix.multiplyMatrices(void 0!==e?e:this.m_camera.projectionMatrix,this.m_camera.matrixWorldInverse),this.m_frustum.setFromMatrix(this.m_viewProjectionMatrix),this.m_extendedFrustumCulling&&this.m_mapTileCuller.setup(),this.computeRequiredInitialRootTileKeys(this.m_camera.position)}compute(e,t,i,s){this.m_tileKeyEntries.clear();let o=!0;Object(p.l)(0!==this.mapView.viewportHeight);const a=Math.pow(256/this.mapView.viewportHeight,2),l=this.mapView.projection.type===n.f.Spherical?new n.e:new r.g,h=new Set(i);for(const e of h)this.m_tileKeyEntries.set(e,new Map);for(const e of this.m_rootTileKeys){const t=new Fr(e.tileKey,1/0,e.offset,e.minElevation,e.maxElevation);for(const i of h){this.m_tileKeyEntries.get(i).set(Un.getKeyForTileKeyAndOffset(e.tileKey,e.offset),t)}}const c=void 0!==t&&t.getTilingScheme()===e,d=[...this.m_rootTileKeys.values()];for(;d.length>0;){const n=d.pop();if(void 0===n)break;const r=n.tileKey;if(!s.some((e,t)=>e.shouldSubdivide(i[t],r)))continue;if(this.m_enableMixedLod&&n.area<a)continue;const m=Un.getKeyForTileKeyAndOffset(r,n.offset);for(const e of h){if(r.level>=e)continue;this.m_tileKeyEntries.get(e).delete(m)}for(const i of e.getSubTileKeys(r)){const r=n.offset,s=Un.getKeyForTileKeyAndOffset(i,r),a=Dr(e,i,r);if(c){const e=t.getElevationRange(i);a.southWest.altitude=e.minElevation,a.northEast.altitude=e.maxElevation,o=o&&e.calculationStatus===Pr.FinalPrecise}this.mapView.projection.projectBox(a,l);const{area:m,distance:u}=this.computeTileAreaAndDistance(l);if(m>0){const e=new Fr(i,m,r,a.southWest.altitude,a.northEast.altitude,u);for(const t of h){if(e.tileKey.level>t)continue;this.m_tileKeyEntries.get(t).set(s,e)}d.push(e)}}}return{tileKeyEntries:this.m_tileKeyEntries,calculationFinal:o}}computeTileAreaAndDistance(e){if(e instanceof r.g){if(this.m_extendedFrustumCulling&&!this.m_mapTileCuller.frustumIntersectsTileBox(e)||!this.m_frustum.intersectsBox(e))return{area:0,distance:1/0}}else if(!e.intersects(this.m_frustum))return{area:0,distance:1/0};const t=e.getCenter(Rr[0]),i=Or.set(t.x,t.y,t.z,1).applyMatrix4(this.m_viewProjectionMatrix),n=.5*e.getSize(Rr[1]).length()/i.w;return{area:n*n,distance:i.z/i.w}}computeRequiredInitialRootTileKeys(e){this.m_rootTileKeys=[];const t=n.g.fromRowColumnLevel(0,0,0);if(!(this.mapView.projection.type===n.f.Planar)||!this.m_tileWrappingEnabled)return void this.m_rootTileKeys.push(new Fr(t,1/0,0,0));const i=this.mapView.projection.unprojectPoint(e),s=Math.round(i.longitude/360),o=this.m_camera,a=Nn.extractAttitude(this.mapView,o).pitch,l=o.aspect>1?o.aspect:1/o.aspect,h=r.bb.degToRad(o.fov*l/2)+a,c=Math.tan(h)*o.position.z-Math.tan(a)*o.position.z,d=new r.Zb(e.x-c,e.y,e.z),m=this.mapView.projection.unprojectPoint(d),u=r.bb.clamp(Math.ceil(Math.abs((i.longitude-m.longitude)/360)*Math.SQRT2),0,7);for(let e=-u+s;e<=u+s;e++)this.m_rootTileKeys.push(new Fr(t,1/0,e,0,0))}}function zr(e,t){if(!("material"in e))return;const i=e.material;"displacementMap"in i&&(i.displacementMap=t)}function kr(e,t,i){const n=i.mapView.projection.unprojectPoint(e),r=t.getHeight(n);void 0!==r&&(n.altitude=r,i.mapView.projection.projectPoint(n,e))}function jr(e,t,i){if(void 0!==e.path)for(const n of e.path)kr(n,t,i);else kr(e.position,t,i)}const Nr=60;class Gr{constructor(e,t,i){this.m_tile=e,this.m_loadPhaseDefinitions=t,this.m_basicGeometryKinds=i,this.m_isFinished=!1,this.m_geometryKindsLoaded=new K.g,this.m_currentPhaseIndex=0}get tile(){return this.m_tile}get currentPhase(){return this.m_currentPhaseIndex}get numberOfPhases(){return this.m_loadPhaseDefinitions.length}get geometryKindsCreated(){return this.m_geometryKindsLoaded}get availableGeometryKinds(){return this.m_availableGeometryKinds}get basicGeometryLoaded(){for(const e of this.m_basicGeometryKinds)if(!this.m_geometryKindsLoaded.has(e))return!1;return!0}get allGeometryLoaded(){return this.currentPhase>=this.m_loadPhaseDefinitions.length}setDecodedTile(e){return this.m_decodedTile=e,this.m_currentPhaseIndex=0,this.m_geometryKindsLoaded.clear(),void 0!==this.m_decodedTile&&(this.m_availableGeometryKinds=bn.prepareDecodedTile(this.m_decodedTile)),this.m_decodedTile}updateCompletely(e,t){return this.update(e,t,!0)}updateToPhase(e,t,i){let n=!1;for(e=Math.min(e,this.numberOfPhases);this.currentPhase<e&&this.update(t,i);)n=!0;return n}update(e,t,i=!1){const n=this.tile,r=this.m_loadPhaseDefinitions;if(!n.dataSource.cacheable)return this.m_currentPhaseIndex=r.length,!1;let s=this.m_decodedTile;const o=this.currentPhase;if(void 0===s&&void 0!==n.decodedTile&&(s=this.setDecodedTile(n.decodedTile),Cn.instance.processTechniques(s,e,t),n.clear()),void 0===s||o>=this.numberOfPhases)return!1;const a=Cn.instance,l=xn.instance;let h=0;if(l.enabled&&(h=p.g.now()),i)a.createAllGeometries(n,s),this.m_currentPhaseIndex=r.length;else{const e=r[o];for(const t of e)this.createKind(a,t)}if(l.enabled&&l.currentFrame.addValue("geometry.geometryCreationTime",p.g.now()-h),void 0===this.nextPhase()){if(l.enabled){const e=l.currentFrame;e.addValue("geometryCount.numGeometries",s.geometries.length),e.addValue("geometryCount.numTechniques",s.techniques.length),e.addValue("geometryCount.numPoiGeometries",void 0!==s.poiGeometries?s.poiGeometries.length:0),e.addValue("geometryCount.numTextGeometries",void 0!==s.textGeometries?s.textGeometries.length:0),e.addValue("geometryCount.numTextPathGeometries",void 0!==s.textPathGeometries?s.textPathGeometries.length:0),e.addValue("geometryCount.numPathGeometries",void 0!==s.pathGeometries?s.pathGeometries.length:0),e.addMessage(`Decoded tile: ${n.dataSource.name} # lvl=${n.tileKey.level} `+`col=${n.tileKey.column} row=${n.tileKey.row}`)}this.finish()}return!0}get isFinished(){return this.m_isFinished}dispose(){this.m_decodedTile=void 0}reset(){this.m_decodedTile=void 0,this.m_isFinished=!1,this.m_availableGeometryKinds=void 0,this.m_geometryKindsLoaded.clear(),this.m_currentPhaseIndex=0}nextPhase(){return this.m_currentPhaseIndex<this.m_loadPhaseDefinitions.length&&this.m_currentPhaseIndex++,this.m_currentPhaseIndex<this.m_loadPhaseDefinitions.length?this.m_currentPhaseIndex:void 0}createKind(e,t){if(this.m_geometryKindsLoaded.has(t))return;this.m_geometryKindsLoaded.add(t);const i=this.tile,n=this.m_decodedTile;if(void 0!==n){const r=e=>{if(!1===e.enabled)return!1;const i=e.kind;if(t===K.f.All)return!0;if(i instanceof Set){return i.has(t)}return i===t};e.createObjects(i,n,r);const s=e=>!!(Object(K.G)(e)||Object(K.E)(e)||Object(K.N)(e))&&r(e);e.createTextElements(i,n,s),e.preparePois(i,n)}}finish(){this.m_decodedTile=void 0,this.m_tile.loadingFinished(),this.m_tile.removeDecodedTile(),this.m_isFinished=!0}}class Ur{constructor(e){this.mapView=e,this.enableFilterByKind=!0,this.enabledKinds=new K.g,this.disabledKinds=new K.g,this.hiddenKinds=new K.g,this.m_visibilityCounter=1}get enabledGeometryKinds(){return this.enabledKinds}set enabledGeometryKinds(e){this.enabledKinds=e}get disabledGeometryKinds(){return this.disabledKinds}set disabledGeometryKinds(e){this.disabledKinds=e}get hiddenGeometryKinds(){return this.hiddenKinds}set hiddenGeometryKinds(e){this.hiddenKinds=e,this.incrementVisibilityCounter()}get visibilityCounter(){return this.m_visibilityCounter}clear(){this.enabledKinds.clear(),this.disabledKinds.clear(),this.hiddenKinds.clear()}enableKind(e,t=!0){this.enableDisableKinds(this.enabledKinds,e,t)}disableKind(e,t=!0){this.enableDisableKinds(this.disabledKinds,e,t)}hideKind(e,t=!0){let i=!1;if(Array.isArray(e))for(const n of e)i=i||this.addRemove(this.hiddenKinds,n,t);else if(e instanceof Set){const n=e;for(const e of n)i=i||this.addRemove(this.hiddenKinds,e,t)}else void 0!==e&&(i=i||this.addRemove(this.hiddenKinds,e,t));i&&this.incrementVisibilityCounter()}getAvailableKinds(e){const t=new K.g;for(const i of e){const e=i.tileGeometryLoader;if(void 0!==e){const i=e.availableGeometryKinds;if(void 0!==i)for(const e of i)t.add(e)}}return t}updateTileObjectVisibility(e){let t=!1;for(const i of e)if(0!==i.objects.length&&i.visibilityCounter!==this.visibilityCounter){i.visibilityCounter=this.visibilityCounter;for(const e of i.objects){const i=void 0!==e.userData?e.userData.kind:void 0;if(void 0!==i){const n=!i.some(e=>this.hiddenKinds.has(e));t=t||e.visible!==n,e.visible=n}}}return t}setTileUpdateCallback(e){this.m_tileUpdateCallback=e}incrementVisibilityCounter(){return++this.m_visibilityCounter}enableDisableKinds(e,t,i){if(Array.isArray(t))for(const n of t)this.addRemove(e,n,i);else if(t instanceof Set){const n=t;for(const t of n)this.addRemove(e,t,i)}else void 0!==t&&this.addRemove(e,t,i)}addRemove(e,t,i){if(i){if(!e.has(t))return e.add(t),!0}else if(e.has(t))return e.delete(t),!0;return!1}}class Br extends Ur{constructor(e){super(e)}initTile(e){e.dataSource.useGeometryLoader&&(e.tileGeometryLoader=new wn(e))}updateTiles(e){for(const t of e){const e=t.tileGeometryLoader;void 0!==e&&(e.update(this.enableFilterByKind?this.enabledGeometryKinds:void 0,this.enableFilterByKind?this.disabledGeometryKinds:void 0),this.m_tileUpdateCallback&&this.m_tileUpdateCallback(t))}this.updateTileObjectVisibility(e)&&this.mapView.update()}}const qr=[[K.f.Background,K.f.Terrain,K.f.Area,K.f.Border],[K.f.Line],[K.f.Building],[K.f.Label],[K.f.All]],Vr=new K.g(qr[0]);class Wr extends Ur{constructor(e){super(e),this.m_maxUpdatedTilePerFrame=5,this.m_loadPhaseDefinitions=qr,this.m_basicGeometryKinds=Vr}initTile(e){e.dataSource.useGeometryLoader&&(e.tileGeometryLoader=new Gr(e,this.m_loadPhaseDefinitions,this.m_basicGeometryKinds))}updateTiles(e){let t=this.mapView.isDynamicFrame?this.updateSomeTiles(e):this.updateAllTilesTogether(e);if(this.m_tileUpdateCallback)for(const t of e)this.m_tileUpdateCallback(t);t=this.updateTileObjectVisibility(e)||t,!t&&this.checkTilesFinished(e)||this.mapView.update()}checkTilesFinished(e){for(const t of e){const e=t.tileGeometryLoader;if(void 0!==e&&!e.allGeometryLoaded)return!1}return!0}updateSomeTiles(e){let t=0;for(const i of e){const e=i.tileGeometryLoader;if(void 0!==e&&e.update(this.enableFilterByKind?this.enabledGeometryKinds:void 0,this.enableFilterByKind?this.disabledGeometryKinds:void 0)&&(t++,this.m_maxUpdatedTilePerFrame>0&&t>=this.m_maxUpdatedTilePerFrame))break}return t>0}updateAllTilesTogether(e){let t,i=!1;for(const i of e){const e=i.tileGeometryLoader;void 0!==e&&(void 0===t||e.currentPhase<t)&&(t=e.currentPhase)}if(void 0!==t&&t<this.m_loadPhaseDefinitions.length){const n=t+1;i=this.updateTilesIfNeeded(e,n)}return i}updateTilesIfNeeded(e,t){let i=!1;for(const n of e){const e=n.tileGeometryLoader;void 0!==e&&e.updateToPhase(t,this.enableFilterByKind?this.enabledGeometryKinds:void 0,this.enableFilterByKind?this.disabledGeometryKinds:void 0)&&(i=!0)}return i}}const Zr=p.d.instance.create("ImageCache");class $r{constructor(){this.m_images=new Map}static get instance(){return void 0===$r.m_instance&&($r.m_instance=new $r),$r.m_instance}static dispose(){$r.m_instance=void 0}registerImage(e,t,i){let n=this.findImageCacheItem(t);if(void 0!==n)return void 0!==e&&n.mapViews.indexOf(e)<0&&n.mapViews.push(e),n.imageItem;if(n=this.findImageCacheItem(t),void 0!==n)return void 0!==e&&n.mapViews.indexOf(e)<0&&n.mapViews.push(e),n.imageItem;const r=[];return void 0!==e&&r.push(e),n={imageItem:{url:t,imageData:i,loaded:!1},mapViews:r},this.m_images.set(t,n),n.imageItem}addImage(e,t,i=!0){const n=this.registerImage(e,t,void 0);return void 0!==n&&!0===i?this.loadImage(n):n}findImage(e){const t=this.m_images.get(e);if(void 0!==t)return t.imageItem}clear(e){const t=[];this.m_images.forEach(i=>{const n=i.mapViews.indexOf(e);n>=0&&i.mapViews.splice(n,1),0===i.mapViews.length&&t.push(i.imageItem.url)});for(const e of t)this.m_images.delete(e)}clearAll(){this.m_images=new Map}get size(){return this.m_images.size}loadImage(e){if(void 0!==e.imageData)return e;if(void 0!==e.loadingPromise)return e.loadingPromise;const t=new r.H;return e.loadingPromise=new Promise(i=>{Zr.debug(`Loading image: ${e.url}`),t.load(e.url,t=>{Zr.debug(`... finished loading image: ${e.url}`),this.renderImage(e,t).then(()=>{e.loadingPromise=void 0,i(e)}).catch(t=>{Zr.error(`... loading image failed: ${e.url} : ${t}`),i(void 0)})},void 0,t=>{Zr.error(`... loading image failed: ${e.url} : ${t}`),e.loadingPromise=void 0,i(void 0)})}),e.loadingPromise}findImageCacheItem(e){return this.m_images.get(e)}renderImage(e,t){return new Promise((i,n)=>{if("function"==typeof createImageBitmap){const n={premultiplyAlpha:"default",imageOrientation:"flipY"};Zr.debug(`Creating bitmap image: ${e.url}`),createImageBitmap(t,0,0,t.width,t.height,n).then(t=>{Zr.debug(`... finished creating bitmap image: ${e.url}`),e.loadingPromise=void 0,e.imageData=t,e.loaded=!0,i(t)}).catch(t=>{Zr.error(`... loading image failed: ${e.url} : ${t}`),i(void 0)})}else try{"undefined"==typeof document&&(Zr.error("Error: document is not available, cannot generate image"),n(new Error("ImageCache#renderImage: document is not available, cannot render image to create texture")));const r=document.createElement("canvas");r.width=t.width,r.height=t.height;const s=r.getContext("2d");if(null!==s){Zr.debug(`... finished creating bitmap image in canvas: ${e.url} ${t}`),s.drawImage(t,0,0,t.width,t.height,0,0,r.width,r.height);const n=s.getImageData(0,0,t.width,t.height);e.imageData=n,e.loaded=!0,i(n)}else Zr.error("renderImage: no context found"),n(new Error("ImageCache#renderImage: no context found"))}catch(t){Zr.error(`renderImage failed: ${t}`),e.imageData=void 0,e.loaded=!0,n(new Error(`ImageCache#renderImage failed: ${t}`))}})}}class Hr{constructor(e){this.mapView=e,this.m_name2Url=new Map,this.m_url2Name=new Map}registerImage(e,t,i){if(void 0!==e){if(this.hasName(e))throw new Error("duplicate name in cache");const i=this.m_url2Name.get(t);void 0!==i?i.indexOf(e)<0&&i.push(e):this.m_url2Name.set(t,[e]),this.m_name2Url.set(e,t)}const n=$r.instance.findImage(t);return void 0===n?$r.instance.registerImage(this.mapView,t,i):n}addImage(e,t,i=!0){const n=this.registerImage(e,t,void 0);return!0===i?$r.instance.loadImage(n):n}findImageByName(e){const t=this.m_name2Url.get(e);if(void 0!==t)return $r.instance.findImage(t)}findImageByUrl(e){return $r.instance.findImage(e)}loadImage(e){return $r.instance.loadImage(e)}clear(){$r.instance.clear(this.mapView),this.m_name2Url=new Map,this.m_url2Name=new Map}get numberOfNames(){return this.m_name2Url.size}get numberOfUrls(){return this.m_url2Name.size}hasName(e){return void 0!==this.m_name2Url.get(e)}hasUrl(e){return void 0!==this.m_url2Name.get(e)}findNames(e){return this.m_url2Name.get(e)}}class Kr{constructor(e){this.m_scene=e,this.m_enabled=!0,this.m_fog=new r.D(0),this.m_fogIsDefined=!1,this.m_cachedTheme={styles:{}}}set enabled(e){this.m_enabled=e,e&&this.m_fogIsDefined&&null===this.m_scene.fog?this.add():e||null===this.m_scene.fog||this.remove()}get enabled(){return this.m_enabled}reset(e){this.m_cachedTheme=e,void 0!==e&&void 0!==e.fog&&void 0!==e.fog.color&&void 0!==e.fog.startRatio?(this.m_fogIsDefined=!0,this.m_fog.color.set(e.fog.color),this.m_enabled&&null===this.m_scene.fog&&this.add()):(this.m_fogIsDefined=!1,null!==this.m_scene.fog&&this.remove())}update(e,t){if(null!==this.m_scene.fog&&void 0!==this.m_cachedTheme&&this.m_cachedTheme.fog&&void 0!==this.m_cachedTheme.fog.startRatio&&(void 0!==e.camera.far||void 0!==t)){const i=void 0!==t?t:e.camera.far,n=1,r=0,s=this.m_cachedTheme.fog.startRatio,o=1;Object(p.l)(s<=o);const a=Nn.rayCastWorldCoordinates(e,0,0);if(null===a)throw new Error("MapView does not support a view pointing in the void.");const l=Math.abs(Math.cos(Nn.extractSphericalCoordinatesFromLocation(e,e.camera,e.projection.unprojectPoint(a)).tilt)),h=p.f.smoothStep(n,r,l);this.m_fog.near=p.f.lerp(i*s,i,1-h),this.m_fog.far=p.f.lerp(i*o,i,h),this.m_fog.near=Math.min(this.m_fog.near,e.camera.far),this.m_fog.far=Math.min(this.m_fog.far,e.camera.far)}}add(){this.m_scene.fog=this.m_fog,this.setFogInRawShaderMaterials(!0)}remove(){this.m_scene.fog=null,this.setFogInRawShaderMaterials(!1)}setFogInRawShaderMaterials(e){this.m_scene.traverse(t=>{t instanceof r.eb&&t.material instanceof r.ab&&(t.material instanceof I||(t.material instanceof $&&t.material.updateFog(e),t.material.fog!==e&&(t.material.fog=e,t.material.needsUpdate=!0)))})}}const Xr=p.d.instance.create("PoiManager");class Yr{constructor(e){this.mapView=e,this.m_imageTextures=new Map,this.m_poiShieldGroups=new Map}static notifyMissingPoiTable(e,t){void 0===e&&(e="undefined"),void 0===Yr.m_missingPoiTableName.get(e)&&(Yr.m_missingPoiTableName.set(e,!0),void 0===t||t.loadedOk?Xr.error(`updatePoiFromPoiTable: No POI table with name '${e}' found!`):Xr.error(`updatePoiFromPoiTable: Could not load POI table '${e}'!`))}static notifyMissingPoi(e,t){void 0===e&&(e="undefined");const i=`${t}[${e}]`;void 0===Yr.m_missingPoiName.get(i)&&(Yr.m_missingPoiName.set(i,!0),Xr.warn("updatePoiFromPoiTable: "+`Cannot find POI info for '${e}' in table '${t}'.`))}addPois(e,t){const i=Object(p.m)(t.poiGeometries),n=e.computeWorldOffsetX();for(const s of i){Object(p.l)(void 0!==s.technique);const i=Object(p.m)(s.technique),o=t.techniques[i];if(!1===o.enabled||!Object(K.E)(o)&&!Object(K.G)(o))continue;if(!1===o.showOnMap)continue;const a=new r.h(new Float32Array(s.positions.buffer),s.positions.itemCount);Object(K.E)(o)&&a.count>0?this.addLineMarker(e,s,o,a,n):Object(K.G)(o)&&this.addPoi(e,s,o,a,n)}}addTextureAtlas(e,t){fetch(t).then(e=>{if(!e.ok)throw new Error(`addTextureAtlas: Cannot load textureAtlas: ${e.statusText}`);return e.json()}).then(i=>{if(void 0!==i){try{Xr.debug(`addTextureAtlas: Loading textureAtlas '${t}' for image '${e}'`);for(const t of Object.getOwnPropertyNames(i)){const n=i[t],r={name:t,image:e,xOffset:n.x,yOffset:n.y,width:n.width,height:n.height};this.addImageTexture(r)}}catch(e){Xr.error("addTextureAtlas: Failed to load textureAtlas "+`'${t}' : ${e}`)}this.mapView.update()}else Xr.info(`addTextureAtlas: TextureAtlas empty: ${t}`)}).catch(e=>{Xr.error(`addTextureAtlas: Failed to load textureAtlas '${t}' : ${e}`)})}addImageTexture(e){void 0!==e.name?(void 0!==this.m_imageTextures.get(e.name)&&Xr.warn(`addImageTexture: Name already used: ${e.name}`+" (overriding it)"),this.m_imageTextures.set(e.name,e)):Xr.error("addImageTexture: Name required",e)}getImageTexture(e){return this.m_imageTextures.get(e)}updatePoiFromPoiTable(e){const t=e.poiInfo;if(void 0===t||void 0===t.poiTableName||void 0===t.poiName)return!0;const i=t.poiTableName,n=this.mapView.poiTableManager.getPoiTable(i);if(void 0!==n&&n.isLoading)return!1;if(t.poiTableName=void 0,void 0===n||!n.loadedOk)return Yr.notifyMissingPoiTable(i,n),!0;const r=t.poiName,s=n.getEntry(r);return void 0===s?(Yr.notifyMissingPoi(r,i),!0):(void 0!==s.iconName&&s.iconName.length>0&&(t.imageTextureName=Object(K.r)(s.iconName,t.technique)),e.visible=void 0!==s.visible?s.visible:e.visible,e.priority=void 0!==s.priority?s.priority:e.priority,t.iconMinZoomLevel=void 0!==s.iconMinLevel?s.iconMinLevel:t.iconMinZoomLevel,t.iconMaxZoomLevel=void 0!==s.iconMaxLevel?s.iconMaxLevel:t.iconMaxZoomLevel,t.textMinZoomLevel=void 0!==s.textMinLevel?s.textMinLevel:t.textMinZoomLevel,t.textMaxZoomLevel=void 0!==s.textMaxLevel?s.textMaxLevel:t.textMaxZoomLevel,e.updateMinMaxZoomLevelsFromPoiInfo(),!0)}clear(){this.m_imageTextures.clear(),this.m_poiShieldGroups.clear()}addLineMarker(e,t,i,n,s){let o,a,l=void 0!==i.imageTexture?Object(K.r)(i.imageTexture,i):void 0,h="";void 0!==t.stringCatalog&&(Object(p.l)(t.texts.length>0),h=t.stringCatalog[t.texts[0]]||"",void 0!==t.objInfos&&(o=t.objInfos[0],a=Object(K.t)(o)),void 0!==t.imageTextures&&(Object(p.l)(t.imageTextures.length>0),l=t.stringCatalog[t.imageTextures[0]]));const c=String(l)+"-"+h;let d=this.m_poiShieldGroups.get(c);void 0===d&&(d=this.m_poiShieldGroups.size,this.m_poiShieldGroups.set(c,d));const m=[];for(let e=0;e<n.count;e+=3){const t=n.getX(e)+s,i=n.getY(e),o=n.getZ(e);m.push(new r.Zb(t,i,o))}const u=this.checkCreateTextElement(e,h,i,l,void 0,void 0,d,a,m,void 0,void 0,o);u.ignoreDistance=!1,e.addTextElement(u)}addPoi(e,t,i,n,r){if(void 0===t.stringCatalog)return;const s=void 0!==i.imageTexture?Object(K.r)(i.imageTexture,i):void 0,o=i,a=o.poiTable;let l=o.poiName;for(let h=0;h<n.count;++h){const c=n.getX(h)+r,d=n.getY(h),m=n.getZ(h);Object(p.l)(t.texts.length>h);let u=s;const f=t.stringCatalog[t.texts[h]]||"",g=void 0!==t.objInfos?t.objInfos[h]:void 0,v=Object(K.t)(g);void 0!==t.imageTextures&&t.imageTextures[h]>=0&&(Object(p.l)(t.imageTextures.length>h),u=t.stringCatalog[t.imageTextures[h]]),void 0!==a&&(l=void 0===o.poiName?u:o.poiName,u=void 0);const _=this.checkCreateTextElement(e,f,i,u,a,l,0,v,c,d,m,g);e.addTextElement(_)}}checkCreateTextElement(e,t,i,n,s,o,a,l,h,c,d,m){const u=this.mapView.textElementsRenderer,p=void 0!==i.priority?i.priority:0,f=Array.isArray(h)?h:new r.Zb(h,c,d),g=this.mapView.zoomLevel,v=void 0!==i.fadeNear?Object(K.w)(i.fadeNear,g):i.fadeNear,_=void 0!==i.fadeFar?Object(K.w)(i.fadeFar,g):i.fadeFar,y=Object(K.w)(i.xOffset,g),x=Object(K.w)(i.yOffset,g),b=new Ot(tt.instance.convert(t),f,u.styleCache.getRenderStyle(e,i),u.styleCache.getLayoutStyle(e,i),Object(K.w)(p,g),void 0!==y?y:0,void 0!==x?x:0,l,i.style,v,_,e.offset);if(b.mayOverlap=!0===i.textMayOverlap,b.reserveSpace=!1!==i.textReserveSpace,b.alwaysOnTop=!0===i.alwaysOnTop,b.userData=m,void 0===n&&void 0!==s?n="":void 0!==n&&void 0!==s&&Xr.warn("Possible duplicate POI icon definition via imageTextureName and poiTable!"),void 0!==n){const e=!0===i.textIsOptional,t=!1!==i.iconIsOptional,r=!(!1===i.renderTextDuringMovements),h=void 0===i.iconMayOverlap?b.textMayOverlap:!0===i.iconMayOverlap,c=void 0===i.iconReserveSpace?b.textReservesSpace:!1!==i.iconReserveSpace;b.poiInfo={technique:i,imageTextureName:n,poiTableName:s,poiName:o,shieldGroupIndex:a,textElement:b,textIsOptional:e,iconIsOptional:t,renderTextDuringMovements:r,mayOverlap:h,reserveSpace:c,featureId:l,iconMinZoomLevel:i.iconMinZoomLevel,iconMaxZoomLevel:i.iconMaxZoomLevel,textMinZoomLevel:i.textMinZoomLevel,textMaxZoomLevel:i.textMaxZoomLevel},b.updateMinMaxZoomLevelsFromPoiInfo()}else void 0===b.minZoomLevel&&(b.minZoomLevel=i.textMinZoomLevel),void 0===b.maxZoomLevel&&(b.maxZoomLevel=i.textMaxZoomLevel);return b.distanceScale=void 0!==i.distanceScale?i.distanceScale:Wi,b}}Yr.m_missingPoiTableName=new Map,Yr.m_missingPoiName=new Map;class Jr{constructor(e){this.m_mapView=e}createPoiRenderer(e){return new li(this.m_mapView,e)}}const Qr=p.d.instance.create("PoiTable");class es{static verifyJSON(e){let t="string"==typeof e.name&&e.name.length>0&&(void 0===e.altNames||Array.isArray(e.altNames))&&(void 0===e.stackMode||"yes"===e.stackMode||"no"===e.stackMode||"parent"===e.stackMode)&&(void 0===e.visible||"boolean"==typeof e.visible)&&(void 0===e.priority||"number"==typeof e.priority)&&(void 0===e.iconMinLevel||"number"==typeof e.iconMinLevel)&&(void 0===e.iconMaxLevel||"number"==typeof e.iconMaxLevel)&&(void 0===e.textMinLevel||"number"==typeof e.textMinLevel)&&(void 0===e.textMaxLevel||"number"==typeof e.textMaxLevel);if(t&&void 0!==e.altNames){const i=e.altNames;for(const e in i)if("string"!=typeof e){t=!1;break}}return t}setup(e){switch(this.name=e.name,this.altNames=e.altNames,this.iconName=e.iconName,this.visible=e.visible,this.priority=e.priority,this.iconMinLevel=e.iconMinLevel,this.iconMaxLevel=e.iconMaxLevel,this.textMinLevel=e.textMinLevel,this.textMaxLevel=e.textMaxLevel,e.stackMode){case"yes":this.stackMode=K.i.Show;break;case"no":this.stackMode=K.i.Hide;break;case"parent":this.stackMode=K.i.ShowParent}}}class ts{constructor(e,t){this.name=e,this.useAltNamesForKey=t,this.poiList=new Array,this.poiDict=new Map,this.m_isLoading=!1,this.m_loadedOk=void 0}get isLoading(){return this.m_isLoading}get loadedOk(){return!0===this.m_loadedOk}getEntry(e){const t=this.poiDict.get(e);if(void 0!==t){if(t<this.poiList.length)return this.poiList[t];throw new Error("Poi table entry index out of stored list!")}}async load(e){if(void 0!==this.m_loadedOk)return!0;this.m_loadedOk=!1;const t=await fetch(e);if(!t.ok)throw new Error(`load: Cannot load POI table at ${e}:`+` ${t.statusText}`);const i=await t.json();if(void 0===i)return Qr.info(`load: TextureAtlas empty: ${e}`),!0;this.startLoading();try{if(Qr.debug(`load: Loading POI table '${e}' for table '${this.name}'`),void 0!==i.poiList&&Array.isArray(i.poiList))for(const t of i.poiList)if(es.verifyJSON(t)){const i=new es;i.setup(t);const n=this.poiList.push(i)-1;if(this.useAltNamesForKey)if(void 0!==i.altNames&&i.altNames.length>0)for(const e of i.altNames)this.poiDict.set(e,n);else Qr.warn(`load: Invalid entry in POI table '${e}' : `+`No alternative names set in entry: ${JSON.stringify(t)}.`);else void 0===i.name?Qr.warn(`load: Invalid entry in POI table '${e}' : `+`. No name set in entry: ${t}.`):this.poiDict.set(i.name,n)}else Qr.warn(`load: Invalid entry in POI table '${e}' : ${JSON.stringify(t)}`);this.m_loadedOk=!0,this.finishedLoading()}catch(t){return Qr.error("load: Failed to load POI table "+`'${e}' : ${t}`),this.m_loadedOk=!1,this.finishedLoading(),!1}return!0}startLoading(){this.m_isLoading=!0}finishedLoading(){this.m_isLoading=!1}}class is{constructor(e){this.mapView=e,this.m_isLoading=!1,this.m_poiTables=new Map}async loadPoiTables(e){return new Promise(t=>{if(this.clear(),void 0!==e.poiTables){this.startLoading();const i=new Array;e.poiTables.forEach(e=>{if(void 0!==e&&void 0!==e.name&&"string"==typeof e.name){const t=new ts(e.name,!1!==e.useAltNamesForKey);void 0!==e.url&&"string"==typeof e.url?(this.addTable(t),i.push(t.load(e.url))):Qr.error(`POI table definition has no valid url: ${e}`)}else Qr.error(`POI table definition has no valid name: ${e}`)}),i.length>0?Promise.all(i).finally(()=>{this.finishLoading(),t()}):(this.finishLoading(),t())}else this.finishLoading(),t()})}clear(){this.m_poiTables=new Map}get poiTables(){return this.m_poiTables}addTable(e){this.m_poiTables.set(e.name,e)}getPoiTable(e){return void 0===e?void 0:this.m_poiTables.get(e)}get finishedLoading(){return!this.m_isLoading}startLoading(){this.m_isLoading=!0}finishLoading(){this.m_isLoading=!1}}var ns=i(18);class rs extends Y{constructor({name:e="polar",styleSetName:t,minZoomLevel:i,maxZoomLevel:r,storageLevelOffset:s=-2,geometryLevelOffset:o=-1,debugTiles:a=!1}){super(e,t,i,r,s),this.m_tilingScheme=n.m,this.m_maxLatitude=n.c.radToDeg(n.d.MAXIMUM_LATITUDE),this.m_geometryLevelOffset=o,this.m_debugTiles=a,this.cacheable=!1}dispose(){this.m_northPoleMaterial&&(this.m_northPoleMaterial.dispose(),delete this.m_northPoleMaterial),this.m_southPoleMaterial&&(this.m_southPoleMaterial.dispose(),delete this.m_southPoleMaterial),this.m_styleSetEvaluator&&delete this.m_styleSetEvaluator}createMaterial(e,t){const i=new ns.a({$geometryType:"polygon",$layer:"earth",kind:e}),n=t.getMatchingTechniques(i);return 0!==n.length?dt({technique:n[0],level:1}):void 0}setStyleSet(e,t,i){this.dispose(),void 0!==e&&(this.m_styleSetEvaluator=new ns.b(e,t),this.m_northPoleMaterial=this.createMaterial("north_pole",this.m_styleSetEvaluator),this.m_southPoleMaterial=this.createMaterial("south_pole",this.m_styleSetEvaluator)),this.mapView.markTilesDirty(this)}setTheme(e,t){const i=void 0!==this.styleSetName&&e.styles&&e.styles[this.styleSetName]||[];this.setStyleSet(i,e.definitions,t)}canGetTile(e,t){if(e!==t.level||t.level<1)return!1;const{north:i,south:n}=this.m_tilingScheme.getGeoBox(t);return i>this.m_maxLatitude||n<-this.m_maxLatitude}shouldSubdivide(e,t){if(e<=t.level)return!1;const{north:i,south:n}=this.m_tilingScheme.getGeoBox(t);return i>this.m_maxLatitude||n<-this.m_maxLatitude}getTilingScheme(){return this.m_tilingScheme}getTile(e){const t=new Zn(this,e);return this.createTileGeometry(t),t}get geometryLevelOffset(){return this.m_geometryLevelOffset}set geometryLevelOffset(e){this.m_geometryLevelOffset=e}intersectEdge(e,t,i){const r=t.latitude,s=i.latitude;let o=t.longitude,a=i.longitude;90===Math.abs(r)&&(o=a),90===Math.abs(s)&&(a=o);const l=a-o,h=(e-r)/(s-r);return new n.b(e,o+l*h,0)}createTileGeometry(e){const{north:t,south:i}=e.geoBox,s=t>0&&i>=0,o=s?this.m_northPoleMaterial:this.m_southPoleMaterial;if(void 0===o)return void e.forceHasGeometry(!0);const a=this.m_tilingScheme.projection,l=this.projection,h=this.m_maxLatitude,c=s?h:-h,d=this.m_tilingScheme.boundingBoxGenerator.getWorldBox(e.tileKey),m=a.unprojectPoint(new r.Zb(d.min.x,d.min.y,0)),u=a.unprojectPoint(new r.Zb(d.max.x,d.min.y,0)),p=a.unprojectPoint(new r.Zb(d.max.x,d.max.y,0)),f=a.unprojectPoint(new r.Zb(d.min.x,d.max.y,0));let g,v=!1;if(1===e.tileKey.level){const e=0===d.min.x,t=e?d.max.x:d.min.x,i=(d.max.y+d.min.y)/2,n=a.unprojectPoint(new r.Zb(t,i,0)),o=e?m:u;g=s?e?[n,p,o,u]:[n,m,o,f]:e?[n,u,o,p]:[n,f,o,m],v=!0}else{g=s?[m,u,p,f]:[m,f,p,u];const e=g.map(e=>e.latitude),t=Math.max(...e),i=Math.min(...e);if(s?t<c:i>c)return;if(v=s?i<c:t>c,v){const n=e.indexOf(s?t:i);if(0!==n)for(let e=0;e<n;e++)g.push(g.shift())}}if(v){const t=(d.min.x+d.max.x)/2,i=(d.min.y+d.max.y)/2,s=a.unprojectPoint(new r.Zb(t,i,0));n.i.alignLongitude(g,s);const o=g[0],l=g[1],m=g[2],u=g[3],p=Math.abs(l.latitude)>=h,f=Math.abs(u.latitude)>=h,v=p?this.intersectEdge(c,l,m):this.intersectEdge(c,o,l),_=f?this.intersectEdge(c,u,m):this.intersectEdge(c,o,u);g.splice(p?2:1,4,v);const y=e.tileKey.level-this.storageLevelOffset+this.m_geometryLevelOffset,x=360/(1<<Math.max(0,y)),b=Math.floor((v.longitude+180)/x),w=Math.ceil((_.longitude+180)/x);for(let e=b+1;e<w;e++)g.push(new n.b(c,e*x-180,0));g.push(_),f&&g.push(u)}const _=new r.F;for(const t of g){const i=l.projectPoint(t,new r.Zb);_.vertices.push(i.sub(e.center))}for(let e=1;e<g.length-1;e++)_.faces.push(s?new r.A(0,e,e+1):new r.A(0,e+1,e));const y=new r.i;y.fromGeometry(_),_.dispose();const x=new r.eb(y,o);if(x.userData={dataSource:this.name,tileKey:e.tileKey},this.m_debugTiles){const t=Math.round(16777215*Math.abs(Math.sin(11*e.tileKey.mortonCode())));x.material=new r.fb({color:t,transparent:!0,opacity:.5}),e.objects.push(new r.eb(y,new r.fb({color:t,wireframe:!0})))}e.objects.push(x)}}const ss=i(55),os=p.d.instance.create("ScreenCollissions");class as{constructor(){this.screenBounds=new p.e.Box,this.rtree=new ss}static toBox2D(e,t){t.x=e.min.x,t.y=e.min.y,t.w=e.max.x-e.min.x,t.h=e.max.y-e.min.y}reset(){this.rtree.clear()}update(e,t){this.screenBounds.set(e/-2,t/-2,e,t),this.reset()}allocate(e){const t={minX:e.x,minY:e.y,maxX:e.x+e.w,maxY:e.y+e.h,type:"box"};this.rtree.insert(t)}allocateIBoxes(e){this.rtree.load(e)}isAllocated(e){const t=e instanceof p.e.Box?this.toCollisionBox(e):e,i=this.rtree.search(t);for(const e of i)switch(e.type){case"box":return!0;case"line":{const i=e;if(this.intersectsLine(t,i))return!0}}return!1}isVisible(e){return this.screenBounds.intersects(e)}intersectsLine(e,t){const i=t.line,n=i.end.x-i.start.x;let r,s,o,a;if(0!==n){const t=i.end.y-i.start.y,l=t,h=-n,c=i.start.y-t/n*i.start.x;r=Math.sign(e.minX*l+(e.minY-c)*h),s=Math.sign(e.maxX*l+(e.minY-c)*h),o=Math.sign(e.minX*l+(e.maxY-c)*h),a=Math.sign(e.maxX*l+(e.maxY-c)*h)}else r=Math.sign(e.minX-i.start.x),s=Math.sign(e.maxX-i.start.x),o=Math.sign(e.minX-i.start.x),a=Math.sign(e.maxX-i.start.x);return r!==s||r!==o||r!==a}toCollisionBox(e){return{minX:e.x,minY:e.y,maxX:e.x+e.w,maxY:e.y+e.h,type:"box"}}}class ls extends as{constructor(e){super(),this.m_renderContext=null,this.m_renderingEnabled=!1,this.m_numAllocations=0,this.m_numSuccessfulTests=0,this.m_numFailedTests=0,this.m_numSuccessfulVisibilityTests=0,this.m_numFailedVisibilityTests=0,null!=e&&(this.m_renderContext=e.getContext("2d"))}reset(){super.reset(),this.m_numAllocations=0,this.m_numSuccessfulTests=0,this.m_numFailedTests=0,this.m_numSuccessfulVisibilityTests=0,this.m_numFailedVisibilityTests=0}update(e,t){this.m_renderingEnabled&&os.log(`Allocations: ${this.m_numAllocations} Successful Tests: ${this.m_numSuccessfulTests} Failed Tests: ${this.m_numFailedTests}  Successful Visibility Tests: ${this.m_numSuccessfulVisibilityTests}  Failed Visibility Tests: ${this.m_numFailedVisibilityTests} `),super.update(e,t),null!==this.m_renderContext&&(this.m_renderContext.canvas.width=e,this.m_renderContext.canvas.height=t),this.m_renderingEnabled=It.getValue("DEBUG_SCREEN_COLLISIONS")}allocate(e){super.allocate(e),this.m_numAllocations++,this.m_renderingEnabled&&null!==this.m_renderContext&&(this.m_renderContext.strokeStyle="#6666ff",this.m_renderContext.strokeRect(e.x-this.screenBounds.x,this.screenBounds.y+this.screenBounds.h-e.y-1,e.w,-e.h))}allocateIBoxes(e){for(const t of e)this.m_numAllocations++,this.m_renderingEnabled&&null!==this.m_renderContext&&(this.m_renderContext.strokeStyle="#aa2222",this.m_renderContext.strokeRect(t.minX-this.screenBounds.x,this.screenBounds.y+this.screenBounds.h-t.minY-1,t.maxX-t.minX,-(t.maxY-t.minY)));super.allocateIBoxes(e)}isAllocated(e){const t=super.isAllocated(e);if(this.m_renderingEnabled&&null!==this.m_renderContext){const i=t?2:0;this.m_renderContext.strokeStyle=t?"#FF0000":"#00ff00",this.m_renderContext.strokeRect(e.x-this.screenBounds.x-i,this.screenBounds.y+this.screenBounds.h-e.y-1+i,e.w+2*i,-e.h-2*i)}return t?this.m_numFailedTests++:this.m_numSuccessfulTests++,t}isVisible(e){const t=super.isVisible(e);return t?this.m_numSuccessfulVisibilityTests++:this.m_numFailedVisibilityTests++,t}}function hs(e){return e.z>-1&&e.z<1&&e.x>=-1&&e.x<=1&&e.y>=-1&&e.y<=1}class cs{constructor(e){this.m_camera=e,this.m_width=0,this.m_height=0}get width(){return this.m_width}get height(){return this.m_height}project(e,t=new r.Yb){const i=this.projectVector(e,cs.tempV3);if(i.z>-1&&i.z<1)return this.ndcToScreen(i,t)}projectOnScreen(e,t=new r.Yb){const i=this.projectVector(e,cs.tempV3);if(hs(i))return this.ndcToScreen(i,t)}project3(e,t=new r.Zb){const i=this.projectVector(e,cs.tempV3);if(i.z>-1&&i.z<1)return t.set(i.x*this.m_width/2,i.y*this.m_height/2,i.z),t}projectVector(e,t){return t.set(e.x,e.y,e.z).project(this.m_camera),t}onScreen(e){return hs(this.projectVector(e,cs.tempV3))}update(e,t,i){this.m_camera=e,this.m_width=t,this.m_height=i}ndcToScreen(e,t){return t.set(e.x*this.m_width/2,e.y*this.m_height/2)}}cs.tempV2=new r.Yb,cs.tempV3=new r.Zb;const ds=p.d.instance.create("SkyCubemapTexture"),ms=6;var us;!function(e){e[e.positiveX=0]="positiveX",e[e.negativeX=1]="negativeX",e[e.positiveY=2]="positiveY",e[e.negativeY=3]="negativeY",e[e.positiveZ=4]="positiveZ",e[e.negativeZ=5]="negativeZ"}(us||(us={}));class ps{constructor(e){const t=this.createCubemapFaceArray(e);this.m_skybox=void 0!==t?(new r.n).load(t):new r.m}dispose(){this.m_skybox.dispose()}get texture(){return this.m_skybox}updateTexture(e){const t=this.createCubemapFaceArray(e);void 0!==t&&(this.m_skybox=(new r.n).load(t))}createCubemapFaceArray(e){const t=[void 0,void 0,void 0,void 0,void 0,void 0];for(let i=0;i<ms;++i){const n=e[us[i]];if(void 0===n)return void ds.error(`Face "${us[i]}" was not defined.`);t[i]=n}return t}}const fs=512,gs=1,vs=[new r.Zb(1,0,0),new r.Zb(-1,0,0),new r.Zb(0,-1,0),new r.Zb(0,1,0),new r.Zb(0,0,1),new r.Zb(0,0,-1)],_s=[new r.Zb(0,0,-1),new r.Zb(0,0,1),new r.Zb(1,0,0),new r.Zb(1,0,0),new r.Zb(1,0,0),new r.Zb(-1,0,0)],ys=[new r.Zb(0,1,0),new r.Zb(0,1,0),new r.Zb(0,0,1),new r.Zb(0,0,-1),new r.Zb(0,1,0),new r.Zb(0,1,0)];class xs{constructor(e,t,i=fs){this.m_projectionType=t,this.m_height=i;const s=new r.l(e.topColor),o=new r.l(e.bottomColor),a=new r.l(e.groundColor);this.m_width=this.m_projectionType===n.f.Planar?1:this.m_height,this.m_faceCount=this.m_projectionType===n.f.Planar?1:6,this.m_faces=[];for(let t=0;t<this.m_faceCount;++t){const i=new Uint8Array(3*this.m_width*this.m_height);this.fillTextureData(i,t,s,o,a,e.monomialPower);const n=new r.q(i,this.m_width,this.m_height,r.Cb);n.needsUpdate=!0,n.unpackAlignment=1,this.m_faces.push(n)}this.m_projectionType===n.f.Spherical?(this.m_skybox=new r.m(this.m_faces),this.m_skybox.needsUpdate=!0):(this.m_farClipPlaneDividedVertically=new r.P,this.m_groundPlane=new r.ub(new r.Zb(0,0,1)),this.m_bottomMidFarPoint=new r.Zb,this.m_topMidFarPoint=new r.Zb,this.m_horizonPosition=new r.Zb,this.m_farClipPlaneCorners=[new r.Zb,new r.Zb,new r.Zb,new r.Zb])}dispose(){for(let e=0;e<this.m_faceCount;++e)this.m_faces[e].dispose();this.m_projectionType===n.f.Spherical&&this.m_skybox.dispose()}get texture(){return this.m_projectionType===n.f.Planar?this.m_faces[0]:this.m_skybox}update(e){this.m_projectionType===n.f.Planar&&(this.setHorizonPosition(e),this.updateTexturePosition())}updateTexture(e){for(let t=0;t<this.m_faceCount;++t)this.fillTextureData(this.m_faces[t].image.data,t,new r.l(e.topColor),new r.l(e.bottomColor),new r.l(e.groundColor),e.monomialPower),this.m_faces[t].needsUpdate=!0;this.m_projectionType===n.f.Spherical&&(this.m_skybox.needsUpdate=!0)}fillTextureData(e,t,i,s,o,a){const l=new r.l,h=new r.Zb,c=new r.Zb,d=new r.Zb,m=new r.Zb(0,0,1);for(let r=0;r<this.m_height;++r)for(let u=0;u<this.m_width;++u){if(this.m_projectionType===n.f.Spherical){const e=c.copy(_s[t]).multiplyScalar((u+.5)/this.m_width*2-1),n=d.copy(ys[t]).multiplyScalar((r+.5)/this.m_height*2-1);h.copy(vs[t]).add(e).add(n).normalize();const f=Math.max(m.dot(h),0);l.copy(o).lerp(s,Math.min(100*f,1)).lerp(i,f**Object(p.r)(a,gs)).multiplyScalar(255)}else{const e=r/this.m_height;0===r?l.copy(o).multiplyScalar(255):l.copy(s).lerp(i,e**Object(p.r)(a,gs)).multiplyScalar(255)}e[r*this.m_width*3+3*u]=l.r,e[r*this.m_width*3+3*u+1]=l.g,e[r*this.m_width*3+3*u+2]=l.b}}setHorizonPosition(e){this.m_farClipPlaneCorners[0].set(-1,-1,1).unproject(e),this.m_farClipPlaneCorners[1].set(1,-1,1).unproject(e),this.m_farClipPlaneCorners[2].set(-1,1,1).unproject(e),this.m_farClipPlaneCorners[3].set(1,1,1).unproject(e),this.m_bottomMidFarPoint.copy(this.m_farClipPlaneCorners[0]).add(this.m_farClipPlaneCorners[1]).multiplyScalar(.5),this.m_topMidFarPoint.copy(this.m_farClipPlaneCorners[2]).add(this.m_farClipPlaneCorners[3]).multiplyScalar(.5),this.m_farClipPlaneDividedVertically.set(this.m_bottomMidFarPoint,this.m_topMidFarPoint),this.m_groundPlane.intersectLine(this.m_farClipPlaneDividedVertically,this.m_horizonPosition)||this.m_horizonPosition.set(0,0,0)}updateTexturePosition(){const e=this.m_bottomMidFarPoint.distanceTo(this.m_horizonPosition)/this.m_farClipPlaneDividedVertically.distance(),t=0===this.m_horizonPosition.length()?1:e-2/this.m_height;this.m_faces[0].offset.set(0,this.m_bottomMidFarPoint.z<=0?-t:e)}}class bs{constructor(e,t,i){switch(this.m_sky=e,this.m_projectionType=t,this.m_sky.type){case"gradient":this.m_skyTexture=new xs(this.m_sky,this.m_projectionType),this.updateCamera(i);break;case"cubemap":this.m_skyTexture=new ps(this.m_sky)}}dispose(){this.m_skyTexture.dispose()}get texture(){return this.m_skyTexture.texture}updateCamera(e){"gradient"===this.m_sky.type&&this.m_skyTexture.update(e)}updateTexture(e,t){const i=this.m_sky.type===e.type&&this.m_projectionType===t;switch(e.type){case"gradient":i?this.m_skyTexture.updateTexture(e):this.m_skyTexture=new xs(e,t);break;case"cubemap":i?this.m_skyTexture.updateTexture(e):this.m_skyTexture=new ps(e)}this.m_projectionType=t,this.m_sky=e}}const ws="default",Ts=p.d.instance.create("FontCatalogLoader");class Ss{constructor(e){this.m_theme=e,this.m_catalogsLoading=0}initialize(e){if(void 0===this.m_theme.fontCatalogs||0===this.m_theme.fontCatalogs.length)return this.m_theme.fontCatalogs=[{name:ws,url:e}],ws;return this.m_theme.fontCatalogs[0].name}async loadCatalogs(e){Object(p.l)(void 0!==this.m_theme.fontCatalogs),Object(p.l)(this.m_theme.fontCatalogs.length>0);const t=[];return this.m_theme.fontCatalogs.forEach(i=>{this.m_catalogsLoading+=1;const n=Re.load(i.url,1024).then(e.bind(void 0,i.name)).catch(e=>{Ts.error("Failed to load FontCatalog: ",e)}).finally(()=>{this.m_catalogsLoading-=1});t.push(n)}),Promise.all(t)}get loading(){return this.m_catalogsLoading>0}}class Cs{constructor(e,t){this.m_mapView=e,this.m_renderedTilesChangeCheck=t}get worldCenter(){return this.m_mapView.worldCenter}get cameraIsMoving(){return this.m_mapView.cameraIsMoving}get maxVisibilityDist(){return this.m_mapView.viewRanges.maximum}get zoomLevel(){return this.m_mapView.zoomLevel}get frameNumber(){return this.m_mapView.frameNumber}get lookAtDistance(){return this.m_mapView.lookAtDistance}get isDynamic(){return this.m_mapView.isDynamicFrame}get hiddenGeometryKinds(){return void 0===this.m_mapView.tileGeometryManager?void 0:this.m_mapView.tileGeometryManager.hiddenGeometryKinds}get renderedTilesChanged(){return this.m_renderedTilesChangeCheck()}}class Es{constructor(e){this.m_renderer=e,this.m_minGlyphCount=0,this.m_maxGlyphCount=0}setGlyphCountLimits(e,t){this.m_minGlyphCount=e,this.m_maxGlyphCount=t}createTextCanvas(e){return Object(p.l)(this.m_maxGlyphCount>0),new Je({renderer:this.m_renderer,fontCatalog:e,minGlyphCount:this.m_minGlyphCount,maxGlyphCount:this.m_maxGlyphCount})}}var Ms=i(14);const As=4;class Ps{static async load(e,t){if(t=t||{},"string"==typeof e){const i=t.uriResolver,n=void 0!==i?i.resolveUri(e):e,r=await fetch(n,{signal:t.signal});if(!r.ok)throw new Error(`ThemeLoader#load: cannot load theme: ${r.statusText}`);(e=await r.json()).url=Object(p.t)(Object(p.q)(),n),e=this.resolveUrls(e,i)}else void 0===e.url&&(e.url=Object(p.q)(),e=this.resolveUrls(e,t.uriResolver));if(null==e)throw new Error("ThemeLoader#load: loaded resource is not valid JSON");e=e,Ps.checkTechniqueSupport(e);const i=Object(p.r)(t.resolveDefinitions,!1);if(e=await Ps.resolveBaseThemes(e,t),i){const i=new p.a(t.logger||console,`when processing Theme ${e.url}:`);Ps.resolveThemeReferences(e,i)}return e}static isThemeLoaded(e){return void 0===e.extends}static async loadAsync(e){return Ps.load(e)}static resolveUrls(e,t){if(void 0===e.url)return e;const i=Object(p.p)(new p.i(e.url),t);if(e.extends&&(e.extends=(Array.isArray(e.extends)?e.extends:[e.extends]).map(n=>"string"==typeof n?i.resolveUri(n):void 0!==n.url?n:(n.url=e.url,this.resolveUrls(n,t)))),e.sky&&"cubemap"===e.sky.type)for(let t=0;t<ms;++t){const n=e.sky[us[t]];void 0!==n&&(e.sky[us[t]]=i.resolveUri(n))}if(e.images)for(const t of Object.keys(e.images)){const n=e.images[t];n.url=i.resolveUri(n.url),void 0!==n.atlas&&(n.atlas=i.resolveUri(n.atlas))}if(e.fontCatalogs)for(const t of e.fontCatalogs)t.url=i.resolveUri(t.url);if(e.poiTables)for(const t of e.poiTables)t.url=i.resolveUri(t.url);if(e.styles)for(const t in e.styles){if(!e.styles.hasOwnProperty(t))continue;const n=e.styles[t];for(const e of n)e.attr&&["map","normalMap","displacementMap","roughnessMap"].forEach(t=>{const n=e.attr[t];n&&"string"==typeof n&&(e.attr[t]=i.resolveUri(n))})}return e}static checkTechniqueSupport(e){if(void 0!==e.styles)for(const t in e.styles)if(e.styles.hasOwnProperty(t))for(const i of e.styles[t])i.technique}static resolveThemeReferences(e,t){if(void 0!==e.definitions){t.pushAttr("definitions");for(const i in e.definitions){if(!e.definitions.hasOwnProperty(i))continue;const n=e.definitions[i];if(Object(Ms.a)(n)){t.pushAttr(i);const r=Ps.resolveStyle(n,e.definitions,t);t.pop(),void 0===r?(t.pushAttr(i),t.warn("skipping invalid style in definition"),t.pop(),delete e.definitions[i]):e.definitions[i]=r}}t.pop()}if(void 0!==e.styles)for(const i in e.styles)e.styles.hasOwnProperty(i)&&(t.pushAttr("styles"),t.pushAttr(i),e.styles[i]=Ps.resolveStyleSet(e.styles[i],e.definitions,t),t.pop(),t.pop());return e}static resolveStyleSet(e,t,i){const n=[];for(let r=0;r<e.length;++r){const s=e[r];i.pushIndex(r);const o=Ps.resolveStyle(s,t,i);void 0!==o?n.push(o):i.warn("invalid style, ignored"),i.pop()}return n}static resolveStyle(e,t,i){if(Object(Ms.b)(e)){const n=t&&t[e[1]];if(!n)return void i.warn(`invalid reference '${e[1]}' - not found`);if(!Object(Ms.a)(n))return void i.warn(`invalid reference '${e[1]}' - expected style definition`);e=Object(p.o)(n)}if(e=e,Array.isArray(e.when)){i.pushAttr("when");const n=this.resolveExpressionReferences(e.when,t,i);if(i.pop(),void 0===n)return;e.when=n}if(void 0!==e.attr){const n=e.attr;i.pushAttr("attr");for(const e in n){if(!n.hasOwnProperty(e))continue;const r=n[e];if(!Array.isArray(r))continue;i.pushAttr(e);const s=this.resolveExpressionReferences(r,t,i);i.pop(),void 0!==s?n[e]=s:delete n[e]}i.pop()}return e}static resolveExpressionReferences(e,t,i){let n=!1;const r=function e(r){if(Object(Ms.b)(r)){const e=r[1],s=t&&t[e];return void 0===s?(i.warn(`invalid reference '${e}' - not found`),void(n=!0)):Object(Ms.d)(s)?s.value:(i.warn(`invalid reference '${e}' - expected value definition`),void(n=!0))}if(Array.isArray(r)){const t=[...r];for(let i=1;i<t.length;++i)t[i]=e(t[i]);return t}return r}(e);if(!n)return r}static async resolveBaseThemes(e,t){if(t=t||{},void 0===e.extends)return e;const i=Object(p.r)(t.maxInheritanceDepth,As);if(i<=0)throw new Error("maxInheritanceDepth reached when attempting to load base theme");const n=Array.isArray(e.extends)?e.extends:[e.extends];delete e.extends;let r={};for(const e of n){const n=await Ps.load(e,{...t,resolveDefinitions:!1,maxInheritanceDepth:i-1});r=Ps.mergeThemes(n,r)}return Ps.mergeThemes(e,r)}static mergeThemes(e,t){const i={...t.definitions,...e.definitions},n={...t.styles,...e.styles};return{...t,...e,definitions:i,styles:n}}}var Ls;!function(e){e[e.EstimationInMb=0]="EstimationInMb",e[e.NumberOfTiles=1]="NumberOfTiles"}(Ls||(Ls={}));const Rs=1/1048576;class Os{constructor(e,t=Ls.EstimationInMb){this.m_disposedTiles=[],this.m_resourceComputationType=t,this.m_tileCache=new ie(e,e=>this.m_resourceComputationType===Ls.EstimationInMb?e.memoryUsage*Rs:1),this.m_tileCache.evictionCallback=(e,t)=>{void 0!==t.tileLoader&&t.tileLoader.cancel(),this.m_disposedTiles.push(t)},this.m_tileCache.canEvict=(e,t)=>!t.isVisible}static getKey(e,t,i){return`${i.name}_${e}_${t}`}static getKeyForTile(e){return Os.getKey(e.tileKey.mortonCode(),e.offset,e.dataSource)}get resourceComputationType(){return this.m_resourceComputationType}get capacity(){return this.m_tileCache.capacity}get size(){return this.m_tileCache.size}setCapacity(e,t){this.m_resourceComputationType=t,this.m_tileCache.setCapacityAndMeasure(e,e=>this.m_resourceComputationType===Ls.EstimationInMb?e.memoryUsage*Rs:1)}get(e,t,i){return this.m_tileCache.get(Os.getKey(e,t,i))}set(e,t,i,n){this.m_tileCache.set(Os.getKey(e,t,i),n)}delete(e){const t=Os.getKeyForTile(e);this.deleteByKey(t)}deleteByKey(e){this.m_tileCache.delete(e)}disposeTiles(){this.m_disposedTiles.forEach(e=>{e.dispose()}),this.m_disposedTiles.length=0}shrinkToCapacity(){this.m_tileCache.shrinkToCapacity()}evictAll(){this.m_tileCache.evictAll()}evictSelected(e){this.m_tileCache.evictSelected(e)}forEach(e,t){this.m_tileCache.forEach((i,n)=>{void 0!==t&&i.dataSource!==t||e(i,n)})}}class Fs{constructor(e,t,i){this.m_frustumIntersection=e,this.m_tileGeometryManager=t,this.dataSourceTileList=[],this.allVisibleTilesLoaded=!1,this.m_projectionMatrixOverride=new r.db,this.m_viewRange={near:.1,far:1/0,minimum:.1,maximum:1/0},this.m_resourceComputationType=Ls.EstimationInMb,this.options=i,this.m_resourceComputationType=void 0===i.resourceComputationType?Ls.EstimationInMb:i.resourceComputationType,this.m_dataSourceCache=new Os(this.options.tileCacheSize,this.m_resourceComputationType)}getDataSourceCacheSize(){return this.options.tileCacheSize}setDataSourceCacheSize(e,t=Ls.EstimationInMb){this.options.tileCacheSize=e,this.resourceComputationType=t}getNumberOfVisibleTiles(){return this.options.maxVisibleDataSourceTiles}setNumberOfVisibleTiles(e){this.options.maxVisibleDataSourceTiles=e}get resourceComputationType(){return this.m_resourceComputationType}set resourceComputationType(e){this.m_resourceComputationType=e,this.m_dataSourceCache.setCapacity(this.options.tileCacheSize,e)}updateClipPlanes(e,t){return void 0!==e&&(this.options.clipPlanesEvaluator.maxElevation=e),void 0!==t&&(this.options.clipPlanesEvaluator.minElevation=t),this.m_viewRange=this.options.clipPlanesEvaluator.evaluateClipPlanes(this.m_frustumIntersection.mapView),this.m_viewRange}updateRenderList(e,t,i,n){let r=!0;const s=this.getVisibleTileKeysForDataSources(t,i,n);this.dataSourceTileList=[];for(const{dataSource:i,visibleTileKeys:n}of s.tileKeys){n.sort((e,t)=>{const i=e.distance-t.distance,n=1e-6*(e.distance+t.distance);return Math.abs(i)<n?e.tileKey.mortonCode()-t.tileKey.mortonCode():i});const s=[];let o=!0,a=0;const l=i.getDisplayZoomLevel(t);for(let e=0;e<n.length&&s.length<this.options.maxVisibleDataSourceTiles;e++){const t=n[e],r=this.getTile(i,t.tileKey,t.offset);void 0!==r&&(r.prepareTileInfo(),o=o&&r.allGeometryLoaded,r.allGeometryLoaded?(r.numFramesVisible++,r.frameNumVisible<0&&(r.frameNumVisible=i.mapView.frameNumber)):a++,r.visibleArea=t.area,r.minElevation=t.minElevation,r.maxElevation=t.maxElevation,s.push(r))}this.m_tileGeometryManager.updateTiles(s),this.dataSourceTileList.push({dataSource:i,storageLevel:e,zoomLevel:l,allVisibleTileLoaded:o,numTilesLoading:a,visibleTiles:s,renderedTiles:new Map}),r=r&&o}let o,a;this.allVisibleTilesLoaded=r&&s.allBoundingBoxesFinal,this.fillMissingTilesFromCache(),this.forEachCachedTile(e=>{e.isVisible||void 0===e.tileLoader||e.tileLoader.isFinished||this.disposeTile(e)}),this.m_dataSourceCache.shrinkToCapacity(),this.dataSourceTileList.forEach(e=>{e.renderedTiles.forEach(e=>{o=p.f.min2(o,e.minElevation),a=p.f.max2(a,e.maxElevation+e.maxGeometryHeight)})}),void 0===o&&(o=0),void 0===a&&(a=0);let l=!1;const h=this.m_viewRange,c=this.updateClipPlanes(a,o);var d,m;return l=!1==(m=h,(d=c).far===m.far&&d.maximum===m.maximum&&d.minimum===m.minimum&&d.near===m.near),{viewRanges:c,viewRangesChanged:l}}getTile(e,t,i=0){return this.getTileImpl(e,t,i,!1)}getCachedTile(e,t,i=0){Object(p.l)(e.cacheable);return this.getTileImpl(e,t,i,!0)}getRenderedTile(e,t,i=0){const n=this.dataSourceTileList.find(t=>t.dataSource===e);if(void 0!==n)return n.renderedTiles.get(Un.getKeyForTileKeyAndOffset(t,i))}getRenderedTileAtLocation(e,t,i=0){const r=this.dataSourceTileList.find(t=>t.dataSource===e);if(void 0===r)return;const s=e.getTilingScheme(),o=r.zoomLevel,a=s.getTileKey(t,o);if(!a)return;let l=r.renderedTiles.get(Un.getKeyForTileKeyAndOffset(a,i));if(void 0!==l)return l;const{searchLevelsUp:h,searchLevelsDown:c}=this.getCacheSearchLevels(e,o);let d=a;for(let e=1;e<=h;++e)if(d=d.parent(),l=r.renderedTiles.get(Un.getKeyForTileKeyAndOffset(d,i)),void 0!==l)return l;const m=s.projection.projectPoint(t);for(let e=1;e<=c;++e){const t=o+e,a=n.h.worldCoordinatesToTileKey(s,m,t);if(a&&(l=r.renderedTiles.get(Un.getKeyForTileKeyAndOffset(a,i)),void 0!==l))return l}}removeDataSource(e){this.clearTileCache(e),this.dataSourceTileList=this.dataSourceTileList.filter(t=>t.dataSource!==e)}clearTileCache(e){void 0!==e?this.m_dataSourceCache.evictSelected((t,i)=>t.dataSource===e):this.m_dataSourceCache.evictAll()}markTilesDirty(e){if(void 0===e)this.dataSourceTileList.forEach(e=>{this.markDataSourceTilesDirty(e)});else{const t=this.dataSourceTileList.find(t=>t.dataSource===e);if(void 0===t)return;this.markDataSourceTilesDirty(t)}}disposePendingTiles(){this.m_dataSourceCache.disposeTiles()}forEachVisibleTile(e){for(const t of this.dataSourceTileList)t.renderedTiles.forEach(e)}forEachCachedTile(e,t){this.m_dataSourceCache.forEach((t,i)=>e(t),t)}disposeTile(e){this.m_dataSourceCache.delete(e),e.dispose()}getCacheSearchLevels(e,t){return{searchLevelsUp:Math.min(this.options.quadTreeSearchDistanceUp,Math.max(0,t-e.minZoomLevel)),searchLevelsDown:Math.min(this.options.quadTreeSearchDistanceDown,Math.max(0,e.maxZoomLevel-t))}}fillMissingTilesFromCache(){this.dataSourceTileList.forEach(e=>{const t=e.dataSource,i=e.zoomLevel,n=e.renderedTiles;let r;!function(e){e[e.NONE=0]="NONE",e[e.UP=1]="UP",e[e.DOWN=2]="DOWN",e[e.BOTH=3]="BOTH"}(r||(r={}));let s=r.NONE;const{searchLevelsUp:o,searchLevelsDown:a}=this.getCacheSearchLevels(t,i);s=a>0&&o>0?r.BOTH:a>0?r.DOWN:o>0?r.UP:r.NONE;const l=new Map;if(e.visibleTiles.forEach(e=>{const t=Un.getKeyForTileKeyAndOffset(e.tileKey,e.offset);e.levelOffset=0,e.hasGeometry||s===r.NONE?n.set(t,e):l.set(t,s)}),0===l.size)return;const h=new Map;for(const[e,s]of l)(s!==r.BOTH&&s!==r.UP||!this.findUp(e,i,n,h,t))&&(s!==r.BOTH&&s!==r.DOWN||this.findDown(e,i,n,t))})}findDown(e,t,i,r){const{offset:s,mortonCode:o}=Un.extractOffsetAndMortonKeyFromKey(e),a=n.g.fromMortonCode(o),l=r.getTilingScheme();for(const e of l.getSubTileKeys(a)){const n=Un.getKeyForTileKeyAndOffset(e,s),o=this.m_dataSourceCache.get(e.mortonCode(),s,r),a=Math.abs(e.level-t);void 0!==o&&o.hasGeometry?(i.set(n,o),o.levelOffset=a):a<this.options.quadTreeSearchDistanceDown&&this.findDown(n,t,i,r)}}findUp(e,t,i,r,s){const o=Un.getParentKeyFromKey(e);if(void 0!==i.get(o))return!0;const a=r.get(o);if(void 0!==a)return a;const{offset:l,mortonCode:h}=Un.extractOffsetAndMortonKeyFromKey(o),c=this.m_dataSourceCache.get(h,l,s),d=c?c.tileKey:n.g.fromMortonCode(h),m=Math.abs(t-d.level);if(void 0!==c&&c.hasGeometry)return r.set(o,!0),i.set(o,c),c.levelOffset=-m,!0;if(r.set(o,!1),m<this.options.quadTreeSearchDistanceUp&&0!==d.level){const e=this.findUp(o,t,i,r,s);if(r.set(o,e),e)return!0}return!1}getTileImpl(e,t,i,n){function r(t){void 0!==t&&(t.frameNumLastRequested=e.mapView.frameNumber)}if(!e.cacheable&&!n){const i=e.getTile(t);return r(i),i}const s=this.m_dataSourceCache;let o=s.get(t.mortonCode(),i,e);return void 0!==o&&o.offset===i?(r(o),o):n?void 0:(o=e.getTile(t),void 0!==o&&(o.offset=i,r(o),s.set(t.mortonCode(),i,e,o),this.m_tileGeometryManager.initTile(o)),o)}markDataSourceTilesDirty(e){const t=this.m_dataSourceCache,i=new Set;function n(e,t){const n=Os.getKeyForTile(e);i.has(n)||(i.add(n),void 0!==e.tileGeometryLoader&&e.tileGeometryLoader.reset(),e.clearTextElements(),e.load())}e.visibleTiles.forEach(e=>{n(e,this.m_tileGeometryManager)}),e.renderedTiles.forEach(e=>{n(e,this.m_tileGeometryManager)}),t.forEach((e,n)=>{i.has(n)||(t.deleteByKey(n),e.dispose())},e.dataSource)}getVisibleTileKeysForDataSources(e,t,i){const n=Array();let r=!0;if(0===t.length)return{tileKeys:n,allBoundingBoxesFinal:r};const s=new Map;if(t.forEach(e=>{const t=e.getTilingScheme(),i=s.get(t);void 0===i?s.set(t,[e]):i.push(e)}),void 0!==i){const e=Nn.getCameraFrustumPlanes(this.m_frustumIntersection.camera);e.near=this.m_viewRange.minimum,e.far=this.m_viewRange.maximum,this.m_projectionMatrixOverride.makePerspective(e.left,e.right,e.bottom,e.top,e.near,e.far),this.m_frustumIntersection.updateFrustum(this.m_projectionMatrixOverride)}else this.m_frustumIntersection.updateFrustum();for(const[t,o]of s){const s=o.map(t=>t.getDisplayZoomLevel(e)),a=this.m_frustumIntersection.compute(t,i,s,o);r=r&&a.calculationFinal;for(const t of o){const i=[],r=t.getDisplayZoomLevel(e);for(const e of a.tileKeyEntries.get(r).values())t.canGetTile(r,e.tileKey)&&i.push(e);n.push({dataSource:t,visibleTileKeys:i})}}return{tileKeys:n,allBoundingBoxesFinal:r}}}const Ds=!0;var Is;Ds?p.d.instance.setLogLevelForAll(p.c.Error):p.d.instance.setLogLevelForAll(p.c.Log),function(e){e.Update="update",e.Resize="resize",e.Render="render",e.AfterRender="didrender",e.FirstFrame="first-render",e.FrameComplete="frame-complete",e.ThemeLoaded="theme-loaded",e.AnimationStarted="animation-started",e.AnimationFinished="animation-finished",e.MovementStarted="movement-started",e.MovementFinished="movement-finished",e.DataSourceConnect="datasource-connect",e.CopyrightChanged="copyright-changed",e.ContextLost="webglcontext-lost",e.ContextRestored="webglcontext-restored",e.CameraPositionChanged="camera-changed"}(Is||(Is={}));const zs=p.d.instance.create("MapView"),ks=15722977,js={type:"dynamic",fov:40},Ns=.1,Gs=4e6,Us=140,Bs=10,qs=2e4,Vs=1,Ws=20,Zs=20,$s=12,Hs=30,Ks=4,Xs="polar",Ys={type:Is.Update},Js={type:Is.Render},Qs={type:Is.AfterRender},eo={type:Is.FirstFrame},to={type:Is.FrameComplete},io={type:Is.ThemeLoaded},no={type:Is.AnimationStarted},ro={type:Is.AnimationFinished},so={type:Is.MovementStarted},oo={type:Is.MovementFinished},ao={type:Is.ContextLost},lo={type:Is.ContextRestored},ho={type:Is.CopyrightChanged},co={vector2:[new r.Yb],vector3:[new r.Zb]};var mo;!function(e){e.Default="default",e.LowPower="low-power",e.HighPerformance="high-performance"}(mo||(mo={}));const uo={projection:n.k,maxVisibleDataSourceTiles:100,extendedFrustumCulling:!0,tileCacheSize:200,resourceComputationType:Ls.EstimationInMb,quadTreeSearchDistanceUp:3,quadTreeSearchDistanceDown:2,pixelRatio:"undefined"!=typeof window&&void 0!==window.devicePixelRatio?window.devicePixelRatio:1,geoCenter:new n.b(25,0,3e7),target:new n.b(25,0),zoomLevel:5,tilt:0,heading:0,enableMixedLod:!1};class po extends r.z{constructor(e){super(),this.dumpNext=!1,this.m_renderLabels=!0,this.m_screenCollisions=new as,this.m_visibleTileSetLock=!1,this.m_tileWrappingEnabled=!0,this.m_zoomLevel=Vs,this.m_minZoomLevel=Vs,this.m_maxZoomLevel=Ws,this.m_minCameraHeight=Zs,this.m_screenCamera=new r.rb(-1,1,1,-1),this.m_rteCamera=new r.tb,this.m_viewRanges={near:Ns,far:Gs,minimum:Ns,maximum:Gs},this.m_scene=new r.Ib,this.m_fog=new Kr(this.m_scene),this.m_mapTilesRoot=new r.ob,this.m_mapAnchors=new r.ob,this.m_animationCount=0,this.m_drawing=!1,this.m_updatePending=!1,this.m_frameNumber=0,this.m_maxFps=0,this.m_detectedFps=Hs,this.m_forceCameraAspect=void 0,this.m_tileDataSources=[],this.m_connectedDataSources=new Set,this.m_failedDataSources=new Set,this.m_enablePolarDataSource=!0,this.m_raycaster=new r.Eb,this.m_plane=new r.ub(new r.Zb(0,0,1)),this.m_sphere=new r.Nb(void 0,n.a.EQUATORIAL_RADIUS),this.m_theme={},this.m_themeIsLoading=!1,this.m_firstFrameRendered=!1,this.m_firstFrameComplete=!1,this.m_initialTextPlacementDone=!1,this.m_frameTimeIndex=0,this.m_frameTimeRing=[],this.m_imageCache=new Hr(this),this.m_poiManager=new Yr(this),this.m_poiTableManager=new is(this),this.m_lastTileIds="",this.m_copyrightInfo=[],this.onWebGLContextLost=e=>{this.dispatchEvent(ao),zs.warn("WebGL context lost",e)},this.onWebGLContextRestored=e=>{this.dispatchEvent(lo),void 0!==this.m_renderer&&(void 0!==this.m_theme&&void 0!==this.m_theme.clearColor?this.m_renderer.setClearColor(new r.l(this.m_theme.clearColor)):this.m_renderer.setClearColor(ks),this.update()),zs.warn("WebGL context restored",e)},this.m_options={...e},this.m_uriResolver=this.m_options.uriResolver,void 0!==this.m_options.minZoomLevel&&(this.m_minZoomLevel=this.m_options.minZoomLevel),void 0!==this.m_options.maxZoomLevel&&(this.m_maxZoomLevel=this.m_options.maxZoomLevel),void 0!==this.m_options.minCameraHeight&&(this.m_minCameraHeight=this.m_options.minCameraHeight),void 0!==this.m_options.decoderUrl&&(Er.defaultScriptUrl=this.m_uriResolver?this.m_uriResolver.resolveUri(this.m_options.decoderUrl):this.m_options.decoderUrl),void 0!==this.m_options.decoderCount&&(Er.defaultWorkerCount=this.m_options.decoderCount),this.m_visibleTileSetOptions={...uo,clipPlanesEvaluator:void 0!==e.clipPlanesEvaluator?e.clipPlanesEvaluator:er()},void 0!==e.projection&&(this.m_visibleTileSetOptions.projection=e.projection),void 0!==e.extendedFrustumCulling&&(this.m_visibleTileSetOptions.extendedFrustumCulling=e.extendedFrustumCulling),void 0!==e.maxVisibleDataSourceTiles&&(this.m_visibleTileSetOptions.maxVisibleDataSourceTiles=e.maxVisibleDataSourceTiles),void 0!==e.tileCacheSize&&(this.m_visibleTileSetOptions.tileCacheSize=e.tileCacheSize),void 0!==e.resourceComputationType&&(this.m_visibleTileSetOptions.resourceComputationType=e.resourceComputationType),void 0!==e.quadTreeSearchDistanceUp&&(this.m_visibleTileSetOptions.quadTreeSearchDistanceUp=e.quadTreeSearchDistanceUp),void 0!==e.quadTreeSearchDistanceDown&&(this.m_visibleTileSetOptions.quadTreeSearchDistanceDown=e.quadTreeSearchDistanceDown),void 0!==e.enablePolarDataSource&&(this.m_enablePolarDataSource=e.enablePolarDataSource),this.m_pixelRatio=e.pixelRatio,void 0!==e.maxFps&&(this.m_maxFps=Math.max(0,e.maxFps)),this.m_options.enableStatistics=!0===this.m_options.enableStatistics,this.m_languages=this.m_options.languages,Ds||void 0===this.m_options.collisionDebugCanvas||null===this.m_options.collisionDebugCanvas||(this.m_collisionDebugCanvas=this.m_options.collisionDebugCanvas,this.m_screenCollisions=new ls(this.m_collisionDebugCanvas)),this.handleRequestAnimationFrame=this.renderFunc.bind(this),this.handlePostponedAnimationFrame=this.postponedAnimationFrame.bind(this),this.m_pickHandler=new Ut(this,this.m_rteCamera,!0===this.m_options.enableRoadPicking),void 0!==this.m_options.tileWrappingEnabled&&(this.m_tileWrappingEnabled=this.m_options.tileWrappingEnabled),this.setupStats(this.m_options.enableStatistics),this.canvas.addEventListener("webglcontextlost",this.onWebGLContextLost),this.canvas.addEventListener("webglcontextrestored",this.onWebGLContextRestored),this.m_renderer=new r.dc({canvas:this.canvas,antialias:this.nativeWebglAntialiasEnabled,alpha:this.m_options.alpha,preserveDrawingBuffer:!0===this.m_options.preserveDrawingBuffer,powerPreference:void 0===this.m_options.powerPreference?mo.Default:this.m_options.powerPreference}),this.m_renderer.autoClear=!1,this.m_renderer.info.autoReset=!1,this.setupRenderer(),this.m_options.fovCalculation=void 0===this.m_options.fovCalculation?js:this.m_options.fovCalculation,this.m_options.fovCalculation.fov=r.bb.clamp(this.m_options.fovCalculation.fov,Bs,Us);const{width:t,height:i}=this.getCanvasClientSize(),s=t/i;this.m_camera=new r.tb(this.m_options.fovCalculation.fov,s,Ns,Gs),this.m_camera.up.set(0,0,1),this.m_lookAtDistance=0,this.m_focalLength=0,this.m_scene.add(this.m_camera),this.m_screenProjector=new cs(this.m_camera),this.setupCamera(e),this.m_movementDetector=new Kn(this.m_options.movementThrottleTimeout,()=>this.movementStarted(),()=>this.movementFinished());const o=this.m_options.customAntialiasSettings;if(this.mapRenderingManager=new vr(t,i,this.m_options.dynamicPixelRatio,o),this.m_tileGeometryManager=!0===this.m_options.enablePhasedLoading?new Wr(this):new Br(this),this.m_enableMixedLod=Object(p.r)(e.enableMixedLod,uo.enableMixedLod),this.m_visibleTiles=this.createVisibleTileSet(),this.m_animatedExtrusionHandler=new go(this),this.m_backgroundDataSource=new $n,this.addDataSource(this.m_backgroundDataSource),this.m_enablePolarDataSource){const t=void 0!==e.polarStyleSetName?e.polarStyleSetName:Xs;this.m_polarDataSource=new rs({styleSetName:t,geometryLevelOffset:e.polarGeometryLevelOffset}),this.updatePolarDataSource()}void 0!==e.backgroundTilingScheme&&this.m_backgroundDataSource.setTilingScheme(e.backgroundTilingScheme),this.initTheme(),this.m_textElementsRenderer=this.createTextRenderer(),this.drawFrame()}get renderLabels(){return this.m_renderLabels}set renderLabels(e){this.m_renderLabels=e}get textElementsRenderer(){return this.m_textElementsRenderer}get cameraMovementDetector(){return this.m_movementDetector}get animatedExtrusionHandler(){return this.m_animatedExtrusionHandler}get tileGeometryManager(){return this.m_tileGeometryManager}get enableMixedLod(){return this.m_enableMixedLod}set enableMixedLod(e){this.m_enableMixedLod=e,this.m_visibleTiles=this.createVisibleTileSet(),this.resetTextRenderer(),this.update()}dispose(){this.m_movementFinishedUpdateTimerId&&(clearTimeout(this.m_movementFinishedUpdateTimerId),this.m_movementFinishedUpdateTimerId=void 0),void 0!==this.m_animationFrameHandle&&(cancelAnimationFrame(this.m_animationFrameHandle),this.m_animationFrameHandle=void 0),this.canvas.removeEventListener("webglcontextlost",this.onWebGLContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onWebGLContextRestored);for(const e of this.m_tileDataSources)e.dispose();this.m_visibleTiles.clearTileCache(),this.m_textElementsRenderer.clearRenderStates(),this.m_renderer.dispose(),this.m_imageCache.clear(),this.m_movementDetector.dispose()}get resourceComputationType(){return this.m_visibleTiles.resourceComputationType}set resourceComputationType(e){this.m_visibleTiles.resourceComputationType=e}getCacheSize(){return this.m_visibleTiles.getDataSourceCacheSize()}setCacheSize(e,t){this.m_visibleTiles.setDataSourceCacheSize(e),t=void 0!==t?t:e/2,this.m_visibleTiles.setNumberOfVisibleTiles(Math.floor(t)),this.updateImages(),this.updateLighting(),this.m_textElementsRenderer.invalidateCache(),this.updateSkyBackground(),this.update()}get extendedFrustumCulling(){return void 0===this.m_options.extendedFrustumCulling||this.m_visibleTileSetOptions.extendedFrustumCulling}set extendedFrustumCulling(e){this.m_visibleTileSetOptions.extendedFrustumCulling=e}get lockVisibleTileSet(){return this.m_visibleTileSetLock}set lockVisibleTileSet(e){this.m_visibleTileSetLock=e}get pointOfView(){return this.m_pointOfView}set pointOfView(e){this.m_pointOfView=e,this.update()}loadPostEffects(e){fetch(e).then(e=>e.json()).then(e=>{this.m_postEffects=e,this.setPostEffects()})}get postEffects(){return this.m_postEffects}set postEffects(e){this.m_postEffects=e,this.setPostEffects()}get theme(){return this.m_theme}set theme(e){if(!Ps.isThemeLoaded(e))return this.m_themeIsLoading=!0,void Ps.load(e,{uriResolver:this.m_uriResolver}).then(e=>{this.m_themeIsLoading=!1,this.theme=e}).catch(e=>{this.m_themeIsLoading=!1,zs.error(`failed to set theme: ${e}`,e)});this.m_theme.fog=e.fog,this.m_theme.sky=e.sky,this.updateSkyBackground(),this.m_fog.reset(this.m_theme),this.m_theme.lights=e.lights,this.updateLighting(),this.m_theme.clearColor=e.clearColor,this.renderer.setClearColor(new r.l(e.clearColor)),this.m_theme.images=e.images,this.m_theme.imageTextures=e.imageTextures,this.updateImages(),this.m_theme.poiTables=e.poiTables,this.loadPoiTables(),this.m_theme.textStyles=e.textStyles,this.m_theme.defaultTextStyle=e.defaultTextStyle,this.m_theme.fontCatalogs=e.fontCatalogs,this.resetTextRenderer(),void 0===this.m_theme.styles&&(this.m_theme.styles={}),this.m_backgroundDataSource&&this.m_backgroundDataSource.setTheme(this.m_theme),this.m_theme.styles=e.styles||{},this.m_theme.definitions=e.definitions;for(const e of this.m_tileDataSources)e.setTheme(this.m_theme);this.dispatchEvent(io),this.update()}get uriResolver(){return this.m_uriResolver}get forceCameraAspect(){return this.m_forceCameraAspect}set forceCameraAspect(e){this.m_forceCameraAspect=e}set maxFps(e){this.m_maxFps=Math.max(0,e)}get maxFps(){return Math.max(0,this.m_maxFps)}get languages(){return this.m_languages}set languages(e){this.m_languages=e,this.m_tileDataSources.forEach(e=>{e.setLanguages(this.m_languages)}),this.update()}get copyrightInfo(){return this.m_copyrightInfo}set disableFading(e){this.m_textElementsRenderer.disableFading=e}get disableFading(){return this.m_textElementsRenderer.disableFading}get frameNumber(){return this.m_frameNumber}resetFrameNumber(){this.m_frameNumber=0,this.m_previousFrameTimeStamp=void 0}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}get canvas(){return this.m_options.canvas}get collisionDebugCanvas(){return this.m_collisionDebugCanvas}get scene(){return this.m_scene}get camera(){return this.m_camera}get renderer(){return this.m_renderer}get clearColor(){const e=this.m_renderer.getClearColor();return void 0!==e?e.getHex():0}set clearColor(e){this.m_renderer.setClearColor(e)}get projection(){return this.m_visibleTileSetOptions.projection}set projection(e){const t=Nn.rayCastWorldCoordinates(this,0,0);if(null===t)throw new Error("MapView does not support a view pointing in the void.");const i=this.projection.unprojectPoint(t),n=this.camera.position.distanceTo(t),s=Nn.extractAttitude(this,this.camera),o=r.bb.radToDeg(s.pitch),a=-r.bb.radToDeg(s.yaw);this.m_visibleTileSetOptions.projection=e,this.updatePolarDataSource(),this.clearTileCache(),this.textElementsRenderer.clearRenderStates(),this.m_visibleTiles=this.createVisibleTileSet(),this.lookAt(i,n,o,a)}get clipPlanesEvaluator(){return this.m_visibleTileSetOptions.clipPlanesEvaluator}set clipPlanesEvaluator(e){this.m_visibleTileSetOptions.clipPlanesEvaluator=e}get focalLength(){return this.m_focalLength}get lookAtDistance(){return this.m_lookAtDistance}get viewRanges(){return this.m_viewRanges}get geoCenter(){return this.projection.unprojectPoint(this.m_camera.position).normalized()}set geoCenter(e){if(void 0!==e.altitude)this.projection.projectPoint(e,this.m_camera.position);else{const t=this.geoCenter.altitude;this.projection.projectPoint(new n.b(e.latitude,e.longitude,t),this.m_camera.position)}this.update()}get mapAnchors(){return this.m_mapAnchors}get worldCenter(){return this.m_camera.position}get worldRootObject(){return this.m_mapTilesRoot}get pickHandler(){return this.m_pickHandler}get imageCache(){return this.m_imageCache}get poiManager(){return this.m_poiManager}get poiTableManager(){return this.m_poiTableManager}get minCameraHeight(){return this.m_minCameraHeight}get minZoomLevel(){return this.m_minZoomLevel}set minZoomLevel(e){this.m_minZoomLevel=e,this.update()}get maxZoomLevel(){return this.m_maxZoomLevel}set maxZoomLevel(e){this.m_maxZoomLevel=e,this.update()}get zoomLevel(){return this.m_zoomLevel}set zoomLevel(e){this.m_zoomLevel=r.bb.clamp(e,this.m_minZoomLevel,this.m_maxZoomLevel),Nn.zoomOnTargetPosition(this,0,0,this.m_zoomLevel),this.update()}get storageLevel(){return r.bb.clamp(Math.floor(this.m_zoomLevel),this.m_minZoomLevel,this.m_maxZoomLevel)}get viewportHeight(){return this.canvas.height}get nativeWebglAntialiasEnabled(){return void 0===this.m_options.enableNativeWebglAntialias?this.pixelRatio<2:this.m_options.enableNativeWebglAntialias}get phasedLoadingEnabled(){return!1!==this.m_options.enablePhasedLoading}get dataSources(){return this.m_tileDataSources}setFovCalculation(e){this.m_options.fovCalculation=e,this.calculateFocalLength(this.m_renderer.getSize(co.vector2[0]).height),this.updateCameras()}getDataSourceByName(e){return this.m_tileDataSources.find(t=>t.name===e)}getDataSourcesByStyleSetName(e){return this.m_tileDataSources.filter(t=>t.styleSetName===e)}isDataSourceEnabled(e){return e.enabled&&e.ready()&&this.m_connectedDataSources.has(e.name)}addDataSource(e){if(void 0!==this.getDataSourceByName(e.name))throw new Error(`A DataSource with the name "${e.name}" already exists in this MapView.`);return e.attach(this),e.setEnableElevationOverlay(void 0!==this.m_elevationProvider),this.m_tileDataSources.push(e),this.m_backgroundDataSource&&this.m_backgroundDataSource.updateStorageLevelOffset(),e.connect().then(()=>new Promise(e=>{if(void 0!==this.theme&&void 0!==this.theme.styles)return void e();const t=()=>{this.removeEventListener(Is.ThemeLoaded,t),e()};this.addEventListener(Is.ThemeLoaded,t)})).then(()=>{-1===this.m_tileDataSources.indexOf(e)||(e.addEventListener(Is.Update,()=>{this.update()}),e.setTheme(this.m_theme),this.m_connectedDataSources.add(e.name),this.dispatchEvent({type:Is.DataSourceConnect,dataSourceName:e.name}),this.update())}).catch(t=>{zs.error(`Failed to connect to datasource ${e.name}: ${t.message}`),this.m_failedDataSources.add(e.name),this.dispatchEvent({type:Is.DataSourceConnect,dataSourceName:e.name,error:t})})}removeDataSource(e){const t=this.m_tileDataSources.indexOf(e);-1!==t&&(e.detach(this),this.m_visibleTiles.removeDataSource(e),this.m_tileDataSources.splice(t,1),this.m_connectedDataSources.delete(e.name),this.m_failedDataSources.delete(e.name),this.m_backgroundDataSource&&this.m_backgroundDataSource.updateStorageLevelOffset(),this.update())}get visibleTileSet(){return this.m_visibleTiles}addOverlayText(e){this.m_textElementsRenderer.addOverlayText(e),this.update()}clearOverlayText(){this.m_textElementsRenderer.clearOverlayText()}lookAt(e,t,i=0,n=0){const r=Math.min(89,i);Nn.getCameraRotationAtTarget(this.projection,e,-n,r,this.camera.quaternion),Nn.getCameraPositionFromTargetCoordinates(e,t,-n,r,this.projection,this.camera.position),this.camera.updateMatrixWorld(!0)}setCameraGeolocationAndZoom(e,t,i=0,s=0){this.geoCenter=e;let o=Math.min(89,s);if(this.projection.type===n.f.Spherical){const e=Math.asin(n.a.EQUATORIAL_RADIUS/(Nn.calculateDistanceToGroundFromZoomLevel(this,t)+n.a.EQUATORIAL_RADIUS)),i=r.bb.radToDeg(e);o=Math.min(o,i)}Nn.zoomOnTargetPosition(this,0,0,t),Nn.setRotation(this,i,o),this.update()}get animating(){return this.m_animationCount>0}beginAnimation(){0==this.m_animationCount++&&(this.m_updatePending||(this.m_updatePending=!0,this.drawFrame()),no.time=Date.now(),this.dispatchEvent(no))}endAnimation(){this.m_animationCount>0&&--this.m_animationCount,0===this.m_animationCount&&(ro.time=Date.now(),this.dispatchEvent(ro))}get cameraIsMoving(){return this.m_movementDetector.cameraIsMoving}get isDynamicFrame(){return this.cameraIsMoving||this.animating||this.m_updatePending||this.m_animatedExtrusionHandler.isAnimating}get pixelToWorld(){if(void 0===this.m_pixelToWorld){Object(p.l)(void 0!==this.m_options.fovCalculation);const e=this.m_lookAtDistance;this.m_pixelToWorld=Nn.calculateWorldSizeByFocalLength(this.m_focalLength,e,1)}return this.m_pixelToWorld}get worldToPixel(){return 1/this.pixelToWorld}get pixelRatio(){return void 0!==this.m_pixelRatio?this.m_pixelRatio:"undefined"!=typeof window&&void 0!==window.devicePixelRatio?window.devicePixelRatio:1}set pixelRatio(e){this.m_pixelRatio=e,this.renderer.getPixelRatio()!==this.pixelRatio&&this.renderer.setPixelRatio(this.pixelRatio)}set dynamicPixelRatio(e){this.mapRenderingManager.lowResPixelRatio=e}get dynamicPixelRatio(){return this.mapRenderingManager.lowResPixelRatio}getScreenPosition(e){this.projection.projectPoint(e,co.vector3[0]);const t=this.m_screenProjector.project(co.vector3[0]);if(void 0!==t){const{width:e,height:i}=this.getCanvasClientSize();t.x=t.x+e/2,t.y=i-(t.y+i/2)}return t}raycasterFromScreenPoint(e,t){return this.m_raycaster.setFromCamera(this.getNormalizedScreenCoordinates(e,t),this.m_rteCamera),this.m_raycaster}getWorldPositionAt(e,t){return this.m_raycaster.setFromCamera(this.getNormalizedScreenCoordinates(e,t),this.m_camera),this.projection.type===n.f.Spherical?this.m_raycaster.ray.intersectSphere(this.m_sphere,co.vector3[0]):this.m_raycaster.ray.intersectPlane(this.m_plane,co.vector3[0])}getGeoCoordinatesAt(e,t){const i=this.getWorldPositionAt(e,t);return i?this.projection.unprojectPoint(i):null}getNormalizedScreenCoordinates(e,t){const{width:i,height:n}=this.getCanvasClientSize();return new r.Zb(e/i*2-1,-t/n*2+1,0)}intersectMapObjects(e,t){return this.m_pickHandler.intersectMapObjects(e,t)}resize(e,t){this.m_renderer.setSize(e,t,!1),this.m_renderer.getPixelRatio()!==this.pixelRatio&&this.m_renderer.setPixelRatio(this.pixelRatio),void 0!==this.mapRenderingManager&&this.mapRenderingManager.setSize(e,t),void 0!==this.collisionDebugCanvas&&(this.collisionDebugCanvas.width=e,this.collisionDebugCanvas.height=t),this.updateCameras(),this.update(),this.dispatchEvent({type:Is.Resize,size:{width:e,height:t}})}renderSync(){this.renderFunc(p.g.now())}update(){this.dispatchEvent(Ys),this.m_updatePending||(this.m_updatePending=!0,this.animating||this.drawFrame())}get updatePending(){return this.m_updatePending}requestUpdateIfNeeded(){this.update()}clearTileCache(e){if(void 0!==e){const t=this.getDataSourceByName(e);t&&(this.m_visibleTiles.clearTileCache(t),t.clearCache())}else this.m_visibleTiles.clearTileCache(),this.m_tileDataSources.forEach(e=>e.clearCache());void 0!==this.m_elevationProvider&&this.m_elevationProvider.clearCache()}forEachVisibleTile(e){this.m_visibleTiles.forEachVisibleTile(e)}forEachCachedTile(e){this.m_visibleTiles.forEachCachedTile(e)}markTilesDirty(e){this.m_visibleTiles.markTilesDirty(e)}setElevationSource(e,t,i){this.removeDataSource(e),this.addDataSource(e),this.m_elevationRangeSource=t,this.m_elevationRangeSource.connect(),this.m_elevationProvider=i,this.dataSources.forEach(e=>{e.setEnableElevationOverlay(!0)}),this.m_tileGeometryManager.setTileUpdateCallback(e=>{!function(e){const t=e.mapView.elevationProvider;if(void 0===t||0===e.objects.length)return;const i=t.getDisplacementMap(e.tileKey);if(void 0===i||0===e.objects.length)return;const n=e.objects[0];if(!n.userData||!n.userData.kind||!n.userData.kind.find(e=>e!==K.f.All&&e!==K.f.Terrain))return;for(const t of e.objects)zr(t,i.texture);if(!e.allGeometryLoaded)return;if(e.allTextElementsOverlaid)return;const r=Math.ceil(e.textElementGroups.count()/Nr),s=e.textElementGroups.sortedGroups;let{groupIndex:o,elementIndex:a}=e.nextTextElementToOverlay,l=0;for(;o<s.length;){const i=s[o];for(;l<r&&a<i.elements.length;)jr(i.elements[a],t,e),a++,l++;if(!(a>=i.elements.length))break;++o,a=0}e.nextTextElementToOverlay={groupIndex:o,elementIndex:a},e.textElementsChanged=!0,e.mapView.update()}(e)}),this.clearTileCache()}clearElevationSource(e){this.removeDataSource(e),this.m_elevationRangeSource=void 0,this.m_elevationProvider=void 0,this.dataSources.forEach(e=>{e.setEnableElevationOverlay(!1)}),this.m_tileGeometryManager.setTileUpdateCallback(void 0),this.clearTileCache()}get fog(){return this.m_fog}setPostEffects(){this.mapRenderingManager.bloom.enabled=!1,this.mapRenderingManager.outline.enabled=!1,this.mapRenderingManager.vignette.enabled=!1,this.mapRenderingManager.sepia.enabled=!1,void 0!==this.m_postEffects&&(void 0!==this.m_postEffects.bloom&&(this.mapRenderingManager.bloom=this.m_postEffects.bloom),void 0!==this.m_postEffects.outline&&(this.mapRenderingManager.outline.enabled=this.m_postEffects.outline.enabled,this.mapRenderingManager.updateOutline(this.m_postEffects.outline)),void 0!==this.m_postEffects.vignette&&(this.mapRenderingManager.vignette=this.m_postEffects.vignette),void 0!==this.m_postEffects.sepia&&(this.mapRenderingManager.sepia=this.m_postEffects.sepia))}get elevationProvider(){return this.m_elevationProvider}updatePolarDataSource(){const e=this.m_polarDataSource;if(!0===this.m_enablePolarDataSource&&void 0!==e){const t=this.getDataSourceByName(e.name);this.projection.type===n.f.Spherical?void 0===t&&this.addDataSource(e):void 0!==t&&this.removeDataSource(e)}}updateCameras(e){const{width:t,height:i}=this.m_renderer.getSize(co.vector2[0]);this.m_camera.aspect=void 0!==this.m_forceCameraAspect?this.m_forceCameraAspect:t/i,this.setFovOnCamera(this.m_options.fovCalculation,i);const n=this.projection.getScaleFactor(this.camera.position)*this.m_tileDataSources.reduce((e,t)=>Math.max(e,t.maxGeometryHeight),0);Object.assign(this.m_viewRanges,void 0===e?this.m_visibleTiles.updateClipPlanes(n):e),this.m_camera.near=this.m_viewRanges.near,this.m_camera.far=this.m_viewRanges.far,this.m_camera.updateProjectionMatrix(),this.m_camera.updateMatrixWorld(!1),this.m_rteCamera.copy(this.m_camera),this.m_rteCamera.position.setScalar(0),this.m_rteCamera.updateMatrixWorld(!0),this.m_screenCamera.left=t/-2,this.m_screenCamera.right=t/2,this.m_screenCamera.bottom=i/-2,this.m_screenCamera.top=i/2,this.m_screenCamera.updateProjectionMatrix(),this.m_screenCamera.updateMatrixWorld(!1),this.m_screenProjector.update(this.camera,t,i),this.m_screenCollisions.update(t,i),this.m_pixelToWorld=void 0;const r=Nn.extractAttitude(this,this.m_camera).pitch,s=this.getCameraHeightAboveTerrain(Ks),o=Nn.rayCastWorldCoordinates(this,0,0);if(null!==o){this.m_lookAtDistance=o.sub(this.camera.position).length();const e=s/Math.cos(Math.min(r,Math.PI/3));this.m_zoomLevel=Nn.calculateZoomLevelFromDistance(e,this),this.m_fog.update(this,this.m_viewRanges.maximum)}}getCameraHeightAboveTerrain(e){if(void 0!==this.elevationProvider){const t=this.elevationProvider.getHeight(this.geoCenter,e);if(void 0!==t){const e=this.projection.unprojectAltitude(this.m_camera.position)-t;return Math.max(e,1)}}return Math.abs(this.projection.groundDistance(this.m_camera.position))}detectCurrentFps(e){if(void 0!==this.m_previousRequestAnimationTime&&this.m_frameNumber>5){const t=1e3/(e-this.m_previousRequestAnimationTime);this.m_frameTimeRing[this.m_frameTimeIndex%$s]=t,this.m_frameTimeIndex++;const i=Math.min(this.m_frameTimeIndex,$s);let n=0;for(let e=0;e<i;e++)n+=this.m_frameTimeRing[e];this.m_detectedFps=n/i}this.m_previousRequestAnimationTime=e}drawFrame(){if(this.m_drawing||this.m_options.synchronousRendering)return;if(void 0!==this.m_animationFrameHandle&&(cancelAnimationFrame(this.m_animationFrameHandle),this.m_animationFrameHandle=void 0),this.m_maxFps<=0)return void(this.m_animationFrameHandle=requestAnimationFrame(this.handleRequestAnimationFrame));const e=1e3/this.m_detectedFps,t=1e3/this.m_maxFps,i=void 0===this.m_previousFrameTimeStamp?0:this.m_previousFrameTimeStamp,n=i+t-e-3;this.m_targetRequestAnimationTime=n,this.postponedAnimationFrame(i)}postponedAnimationFrame(e){void 0!==this.m_targetRequestAnimationTime&&(void 0!==this.m_animationFrameHandle&&(cancelAnimationFrame(this.m_animationFrameHandle),this.m_animationFrameHandle=void 0),this.detectCurrentFps(e),this.m_animationFrameHandle=requestAnimationFrame(e>this.m_targetRequestAnimationTime?this.handleRequestAnimationFrame:this.handlePostponedAnimationFrame))}renderFunc(e){this.render(e)}getEnabledTileDataSources(){const e=[];for(const t of this.m_tileDataSources)this.isDataSourceEnabled(t)&&e.push(t);return e}render(e){if(this.m_drawing)return;++this.m_frameNumber;const t=xn.instance,i=t.enabled,r=e;let s,o,a,l,h,c,d;if(Js.time=e,this.dispatchEvent(Js),i&&(s=t.currentFrame,s.setValue("renderCount.frameNumber",this.m_frameNumber),void 0!==this.m_previousFrameTimeStamp)){const e=r-this.m_previousFrameTimeStamp;i&&(s.setValue("render.fullFrameTime",e),s.setValue("render.fps",1e3/e))}for(this.m_previousFrameTimeStamp=r,this.m_renderer.info.reset(),this.m_updatePending=!1,this.m_thisFrameTilesChanged=void 0,this.m_drawing=!0,this.m_renderer.getPixelRatio()!==this.pixelRatio&&this.m_renderer.setPixelRatio(this.pixelRatio),this.updateCameras(),this.m_renderer.clear();this.m_mapTilesRoot.children.length>0;)this.m_mapTilesRoot.remove(this.m_mapTilesRoot.children[0]);if(i&&(o=p.g.now()),!this.lockVisibleTileSet){const e=this.m_visibleTiles.updateRenderList(this.storageLevel,Math.floor(this.zoomLevel),this.getEnabledTileDataSources(),this.m_elevationRangeSource);e.viewRangesChanged&&this.updateCameras(e.viewRanges)}i&&(a=p.g.now());const m=this.m_visibleTiles.dataSourceTileList;if(m.forEach(({zoomLevel:e,renderedTiles:t})=>{t.forEach(t=>{this.renderTileObjects(t,e),t.frameNumLastVisible=this.m_frameNumber})}),this.m_initialTextPlacementDone||this.m_firstFrameComplete||this.isDynamicFrame||this.m_themeIsLoading||!this.m_poiTableManager.finishedLoading||!this.m_visibleTiles.allVisibleTilesLoaded||this.m_connectedDataSources.size+this.m_failedDataSources.size!==this.m_tileDataSources.length||this.m_textElementsRenderer.initializing||this.m_textElementsRenderer.loading||(this.m_initialTextPlacementDone=!0),this.m_mapAnchors.children.forEach(e=>{void 0!==e.geoPosition&&(this.projection.projectPoint(e.geoPosition,e.position),e.position.sub(this.camera.position))}),this.m_animatedExtrusionHandler.zoom=this.m_zoomLevel,void 0!==s&&(s.addValue("renderCount.numTilesRendered",0),s.addValue("renderCount.numTilesVisible",0),s.addValue("renderCount.numTilesLoading",0),m.forEach(({zoomLevel:e,renderedTiles:t,visibleTiles:i,numTilesLoading:n})=>{s.addValue("renderCount.numTilesRendered",t.size),s.addValue("renderCount.numTilesVisible",i.length),s.addValue("renderCount.numTilesLoading",n)})),this.m_movementDetector.checkCameraMoved(this,e)){const{yaw:e,pitch:t,roll:i}=Nn.extractAttitude(this,this.camera),{latitude:n,longitude:r,altitude:s}=this.geoCenter;this.dispatchEvent({type:Is.CameraPositionChanged,latitude:n,longitude:r,altitude:s,yaw:e,pitch:t,roll:i,zoom:this.zoomLevel})}const u=void 0!==this.m_pointOfView?this.m_pointOfView:this.m_rteCamera;this.renderLabels&&this.prepareRenderTextElements(e),i&&(l=p.g.now()),void 0!==this.m_skyBackground&&this.projection.type===n.f.Planar&&this.m_skyBackground.updateCamera(this.m_camera),this.mapRenderingManager.render(this.m_renderer,this.m_scene,u,!this.isDynamicFrame),i&&(h=p.g.now()),this.renderLabels&&this.finishRenderTextElements(),i&&(c=p.g.now()),this.m_firstFrameRendered||(this.m_firstFrameRendered=!0,i&&t.appResults.set("firstFrame",e),eo.time=e,this.dispatchEvent(eo)),this.m_visibleTiles.disposePendingTiles(),this.m_drawing=!1,(this.animating||this.m_updatePending)&&this.drawFrame(),this.checkCopyrightUpdates(),void 0!==s&&(d=p.g.now(),s.setValue("render.setupTime",o-r),s.setValue("render.cullTime",a-o),s.setValue("render.textPlacementTime",l-a),s.setValue("render.drawTime",h-l),s.setValue("render.textDrawTime",c-h),s.setValue("render.cleanupTime",d-c),s.setValue("render.frameRenderTime",d-r),xn.instance.storeFrameInfo(this.m_renderer.info)),Qs.time=e,this.dispatchEvent(Qs),this.m_firstFrameComplete||!this.m_initialTextPlacementDone||this.isDynamicFrame||this.textElementsRenderer.loading||(this.m_firstFrameComplete=!0,i&&t.appResults.set("firstFrameComplete",e),to.time=e,this.dispatchEvent(to))}renderTileObjects(e,t){const i=e.computeWorldOffsetX();if(e.willRender(t))for(const t of e.objects){t.position.copy(e.center),void 0!==t.displacement&&t.position.add(t.displacement),t.position.x+=i,t.position.sub(this.m_camera.position),e.localTangentSpace&&t.setRotationFromMatrix(e.boundingBox.getRotationMatrix()),t.frustumCulled=!1,void 0===t._backupRenderOrder&&(t._backupRenderOrder=t.renderOrder);const n=void 0!==t.userData&&void 0!==t.userData.kind&&t.userData.kind.includes(K.f.Building);t.renderOrder=t._backupRenderOrder+(!n&&e.levelOffset<0?qs*e.levelOffset:0),this.m_mapTilesRoot.add(t)}e.didRender()}prepareRenderTextElements(e){void 0!==this.m_pointOfView||this.m_textElementsRenderer.placeText(this.m_visibleTiles.dataSourceTileList,this.projection,e)}finishRenderTextElements(){void 0===this.m_pointOfView&&(this.m_screenCamera.far=this.m_viewRanges.maximum,this.m_textElementsRenderer.renderText(this.m_screenCamera))}initTheme(){void 0!==this.m_options.theme&&(this.m_themeIsLoading=!0,Promise.resolve(this.m_options.theme).then(e=>Ps.load(e,{uriResolver:this.m_uriResolver})).then(e=>{this.m_themeIsLoading=!1,this.theme=e,io.time=Date.now(),this.dispatchEvent(io)}).catch(e=>{this.m_themeIsLoading=!1;const t="string"==typeof this.m_options.theme?` from ${this.m_options.theme}`:"";zs.error(`Failed to load theme${t}: ${e}`,e)}))}setupCamera(e){const{width:t,height:i}=this.getCanvasClientSize(),r=uo.geoCenter;this.projection.projectPoint(r,this.m_camera.position),this.projection.type===n.f.Spherical&&this.m_camera.lookAt(this.scene.position),this.m_lookAtDistance=r.altitude,this.calculateFocalLength(i),this.m_visibleTiles=this.createVisibleTileSet(),this.setInitialCameraPosition(e),this.resize(t,i),this.m_screenCamera.position.z=1,this.m_screenCamera.near=0}setInitialCameraPosition(e){const t=n.b.fromObject(Object(p.r)(e.target,uo.target));t.altitude=0;const i=Object(p.r)(e.zoomLevel,uo.zoomLevel),r=Object(p.r)(e.tilt,uo.tilt),s=Object(p.r)(e.heading,uo.heading);this.lookAt(t,3e5,r,s),this.zoomLevel=i}createVisibleTileSet(){return new Fs(new Ir(this.m_camera,this,this.m_visibleTileSetOptions.extendedFrustumCulling,this.m_tileWrappingEnabled,this.m_enableMixedLod),this.m_tileGeometryManager,this.m_visibleTileSetOptions)}updateSkyBackground(){if(void 0===this.m_theme)return;const e=this.m_theme;if(this.m_skyBackground instanceof bs&&void 0!==e.sky)this.updateSkyBackgroundColors(e.sky,e.clearColor);else{if(void 0===this.m_skyBackground&&void 0!==e.sky)return void this.addNewSkyBackground(e.sky,e.clearColor);this.m_skyBackground instanceof bs&&void 0===e.sky&&this.removeSkyBackGround()}}addNewSkyBackground(e,t){"gradient"===e.type&&void 0===e.groundColor&&(e.groundColor=Object(p.r)(t,"#000000")),this.m_skyBackground=new bs(e,this.projection.type,this.m_camera),this.m_scene.background=this.m_skyBackground.texture}removeSkyBackGround(){this.m_scene.background=null,void 0!==this.m_skyBackground&&(this.m_skyBackground.dispose(),this.m_skyBackground=void 0)}updateSkyBackgroundColors(e,t){"gradient"===e.type&&void 0===e.groundColor&&(e.groundColor=Object(p.r)(t,"#000000")),void 0!==this.m_skyBackground&&this.m_skyBackground.updateTexture(e,this.projection.type)}updateLighting(){if(!this.m_theme)return;const e=this.m_theme;void 0!==e.clearColor&&this.m_renderer.setClearColor(new r.l(e.clearColor)),this.m_createdLights&&this.m_createdLights.forEach(e=>{this.m_scene.remove(e)}),void 0!==e.lights&&(this.m_createdLights=[],e.lights.forEach(e=>{const t=function(e){switch(e.type){case"ambient":{const t=new r.d(e.color,e.intensity);return t.name=e.name,t}case"directional":{const t=new r.t(e.color,e.intensity);return t.name=e.name,void 0!==e.castShadow&&(t.castShadow=e.castShadow),t.position.set(e.direction.x,e.direction.y,e.direction.z),t.position.normalize(),t}}}(e);t?(this.m_scene.add(t),this.m_createdLights.push(t)):zs.warn(`MapView: failed to create light ${e.name} of type ${e.type}`)}))}movementStarted(){this.m_textElementsRenderer.movementStarted(),so.time=Date.now(),this.dispatchEvent(so)}movementFinished(){this.m_textElementsRenderer.movementFinished(),oo.time=Date.now(),this.dispatchEvent(oo),this.animating||(void 0!==this.m_movementFinishedUpdateTimerId&&clearTimeout(this.m_movementFinishedUpdateTimerId),this.m_movementFinishedUpdateTimerId=setTimeout(()=>{this.m_movementFinishedUpdateTimerId=void 0,this.update()},0))}checkIfTilesChanged(){if(void 0!==this.m_thisFrameTilesChanged)return this.m_thisFrameTilesChanged;const e=this.m_visibleTiles.dataSourceTileList,t=[];t.length=0,e.forEach(({dataSource:e,renderedTiles:i})=>{i.forEach(i=>{t.push(e.name+"-"+i.tileKey.mortonCode())})}),t.sort();const i=t.join("#");return i!==this.m_lastTileIds?(this.m_lastTileIds=i,this.m_thisFrameTilesChanged=!0):this.m_thisFrameTilesChanged=!1,this.m_thisFrameTilesChanged}checkCopyrightUpdates(){if(!this.checkIfTilesChanged())return;const e=this.getRenderedTilesCopyrightInfo();if(e!==this.m_copyrightInfo){if(e.length===this.m_copyrightInfo.length){let t=!0;for(let i=0;i<e.length;i++){const n=e[i],r=this.m_copyrightInfo[i];if(n.label!==r.label){t=!1;break}}if(t)return}this.m_copyrightInfo=e,this.dispatchEvent(ho)}}getRenderedTilesCopyrightInfo(){let e=[];for(const t of this.m_visibleTiles.dataSourceTileList)for(const i of t.renderedTiles.values()){const t=i.copyrightInfo;void 0!==t&&0!==t.length&&(e=Mr.mergeArrays(e,t))}return e}updateImages(){if(!this.m_theme)return;const e=this.m_theme;if(this.m_imageCache.clear(),this.poiManager.clear(),void 0!==e.images)for(const t of Object.keys(e.images)){const i=e.images[t];this.m_imageCache.addImage(t,i.url,!0===i.preload),"string"==typeof i.atlas&&this.poiManager.addTextureAtlas(t,i.atlas)}void 0!==e.imageTextures&&e.imageTextures.forEach(e=>{this.poiManager.addImageTexture(e)})}loadPoiTables(){void 0!==this.m_theme&&(this.poiTableManager.clear(),this.poiTableManager.loadPoiTables(this.m_theme).then(()=>this.update()).catch(()=>this.update()))}setupStats(e){new xn(e,1e3)}setupRenderer(){this.m_renderer.setClearColor(ks),this.m_scene.add(this.m_mapTilesRoot),this.m_scene.add(this.m_mapAnchors)}createTextRenderer(){return new pn(new Cs(this,this.checkIfTilesChanged.bind(this)),this.m_camera,()=>{this.update()},this.m_screenCollisions,this.m_screenProjector,new Es(this.m_renderer),this.m_poiManager,new Jr(this),new Ss(this.m_theme),this.m_theme,this.m_options)}resetTextRenderer(){const e=this.m_textElementsRenderer.overlayText;this.m_textElementsRenderer=this.createTextRenderer(),void 0!==e&&this.m_textElementsRenderer.addOverlayText(e)}limitFov(e,t){e=r.bb.clamp(e,Bs,Us);let i=r.bb.radToDeg(Nn.calculateHorizontalFovByVerticalFov(r.bb.degToRad(e),t));return(i>Us||i<Bs)&&(i=r.bb.clamp(i,Bs,Us),e=r.bb.radToDeg(Nn.calculateVerticalFovByHorizontalFov(r.bb.degToRad(i),t))),e}setFovOnCamera(e,t){let i=0;"fixed"===e.type?(this.calculateFocalLength(t),i=e.fov):(Object(p.l)(0!==this.m_focalLength),i=Nn.calculateFovByFocalLength(this.m_focalLength,t)),this.m_camera.fov=this.limitFov(i,this.m_camera.aspect)}calculateFocalLength(e){Object(p.l)(void 0!==this.m_options.fovCalculation),this.m_focalLength=Nn.calculateFocalLengthByVerticalFov(r.bb.degToRad(this.m_options.fovCalculation.fov),e)}getCanvasClientSize(){const{clientWidth:e,clientHeight:t}=this.canvas;if(0===e||0===t||"number"!=typeof e||"number"!=typeof t){const e=this.m_renderer.getPixelRatio();return{width:Math.round(this.canvas.width/e),height:Math.round(this.canvas.height/e)}}return{width:e,height:t}}}var fo;!function(e){e[e.None=0]="None",e[e.Started=1]="Started",e[e.Playing=2]="Playing",e[e.Finished=3]="Finished"}(fo||(fo={}));class go{constructor(e){this.m_mapView=e,this.enabled=!0,this.duration=750,this.forceEnabled=!1,this.m_tileHandlerMap=new Map,this.m_zoomDirection=0,this.m_zoomLevelPrevious=this.m_mapView.zoomLevel}get zoomDirection(){return this.m_zoomDirection}set zoom(e){this.m_zoomLevelPrevious!==e&&(this.m_tileHandlerMap.forEach(t=>{void 0!==this.m_mapView.getDataSourceByName(t.tile.dataSource.name)&&(this.m_zoomDirection=e>this.m_zoomLevelPrevious?1:-1,t.zoomLevelChanged(this.m_zoomDirection))}),this.m_zoomLevelPrevious=e)}get forceAnimatedExtrusion(){return this.m_forceAnimatedExtrusion}set forceAnimatedExtrusion(e){this.m_forceAnimatedExtrusion=e}get forceAnimatedExtrusionDuration(){return this.m_forceAnimatedExtrusionDuration}set forceAnimatedExtrusionDuration(e){this.m_forceAnimatedExtrusionDuration=e}add(e){this.m_tileHandlerMap.set(e.tile,e)}removeTile(e){this.m_tileHandlerMap.delete(e)}find(e){for(const t of this.m_tileHandlerMap)for(const i of e)if(void 0!==i&&t[0].tileKey.mortonCode()===i.mortonCode())return t[1]}get isAnimating(){for(const e of this.m_tileHandlerMap)if(e[1].isAnimating)return!0;return!1}}class vo{constructor(e,t,i){this.m_tile=e,this.m_animatedExtrusionDuration=i,this.m_extrudedObjects=[],this.m_animatedExtrusionRatio=f.a.DEFAULT_RATIO_MAX,this.m_animatedExtrusionState=fo.None,this.m_animatedExtrusionStartTime=void 0,this.animateExtrusion=e=>{if(this.m_animatedExtrusionState!==fo.Playing){if(this.m_animatedExtrusionState!==fo.Started)return;this.m_animatedExtrusionState=fo.Playing}const t=Date.now();(void 0===this.m_animatedExtrusionStartTime||this.m_animatedExtrusionStartTime<=0)&&(this.m_animatedExtrusionStartTime=t);const i=Math.min(t-this.m_animatedExtrusionStartTime,this.m_animatedExtrusionDuration);this.extrusionRatio=p.f.easeInOutCubic(f.a.DEFAULT_RATIO_MIN,f.a.DEFAULT_RATIO_MAX,i/this.m_animatedExtrusionDuration),i>=this.m_animatedExtrusionDuration&&(this.m_animatedExtrusionState=fo.Finished,this.stopExtrusionAnimation()),this.m_tile.dataSource.requestUpdate()},this.m_mapView=e.mapView,this.m_animatedExtrusionHandler=this.m_mapView.animatedExtrusionHandler,t.forEach(e=>{e.materialFeature&&x.addRenderHelper(e.object),this.m_extrudedObjects.push(e.object)}),this.startExtrusionAnimationIfNeeded(this.m_animatedExtrusionHandler.zoomDirection)}set extrusionRatio(e){this.m_animatedExtrusionRatio=e,this.m_extrudedObjects.forEach(e=>{e.material.extrusionRatio=this.m_animatedExtrusionRatio})}get tile(){return this.m_tile}get animationState(){return this.m_animatedExtrusionState}get isAnimating(){return this.m_animatedExtrusionState!==fo.Finished}dispose(){this.stopExtrusionAnimation(),this.m_animatedExtrusionHandler.removeTile(this.m_tile)}zoomLevelChanged(e){!1===this.m_tile.isVisible&&this.m_animatedExtrusionState!==fo.None&&(this.m_animatedExtrusionState=fo.None,this.stopExtrusionAnimation()),!0===this.m_tile.isVisible&&this.m_animatedExtrusionState===fo.None&&this.startExtrusionAnimationIfNeeded(e)}getChildTiles(e){const t=[];return e.forEach(e=>{const i=this.tile.dataSource.getTilingScheme().getSubTileKeys(e);for(const e of i)t.push(e)}),t}startExtrusionAnimationIfNeeded(e){const{quadTreeSearchDistanceUp:t,quadTreeSearchDistanceDown:i}=this.tile.mapView.visibleTileSet.options,n=this.m_tile;let r;if(void 0!==e){let s;if(e<0){let e=0,t=[n.tileKey];for(;i>e&&void 0===r;){const i=this.getChildTiles(t);if(void 0!==i){if(s=this.m_animatedExtrusionHandler.find(i),void 0!==s){r=s.m_animatedExtrusionStartTime;break}t=i}e++}}if(e>0){let e=0,i=n.tileKey;for(;t>e&&void 0===r&&0!==i.level;){const t=i.parent();if(s=this.m_animatedExtrusionHandler.find([t]),void 0!==s){r=s.m_animatedExtrusionStartTime;break}i=t,e++}}}this.startExtrusionAnimation(r)}startExtrusionAnimation(e){this.m_animatedExtrusionState=fo.Started,this.m_animatedExtrusionStartTime=e,this.animateExtrusion(),this.m_mapView.addEventListener(Is.AfterRender,this.animateExtrusion)}stopExtrusionAnimation(){this.m_mapView.removeEventListener(Is.AfterRender,this.animateExtrusion)}}let _o=0;class yo{constructor(e,t){this.workerSet=e,this.tilerServiceType=t,this.m_serviceCreated=!1,this.workerSet.addReference(),this.serviceId=`${this.tilerServiceType}-${_o++}`}dispose(){this.m_serviceCreated&&this.workerSet.broadcastRequest(K.o.WORKER_SERVICE_MANAGER_SERVICE_ID,{type:K.o.Requests.DestroyService,targetServiceId:this.serviceId}).catch(()=>{}),this.workerSet.removeReference()}async connect(){await this.workerSet.connect(K.o.WORKER_SERVICE_MANAGER_SERVICE_ID),this.m_serviceCreated||(await this.workerSet.broadcastRequest(K.o.WORKER_SERVICE_MANAGER_SERVICE_ID,{type:K.o.Requests.CreateService,targetServiceType:this.tilerServiceType,targetServiceId:this.serviceId}),this.m_serviceCreated=!0)}registerIndex(e,t){const i={type:K.p.Requests.RegisterIndex,id:e,input:t instanceof URL?t.href:t};return this.workerSet.invokeRequest(this.serviceId,i)}updateIndex(e,t){const i={type:K.p.Requests.UpdateIndex,id:e,input:t instanceof URL?t.href:t};return this.workerSet.invokeRequest(this.serviceId,i)}getTile(e,t){const i=t.mortonCode(),n={type:K.p.Requests.TileRequest,index:e,tileKey:i};return this.workerSet.invokeRequest(this.serviceId,n)}}class xo{static getTiler(e,t,i){const n=this.getWorkerSet(t,i);return new yo(n,e)}static getWorkerSet(e,t){void 0===e&&(e=this.defaultScriptUrl);let i=this.workerSets[e];return void 0===i&&(i=new Tr({scriptUrl:e,workerCount:void 0===t?this.defaultWorkerCount:t}),this.workerSets[e]=i),i}static destroyWorkerSet(e){const t=this.workerSets[e];void 0!==t&&(t.destroy(),delete this.workerSets[e])}static destroy(){Object.keys(this.workerSets).forEach(e=>{this.workerSets[e].destroy()}),this.workerSets={}}}xo.defaultScriptUrl="./decoder.bundle.js",xo.defaultWorkerCount=1,xo.workerSets={};i(55);class bo{constructor(e){this.executor=e,this.doExec=!1,this.promise=new Promise((e,t)=>{this.resolveFunc=e,this.rejectFunc=t,this.doExec&&this.execInnerPromise(this.resolveFunc,this.rejectFunc)})}exec(){void 0!==this.resolveFunc&&void 0!==this.rejectFunc?this.execInnerPromise(this.resolveFunc,this.rejectFunc):this.doExec=!0}execInnerPromise(e,t){this.executor().then(t=>e(t)).catch(e=>t(e))}}class wo{constructor(e=fetch,t=5){this.fetchFunction=e,this.maxRetries=t,this.activeDownloadCount=0,this.downloadQueue=new Array,this.activeDownloads=new Map}static instance(){return wo.defaultInstance}static async fetchRepeatedly(e,t,i,n,r){try{const s=await e(n,r);if(503!==s.status||t>i)return s}catch(e){if(e.hasOwnProperty("isCancelled")||e.hasOwnProperty("name")&&"AbortError"===e.name||t>i)throw e}return wo.waitFor(wo.retryTimeout*t).then(()=>wo.fetchRepeatedly(e,i,t+1,n,r))}static waitFor(e){return new Promise(t=>setTimeout(t,e))}downloadJson(e,t){return this.downloadAs(e=>e.json(),e,t)}downloadArrayBuffer(e,t){return this.download(e,t).then(e=>e.arrayBuffer())}download(e,t){if(this.activeDownloadCount>=wo.maxParallelDownloads){const i=new bo(()=>this.doDownload(e,t));return this.downloadQueue.push(i),i.promise}return this.doDownload(e,t)}doDownload(e,t){return++this.activeDownloadCount,wo.fetchRepeatedly(this.fetchFunction,0,this.maxRetries,e,t).then(e=>(this.onDownloadDone(),e)).catch(e=>{throw this.onDownloadDone(),e})}onDownloadDone(){--this.activeDownloadCount,this.execDeferredDownload()}execDeferredDownload(){const e=this.downloadQueue.pop();void 0!==e&&e.exec()}downloadAs(e,t,i){const n=t,r=this.activeDownloads.get(n);if(void 0!==r)return Promise.resolve(r);const s=this.download(t,i).then(t=>{if(this.activeDownloads.delete(n),t.ok)return e(t);throw new Error(JSON.stringify(t))}).catch(e=>{throw this.activeDownloads.delete(n),e});return this.activeDownloads.set(n,s),s}}wo.retryTimeout=500,wo.maxParallelDownloads=16,wo.defaultInstance=new wo;var To;!function(e){e.isLoading=function(e){return void 0!==e.loadingPromise}}(To||(To={}));i(26);var So,Co=i(25);class Eo extends r.xb{constructor(e,t,i,n,s){void 0===t&&(t=new k({color:n||k.DEFAULT_COLOR,opacity:void 0!==s?s:1})),super(void 0===e?new r.i:e,t),this.matrixWorldInverse=new r.db,i&&this.setPositions(i)}get bufferGeometry(){return this.geometry}clearGeometry(){return this.geometry=new r.i}get shaderMaterial(){return this.material}setPositions(e){So.setPositions(this,e)}setupForRendering(){this.material.isHighPrecisionPointsMaterial&&void 0!==this.dimensionality&&this.material.setDimensionality(this.dimensionality),this.onBeforeRender=(e,t,i,n,r,s)=>{So.updateHpUniforms(this,i,this.shaderMaterial)}}updateMatrixWorld(e){const t=this.matrixWorldNeedsUpdate||e;super.updateMatrixWorld(e),t&&this.matrixWorldInverse.getInverse(this.matrixWorld)}}!function(e){function t(e){return new r.Zb(Math.fround(e.x),Math.fround(e.y),Math.fround(e.z))}function i(e,i){const n=(new r.db).copy(e.projectionMatrix).multiply(e.matrixWorldInverse),s=new r.Zb(0,0,0).applyMatrix4(i),o=t(s);return{viewProjection:n,eyePosHi:o,eyePosLo:t(s.sub(o))}}function n(e){if(e.length>0){const t=e[0];if(null==t)throw Error("Empty element in positions");const i=new Array,n=new Array,s=(...e)=>{for(const t of e){const e=Math.fround(t);n.push(t-e),i.push(e)}},o=e=>{s(e.x,e.y,e.z)};if(void 0!==t.z)e.forEach(e=>{o(e)});else{if(i.length%3!=0)throw Error("Positions must be 3D, not 2D");e.forEach(e=>{s(e)})}return{positionHigh:new r.B(i,3),positionLow:new r.B(n,3)}}return{positionHigh:new r.B([],3),positionLow:new r.B([],3)}}function s(e,t,i=0){const n=new Array,r=e.length;for(let s=0;s<r;s+=t){for(let t=0;t<i;t++)n.push(e[s+t]);const r=e[s+i],o=e[s+i+1],a=e[s+i+2],l=Math.fround(r),h=r-l,c=Math.fround(o),d=o-c,m=Math.fround(a),u=a-m;n.push(l,c,m,h,d,u);for(let r=i+3;r<t;r++)n.push(e[s+r])}return n}function o(e,t){const i=n(t);return e.bufferGeometry.setAttribute("position",i.positionHigh),e.bufferGeometry.setAttribute("positionLow",i.positionLow),i.positionHigh.itemSize}e.doubleToFloatVec=t,e.makeFloatVec=function(e){const t=Math.fround(e.x),i=Math.fround(e.y),n=Math.fround(e.z),s=new r.Zb(e.x-t,e.y-i,e.z-n);return e.x=Math.fround(t),e.y=Math.fround(i),e.z=Math.fround(n),s},e.createHighPrecisionCameraPos=i,e.updateHpUniforms=function(e,t,n){const r=i(t,e.matrixWorldInverse),s=r.viewProjection;if(void 0===n||!n.isMaterial)throw Error("High pecision line has no high precision material");if(!(n.uniforms&&n.uniforms.u_mvp&&n.uniforms.u_eyepos&&n.uniforms.u_eyepos_lowpart))throw Error("High pecision material has missing uniforms");n.uniforms.u_mvp.value=new Float32Array(s.elements),n.uniforms.u_eyepos.value=new Float32Array(r.eyePosHi.toArray()),n.uniforms.u_eyepos_lowpart.value=new Float32Array(r.eyePosLo.toArray())},e.createAttributes=n,e.addInterleavedAttributes3=s,e.setPositions=o,e.convertPositions=function(e){if(e.length<=0)return{positions:[]};const t=e[0];if(null==t)throw Error("Empty element in positions");const i=t;if(void 0===i.y&&void 0===i.z)return{positions:e};const n=new Array;return e.forEach(e=>{n.push(e.x,e.y,e.z)}),{positions:n}},e.createLine=function(e,t){const i=void 0!==t.lineWidth?t.lineWidth:5,n=void 0!==t.addCircles&&t.addCircles,o=void 0!==t.wireFrame&&t.wireFrame,a=[],l=[];Object(Co.b)(e,i,a,l,n);const h=new r.i,c=s(a,3),d=new r.J(new Float32Array(c),6),m=new r.K(d,3,0,!1),u=new r.K(d,3,3,!1);h.setAttribute("position",m),h.setAttribute("positionLow",u),h.setIndex(new r.h(new Uint32Array(l),1));const p=new I(t),f=o?new Mo(h,p):new Ao(h,p);return f.setupForRendering(),f},e.createPoints=function(e,t){const i=[];for(let t=0;t<e.length;t++)i.push(i.length/3);const n=new r.i,s=void 0!==(a=t)&&!0===a.isHighPrecisionPointMaterial?t:new k(t);var a;const l=new Eo(n,s);return o(l,e),l.setupForRendering(),l}}(So||(So={}));class Mo extends r.O{constructor(e,t,i,n,s){super(void 0===e?new r.i:e,t),void 0===t&&(t=new I({color:n||I.DEFAULT_COLOR,opacity:void 0!==s?s:I.DEFAULT_OPACITY})),this.matrixWorldInverse=new r.db,i&&this.setPositions(i)}get bufferGeometry(){return this.geometry}get shaderMaterial(){return this.material}setPositions(e){So.setPositions(this,e)}setupForRendering(){this.onBeforeRender=(e,t,i,n,r,s)=>{So.updateHpUniforms(this,i,this.shaderMaterial)}}updateMatrixWorld(e){const t=this.matrixWorldNeedsUpdate||e;super.updateMatrixWorld(e),t&&this.matrixWorldInverse.getInverse(this.matrixWorld)}}class Ao extends r.eb{constructor(e,t,i,n,s){super(void 0===e?new r.i:e,t),void 0===t&&(t=new I({color:n||I.DEFAULT_COLOR,opacity:void 0!==s?s:I.DEFAULT_OPACITY})),this.matrixWorldInverse=new r.db,i&&this.setPositions(i)}get bufferGeometry(){return this.geometry}get shaderMaterial(){return this.material}setPositions(e){So.setPositions(this,e)}setupForRendering(){this.onBeforeRender=(e,t,i,n,r,s)=>{So.updateHpUniforms(this,i,this.shaderMaterial)}}updateMatrixWorld(e){const t=this.matrixWorldNeedsUpdate||e;super.updateMatrixWorld(e),t&&this.matrixWorldInverse.getInverse(this.matrixWorld)}}p.d.instance.create("TileGeometry");p.d.instance.create("TileDataAccessor");i(17);const Po=p.d.instance.create("TileLoader");class Lo{constructor(e,t,i,n,r){this.dataSource=e,this.tileKey=t,this.dataProvider=i,this.tileDecoder=n,this.priority=r,this.state=Wn.Initialized,this.loadAbortController=new AbortController,this.countRequests=0}loadAndDecode(){switch(this.state){case Wn.Loading:case Wn.Loaded:case Wn.Decoding:return this.countRequests++,this.donePromise;case Wn.Ready:case Wn.Failed:case Wn.Initialized:case Wn.Canceled:return this.countRequests++,this.startLoading(),this.donePromise}}waitSettled(){return this.donePromise?this.donePromise:Promise.resolve(this.state)}cancel(){if(0==--this.countRequests){switch(this.state){case Wn.Loading:this.loadAbortController.abort(),this.loadAbortController=new AbortController;break;case Wn.Decoding:this.requestController&&(this.requestController.abort(),this.requestController=void 0)}this.onDone(Wn.Canceled)}}get isFinished(){return this.state===Wn.Ready||this.state===Wn.Canceled||this.state===Wn.Failed}updatePriority(e){this.priority=e,void 0!==this.requestController&&(this.requestController.priority=e)}startLoading(){const e=this.loadAbortController.signal;this.dataProvider.getTile(this.tileKey,e).then(t=>{if(e.aborted){const e=new Error("Aborted");throw e.name="AbortError",e}this.onLoaded(t)}).catch(e=>{"AbortError"!==e.name&&"AbortError: Aborted"!==e.message&&this.onError(e)}),void 0===this.donePromise&&(this.donePromise=new Promise((e,t)=>{this.resolveDonePromise=e,this.rejectedDonePromise=t})),this.state=Wn.Loading}onLoaded(e){this.state=Wn.Loaded,this.payload=e,(void 0===e.byteLength||0!==e.byteLength)&&e!=={}?this.startDecodeTile():this.onDone(Wn.Ready)}startDecodeTile(){const e=this.payload;if(void 0===e)return void Po.error("TileLoader#startDecodeTile: Cannot decode without payload");this.state=Wn.Decoding,this.payload=void 0;const t=new K.j(this.priority);this.requestController=t;const i=this.dataSource;this.tileDecoder.decodeTile(e,this.tileKey,i.projection,t).then(e=>{t.signal.aborted||this.onDecoded(e)}).catch(e=>{"AbortError"!==e.name&&"AbortError: Aborted"!==e.message&&this.onError(e)})}onDecoded(e){this.decodedTile=e,this.onDone(Wn.Ready)}cancelDecoding(){void 0!==this.requestController&&(this.requestController.abort(),this.requestController=void 0)}onDone(e){this.resolveDonePromise&&e===Wn.Ready?this.resolveDonePromise(e):this.rejectedDonePromise&&this.rejectedDonePromise(e),this.resolveDonePromise=void 0,this.rejectedDonePromise=void 0,this.donePromise=void 0,this.state=e}onError(e){if(this.state===Wn.Canceled)return;const t=this.dataSource;Po.error(`[${t.name}]: failed to load tile ${this.tileKey.mortonCode()}`,e),this.error=e,this.onDone(Wn.Failed)}}class Ro extends Lo{startDecodeTile(){const e=this.payload;if(void 0===e)return void Po.error("TileInfoLoader#startDecodeTile: Cannot decode without payload");this.state=Wn.Decoding,this.payload=void 0;const t=new K.j(this.priority);this.requestController=t;const i=this.dataSource;this.tileDecoder.getTileInfo(e,this.tileKey,i.projection,t).then(e=>{t.signal.aborted||(this.tileInfo=e,this.onDone(Wn.Ready))}).catch(e=>{"AbortError"!==e.name&&"AbortError: Aborted"!==e.message&&this.onError(e)})}}class Oo{constructor(e){this.m_modelConstructor=e}create(e,t){return new this.m_modelConstructor(e,t)}}const Fo=3;class Do extends Y{constructor(e,t){if(super(t.name,t.styleSetName,t.minZoomLevel,t.maxZoomLevel,t.storageLevelOffset),this.m_tileFactory=e,this.m_options=t,this.logger=p.d.instance.create("TileDataSource"),this.m_isReady=!1,t.decoder)this.m_decoder=t.decoder;else{if(!t.concurrentDecoderServiceName)throw new Error(`TileDataSource[${this.name}]: unable to create, missing decoder or `+"concurrentDecoderServiceName");this.m_decoder=Er.getTileDecoder(t.concurrentDecoderServiceName,t.concurrentDecoderScriptUrl,t.concurrentDecoderWorkerCount)}this.useGeometryLoader=!0,this.cacheable=!0,this.m_tileLoaderCache=new ie(this.getCacheCount()),this.m_tileLoaderCache.evictionCallback=(e,t)=>{t.cancel()}}dispose(){this.decoder.dispose()}ready(){return this.m_isReady&&this.m_options.dataProvider.ready()}get decoder(){return this.m_decoder}async connect(){await Promise.all([this.m_options.dataProvider.connect(),this.m_decoder.connect()]),this.m_isReady=!0,this.m_decoder.configure(void 0,void 0,void 0,{storageLevelOffset:this.m_options.storageLevelOffset})}setStyleSet(e,t,i){this.m_decoder.configure(e,t,i),this.mapView.markTilesDirty(this)}setTheme(e,t){const i=void 0!==this.styleSetName&&e.styles?e.styles[this.styleSetName]:void 0;void 0!==i&&this.setStyleSet(i,e.definitions,t)}clearCache(){this.m_tileLoaderCache.evictAll()}dataProvider(){return this.m_options.dataProvider}getTilingScheme(){return this.m_options.tilingScheme}getTile(e){const t=this.m_tileFactory.create(this,e),i=e.mortonCode(),n=this.m_tileLoaderCache.get(i);if(void 0!==n)t.tileLoader=n;else{const n=new Lo(this,e,this.m_options.dataProvider,this.decoder,0);t.tileLoader=n,t.copyrightInfo=this.m_options.copyrightInfo,void 0!==this.m_options.copyrightProvider&&this.m_options.copyrightProvider.getCopyrights(t.geoBox,e.level).then(e=>{t.copyrightInfo=void 0===t.copyrightInfo?e:[...t.copyrightInfo,...e],this.requestUpdate()}),e.level<=Fo&&this.m_tileLoaderCache.set(i,n)}return void 0!==t.tileLoader.decodedTile?t.decodedTile=t.tileLoader.decodedTile:t.load(),t}getTileInfo(e){return new Promise((t,i)=>{const n=new Ro(this,e,this.m_options.dataProvider,this.decoder,0);n.loadAndDecode().then(e=>{e===Wn.Ready?t(n.tileInfo):i(new Error(`TileDataSource#getInfoTile wrong final state: ${e}`))})})}getCacheCount(){return 2*Math.pow(2,Fo)}}var Io=i(6);const zo=p.d.instance.create("OmvRestClient");var ko,jo;!function(e){e[e.HereV1=0]="HereV1",e[e.MapboxV4=1]="MapboxV4",e[e.XYZMVT=2]="XYZMVT",e[e.XYZJson=3]="XYZJson",e[e.XYZOMV=4]="XYZOMV",e[e.TomtomV1=5]="TomtomV1",e[e.XYZSpace=6]="XYZSpace"}(ko||(ko={})),function(e){e[e.QueryString=0]="QueryString",e[e.AuthorizationHeader=1]="AuthorizationHeader"}(jo||(jo={}));const No={method:jo.AuthorizationHeader,name:"Bearer"},Go={method:jo.QueryString,name:"key"},Uo={method:jo.QueryString,name:"access_token"};class Bo{constructor(e){this.params=e,this.downloadManager=void 0===e.downloadManager?wo.instance():e.downloadManager,this.urlParams=void 0===e.urlParams?{}:e.urlParams}async connect(){}ready(){return!0}async getTile(e,t){const i={signal:t};let n=this.dataUrl(e);const r=await this.getActualAuthenticationCode();return n=this.applyAuthCode(n,i,r),n=this.addQueryParams(n,this.urlParams),this.params.apiFormat===ko.XYZJson?this.downloadManager.downloadJson(n,i):this.downloadManager.downloadArrayBuffer(n,i)}async getActualAuthenticationCode(){return"string"==typeof this.params.authenticationCode?this.params.authenticationCode:void 0!==this.params.authenticationCode?this.params.authenticationCode():void 0!==this.params.getBearerToken?this.params.getBearerToken():void 0}getDefaultAuthMethod(){if(void 0!==this.params.getBearerToken)return No;switch(this.params.apiFormat){case ko.HereV1:return No;case ko.MapboxV4:case ko.XYZOMV:case ko.XYZMVT:case ko.XYZSpace:case ko.XYZJson:return Uo;case ko.TomtomV1:return Go;default:return void zo.warn(`#getDefaultAuthMethod: Not supported API format: ${this.params.apiFormat}`)}}applyAuthCode(e,t,i){if(void 0===i)return e;const n=this.params.authenticationMethod||this.getDefaultAuthMethod();if(void 0===n)return e;if(n.method===jo.AuthorizationHeader){void 0===t.headers&&(t.headers=new Headers);const e=n.name||"Bearer";t.headers.append("Authorization",`${e} ${i}`)}else if(n.method===jo.QueryString){const t={};t[n.name||"access_token"]=i,e=this.addQueryParams(e,t)}return e}dataUrl(e){if(void 0!==this.params.url)return this.params.url.replace("{x}",String(e.column)).replace("{y}",String(e.row)).replace("{z}",String(e.level));let t=[`/${e.level}`,e.column,e.row].join(this.params.apiFormat===ko.XYZSpace?"_":"/");switch(this.params.apiFormat){case ko.HereV1:case ko.XYZOMV:t+="/omv";break;case ko.MapboxV4:case ko.XYZMVT:t+=".mvt";break;case ko.XYZJson:t+=".json";break;case ko.XYZSpace:t+=".mvt";break;case ko.TomtomV1:t+=".pbf";break;default:zo.warn(`Not supported API format: ${this.params.apiFormat}`)}return this.params.baseUrl+t}addQueryParams(e,t){let i="",n=-1!==e.indexOf("?")?"&":"?";return Object.getOwnPropertyNames(t).forEach(e=>{i+=n+e+"="+t[e],"?"===n&&(n="&")}),e+i}}class qo extends Zn{constructor(e,t){super(e,t)}}const Vo=p.d.instance.create("OmvDataSource");function Wo(e){if(e.dataProvider)return e.dataProvider;if(e.baseUrl||e.url)return new Bo(e);throw new Error("OmvDataSource: missing url, baseUrl or dataProvider params")}let Zo=!1;class $o extends Do{constructor(e){super(e.tileFactory||new Oo(qo),{styleSetName:e.styleSetName||"omv",name:e.name,tilingScheme:n.p,dataProvider:Wo(e),concurrentDecoderServiceName:Io.c,decoder:e.decoder,concurrentDecoderScriptUrl:e.concurrentDecoderScriptUrl,copyrightInfo:e.copyrightInfo,copyrightProvider:e.copyrightProvider,minZoomLevel:Object(p.r)(e.minZoomLevel,1),maxZoomLevel:Object(p.r)(e.maxZoomLevel,14),storageLevelOffset:Object(p.r)(e.storageLevelOffset,-1)}),this.m_params=e,this.cacheable=!0,this.addGroundPlane=void 0===e.addGroundPlane||!0===e.addGroundPlane,this.m_decoderOptions={showMissingTechniques:!0===this.m_params.showMissingTechniques,filterDescription:this.m_params.filterDescr,gatherFeatureAttributes:!0===this.m_params.gatherFeatureAttributes,createTileInfo:!0===this.m_params.createTileInfo,gatherRoadSegments:!0===this.m_params.gatherRoadSegments,featureModifierId:this.m_params.featureModifierId,skipShortLabels:this.m_params.skipShortLabels,storageLevelOffset:Object(p.r)(e.storageLevelOffset,-1),enableElevationOverlay:!0===this.m_params.enableElevationOverlay},this.maxGeometryHeight=Object(p.r)(e.maxGeometryHeight,n.a.MAX_BUILDING_HEIGHT)}async connect(){try{await super.connect()}catch(e){throw K.o.isUnknownServiceError(e)&&!Zo&&(Vo.info("Unable to create decoder service in worker. Use  'OmvTileDecoderService.start();' in decoder script."),Zo=!0),e}this.configureDecoder(void 0,void 0,void 0,this.m_decoderOptions)}removeDataFilter(){this.configureDecoder(void 0,void 0,void 0,{filterDescription:null})}setDataFilter(e){this.m_decoderOptions.filterDescription=null!==e?e:void 0,this.configureDecoder(void 0,void 0,void 0,{filterDescription:e})}shouldPreloadTiles(){return!0}canGetTile(e,t){return!(t.level>this.maxZoomLevel)&&(t.level<=this.maxZoomLevel&&e>=this.maxZoomLevel||super.canGetTile(e,t))}setLanguages(e){void 0!==e&&this.configureDecoder(void 0,void 0,e,void 0)}get storageLevelOffset(){return super.storageLevelOffset}set storageLevelOffset(e){super.storageLevelOffset=e,this.m_decoderOptions.storageLevelOffset=this.storageLevelOffset,this.configureDecoder(void 0,void 0,void 0,{storageLevelOffset:this.storageLevelOffset})}setEnableElevationOverlay(e){this.m_decoderOptions.enableElevationOverlay!==e&&(this.m_decoderOptions.enableElevationOverlay=e,this.configureDecoder(void 0,void 0,void 0,{enableElevationOverlay:e}))}configureDecoder(e,t,i,n){this.clearCache(),this.decoder.configure(e,t,i,n),this.mapView.markTilesDirty(this)}}new r.Q({color:0,linewidth:2,depthTest:!1,depthFunc:r.lb}),new r.fb({color:16711680,depthTest:!1,depthFunc:r.lb});new r.fb({color:16711680,depthTest:!1,depthFunc:r.lb}).wireframe=!0,new r.fb({color:8421631,depthTest:!1,depthFunc:r.lb}).wireframe=!0;new r.fb({color:0,depthTest:!1,depthFunc:r.lb});const Ho=new Se;new Ce;Ho.fontSize={unit:ge.Point,size:9,backgroundSize:0},Ho.opacity=.75,Ho.backgroundOpacity=.75;const Ko="AGln99HORnqL1kfIQtsQl70";(new Date).getFullYear();i.d(t,"createMap",(function(){return Yo}));const Xo=i(56);function Yo(e){const t=new po({...e,decoderUrl:"decoder.bundle.js",theme:Xo,preserveDrawingBuffer:!0,maxVisibleDataSourceTiles:40,tileCacheSize:100}),i=new $o({baseUrl:"https://xyz.api.here.com/tiles/herebase.02",apiFormat:ko.XYZOMV,styleSetName:"tilezen",authenticationCode:Ko});t.addDataSource(i);const r=34.3,s=1400,o=new n.b(42.361145,-71.057083);let a=135;return t.lookAt(o,s,r,a),t.addEventListener(Is.FrameComplete,()=>{console.log("#FirstFrameComplete, starting animation"),t.addEventListener(Is.Render,()=>t.lookAt(o,s,r,a+=.1)),setTimeout(()=>{t.beginAnimation()},.5)}),t}}]]);
//# sourceMappingURL=mapview-main-chunk.bundle.js.map